<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ŸÖÿµÿ≠ŸÅ ÿßŸÑŸÜŸàÿ±">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<title>ŸÖÿµÿ≠ŸÅ ÿßŸÑŸÜŸàÿ± Ÿ¢Ÿ†Ÿ¢Ÿ¶</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#062115">
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&family=Reem+Kufi:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ===================== VARIABLES ===================== */
:root{
  --primary:#062115;--secondary:#0b2b1d;--accent:#d4af37;
  --bg:#fdfcf6;--text:#062115;--card:#ffffff;
  --gray:#888;--red:#c0392b;--green:#2d9e6b;
  --ease:all .38s cubic-bezier(.175,.885,.32,1.275);
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bot:env(safe-area-inset-bottom,0px);
}
.dark-mode{
  --primary:#010e07;--secondary:#031a0e;
  --bg:#010e07;--text:#e8e8e8;--card:#051a0f;--gray:#aaa;
}
.dark-mode .card{
  background:linear-gradient(160deg,#071f12 0%,#051508 100%);
  border-color:rgba(212,175,55,.18);
  box-shadow:0 8px 24px rgba(0,0,0,.4), 0 1px 4px rgba(0,0,0,.25), inset 0 1px 0 rgba(212,175,55,.06);
}
.dark-mode .stat-chip{
  background:linear-gradient(160deg,#071f12 0%,#051508 100%);
  border-color:rgba(212,175,55,.16);
  box-shadow:0 6px 20px rgba(0,0,0,.35), inset 0 1px 0 rgba(212,175,55,.05);
}

/* ===================== RESET ===================== */
*{-webkit-tap-highlight-color:transparent;user-select:none;box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased;}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:'Amiri',serif;transition:background .4s,color .4s;background-image:url('https://www.transparenttextures.com/patterns/islamic-art.png')}

/* ===================== SPLASH ===================== */
#splash{position:fixed;inset:0;background:var(--primary);z-index:10000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .8s}
.splash-logo{font-family:'Reem Kufi';font-size:clamp(2.5em,10vw,4.5em);color:var(--accent);text-shadow:0 0 30px rgba(212,175,55,.4);animation:splashPulse 2s ease-in-out infinite}
.splash-ayah{color:rgba(255,255,255,.5);font-size:clamp(.82em,3.5vw,.95em);text-align:center;padding:0 24px;max-width:320px;line-height:1.8}
.splash-bar{width:160px;height:3px;background:rgba(212,175,55,.2);border-radius:3px;overflow:hidden;margin-top:10px}
.splash-fill{height:100%;background:var(--accent);border-radius:3px;animation:fillBar 2.2s linear forwards}
@keyframes splashPulse{0%,100%{opacity:.75;transform:scale(1)}50%{opacity:1;transform:scale(1.06)}}
@keyframes fillBar{from{width:0}to{width:100%}}

/* ===================== TOAST ===================== */
#toast{position:fixed;top:max(20px, calc(var(--safe-top) + 12px));left:50%;transform:translateX(-50%) translateY(-200%);background:rgba(6,33,21,.96);color:var(--accent);padding:11px 28px;border-radius:50px;border:1.5px solid var(--accent);z-index:9999;transition:transform .35s cubic-bezier(.175,.885,.32,1.275);font-size:.92em;font-weight:bold;box-shadow:0 8px 24px rgba(0,0,0,.5);text-align:center;pointer-events:none;max-width:88vw;backdrop-filter:blur(10px)}
#toast.show{transform:translateX(-50%) translateY(0)}

/* ===================== HOME ===================== */
#home-screen{display:flex;flex-direction:column;height:100vh;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}

/* ===================== HEADER ===================== */
header{background:linear-gradient(160deg,#041a0e 0%,#0b2b1d 100%);padding:calc(var(--safe-top) + 52px) 20px 20px;text-align:center;position:relative;flex-shrink:0;overflow:hidden}
header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
header h1{font-family:'Reem Kufi';font-size:clamp(2.2em,9vw,3.4em);color:var(--accent);line-height:1;letter-spacing:1px;text-shadow:0 0 20px rgba(212,175,55,.3)}
header p{color:rgba(255,255,255,.45);margin-top:4px;font-size:clamp(.8em,3.2vw,.9em)}
#menu-btn{position:absolute;top:calc(var(--safe-top) + 12px);left:14px;width:44px;height:44px;border-radius:50%;background:rgba(212,175,55,.1);border:1.5px solid rgba(212,175,55,.4);color:var(--accent);font-size:1.35em;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:background .2s}
#menu-btn:active{background:rgba(212,175,55,.25)}
#search-home-btn{position:absolute;top:calc(var(--safe-top) + 12px);right:14px;width:44px;height:44px;border-radius:50%;background:rgba(212,175,55,.1);border:1.5px solid rgba(212,175,55,.4);color:var(--accent);font-size:1.2em;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:background .2s}
#search-home-btn:active{background:rgba(212,175,55,.25)}

/* ===================== PRAYER SCENE CARD ===================== */
#prayer-scene{background:linear-gradient(180deg,#041520 0%,#0d2b1e 60%,#0b2b1d 100%);margin:0;padding:0;flex-shrink:0;position:relative;overflow:hidden;cursor:pointer}
#prayer-scene:active{opacity:.9}

/* Sky canvas */
#sky-canvas{width:100%;height:130px;display:block}

/* Prayer info row */
#prayer-info-row{display:flex;justify-content:space-between;align-items:center;padding:8px 18px 12px;background:rgba(0,0,0,.2);border-bottom:1.5px solid rgba(212,175,55,.25)}
#pi-left{display:flex;flex-direction:column;gap:2px}
#pi-label{font-size:.75em;color:rgba(255,255,255,.45);letter-spacing:.5px}
#pi-name{font-size:1.1em;color:var(--accent);font-weight:bold;font-family:'Reem Kufi'}
#pi-timer{font-family:monospace;font-size:1.5em;color:#fff;letter-spacing:2px;font-weight:bold;direction:ltr}

/* ===================== DATE / HIJRI ===================== */
#hijri-bar{background:rgba(0,0,0,.15);padding:6px 16px;display:flex;justify-content:space-between;align-items:center;font-size:clamp(.75em,3vw,.85em);color:rgba(255,255,255,.6);flex-shrink:0;border-bottom:1px solid rgba(212,175,55,.1)}
#hijri-bar .hj{color:var(--accent)}

/* ===================== NOTIF BANNER ===================== */
#notif-banner{background:linear-gradient(135deg,#1a3a2a,#0f2218);border:1px solid rgba(212,175,55,.3);border-radius:14px;margin:10px 12px 0;padding:12px 14px;display:none;flex-direction:column;gap:9px;flex-shrink:0}
#notif-banner p{color:rgba(212,175,55,.9);text-align:center;font-size:.88em;line-height:1.5}
.nb-btns{display:flex;gap:9px}
.nb-allow{flex:1;padding:10px;border-radius:11px;border:none;font-weight:bold;cursor:pointer;font-family:'Amiri';font-size:.92em;background:var(--accent);color:var(--primary)}
.nb-later{flex:1;padding:10px;border-radius:11px;border:1.5px solid rgba(212,175,55,.5);font-weight:bold;cursor:pointer;font-family:'Amiri';font-size:.92em;background:transparent;color:var(--accent)}

/* ===================== LAST READ BANNER ===================== */
#last-read-bar{margin:10px 12px 0;background:var(--card);border:1.5px solid rgba(212,175,55,.2);border-radius:13px;padding:11px 14px;display:none;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;flex-shrink:0}
#last-read-bar:active{opacity:.75}
#last-read-bar .lr-label{font-size:.75em;color:var(--gray)}
#last-read-bar .lr-value{color:var(--accent);font-weight:bold;font-size:.92em;margin-top:2px}
#last-read-bar .lr-arrow{color:var(--accent);font-size:1.1em;flex-shrink:0}

/* ===================== GRID ===================== */
.home-grid-wrap{padding:12px 14px 0;flex-shrink:0}
/* ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© - ÿπÿ±ÿ∂ ŸÉÿßŸÖŸÑ */
.card-quran{
  background:linear-gradient(135deg,#0d3d26 0%,#062115 60%,#041a10 100%);
  border:1.5px solid rgba(212,175,55,.45);
  border-radius:20px;padding:18px 20px;
  display:flex;align-items:center;gap:16px;
  cursor:pointer;margin-bottom:11px;
  box-shadow:0 8px 28px rgba(0,0,0,.45), 0 2px 8px rgba(212,175,55,.08), inset 0 1px 0 rgba(212,175,55,.15);
  transition:transform .18s ease,box-shadow .18s ease,opacity .15s;
  position:relative;overflow:hidden;
}
.card-quran::before{
  content:'';position:absolute;top:-40%;right:-10%;
  width:160px;height:160px;
  background:radial-gradient(circle,rgba(212,175,55,.07) 0%,transparent 70%);
  pointer-events:none;
}
.card-quran:active{transform:scale(.97);box-shadow:0 3px 12px rgba(0,0,0,.4);opacity:.9}
.card-quran .cq-icon{font-size:2.5em;flex-shrink:0;filter:drop-shadow(0 2px 6px rgba(212,175,55,.3))}
.card-quran .cq-text{flex:1}
.card-quran .cq-title{font-family:'Reem Kufi';font-size:1.2em;color:var(--accent);text-shadow:0 1px 8px rgba(212,175,55,.2)}
.card-quran .cq-sub{font-size:.77em;color:rgba(255,255,255,.45);margin-top:3px;font-family:'Amiri'}
.card-quran .cq-arrow{color:var(--accent);opacity:.6;font-size:1em}
/* ÿ¥ÿ®ŸÉÿ© Ÿ¢√óŸ¢ ŸÑŸÑÿ®ŸÇŸäÿ© */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:11px}
.card{
  background:linear-gradient(160deg,var(--card) 0%,rgba(6,33,21,.04) 100%);
  border:1px solid rgba(212,175,55,.16);
  border-radius:18px;
  padding:16px 15px;
  display:flex;align-items:center;gap:12px;
  cursor:pointer;
  transition:transform .18s ease,box-shadow .18s ease;
  box-shadow:0 6px 20px rgba(0,0,0,.13), 0 1px 4px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.06);
  position:relative;overflow:hidden;
}
.card::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(160deg,rgba(212,175,55,.04) 0%,transparent 60%);
  pointer-events:none;border-radius:inherit;
}
.card:active{transform:scale(.95);box-shadow:0 2px 8px rgba(0,0,0,.18)}
.card-icon{font-size:1.85em;flex-shrink:0;width:36px;text-align:center;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
.card b{font-size:clamp(.88em,3.6vw,.98em);color:var(--text);font-weight:700;letter-spacing:.2px}

/* ===================== QURAN STATS ===================== */
#stats-bar{display:flex;gap:11px;padding:12px 14px 16px;flex-shrink:0}
.stat-chip{
  flex:1;
  background:linear-gradient(160deg,var(--card) 0%,rgba(6,33,21,.03) 100%);
  border:1px solid rgba(212,175,55,.14);
  border-radius:16px;
  padding:12px 6px;text-align:center;
  box-shadow:0 6px 18px rgba(0,0,0,.12), 0 1px 3px rgba(0,0,0,.07), inset 0 1px 0 rgba(255,255,255,.05);
  position:relative;overflow:hidden;
}
.stat-chip::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,.18),transparent);
}
.stat-chip .sc-num{color:var(--accent);font-size:1.35em;font-weight:bold;display:block;line-height:1.2;text-shadow:0 1px 6px rgba(212,175,55,.2)}
.stat-chip .sc-lbl{color:var(--gray);font-size:.72em;display:block;margin-top:3px}

/* ===================== SIDE MENU ===================== */
#side-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9700;display:none;opacity:0;transition:opacity .3s;backdrop-filter:blur(2px)}
#side-overlay.show{display:block;opacity:1}
#side-menu{position:fixed;top:0;right:-300px;width:280px;height:100%;background:var(--card);z-index:9800;transition:right .38s cubic-bezier(.25,.8,.25,1);box-shadow:-8px 0 32px rgba(0,0,0,.3);display:flex;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch}
#side-menu.open{right:0}
.side-header{background:linear-gradient(150deg,var(--primary),var(--secondary));padding:calc(var(--safe-top) + 44px) 16px 22px;text-align:center;border-bottom:2px solid var(--accent)}
.side-header h2{font-family:'Reem Kufi';color:var(--accent);font-size:1.35em}
.side-header p{color:rgba(255,255,255,.45);font-size:.78em;margin-top:4px}
.side-section{padding:10px 16px 4px;font-size:.72em;color:var(--accent);opacity:.6;letter-spacing:1.5px;border-top:1px solid rgba(212,175,55,.08);margin-top:4px;text-transform:uppercase}
.side-item{display:flex;align-items:center;gap:13px;padding:14px 16px;border-bottom:1px solid rgba(212,175,55,.06);cursor:pointer;transition:background .2s;font-size:.97em}
.side-item:active{background:rgba(212,175,55,.08)}
.side-icon{font-size:1.25em;width:26px;text-align:center;flex-shrink:0}
.side-toggle{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;border-bottom:1px solid rgba(212,175,55,.06);font-size:.97em;gap:10px}
.side-toggle span{flex:1}
.tog{width:44px;height:24px;background:rgba(136,136,136,.4);border-radius:12px;position:relative;cursor:pointer;transition:background .3s;flex-shrink:0}
.tog.on{background:var(--accent)}
.tog::after{content:'';position:absolute;width:20px;height:20px;background:white;border-radius:50%;top:2px;right:2px;transition:transform .3s;box-shadow:0 1px 4px rgba(0,0,0,.3)}
.tog.on::after{transform:translateX(-20px)}

/* ===================== VIEWER ===================== */
#viewer{position:fixed;inset:0;background:var(--bg);z-index:5000;display:none;opacity:0;transform:translateY(12px);transition:opacity .35s ease,transform .35s ease;flex-direction:column}
#viewer.active{display:flex;opacity:1;transform:translateY(0)}
.nav-bar{background:var(--primary);padding:calc(var(--safe-top) + 10px) 12px 10px;display:flex;align-items:center;gap:8px;border-bottom:2px solid var(--accent);z-index:100;flex-shrink:0}
.btn-back{background:var(--accent);color:var(--primary);border:none;padding:8px 16px;border-radius:10px;font-weight:bold;cursor:pointer;font-family:'Amiri';font-size:clamp(.82em,3.5vw,.9em);white-space:nowrap;flex-shrink:0;min-height:38px}
#v-title{flex:1;text-align:center;color:var(--accent);font-family:'Reem Kufi';font-size:clamp(.95em,4vw,1.1em);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.nic{background:transparent;border:1.5px solid rgba(212,175,55,.35);border-radius:8px;color:var(--accent);font-size:1.1em;width:36px;height:36px;display:none;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.nic.vis{display:flex}

/* ===================== SEARCH ===================== */
#search-panel{background:var(--secondary);max-height:0;overflow:hidden;transition:max-height .38s ease,padding .32s;border-bottom:2px solid transparent;flex-shrink:0}
#search-panel.open{max-height:220px;padding:12px 13px;border-bottom-color:var(--accent)}
.s-inp{width:100%;padding:11px 16px;border-radius:24px;border:1.5px solid var(--accent);background:var(--primary);color:var(--accent);font-family:'Noto Naskh Arabic';font-size:clamp(.95em,4vw,1.05em);outline:none;-webkit-appearance:none}
.s-inp::placeholder{color:rgba(212,175,55,.4)}
#filter-row{display:flex;gap:7px;margin-top:9px;flex-wrap:wrap}
.fchip{padding:5px 12px;border-radius:18px;border:1.5px solid var(--accent);background:transparent;color:var(--accent);font-family:'Amiri';font-size:clamp(.8em,3.2vw,.88em);cursor:pointer;transition:background .2s;white-space:nowrap}
.fchip.on{background:var(--accent);color:var(--primary);font-weight:bold}
#sr-area{overflow-y:auto;-webkit-overflow-scrolling:touch;flex-shrink:0;max-height:40vh}
.sr-item{background:var(--card);border-radius:13px;padding:13px;margin:0 13px 9px;border-right:4px solid var(--accent);cursor:pointer}
.sr-item:active{opacity:.8}
.sr-meta{color:var(--accent);font-size:.8em;margin-bottom:7px;font-weight:bold}
.sr-txt{font-family:'Noto Naskh Arabic';font-size:clamp(1.05em,4.5vw,1.18em);line-height:1.85}
.hl{background:rgba(212,175,55,.3);border-radius:3px;padding:0 2px}
.sr-count{padding:8px 14px;color:var(--accent);font-size:.85em}

/* ===================== V-BODY ===================== */
#v-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;padding-bottom:calc(var(--safe-bot) + 70px)}

/* ===================== AYAH ===================== */
.ayah-frame{animation:fadeUp .28s ease forwards;background:var(--card);margin:10px 12px;padding:18px;border-radius:16px;border-right:5px solid var(--accent);box-shadow:0 3px 10px rgba(0,0,0,.05);position:relative}
.ayah-frame.playing{background:rgba(45,158,107,.07);border-right-color:var(--green)}
.ayah-frame.bookmarked{border-right-color:var(--red)}
.ayah-frame.highlighted{background:rgba(212,175,55,.1)}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.qf{font-family:'Noto Naskh Arabic',serif;line-height:2.1;text-align:justify}
.anum{color:var(--accent);font-weight:bold;display:inline-block}
.ayah-acts{display:flex;gap:6px;margin-top:9px;flex-wrap:wrap;align-items:center}
.ab{font-size:clamp(.72em,3vw,.8em);padding:5px 11px;border-radius:9px;border:1.5px solid var(--accent);background:transparent;color:var(--accent);cursor:pointer;font-family:'Amiri';white-space:nowrap;min-height:32px;display:flex;align-items:center}
.ab:active{background:rgba(212,175,55,.18)}
.ab.bmact{background:var(--red);border-color:var(--red);color:#fff}
.tf-box{background:rgba(45,106,79,.07);border-radius:10px;padding:12px;margin-top:10px;color:#2d6a4f;font-size:.9em;display:none;line-height:1.9;font-family:'Noto Naskh Arabic'}
.dark-mode .tf-box{background:rgba(126,200,164,.06);color:#7ec8a4}

/* ===================== TAFSIR PAGE ===================== */
.tafsir-ayah-block{
  background:var(--card);
  margin:10px 12px;
  border-radius:16px;
  border-right:5px solid var(--accent);
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  overflow:hidden;
}
.tafsir-ayah-num{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 14px 0;
}
.tafsir-ayah-text{
  font-family:'Noto Naskh Arabic',serif;
  font-size:1.2em;line-height:2.2;
  padding:10px 16px;
  color:var(--text);
  border-bottom:1px solid rgba(212,175,55,.12);
}
.tafsir-content{
  padding:12px 14px 14px;
}
.tafsir-source-label{
  font-size:.72em;color:var(--accent);font-weight:bold;
  margin-bottom:8px;opacity:.8;
}
.tafsir-text{
  font-family:'Noto Naskh Arabic',serif;
  font-size:.92em;line-height:2;
  color:var(--text);opacity:.85;
}
.dark-mode .tafsir-text{opacity:.9;}
.dark-mode .tafsir-ayah-text{color:#ddd;}
.bismillah-line{text-align:center;color:var(--accent);font-weight:bold;font-size:clamp(1.1em,4.5vw,1.3em);padding:14px 0 8px;font-family:'Noto Naskh Arabic';letter-spacing:.5px}

/* ===================== FONT CTRL ===================== */
#font-ctrl{
  display:flex;align-items:center;gap:10px;
  margin:10px 14px 4px;
  background:linear-gradient(135deg,var(--card),rgba(6,33,21,.04));
  border-radius:14px;padding:10px 16px;
  border:1px solid rgba(212,175,55,.15);
  box-shadow:0 4px 14px rgba(0,0,0,.1),inset 0 1px 0 rgba(255,255,255,.05);
}
#font-ctrl span{flex:1;text-align:center;font-size:.82em;color:var(--accent);opacity:.8;font-family:'Amiri'}
#font-ctrl button{
  width:38px;height:38px;border-radius:50%;
  border:1.5px solid rgba(212,175,55,.5);
  background:linear-gradient(160deg,var(--primary),var(--secondary));
  color:var(--accent);font-size:1em;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 3px 10px rgba(0,0,0,.25);
  transition:transform .12s,box-shadow .12s;
  font-family:'Amiri';font-weight:bold;
}
#font-ctrl button:active{transform:scale(.9);box-shadow:0 1px 4px rgba(0,0,0,.2)}

/* ===================== AUTO SCROLL FLOATING WIDGET ===================== */
#scroll-widget{
  position:fixed;
  bottom:calc(var(--safe-bot) + 80px);
  left:14px;
  width:58px;
  display:none;
  flex-direction:column;
  align-items:center;
  gap:6px;
  z-index:9100;
}
/* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ≥ÿ±ÿπÿ© ÿßŸÑÿπŸÖŸàÿØŸä */
#spctl{
  width:46px;
  height:110px;
  background:linear-gradient(180deg,rgba(6,33,21,.97),rgba(3,18,10,.97));
  border:1.5px solid rgba(212,175,55,.35);
  border-radius:16px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:space-between;
  padding:10px 0;
  box-shadow:0 6px 24px rgba(0,0,0,.5),inset 0 1px 0 rgba(212,175,55,.1);
  position:relative;overflow:hidden;
}
#spctl::before{
  content:'ÿ≥ÿ±ÿπÿ©';position:absolute;top:5px;left:50%;transform:translateX(-50%);
  font-size:.5em;color:rgba(212,175,55,.5);font-family:'Amiri';white-space:nowrap;
}
#spctl-fast,#spctl-slow{
  color:rgba(212,175,55,.7);font-size:.58em;font-family:'Amiri';line-height:1;
  padding:0 6px;text-align:center;
}
#spctl input[type=range]{
  writing-mode:vertical-lr;
  direction:rtl;
  width:10px;
  height:60px;
  accent-color:var(--accent);
  cursor:pointer;
  flex-shrink:0;
}
/* ÿ≤ÿ± ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ/ÿßŸÑÿ•ŸäŸÇÿßŸÅ */
#asbtn{
  width:54px;height:54px;
  background:linear-gradient(160deg,#0d3d26,#062115);
  color:var(--accent);
  border:2px solid rgba(212,175,55,.5);
  border-radius:50%;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  cursor:pointer;
  font-size:.6em;font-weight:bold;line-height:1.3;
  box-shadow:0 6px 20px rgba(0,0,0,.5),0 0 0 0 rgba(212,175,55,0);
  transition:transform .15s,box-shadow .15s,background .2s;
  text-align:center;font-family:'Amiri';
  position:relative;
}
#asbtn.running{
  background:linear-gradient(160deg,rgba(212,175,55,.2),rgba(212,175,55,.08));
  border-color:var(--accent);
  box-shadow:0 6px 20px rgba(0,0,0,.5),0 0 14px rgba(212,175,55,.25);
  animation:scrollPulse 2s ease-in-out infinite;
}
@keyframes scrollPulse{
  0%,100%{box-shadow:0 6px 20px rgba(0,0,0,.5),0 0 8px rgba(212,175,55,.2)}
  50%{box-shadow:0 6px 20px rgba(0,0,0,.5),0 0 20px rgba(212,175,55,.4)}
}
#asbtn:active{transform:scale(.92)}

/* ===================== SEBHA ===================== */
.sebha-circle{width:clamp(160px,55vw,210px);height:clamp(160px,55vw,210px);border-radius:50%;margin:22px auto;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:clamp(1.8em,7vw,2.6em);cursor:pointer;transition:all .08s;background:radial-gradient(circle at 30% 30%,#0b2b1d,#062115);color:#fff;border:7px solid var(--accent);box-shadow:0 12px 0 #04140e,0 16px 24px rgba(0,0,0,.4);position:relative;top:0;gap:4px}
.sebha-circle:active{top:9px;box-shadow:0 3px 0 #04140e}
.sebha-circle small{font-size:.35em;opacity:.7;font-family:'Amiri'}

/* ===================== TABS ===================== */
.tab-bar{display:flex;gap:7px;padding:10px 12px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;flex-shrink:0}
.tab-bar::-webkit-scrollbar{display:none}
.tbb{flex-shrink:0;padding:7px 16px;border-radius:18px;border:1.5px solid var(--accent);background:transparent;color:var(--accent);font-family:'Amiri';font-size:clamp(.83em,3.5vw,.93em);cursor:pointer;white-space:nowrap;min-height:36px}
.tbb.on{background:var(--accent);color:var(--primary);font-weight:bold}

/* ===================== PRAYER ===================== */
#next-card{background:linear-gradient(150deg,var(--primary),var(--secondary));border:1.5px solid var(--accent);border-radius:20px;margin:13px;padding:20px;text-align:center}
#next-card h3{color:var(--accent);font-family:'Reem Kufi';margin-bottom:5px;font-size:clamp(.95em,4vw,1.05em)}
#next-name{font-size:clamp(1.7em,7vw,2.2em);color:#fff;font-family:'Reem Kufi'}
#next-timer{font-size:clamp(2em,8vw,3em);font-family:monospace;color:var(--accent);font-weight:bold;letter-spacing:2px;margin-top:4px}
.p-row{display:flex;justify-content:space-between;align-items:center;padding:13px 16px;border-radius:13px;margin:0 12px 9px;background:var(--card);border:1.5px solid rgba(212,175,55,.1)}
.p-row.acp{border-color:var(--accent);background:rgba(212,175,55,.07)}
.pn{font-size:clamp(1em,4vw,1.1em);font-weight:bold}
.pt{color:var(--accent);font-size:clamp(1em,4vw,1.15em);font-family:monospace}

/* ===================== BOOKMARKS ===================== */
.bm-item{background:var(--card);border-radius:13px;margin:8px 12px;padding:13px;border-right:4px solid var(--red);cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:10px}
.bm-item:active{opacity:.8}

/* ===================== NAMES ===================== */
.name-card{background:var(--card);border:1.5px solid rgba(212,175,55,.13);border-radius:14px;padding:clamp(13px,4vw,17px) 10px;text-align:center;cursor:pointer;transition:var(--ease);display:flex;flex-direction:column;align-items:center;gap:5px}
.name-card:active{transform:scale(.88);background:rgba(212,175,55,.07)}
.name-meaning{font-size:.76em;color:var(--gray);line-height:1.4;margin-top:4px}

/* ===================== PLAYER BAR ===================== */
#player-bar{background:var(--primary);border-top:1.5px solid var(--accent);padding:10px 14px calc(var(--safe-bot) + 10px);display:none;align-items:center;gap:9px;z-index:200;flex-shrink:0}
#player-bar.show{display:flex}
#pinfo{flex:1;font-size:.85em;color:var(--accent);overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.p-ctrl{display:flex;gap:7px}
#pprev,#pnext{background:rgba(212,175,55,.15);color:var(--accent);border:1px solid rgba(212,175,55,.3);border-radius:8px;padding:7px 11px;cursor:pointer;font-family:'Amiri';font-size:.85em}
#pstop{background:#8b0000;color:#fff;border:none;border-radius:9px;padding:8px 13px;cursor:pointer;font-family:'Amiri';font-size:.88em}

/* ===================== DUA MODAL ===================== */
#dua-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9500;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(3px)}
#dua-modal.show{display:flex}
#dua-sheet{background:var(--card);border-radius:22px 22px 0 0;padding:20px 18px calc(var(--safe-bot) + 20px);max-height:70vh;overflow-y:auto;width:100%;animation:slideUp .32s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
#dua-sheet h3{color:var(--accent);font-family:'Reem Kufi';margin-bottom:12px;font-size:1.1em}
#dua-sheet p{font-family:'Noto Naskh Arabic';font-size:1.15em;line-height:2;color:var(--text)}
#dua-sheet .dua-source{color:var(--gray);font-size:.8em;margin-top:8px}
.dua-close{position:absolute;top:10px;left:50%;transform:translateX(-50%);width:40px;height:4px;background:rgba(136,136,136,.4);border-radius:2px;cursor:pointer}

/* ===================== AZKAR CARD ===================== */
.azkar-card{background:var(--card);border-right:5px solid var(--accent);border-radius:16px;margin:10px 12px;padding:16px 14px;position:relative;overflow:hidden}
.azkar-title{color:var(--accent);font-family:'Reem Kufi';font-size:1em;margin-bottom:10px}
.azkar-text{font-family:'Noto Naskh Arabic';font-size:clamp(1.05em,4.5vw,1.2em);line-height:2.1;color:var(--text)}
.azkar-count{display:inline-flex;align-items:center;gap:6px;background:rgba(212,175,55,.1);border:1px solid rgba(212,175,55,.2);border-radius:20px;padding:4px 12px;font-size:.8em;color:var(--accent);margin-top:10px}
.azkar-actions{display:flex;gap:7px;margin-top:11px}
.azkar-btn{flex:1;padding:8px;border-radius:10px;border:1.5px solid var(--accent);background:transparent;color:var(--accent);font-family:'Amiri';font-size:.85em;cursor:pointer}
.azkar-btn.active{background:var(--accent);color:var(--primary);font-weight:bold}
.azkar-counter-display{position:absolute;top:14px;left:14px;font-size:.78em;color:var(--gray);font-family:monospace}

/* ===================== WORD SEARCH (tajweed) ===================== */
.word-btn{display:inline;cursor:pointer;border-radius:4px;padding:0 2px;transition:background .15s}
.word-btn:active{background:rgba(212,175,55,.3)}

/* ===================== PROGRESS ===================== */
.reading-progress{background:rgba(212,175,55,.15);border-radius:6px;height:6px;margin:8px 12px;overflow:hidden}
.reading-fill{height:100%;background:var(--accent);border-radius:6px;transition:width .5s ease}

/* ===================== SCROLL TO TOP ===================== */
#scroll-top-btn{position:fixed;bottom:calc(var(--safe-bot) + 22px);right:16px;width:44px;height:44px;background:var(--accent);color:var(--primary);border:none;border-radius:50%;font-size:1.1em;display:none;align-items:center;justify-content:center;z-index:9000;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.3)}
#scroll-top-btn.show{display:flex}

/* ===================== RESPONSIVE ===================== */
@media(max-width:360px){
  header h1{font-size:1.9em}
  .card{padding:14px 10px}
  .card-icon{font-size:1.65em}
  .qf{font-size:1.4em!important}
  .home-grid-wrap{padding:10px 10px 0}
  .grid{gap:9px}
  #stats-bar{padding:10px 10px 14px;gap:9px}
}
@media(min-width:480px){
  .grid{grid-template-columns:repeat(4,1fr)}
  #side-menu{width:310px;right:-320px}
}
@media(max-width:479px){
  .grid{grid-template-columns:repeat(2,1fr)}
}
@media(prefers-color-scheme:dark){
  body:not(.light-forced){--primary:#010e07;--secondary:#031a0e;--bg:#010e07;--text:#e8e8e8;--card:#051a0f;--gray:#aaa}
}

/* ===================== BOTTOM NAV ===================== */
#bottom-nav{
  position:fixed;bottom:0;left:0;right:0;
  height:calc(58px + var(--safe-bot));
  background:rgba(3,18,10,.97);
  border-top:1.5px solid rgba(212,175,55,.22);
  display:flex;align-items:stretch;
  z-index:8500;
  backdrop-filter:blur(14px);
  padding-bottom:var(--safe-bot);
}
.bnav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:pointer;gap:3px;transition:background .2s;position:relative;padding-top:5px;
}
.bnav-item:active{background:rgba(212,175,55,.07)}
.bnav-icon{font-size:1.3em;color:rgba(255,255,255,.38);transition:color .25s,transform .25s}
.bnav-label{font-size:.63em;color:rgba(255,255,255,.3);font-family:'Amiri';transition:color .25s}
.bnav-item.active .bnav-icon{color:var(--accent);transform:scale(1.12)}
.bnav-item.active .bnav-label{color:var(--accent)}
.bnav-item.active::after{
  content:'';position:absolute;top:0;left:22%;right:22%;
  height:2.5px;background:var(--accent);border-radius:0 0 4px 4px;
}

/* ===================== PAGE SYSTEM ===================== */
/* All pages hidden by default except home */
.app-page{
  display:none;
  position:fixed;inset:0 0 58px 0;
  overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;
  background:var(--bg);
  z-index:100;
}
.app-page.active{display:block}
/* home screen special - flex column */
#home-screen{
  display:flex;flex-direction:column;
  position:fixed;inset:0 0 58px 0;
  overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;
  z-index:100;
}
/* viewer must be above everything */
#viewer{z-index:9000!important}

/* ===================== ADHAN BAR ===================== */
#adhan-bar{
  position:fixed;bottom:58px;left:0;right:0;
  background:linear-gradient(135deg,#041a0e,#0b2b1d);
  border-top:2px solid var(--accent);
  padding:10px 16px;z-index:8400;
  display:none;align-items:center;gap:12px;
  box-shadow:0 -4px 20px rgba(0,0,0,.4);
}
#adhan-bar.show{display:flex;animation:slideUpBar .35s ease}
@keyframes slideUpBar{from{transform:translateY(100%)}to{transform:translateY(0)}}
#adhan-bar-info{flex:1;color:var(--accent);font-family:'Reem Kufi';font-size:1em;line-height:1.3}
#adhan-bar-sub{color:rgba(255,255,255,.5);font-size:.75em;margin-top:2px}
#adhan-stop{
  background:rgba(212,175,55,.15);border:1.5px solid var(--accent);
  color:var(--accent);border-radius:10px;padding:7px 14px;
  font-family:'Amiri';cursor:pointer;white-space:nowrap;
}

/* ===================== COMPASS ===================== */
#compass-wrap{
  display:flex;flex-direction:column;align-items:center;
  padding:16px 16px 100px;min-height:100%;
}
.compass-header-page{
  text-align:center;padding:calc(var(--safe-top)+14px) 16px 10px;
  background:linear-gradient(160deg,#041a0e,#0b2b1d);
  border-bottom:2px solid var(--accent);
  flex-shrink:0;
}
.compass-header-page h1{font-family:'Reem Kufi';font-size:1.5em;color:var(--accent)}
.compass-header-page p{color:rgba(255,255,255,.45);font-size:.8em;margin-top:3px}

#compass-outer{
  width:clamp(240px,72vw,300px);height:clamp(240px,72vw,300px);
  position:relative;margin:20px auto 0;
}
#compass-canvas{width:100%;height:100%;display:block;border-radius:50%}

#compass-info-card{
  background:var(--card);border:1.5px solid rgba(212,175,55,.2);
  border-radius:18px;padding:16px 22px;text-align:center;
  width:calc(100% - 24px);max-width:320px;margin-top:14px;
}
#compass-degree{
  font-size:clamp(2.2em,10vw,3.2em);color:var(--accent);
  font-weight:bold;font-family:monospace;line-height:1;
}
#compass-city-label{color:var(--gray);font-size:.8em;margin-bottom:6px}
#compass-direction{color:var(--text);font-size:1em;margin-top:4px;font-family:'Reem Kufi'}
#compass-accuracy-badge{
  display:inline-block;font-size:.75em;padding:4px 12px;
  border-radius:8px;background:rgba(45,158,107,.12);
  color:var(--green);margin-top:8px;
}
.compass-tip{
  color:rgba(255,255,255,.45);font-size:.78em;text-align:center;
  margin-top:14px;padding:0 20px;line-height:1.8;
}

/* ===================== PRAYERS PAGE ===================== */
.prayers-header{
  text-align:center;padding:calc(var(--safe-top)+14px) 16px 14px;
  background:linear-gradient(160deg,#041a0e,#0b2b1d);
  border-bottom:2px solid var(--accent);flex-shrink:0;
}
.prayers-header h1{font-family:'Reem Kufi';font-size:1.5em;color:var(--accent)}

/* ===================== OFFLINE SEARCH ===================== */
#offline-search-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.65);
  z-index:9600;display:none;align-items:flex-end;
  backdrop-filter:blur(4px);
}
#offline-search-overlay.open{display:flex}
#offline-search-sheet{
  background:var(--bg);border-radius:22px 22px 0 0;
  width:100%;max-height:85vh;display:flex;flex-direction:column;
  padding-bottom:var(--safe-bot);
  animation:slideUpBar .3s ease;
}
.off-search-handle{
  width:40px;height:4px;background:rgba(136,136,136,.4);
  border-radius:2px;margin:10px auto 6px;cursor:pointer;
}
.off-search-top{padding:0 14px 10px;border-bottom:1.5px solid rgba(212,175,55,.12)}
.off-search-inp{
  width:100%;padding:11px 16px;border-radius:20px;
  border:1.5px solid var(--accent);background:var(--primary);
  color:var(--accent);font-family:'Noto Naskh Arabic';font-size:1em;
  outline:none;direction:rtl;
}
.off-search-inp::placeholder{color:rgba(212,175,55,.4)}
.off-results-area{flex:1;overflow-y:auto;padding:8px 12px 20px}
.off-result-item{
  background:var(--card);border-radius:12px;
  padding:12px 14px;margin-bottom:8px;
  border-right:4px solid var(--green);cursor:pointer;
}
.off-result-item:active{opacity:.8}
.off-result-meta{color:var(--accent);font-size:.78em;font-weight:bold;margin-bottom:5px}
.off-result-text{font-family:'Noto Naskh Arabic';font-size:1em;line-height:1.9}

/* ===================== OFFLINE SEARCH ENHANCED ===================== */
.off-search-stats{
  display:flex;gap:6px;padding:8px 14px 4px;flex-wrap:wrap;align-items:center;
}
.off-stat-badge{
  background:rgba(212,175,55,.1);border:1px solid rgba(212,175,55,.25);
  border-radius:20px;padding:3px 10px;font-size:.73em;color:var(--accent);
}
.off-search-voice{
  width:38px;height:38px;border-radius:50%;background:rgba(212,175,55,.1);
  border:1.5px solid rgba(212,175,55,.4);color:var(--accent);font-size:1.2em;
  display:flex;align-items:center;justify-content:center;cursor:pointer;
  flex-shrink:0;transition:background .2s;margin-right:6px;
}
.off-search-voice:active,.off-search-voice.listening{
  background:rgba(192,57,43,.25);border-color:#e74c3c;color:#e74c3c;
  animation:pulseBorder 1s ease-in-out infinite;
}
@keyframes pulseBorder{0%,100%{box-shadow:0 0 0 0 rgba(231,76,60,.4)}50%{box-shadow:0 0 0 8px rgba(231,76,60,0)}}
.off-search-row{display:flex;align-items:center;gap:0}

/* ===================== HIFZ (Memorization) MODE ===================== */
#hifz-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.7);
  z-index:9650;display:none;align-items:flex-end;
  backdrop-filter:blur(6px);
}
#hifz-overlay.open{display:flex}
#hifz-sheet{
  background:var(--bg);border-radius:22px 22px 0 0;
  width:100%;max-height:90vh;display:flex;flex-direction:column;
  padding-bottom:var(--safe-bot);
  animation:slideUpBar .3s ease;
}
.hifz-handle{
  width:40px;height:4px;background:rgba(136,136,136,.4);
  border-radius:2px;margin:10px auto 0;cursor:pointer;
}
.hifz-top{
  padding:12px 16px;border-bottom:1.5px solid rgba(212,175,55,.15);
}
.hifz-title{
  font-family:'Reem Kufi';font-size:1.2em;color:var(--accent);
  text-align:center;margin-bottom:8px;
}
.hifz-surah-info{
  text-align:center;color:var(--gray);font-size:.82em;margin-bottom:10px;
}
/* ÿ™ŸÇÿØŸÖ ÿßŸÑÿ≠ŸÅÿ∏ */
.hifz-progress-bar{
  height:6px;background:rgba(212,175,55,.15);border-radius:3px;
  overflow:hidden;margin-bottom:10px;
}
.hifz-progress-fill{
  height:100%;background:linear-gradient(90deg,var(--green),var(--accent));
  border-radius:3px;transition:width .5s ease;
}
/* ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¢Ÿäÿ© */
#hifz-body{flex:1;overflow-y:auto;padding:12px 14px 10px;display:flex;flex-direction:column;gap:10px}
.hifz-ayah-card{
  background:var(--card);border-radius:14px;padding:14px 16px;
  border-right:5px solid rgba(212,175,55,.3);
  transition:border-color .4s,background .4s;position:relative;
}
.hifz-ayah-card.hifz-correct{
  border-right-color:var(--green);
  background:rgba(45,158,107,.08);
}
.hifz-ayah-card.hifz-wrong{
  border-right-color:var(--red);
  background:rgba(192,57,43,.08);
}
.hifz-ayah-card.hifz-active{
  border-right-color:var(--accent);
  box-shadow:0 0 0 2px rgba(212,175,55,.25);
}
.hifz-ayah-num{
  font-size:.75em;color:var(--accent);font-weight:bold;margin-bottom:6px;
  display:flex;justify-content:space-between;align-items:center;
}
.hifz-ayah-text{
  font-family:'Noto Naskh Arabic';font-size:1.25em;line-height:2.1;
  direction:rtl;color:var(--text);
}
.hifz-ayah-text.hidden{
  filter:blur(8px);user-select:none;transition:filter .4s;
}
.hifz-ayah-text.revealed{filter:none;}
.hifz-result-badge{
  position:absolute;top:10px;left:12px;
  font-size:.85em;padding:2px 10px;border-radius:20px;
  font-weight:bold;
}
.hifz-result-badge.correct{background:rgba(45,158,107,.2);color:var(--green);}
.hifz-result-badge.wrong{background:rgba(192,57,43,.2);color:var(--red);}
/* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ≥ŸÅŸÑŸä */
.hifz-ctrl-bar{
  padding:12px 14px;border-top:1.5px solid rgba(212,175,55,.12);
  display:flex;flex-direction:column;gap:10px;
}
.hifz-mode-row{display:flex;gap:8px;}
.hifz-mode-btn{
  flex:1;padding:9px 6px;border-radius:12px;
  border:1.5px solid rgba(212,175,55,.3);background:transparent;
  color:var(--accent);font-family:'Amiri';font-size:.85em;cursor:pointer;
  text-align:center;transition:background .2s,border-color .2s;
}
.hifz-mode-btn.on{background:var(--accent);color:var(--primary);border-color:var(--accent);font-weight:bold;}
.hifz-mode-btn:active{opacity:.8}
#hifz-mic-btn{
  width:100%;padding:13px;border-radius:14px;
  border:2px solid var(--accent);background:rgba(212,175,55,.08);
  color:var(--accent);font-family:'Amiri';font-size:1.05em;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;
  transition:background .2s,transform .15s;
}
#hifz-mic-btn:active{transform:scale(.97)}
#hifz-mic-btn.recording{
  background:rgba(231,76,60,.15);border-color:#e74c3c;color:#e74c3c;
  animation:pulseBorder 1s ease-in-out infinite;
}
#hifz-status{
  text-align:center;font-size:.88em;color:var(--gray);min-height:20px;line-height:1.4;
}
.hifz-score-row{
  display:flex;justify-content:center;gap:18px;padding:4px 0;
}
.hifz-score-item{text-align:center;}
.hifz-score-num{font-size:1.6em;font-weight:bold;line-height:1;}
.hifz-score-num.green{color:var(--green);}
.hifz-score-num.red{color:var(--red);}
.hifz-score-lbl{font-size:.7em;color:var(--gray);margin-top:2px;}
.hifz-nav-row{display:flex;gap:8px;}
.hifz-nav-btn{
  flex:1;padding:10px;border-radius:12px;
  border:1.5px solid rgba(212,175,55,.3);background:transparent;
  color:var(--accent);font-family:'Amiri';font-size:.9em;cursor:pointer;
}
.hifz-nav-btn:active{background:rgba(212,175,55,.1)}

/* ===================== HIFZ WORD-BY-WORD (ŸÖÿµÿ≠ŸÅ ÿ¥ŸÉŸÑ) ===================== */
.hifz-mushaf-wrap{
  font-family:'Noto Naskh Arabic',serif;
  font-size:clamp(1.3em,5.5vw,1.55em);
  line-height:2.9;text-align:justify;direction:rtl;word-spacing:4px;
  padding:14px 18px;background:var(--card);border-radius:14px;margin:10px 0;
}
.hifz-word{display:inline;padding:0 1px;}
.word-visible{color:var(--text);}
.hifz-word-blank{
  display:inline-block;color:transparent;
  background:rgba(212,175,55,.12);
  border-bottom:2.5px solid var(--accent);
  border-radius:3px;min-width:2.2em;text-align:center;
  vertical-align:baseline;letter-spacing:2px;cursor:default;
  transition:background .25s,color .25s;
}
.hifz-word-blank.word-blank-correct{
  color:var(--text);background:rgba(45,158,107,.15);
  border-bottom-color:var(--green);animation:blankReveal .4s ease;
}
@keyframes blankReveal{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.hifz-word-blank.word-blank-wrong{
  background:rgba(192,57,43,.12);border-bottom-color:var(--red);
  animation:blankShake .35s ease;
}
@keyframes blankShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.hifz-mushaf-anum{
  display:inline-flex;align-items:center;justify-content:center;
  width:1.5em;height:1.5em;border-radius:50%;
  background:rgba(212,175,55,.15);border:1px solid rgba(212,175,55,.4);
  color:var(--accent);font-size:.55em;font-family:'Amiri';font-weight:bold;
  vertical-align:middle;margin:0 4px;
}
.hifz-span-row{display:flex;gap:6px;align-items:center;}
.hifz-span-label{font-size:.78em;color:var(--gray);flex-shrink:0;}
.hifz-span-btn{
  flex:1;padding:7px 4px;border-radius:10px;
  border:1.5px solid rgba(212,175,55,.3);background:transparent;
  color:var(--accent);font-family:'Amiri';font-size:.85em;cursor:pointer;text-align:center;
}
.hifz-span-btn.on{background:var(--accent);color:var(--primary);border-color:var(--accent);font-weight:bold;}
.hifz-span-btn:active{opacity:.8}
.hifz-word-info{
  text-align:center;font-family:'Noto Naskh Arabic';font-size:1.25em;
  color:var(--accent);min-height:2.2em;padding:8px 12px;
  background:rgba(212,175,55,.06);border-radius:10px;direction:rtl;line-height:1.8;
}
.hifz-word-nav{display:flex;gap:8px;}
.hifz-word-nav-btn{
  flex:1;padding:11px 6px;border-radius:12px;
  border:1.5px solid rgba(212,175,55,.35);background:transparent;
  color:var(--accent);font-family:'Amiri';font-size:.9em;cursor:pointer;text-align:center;
}
.hifz-word-nav-btn:active{background:rgba(212,175,55,.12)}
.hifz-word-nav-btn.accent{background:var(--accent);color:var(--primary);border-color:var(--accent);font-weight:bold;}

/* ===================== WORD BOOKMARK ===================== */
.wbm-dot{
  display:inline-block;width:6px;height:6px;border-radius:50%;
  background:transparent;margin:0 1px;vertical-align:super;
  cursor:pointer;transition:background .15s;border:1px solid rgba(212,175,55,.3);
}
.wbm-dot.marked{background:var(--red);border-color:var(--red)}
.wbm-item{
  background:var(--card);border-radius:12px;padding:13px 14px;
  margin:0 12px 9px;border-right:4px solid var(--red);cursor:pointer;
}
.wbm-item:active{opacity:.8}
.wbm-word{color:var(--accent);font-family:'Noto Naskh Arabic';font-size:1.2em}
.wbm-ref{color:var(--gray);font-size:.78em;margin-top:3px}

/* ===================== MUSHAF MODE ===================== */
/* ÿπÿ±ÿ∂ ÿßŸÑŸÖÿµÿ≠ŸÅ - ŸÜÿµ ŸÖÿ™ÿµŸÑ ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿ®ÿ∑ÿßŸÇÿßÿ™ */
.mushaf-wrap{padding:0 16px 24px}
.mushaf-header{text-align:center;padding:16px 0 12px;border-bottom:1px solid rgba(212,175,55,.18);margin-bottom:8px}
.mushaf-sname{font-family:'Reem Kufi';font-size:1.5em;color:var(--accent)}
.mushaf-sinfo{font-size:.8em;color:var(--gray);margin-top:3px}
.mushaf-bismillah{text-align:center;font-family:'Noto Naskh Arabic';font-size:clamp(1.2em,5vw,1.45em);color:var(--accent);padding:14px 0 10px;line-height:2.2}
/* ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿ™ÿµŸÑ */
.mushaf-body{font-family:'Noto Naskh Arabic',serif;font-size:clamp(1.25em,5.5vw,1.5em);line-height:2.8;text-align:justify;color:var(--text);direction:rtl;word-spacing:3px}
/* ÿ±ŸÇŸÖ ÿßŸÑÿ¢Ÿäÿ© */
.m-anum{
  display:inline-flex;align-items:center;justify-content:center;
  width:1.6em;height:1.6em;border-radius:50%;
  background:rgba(212,175,55,.12);border:1px solid rgba(212,175,55,.3);
  color:var(--accent);font-size:.65em;font-family:'Amiri';font-weight:bold;
  cursor:pointer;vertical-align:middle;margin:0 3px;flex-shrink:0;
  transition:background .15s;
}
.m-anum:active,.m-anum.selected{background:var(--accent);color:var(--primary)}
.m-anum.has-bm{background:rgba(192,57,43,.18);border-color:rgba(192,57,43,.5);color:var(--red)}
.m-anum.selected{background:var(--accent);color:var(--primary);transform:scale(1.2);transition:transform .3s}
#ayah-ctx-menu{
  position:fixed;bottom:calc(var(--safe-bot) + 62px);left:10px;right:10px;
  background:var(--secondary);border:1.5px solid var(--accent);border-radius:18px;
  padding:14px 16px;z-index:9600;
  display:none;flex-direction:column;gap:10px;
  box-shadow:0 -6px 30px rgba(0,0,0,.5);
  animation:ctxSlideUp .25s ease;
}
#ayah-ctx-menu.show{display:flex}
@keyframes ctxSlideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
#ctx-ayah-preview{font-family:'Noto Naskh Arabic';font-size:1em;color:rgba(255,255,255,.7);line-height:1.8;border-bottom:1px solid rgba(212,175,55,.15);padding-bottom:10px;direction:rtl}
#ctx-ayah-ref{font-size:.78em;color:var(--accent);margin-bottom:2px;font-family:'Amiri'}
.ctx-btns{display:flex;gap:8px;flex-wrap:wrap}
.ctx-btn{flex:1;padding:9px 8px;border-radius:11px;border:1.5px solid rgba(212,175,55,.35);background:transparent;color:var(--accent);font-family:'Amiri';font-size:.88em;cursor:pointer;text-align:center;min-width:60px;white-space:nowrap}
.ctx-btn:active{background:rgba(212,175,55,.15)}
.ctx-btn.red{border-color:rgba(192,57,43,.5);color:#e74c3c}
.ctx-btn.red:active{background:rgba(192,57,43,.1)}
.ctx-btn.green{border-color:rgba(45,158,107,.5);color:var(--green)}
.ctx-btn.green:active{background:rgba(45,158,107,.1)}
#ctx-overlay{position:fixed;inset:0;z-index:9550;display:none}
#ctx-overlay.show{display:block}
</style>
</head>
<body>

<div id="splash">
  <div class="splash-logo">ŸÖÿµÿ≠ŸÅ ÿßŸÑŸÜŸàÿ±</div>
  <div class="splash-ayah">Ô¥ø ÿ•ŸêŸÜŸéŸë ŸáŸéŸÄŸ∞ÿ∞Ÿéÿß ÿßŸÑŸíŸÇŸèÿ±Ÿíÿ¢ŸÜŸé ŸäŸéŸáŸíÿØŸêŸä ŸÑŸêŸÑŸéŸëÿ™ŸêŸä ŸáŸêŸäŸé ÿ£ŸéŸÇŸíŸàŸéŸÖŸè Ô¥æ</div>
  <div class="splash-bar"><div class="splash-fill"></div></div>
</div>

<div id="toast"></div>
<div id="side-overlay" onclick="closeSide()"></div>

<!-- ŸÇÿßÿ¶ŸÖÿ© ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ¢Ÿäÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© -->
<div id="ctx-overlay" onclick="closeAyahCtx()"></div>
<div id="ayah-ctx-menu">
  <div id="ctx-ayah-ref"></div>
  <div id="ctx-ayah-preview"></div>
  <div class="ctx-btns">
    <button class="ctx-btn green" onclick="ctxBm()">üîñ ÿ•ÿ¥ÿßÿ±ÿ©</button>
    <button class="ctx-btn" onclick="ctxSaveRead()">üìå ŸÖŸàÿ∂ÿπŸä</button>
    <button class="ctx-btn" onclick="ctxPlay()">‚ñ∂ ÿ™ÿ¥ÿ∫ŸäŸÑ</button>
    <button class="ctx-btn" onclick="ctxTafsir()">üìñ ÿ™ŸÅÿ≥Ÿäÿ±</button>
    <button class="ctx-btn" onclick="ctxHifz()">üéôÔ∏è ÿ™ÿ≠ŸÅŸäÿ∏</button>
    <button class="ctx-btn" onclick="ctxCopy()">ŸÜÿ≥ÿÆ</button>
    <button class="ctx-btn" onclick="ctxShare()">ŸÖÿ¥ÿßÿ±ŸÉÿ©</button>
    <button class="ctx-btn red" onclick="closeAyahCtx()">‚úï ÿ•ÿ∫ŸÑÿßŸÇ</button>
  </div>
</div>

<!-- DUA MODAL -->
<div id="dua-modal" onclick="if(event.target===this)closeDua()">
  <div id="dua-sheet">
    <div class="dua-close" onclick="closeDua()"></div>
    <h3 id="dua-title"></h3>
    <p id="dua-text"></p>
    <div class="dua-source" id="dua-source"></div>
    <div style="margin-top:14px;display:flex;gap:8px">
      <button class="ab" style="flex:1;justify-content:center" onclick="cpDua()">ŸÜÿ≥ÿÆ ÿßŸÑÿØÿπÿßÿ°</button>
      <button class="ab" onclick="closeDua()" style="flex:1;justify-content:center">ÿ•ÿ∫ŸÑÿßŸÇ</button>
    </div>
  </div>
</div>

<!-- SIDE MENU -->
<div id="side-menu">
  <div class="side-header">
    <h2>ŸÖÿµÿ≠ŸÅ ÿßŸÑŸÜŸàÿ± ‚ú®</h2>
    <p>ÿßŸÑÿ•ÿµÿØÿßÿ± Ÿ¢Ÿ†Ÿ¢Ÿ¶</p>
  </div>
  <div class="side-section">ÿßŸÑŸÇÿ±ÿ¢ŸÜ ŸàÿßŸÑŸÇÿ±ÿßÿ°ÿ©</div>
  <div class="side-item" onclick="closeSide();openMod('quran')"><span class="side-icon">üìñ</span>ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ</div>
  <div class="side-item" onclick="closeSide();openMod('search')"><span class="side-icon">üîç</span>ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÇÿ±ÿ¢ŸÜ</div>
  <div class="side-item" onclick="closeSide();openMod('tafsir')"><span class="side-icon">üìö</span>ÿßŸÑÿ™ŸÅÿßÿ≥Ÿäÿ± ÿßŸÑŸÉÿßŸÖŸÑÿ©</div>
  <div class="side-item" onclick="closeSide();openHifz()"><span class="side-icon">üéôÔ∏è</span>ÿ™ÿ≠ŸÅŸäÿ∏ ÿßŸÑŸÇÿ±ÿ¢ŸÜ</div>
  <div class="side-item" onclick="closeSide();openMod('bookmarks')"><span class="side-icon">üîñ</span>ÿßŸÑÿ•ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ±ÿ¨ÿπŸäÿ©</div>
  <div class="side-item" onclick="closeSide();openMod('khatma')"><span class="side-icon">üåü</span>ÿßŸÑÿÆÿ™ŸÖÿ© ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ©</div>
  <div class="side-section">ÿßŸÑÿ∞ŸÉÿ± ŸàÿßŸÑÿπÿ®ÿßÿØÿ©</div>
  <div class="side-item" onclick="closeSide();openMod('azkar')"><span class="side-icon">üìø</span>ÿßŸÑÿ£ÿ∞ŸÉÿßÿ±</div>
  <div class="side-item" onclick="closeSide();openMod('tasbih')"><span class="side-icon">üî¢</span>ÿßŸÑÿ≥ÿ®ÿ≠ÿ©</div>
  <div class="side-item" onclick="closeSide();openMod('duas')"><span class="side-icon">ü§≤</span>ÿßŸÑÿ£ÿØÿπŸäÿ© ÿßŸÑŸÖÿ£ÿ´Ÿàÿ±ÿ©</div>
  <div class="side-item" onclick="closeSide();openMod('names')"><span class="side-icon">‚ú®</span>ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÑŸá ÿßŸÑÿ≠ÿ≥ŸÜŸâ</div>
  <div class="side-section">ÿßŸÑÿµŸÑÿßÿ©</div>
  <div class="side-item" onclick="closeSide();openMod('prayers')"><span class="side-icon">‚è∞</span>ŸÖŸàÿßŸÇŸäÿ™ ÿßŸÑÿµŸÑÿßÿ©</div>
  <div class="side-item" onclick="closeSide();openMod('reciters')"><span class="side-icon">üéôÔ∏è</span>ÿßŸÑÿ™ŸÑÿßŸàÿßÿ™</div>
  <div class="side-section">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</div>
  <div class="side-toggle"><span>üåó ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä</span><div id="tg-dark" class="tog" onclick="toggleDark()"></div></div>
  <div class="side-toggle"><span>üîî ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿµŸÑÿßÿ©</span><div id="tg-notif" class="tog" onclick="toggleNotifSetting()"></div></div>
  <div class="side-toggle"><span>üîä ÿ£ÿµŸàÿßÿ™ ÿßŸÑŸÑŸÖÿ≥</span><div id="tg-click" class="tog" onclick="toggleClickSnd()"></div></div>
  <div class="side-section">ÿßŸÑŸÖÿØŸäŸÜÿ© ŸÑŸÑÿµŸÑÿßÿ©</div>
  <div class="side-item" onclick="changeCity()" style="justify-content:space-between">
    <span><span class="side-icon">üìç</span><span id="city-display">ÿßŸÑŸÇÿßŸáÿ±ÿ©</span></span>
    <span style="color:var(--accent);font-size:.8em">ÿ™ÿ∫ŸäŸäÿ±</span>
  </div>
</div>

<!-- AUTO SCROLL WIDGET -->
<div id="scroll-widget">
  <div id="spctl">
    <span id="spctl-fast">ÿ≥ÿ±Ÿäÿπ</span>
    <input type="range" min="10" max="100" value="50" oninput="updSpd(this.value)">
    <span id="spctl-slow">ÿ®ÿ∑Ÿäÿ°</span>
  </div>
  <div id="asbtn" onclick="togScroll()">
    <span id="asbtn-icon">‚ñº‚ñº</span>
    <span id="asbtn-lbl">ÿ™ŸÖÿ±Ÿäÿ±</span>
  </div>
</div>
<button id="scroll-top-btn" onclick="scrollToTop()">‚Üë</button>

<!-- HOME -->
<div id="home-screen">

  <!-- HEADER -->
  <header>
    <div id="menu-btn" onclick="openSide()">‚ò∞</div>
    <div id="search-home-btn" onclick="ck();openOffSearch()">üîç</div>
    <h1>ŸÖÿµÿ≠ŸÅ ÿßŸÑŸÜŸàÿ±</h1>
    <p>ÿ™ÿ∑ÿ®ŸäŸÇŸÉ ÿßŸÑÿ•ŸäŸÖÿßŸÜŸä ÿßŸÑŸÖŸÅÿ∂ŸÑ</p>
  </header>

  <!-- HIJRI BAR -->
  <div id="hijri-bar">
    <span class="hj" id="hijri-date">‚è≥</span>
    <span id="gregorian-date"></span>
  </div>

  <!-- PRAYER SCENE CARD -->
  <div id="prayer-scene" onclick="ck();showPage('prayers-page');renderPrayersPage()">
    <canvas id="sky-canvas"></canvas>
    <div id="prayer-info-row">
      <div id="pi-left">
        <span id="pi-label">ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©</span>
        <span id="pi-name">ÿ™ÿ≠ŸÖŸäŸÑ...</span>
      </div>
      <span id="pi-timer">--:--:--</span>
    </div>
  </div>

  <!-- NOTIF BANNER -->
  <div id="notif-banner">
    <p>üîî ŸÅÿπŸëŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑÿ™ŸÑŸÇŸëŸä ÿ™ŸÜÿ®ŸäŸáÿßÿ™ ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿµŸÑÿßÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</p>
    <div class="nb-btns">
      <button class="nb-allow" onclick="reqNotif()">ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</button>
      <button class="nb-later" onclick="dismissBanner()">ŸÑÿßÿ≠ŸÇÿßŸã</button>
    </div>
  </div>

  <!-- LAST READ -->
  <div id="last-read-bar" onclick="goLastRead()">
    <div>
      <div class="lr-label">ÿ™ÿßÿ®ÿπ ŸÖŸÜ ÿ≠Ÿäÿ´ ÿ™ŸàŸÇŸÅÿ™</div>
      <div class="lr-value" id="lr-text">...</div>
    </div>
    <span class="lr-arrow">‚Üê</span>
  </div>

  <!-- GRID -->
  <div class="home-grid-wrap">
    <!-- ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ - ÿ®ÿ∑ÿßŸÇÿ© ÿ®ÿßÿ±ÿ≤ÿ© -->
    <div class="card-quran" onclick="ck();openMod('quran')">
      <span class="cq-icon">üìñ</span>
      <div class="cq-text">
        <div class="cq-title">ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ</div>
        <div class="cq-sub">ÿßŸÇÿ±ÿ£ ‚Ä¢ ÿßÿ≥ÿ™ŸÖÿπ ‚Ä¢ ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÇÿ±ÿ¢ŸÜ</div>
      </div>
      <span class="cq-arrow">‚Üê</span>
    </div>
    <!-- ÿ¥ÿ®ŸÉÿ© ÿ®ŸÇŸäÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ -->
    <div class="grid">
      <div class="card" onclick="ck();openMod('azkar')"><span class="card-icon">üìø</span><b>ÿßŸÑÿ£ÿ∞ŸÉÿßÿ±</b></div>
      <div class="card" onclick="ck();showPage('prayers-page');renderPrayersPage()"><span class="card-icon">‚è∞</span><b>ÿßŸÑŸÖŸàÿßŸÇŸäÿ™</b></div>
      <div class="card" onclick="ck();openMod('tasbih')"><span class="card-icon">üî¢</span><b>ÿßŸÑÿ≥ÿ®ÿ≠ÿ©</b></div>
      <div class="card" onclick="ck();openMod('reciters')"><span class="card-icon">üéôÔ∏è</span><b>ÿßŸÑÿ™ŸÑÿßŸàÿßÿ™</b></div>
      <div class="card" onclick="ck();openMod('names')"><span class="card-icon">‚ú®</span><b>ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÑŸá</b></div>
      <div class="card" onclick="ck();openMod('duas')"><span class="card-icon">ü§≤</span><b>ÿßŸÑÿ£ÿØÿπŸäÿ©</b></div>
      <div class="card" onclick="ck();showPage('compass-page');initCompass()"><span class="card-icon">üß≠</span><b>ÿßŸÑŸÇÿ®ŸÑÿ©</b></div>
      <div class="card" onclick="ck();openMod('bookmarks')"><span class="card-icon">üîñ</span><b>ÿßŸÑÿ•ÿ¥ÿßÿ±ÿßÿ™</b></div>
      <div class="card" onclick="ck();openMod('tafsir')"><span class="card-icon">üìö</span><b>ÿßŸÑÿ™ŸÅÿßÿ≥Ÿäÿ±</b></div>
    </div>
  </div>

  <!-- STATS -->
  <div id="stats-bar">
    <div class="stat-chip"><span class="sc-num" id="stat-bm">Ÿ†</span><span class="sc-lbl">ÿ•ÿ¥ÿßÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©</span></div>
    <div class="stat-chip"><span class="sc-num" id="stat-tas">Ÿ†</span><span class="sc-lbl">ÿ™ÿ≥ÿ®Ÿäÿ≠ÿ©</span></div>
    <div class="stat-chip"><span class="sc-num" id="stat-days">Ÿ†</span><span class="sc-lbl">ŸäŸàŸÖ ŸÖÿπŸÜÿß</span></div>
  </div>

</div>

<!-- ================= PRAYERS PAGE ================= -->
<div id="prayers-page" class="app-page">
  <div class="prayers-header">
    <button onclick="showPage('home-screen')" style="position:absolute;top:calc(var(--safe-top)+10px);right:14px;background:rgba(212,175,55,.1);border:1.5px solid rgba(212,175,55,.4);color:var(--accent);border-radius:50%;width:40px;height:40px;font-size:1em;cursor:pointer">‚Üê</button>
    <h1>üïå ŸÖŸàÿßŸÇŸäÿ™ ÿßŸÑÿµŸÑÿßÿ©</h1>
    <p id="prayers-city-label" style="color:rgba(255,255,255,.5);font-size:.8em;margin-top:3px">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>
  </div>
  <div id="prayers-page-body" style="padding-bottom:100px"></div>
</div>

<!-- ================= COMPASS PAGE ================= -->
<div id="compass-page" class="app-page">
  <div class="compass-header-page">
    <button onclick="showPage('home-screen');stopCompass()" style="position:absolute;top:calc(var(--safe-top)+10px);right:14px;background:rgba(212,175,55,.1);border:1.5px solid rgba(212,175,55,.4);color:var(--accent);border-radius:50%;width:40px;height:40px;font-size:1em;cursor:pointer">‚Üê</button>
    <h1>üß≠ ÿßÿ™ÿ¨ÿßŸá ÿßŸÑŸÇÿ®ŸÑÿ©</h1>
    <p>ÿ®ŸàÿµŸÑÿ© ÿØŸÇŸäŸÇÿ© ÿ™ÿπÿ™ŸÖÿØ ÿπŸÑŸâ GPS Ÿàÿ≠ÿ≥ÿßÿ≥ÿßÿ™ ÿßŸÑÿ¨Ÿáÿßÿ≤</p>
  </div>
  <div id="compass-wrap">
    <div id="compass-outer">
      <canvas id="compass-canvas"></canvas>
    </div>
    <div id="compass-info-card">
      <div id="compass-city-label">Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ...</div>
      <div id="compass-degree">---¬∞</div>
      <div id="compass-direction">ÿßÿ™ÿ¨ÿßŸá ÿßŸÑŸÇÿ®ŸÑÿ©</div>
      <div id="compass-accuracy-badge">‚è≥ ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ•ÿ∞ŸÜ ÿßŸÑŸÖŸàŸÇÿπ</div>
    </div>
    <p class="compass-tip">üîÑ ŸÑŸÖÿπÿßŸäÿ±ÿ© ÿßŸÑÿ®ŸàÿµŸÑÿ©: ÿ≠ÿ±ŸëŸÉ Ÿáÿßÿ™ŸÅŸÉ ÿ®ÿ®ÿ∑ÿ° ÿπŸÑŸâ ÿ¥ŸÉŸÑ ÿ±ŸÇŸÖ Ÿ®<br>üìç ÿßŸÑŸÖÿØŸäŸÜÿ© ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ÿ© ŸáŸä ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä ÿßŸÑŸÅÿπŸÑŸä<br>üïã ÿßŸÑÿ•ÿ®ÿ±ÿ© ÿßŸÑÿ∞Ÿáÿ®Ÿäÿ© ÿ™ÿ¥Ÿäÿ± ÿØÿßÿ¶ŸÖÿßŸã ŸÜÿ≠Ÿà ŸÖŸÉÿ© ÿßŸÑŸÖŸÉÿ±ŸÖÿ©</p>
  </div>
</div>

<!-- ================= ADHAN BAR ================= -->
<div id="adhan-bar">
  <div>
    <div id="adhan-bar-info">üïå ÿ≠ÿßŸÜ ŸàŸÇÿ™ ÿßŸÑÿµŸÑÿßÿ©</div>
    <div id="adhan-bar-sub">ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ± ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±</div>
  </div>
  <button id="adhan-stop" onclick="stopAdhan()">ÿ•ŸäŸÇÿßŸÅ</button>
</div>

<!-- ================= OFFLINE SEARCH ================= -->
<div id="offline-search-overlay" onclick="if(event.target===this)closeOffSearch()">
  <div id="offline-search-sheet">
    <div class="off-search-handle" onclick="closeOffSearch()"></div>
    <div class="off-search-top">
      <div class="off-search-row">
        <div style="flex:1;position:relative">
          <input id="off-search-inp" class="off-search-inp" type="search" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ..." autocomplete="off" oninput="offSrchDebounce(this.value)" style="padding-left:46px">
          <button class="off-search-voice" id="off-voice-btn" onclick="offVoiceSearch()" title="ÿ®ÿ≠ÿ´ ÿµŸàÿ™Ÿä" style="position:absolute;left:5px;top:50%;transform:translateY(-50%);width:34px;height:34px;font-size:1em">üé§</button>
        </div>
      </div>
      <div class="off-search-stats" id="off-search-stats" style="display:none">
        <span class="off-stat-badge" id="off-index-size"></span>
        <span class="off-stat-badge">üîÑ ÿ®ÿ≠ÿ´ ŸÅŸàÿ±Ÿä</span>
      </div>
      <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
        <button class="fchip on" onclick="offSrchFilter(this,'all')">üåê ŸÉŸÑ ÿßŸÑŸÇÿ±ÿ¢ŸÜ</button>
        <button class="fchip" onclick="offSrchFilter(this,'surah')">üìñ ÿßŸÑÿ≥Ÿàÿ±ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©</button>
        <button class="fchip" onclick="offSrchFilter(this,'juz')">üìö ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≠ÿßŸÑŸä</button>
        <button class="fchip" onclick="openHifzFromSearch()">üéôÔ∏è ÿ™ÿ≠ŸÅŸäÿ∏</button>
      </div>
    </div>
    <div id="off-search-results" class="off-results-area">
      <p style="text-align:center;padding:30px;color:var(--gray)">ÿßŸÉÿ™ÿ® ŸÑŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿ®ÿØŸàŸÜ ÿ•ŸÜÿ™ÿ±ŸÜÿ™</p>
    </div>
  </div>
</div>

<!-- ================= HIFZ (MEMORIZATION) OVERLAY ================= -->
<div id="hifz-overlay" onclick="if(event.target===this)closeHifz()">
  <div id="hifz-sheet">
    <div class="hifz-handle" onclick="closeHifz()"></div>
    <div class="hifz-top">
      <div class="hifz-title">üéôÔ∏è ÿ™ÿ≠ŸÅŸäÿ∏ ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ</div>
      <div class="hifz-surah-info" id="hifz-surah-info">ÿßÿÆÿ™ÿ± ÿ≥Ÿàÿ±ÿ© ŸÑÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ŸÅŸäÿ∏</div>
      <div class="hifz-progress-bar"><div class="hifz-progress-fill" id="hifz-progress" style="width:0%"></div></div>
      <div class="hifz-score-row">
        <div class="hifz-score-item"><div class="hifz-score-num green" id="hifz-correct-count">Ÿ†</div><div class="hifz-score-lbl">ÿµÿ≠Ÿäÿ≠ ‚úÖ</div></div>
        <div class="hifz-score-item"><div class="hifz-score-num" id="hifz-total-count" style="color:var(--accent)">Ÿ†</div><div class="hifz-score-lbl">ÿ•ÿ¨ŸÖÿßŸÑŸä</div></div>
        <div class="hifz-score-item"><div class="hifz-score-num red" id="hifz-wrong-count">Ÿ†</div><div class="hifz-score-lbl">ÿÆÿ∑ÿ£ ‚ùå</div></div>
      </div>
    </div>
    <div id="hifz-body">
      <p style="text-align:center;padding:30px;color:var(--gray)">ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑÿ¢Ÿäÿßÿ™ ŸáŸÜÿß ŸÑŸÑÿ™ÿ≥ŸÖŸäÿπ</p>
    </div>
    <div class="hifz-ctrl-bar">
      <div class="hifz-mode-row">
        <button class="hifz-mode-btn on" id="hm-show" onclick="hifzMode('show',this)">ÿπÿ±ÿ∂ ÿßŸÑŸÜÿµ</button>
        <button class="hifz-mode-btn" id="hm-hide" onclick="hifzMode('hide',this)">ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜÿµ</button>
        <button class="hifz-mode-btn" id="hm-word" onclick="hifzMode('word',this)">üî§ ŸÉŸÑŸÖÿ© ŸÉŸÑŸÖÿ©</button>
        <button class="hifz-mode-btn" id="hm-test" onclick="hifzMode('test',this)">ÿßÿÆÿ™ÿ®ÿßÿ± ŸÉÿßŸÖŸÑ</button>
      </div>
      <button id="hifz-mic-btn" onclick="hifzToggleMic()">
        <span id="hifz-mic-icon">üéôÔ∏è</span>
        <span id="hifz-mic-label">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿ≥ŸÖŸäÿπ</span>
      </button>
      <div id="hifz-status">ÿ≥Ÿäÿ™ŸÖ ŸÖŸÇÿßÿ±ŸÜÿ© ŸÖÿß ÿ™ŸÇŸàŸÑŸá ÿ®ŸÜÿµ ÿßŸÑÿ¢Ÿäÿ©</div>
      <div class="hifz-nav-row">
        <button class="hifz-nav-btn" onclick="hifzPrev()">‚Üê ÿ¢Ÿäÿ© ÿ≥ÿßÿ®ŸÇÿ©</button>
        <button class="hifz-nav-btn" onclick="hifzReveal()">üëÅÔ∏è ÿ•ÿ∏Ÿáÿßÿ±</button>
        <button class="hifz-nav-btn" onclick="hifzNext()">ÿ¢Ÿäÿ© ÿ™ÿßŸÑŸäÿ© ‚Üí</button>
      </div>
      <!-- ÿ£ÿ≤ÿ±ÿßÿ± Ÿàÿ∂ÿπ ŸÉŸÑŸÖÿ© ŸÉŸÑŸÖÿ© -->
      <div id="hifz-word-controls" style="display:none">
        <div class="hifz-span-row">
          <span class="hifz-span-label">ŸÜÿ∑ÿßŸÇ:</span>
          <button class="hifz-span-btn on" onclick="hifzSetSpan(1,this)">ŸÉŸÑŸÖÿ©</button>
          <button class="hifz-span-btn" onclick="hifzSetSpan(2,this)">Ÿ¢ ŸÉŸÑŸÖÿßÿ™</button>
          <button class="hifz-span-btn" onclick="hifzSetSpan(3,this)">Ÿ£ ŸÉŸÑŸÖÿßÿ™</button>
          <button class="hifz-span-btn" onclick="hifzSetSpan(4,this)">Ÿ§ ŸÉŸÑŸÖÿßÿ™</button>
        </div>
        <div class="hifz-word-info" id="hifz-word-display">ÿßÿÆÿ™ÿ± ÿ≥Ÿàÿ±ÿ© ÿ£ŸàŸÑÿßŸã</div>
        <div class="hifz-word-nav">
          <button class="hifz-word-nav-btn" onclick="hifzWordPrev()">‚Üê ÿ≥ÿßÿ®ŸÇ</button>
          <button class="hifz-word-nav-btn accent" onclick="hifzWordReveal()">üëÅÔ∏è ÿ•ÿ∏Ÿáÿßÿ±</button>
          <button class="hifz-word-nav-btn" onclick="hifzToggleMic()" id="hifz-word-mic-btn">üéôÔ∏è ÿ≥ŸÖŸëÿπ</button>
          <button class="hifz-word-nav-btn" onclick="hifzWordNext()">ÿ™ÿßŸÑŸä ‚Üí</button>
        </div>
        <div class="hifz-word-nav" style="margin-top:6px">
          <button class="hifz-word-nav-btn" onclick="hifzWordPrevAyah()">‚Üû ÿ¢Ÿäÿ© ÿ≥ÿßÿ®ŸÇÿ©</button>
          <button class="hifz-word-nav-btn" onclick="hifzWordNextAyah()">ÿ¢Ÿäÿ© ÿ™ÿßŸÑŸäÿ© ‚Ü†</button>
        </div>
        <div id="hifz-status-word" style="text-align:center;font-size:.85em;color:var(--gray);min-height:18px;margin-top:4px"></div>
      </div>
    </div>
  </div>
</div>

<!-- ================= BOTTOM NAV ================= -->
<nav id="bottom-nav">
  <div class="bnav-item active" id="bnav-home" onclick="showPage('home-screen')">
    <span class="bnav-icon">üè†</span>
    <span class="bnav-label">ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
  </div>
  <div class="bnav-item" id="bnav-quran" onclick="ck();openMod('quran')">
    <span class="bnav-icon">üìñ</span>
    <span class="bnav-label">ÿßŸÑŸÇÿ±ÿ¢ŸÜ</span>
  </div>
  <div class="bnav-item" id="bnav-prayers" onclick="showPage('prayers-page');renderPrayersPage()">
    <span class="bnav-icon">‚è∞</span>
    <span class="bnav-label">ÿßŸÑŸÖŸàÿßŸÇŸäÿ™</span>
  </div>
  <div class="bnav-item" id="bnav-compass" onclick="showPage('compass-page');initCompass()">
    <span class="bnav-icon">üß≠</span>
    <span class="bnav-label">ÿßŸÑŸÇÿ®ŸÑÿ©</span>
  </div>
  <div class="bnav-item" id="bnav-azkar" onclick="ck();openMod('azkar')">
    <span class="bnav-icon">üìø</span>
    <span class="bnav-label">ÿßŸÑÿ£ÿ∞ŸÉÿßÿ±</span>
  </div>
</nav>

<!-- VIEWER -->
<div id="viewer">
  <div class="nav-bar">
    <button class="btn-back" onclick="doBack()">‚Üê ÿ±ÿ¨Ÿàÿπ</button>
    <div id="v-title"></div>
    <button class="nic" id="nic-search" onclick="togSearchPanel()" title="ÿ®ÿ≠ÿ´">üîç</button>
    <button class="nic vis" onclick="openSide()" title="ÿßŸÑŸÇÿßÿ¶ŸÖÿ©">‚ò∞</button>
  </div>
  <div id="search-panel">
    <input class="s-inp" id="s-inp" type="search" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¢Ÿäÿ© ÿ£Ÿà ŸÉŸÑŸÖÿ©..." autocomplete="off" oninput="debSearch(this.value)">
    <div id="filter-row">
      <button class="fchip on" onclick="setFlt(this,'all')">ŸÉŸÑ ÿßŸÑŸÇÿ±ÿ¢ŸÜ</button>
      <button class="fchip" onclick="setFlt(this,'surah')">ÿßŸÑÿ≥Ÿàÿ±ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©</button>
      <button class="fchip" onclick="setFlt(this,'exact')">ÿ™ÿ∑ÿßÿ®ŸÇ ÿ™ÿßŸÖ</button>
    </div>
  </div>
  <div id="sr-area"></div>
  <div id="v-body"></div>
  <div id="player-bar">
    <div id="pinfo">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ...</div>
    <div class="p-ctrl">
      <button id="pprev" onclick="playPrevSurah()">‚óÄ</button>
      <button id="pnext" onclick="playNextSurah()">‚ñ∂</button>
      <button id="pstop" onclick="stopAud()">‚èπ</button>
    </div>
  </div>
</div>

<audio id="aud" crossorigin="anonymous" preload="none"></audio>

<!-- Firebase -->
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import{getDatabase,ref,set,onValue,get,push,update}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
const cfg={apiKey:"AIzaSyBKc0Vu8e1WxyUTmd1dEpGgrKDNOQV9PsY",authDomain:"quranapp-9c312.firebaseapp.com",projectId:"quranapp-9c312",databaseURL:"https://quranapp-9c312-default-rtdb.firebaseio.com/",storageBucket:"quranapp-9c312.firebasestorage.app",messagingSenderId:"708147485092",appId:"1:708147485092:web:ce228b7a245a89f08b0931"};
try{const app=initializeApp(cfg);const db=getDatabase(app);window._fb={db,ref,set,onValue,get,push,update};console.log('‚úÖ Firebase ŸÖÿ™ÿµŸÑ');}catch(e){console.warn('Firebase init failed',e);}
</script>
<!-- ŸÜÿ∏ÿßŸÖ Firebase ÿßŸÑÿ¥ÿßŸÖŸÑ: Streak + ÿßŸÑÿÆÿ™ŸÖÿ© + ÿ¢Ÿäÿ© ÿßŸÑŸäŸàŸÖ -->
<script src="firebase-system.js"></script>

<script>
/* ============================================================
   GLOBALS
============================================================ */
let quranXml=null,prayerTimes=null,countInv=null,miniInv=null;
let isScroll=false,scrollInv=null,scrollSpd=50;
let fontSize=parseFloat(localStorage.getItem('fontSize')||'1.8');
let bookmarks=[];
try{bookmarks=JSON.parse(localStorage.getItem('bm')||'[]');}catch(e){bookmarks=[];}
let clickOn=localStorage.getItem('clickSnd')!=='false';
let sDeb=null,activeFilter='all',curSurahId=null,curSurahName=null,curRecBase=null,curRecName=null,curRecSurahNum=null;
let notifSched=false;
let currentCity=localStorage.getItem('prayerCity')||'Cairo';
let currentCountry=localStorage.getItem('prayerCountry')||'Egypt';
const navStack=[];
let azkarCounts={};
try{azkarCounts=JSON.parse(localStorage.getItem('azkarCounts')||'{}');}catch(e){}

const G=id=>document.getElementById(id);
const aud=G('aud'),viewer=G('viewer'),vBody=G('v-body'),vTitle=G('v-title'),toast=G('toast');
let sCount=parseInt(localStorage.getItem('tasbihCount')||'0');

/* ============================================================
   AUDIO CTX
============================================================ */
let _actx=null;
function gctx(){
  if(!_actx)_actx=new(window.AudioContext||window.webkitAudioContext)();
  if(_actx.state==='suspended')_actx.resume();
  return _actx;
}
function ck(){
  if(!clickOn)return;
  try{const c=gctx(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=820;o.type='sine';g.gain.setValueAtTime(.11,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+.09);o.start(c.currentTime);o.stop(c.currentTime+.09);}catch(e){}
}
function ckOk(){
  if(!clickOn)return;
  try{const c=gctx();[523,659,784].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=f;g.gain.setValueAtTime(.07,c.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+i*.1+.15);o.start(c.currentTime+i*.1);o.stop(c.currentTime+i*.1+.15);});}catch(e){}
}
document.addEventListener('click',function unlockAudio(){aud.play().then(()=>{aud.pause();aud.currentTime=0;}).catch(()=>{});document.removeEventListener('click',unlockAudio);},{once:true});

/* ============================================================
   HELPERS
============================================================ */
function toAr(n){return String(n).replace(/\d/g,d=>'Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©'[d]);}
function sh(msg,dur=2700){toast.textContent=msg;toast.classList.add('show');clearTimeout(toast._t);toast._t=setTimeout(()=>toast.classList.remove('show'),dur);}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function safeAttr(s){return String(s).replace(/'/g,'&#39;').replace(/"/g,'&quot;');}
function fmtDiff(ms){const h=Math.floor(ms/3600000),m=Math.floor((ms%3600000)/60000),s=Math.floor((ms%60000)/1000);return`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}

/* ============================================================
   SIDE MENU
============================================================ */
function openSide(){ck();G('side-menu').classList.add('open');G('side-overlay').classList.add('show');}
function closeSide(){G('side-menu').classList.remove('open');G('side-overlay').classList.remove('show');}
function refToggles(){
  G('tg-dark').classList.toggle('on',document.body.classList.contains('dark-mode'));
  G('tg-notif').classList.toggle('on',typeof Notification!=='undefined'&&Notification.permission==='granted');
  G('tg-click').classList.toggle('on',clickOn);
}
function toggleDark(){ck();document.body.classList.toggle('dark-mode');localStorage.setItem('darkMode',document.body.classList.contains('dark-mode'));refToggles();}
function toggleNotifSetting(){ck();if(typeof Notification==='undefined'){sh('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');return;}if(Notification.permission!=='granted')reqNotif();else sh('ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖŸÅÿπŸëŸÑÿ© ÿ®ÿßŸÑŸÅÿπŸÑ');}
function toggleClickSnd(){clickOn=!clickOn;localStorage.setItem('clickSnd',clickOn);refToggles();sh(clickOn?'üîä ÿßŸÑÿ£ÿµŸàÿßÿ™ ŸÖŸÅÿπŸëŸÑÿ©':'üîá ÿßŸÑÿ£ÿµŸàÿßÿ™ ŸÖŸÉÿ™ŸàŸÖÿ©');}

/* ============================================================
   VIEWER NAVIGATION
============================================================ */
function openViewer(){
  stopSkyAnim();
  viewer.style.display='flex';
  setTimeout(()=>viewer.classList.add('active'),10);
  G('search-panel').classList.remove('open');
  G('sr-area').style.display='none';
  G('nic-search').classList.remove('vis');
  G('player-bar').classList.remove('show');
  G('scroll-widget').style.display='none';
  G('scroll-top-btn').classList.remove('show');
}
function openMod(type){ck();navStack.length=0;openViewer();route(type);}
function route(t){
  if(t==='quran')renderSurahList();
  else if(t==='azkar')renderAzkar();
  else if(t==='prayers')renderPrayers();
  else if(t==='tasbih')renderTasbih();
  else if(t==='reciters')renderReciters();
  else if(t==='names')renderNames();
  else if(t==='khatma')renderKhatma();
  else if(t==='bookmarks')renderBookmarks();
  else if(t==='search')renderSearchPage();
  else if(t==='duas')renderDuas();
  else if(t==='tafsir')renderTafsirPage();
}
function doBack(){
  ck();clearInterval(countInv);stopScroll();
  G('search-panel').classList.remove('open');
  G('sr-area').style.display='none';
  G('scroll-widget').style.display='none';
  G('scroll-top-btn').classList.remove('show');
  closeAyahCtx();
  if(navStack.length>0){const fn=navStack.pop();fn();}
  else{
    viewer.classList.remove('active');
    setTimeout(()=>{viewer.style.display='none';const nx=nextPrayer();if(nx)startSkyAnim(nx.key);},380);
  }
  aud.pause();
}
function pushNav(fn){navStack.push(fn);}

/* ============================================================
   SCROLL TO TOP (in viewer)
============================================================ */
function scrollToTop(){vBody.scrollTo({top:0,behavior:'smooth'});}
vBody&&vBody.addEventListener('scroll',()=>{
  G('scroll-top-btn').classList.toggle('show',vBody.scrollTop>300);
});

/* ============================================================
   HIJRI DATE
============================================================ */
function renderHijriDate(){
  try{
    const now=new Date();
    const hijri=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'numeric',month:'long',year:'numeric'}).format(now);
    const greg=new Intl.DateTimeFormat('ar',{day:'numeric',month:'long',year:'numeric'}).format(now);
    G('hijri-date').textContent=hijri;
    G('gregorian-date').textContent=greg;
  }catch(e){
    G('hijri-date').textContent='';G('gregorian-date').textContent='';
  }
}

/* ============================================================
   STATS HOME
============================================================ */
function updateHomeStats(){
  G('stat-bm').textContent=toAr(bookmarks.length);
  G('stat-tas').textContent=toAr(parseInt(localStorage.getItem('tasbihCount')||'0'));
  const first=parseInt(localStorage.getItem('firstVisit')||'0');
  const days=first?Math.max(1,Math.floor((Date.now()-first)/86400000)):1;
  G('stat-days').textContent=toAr(days);
}

/* ============================================================
   LAST READ
============================================================ */
function saveLastRead(surahId,surahName,ayahNum){
  const data={surahId,surahName,ayahNum,date:Date.now()};
  localStorage.setItem('lastRead',JSON.stringify(data));
  updateLastReadBar();
}
function updateLastReadBar(){
  try{
    const d=JSON.parse(localStorage.getItem('lastRead')||'null');
    if(!d||!d.surahName||!d.ayahNum){G('last-read-bar').style.display='none';return;}
    G('last-read-bar').style.display='flex';
    G('lr-text').textContent=`ÿ≥Ÿàÿ±ÿ© ${d.surahName} - ÿ¢Ÿäÿ© ${toAr(d.ayahNum)}`;
  }catch(e){G('last-read-bar').style.display='none';}
}
async function goLastRead(){
  try{
    const d=JSON.parse(localStorage.getItem('lastRead')||'null');
    if(!d)return;
    ck();
    openViewer();
    navStack.length=0;
    await renderAyahs(d.surahId,d.surahName);
    setTimeout(()=>{const el=G('ayah-'+d.ayahNum);if(el)el.scrollIntoView({behavior:'smooth',block:'center'});},600);
  }catch(e){}
}

/* ============================================================
   ONLOAD
============================================================ */
window.addEventListener('load',async()=>{
  // First visit
  if(!localStorage.getItem('firstVisit'))localStorage.setItem('firstVisit',Date.now().toString());
  setTimeout(()=>{G('splash').style.opacity='0';setTimeout(()=>G('splash').style.display='none',750);},2200);
  if(localStorage.getItem('darkMode')==='true')document.body.classList.add('dark-mode');
  refToggles();
  renderHijriDate();
  updateHomeStats();
  updateLastReadBar();
  G('city-display').textContent=currentCity;

  // Load quran xml
  try{const r=await fetch('quran-simple.xml');const t=await r.text();quranXml=new DOMParser().parseFromString(t,'text/xml');}catch(e){}

  await loadPrayers();
  startMini();

  if(typeof Notification!=='undefined'&&Notification.permission==='default'&&!localStorage.getItem('nd')){
    G('notif-banner').style.display='flex';
  }
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js')
      .then(async r=>{
        window.swReg=r;
        if(r.installing)await new Promise(res=>{r.installing.addEventListener('statechange',function(){if(this.state==='activated')res();});});
        if(typeof Notification!=='undefined'&&Notification.permission==='granted')schedNotifs();
      }).catch(e=>console.warn('SW:',e));

    // ‚úÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÑŸÇÿßÿ¶Ÿä ‚Äî ŸÑŸÖÿß ÿßŸÑŸÄ SW ÿßŸÑÿ¨ÿØŸäÿØ Ÿäÿ™ŸÅÿπŸëŸÑ ŸäÿπŸÖŸÑ reload ŸÅŸàÿ±Ÿä
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });

    // ‚úÖ ÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÜ ÿßŸÑŸÄ SW
    navigator.serviceWorker.addEventListener('message', e => {
      if(e.data && e.data.type === 'SW_UPDATED'){
        sh('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÑŸÑÿ•ÿµÿØÿßÿ± ÿßŸÑÿ¨ÿØŸäÿØ', 3500);
      }
      // ‚úÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿßŸÑÿ£ÿ∞ÿßŸÜ ÿπŸÜÿØŸÖÿß Ÿäÿ±ÿ≥ŸÑŸá ÿßŸÑŸÄ SW (ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÖŸÅÿ™Ÿàÿ≠)
      if(e.data && e.data.type === 'PLAY_ADHAN'){
        playAdhan(false, e.data.prayerKey);
      }
    });
  }

  // Handle hash shortcuts
  const hash=location.hash.replace('#','');
  if(hash&&['quran','prayers','azkar','tasbih','reciters','names','duas','khatma'].includes(hash)){openMod(hash);}
});

/* ============================================================
   PRAYER TIMES
============================================================ */
async function loadPrayers(){
  const c=localStorage.getItem('pt'),cd=localStorage.getItem('ptd'),today=new Date().toDateString();
  if(c&&cd===today){prayerTimes=JSON.parse(c);return;}
  try{
    const r=await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(currentCity)}&country=${encodeURIComponent(currentCountry)}&method=5`);
    const d=await r.json();
    if(d.data){prayerTimes=d.data.timings;localStorage.setItem('pt',JSON.stringify(prayerTimes));localStorage.setItem('ptd',today);
      // ‚úÖ ÿ£ÿ±ÿ≥ŸÑ ŸÑŸÑŸÄ SW ŸÅŸàÿ±ÿßŸã ŸÑÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ£ÿ∞ÿßŸÜ ÿ®ÿØŸàŸÜ ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
      if(navigator.serviceWorker.controller){
        navigator.serviceWorker.controller.postMessage({type:'SAVE_PRAYER_TIMES',times:prayerTimes,city:currentCity});
      }
    }
  }catch(e){if(c)prayerTimes=JSON.parse(c);}
}
function nextPrayer(){
  if(!prayerTimes)return null;
  const ks=['Fajr','Dhuhr','Asr','Maghrib','Isha'],ns={Fajr:'ÿßŸÑŸÅÿ¨ÿ±',Dhuhr:'ÿßŸÑÿ∏Ÿáÿ±',Asr:'ÿßŸÑÿπÿµÿ±',Maghrib:'ÿßŸÑŸÖÿ∫ÿ±ÿ®',Isha:'ÿßŸÑÿπÿ¥ÿßÿ°'};
  const now=new Date();
  for(const k of ks){
    if(!prayerTimes[k])continue;
    const[h,m]=prayerTimes[k].split(':');const t=new Date();t.setHours(+h,+m,0,0);
    if(t>now)return{name:ns[k],time:t,key:k};
  }
  const[h,m]=(prayerTimes.Fajr||'05:00').split(':');
  const t=new Date();t.setDate(t.getDate()+1);t.setHours(+h,+m,0,0);
  return{name:'ÿßŸÑŸÅÿ¨ÿ±',time:t,key:'Fajr'};
}
/* ============================================================
   SKY CANVAS ‚Äî ŸÖÿ¥ŸáÿØ ÿßŸÑÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ™ÿ≠ÿ±ŸÉ
============================================================ */
const SKY_SCENES={
  Fajr:{   sky:['#0a0e2a','#1a1040','#2d1b5a'],  bodyColor:'#ffd700', bodyR:20, bodyType:'moon',  horizon:'#1a2040', groundColor:'#0d1520', label:'ÿßŸÑŸÅÿ¨ÿ± üåô'},
  Dhuhr:{  sky:['#1a6fb5','#2196f3','#87ceeb'],   bodyColor:'#fff7aa', bodyR:28, bodyType:'sun',   horizon:'#4db8ff', groundColor:'#0f5c2e', label:'ÿßŸÑÿ∏Ÿáÿ± ‚òÄÔ∏è'},
  Asr:{    sky:['#e8750a','#f0a500','#ffd580'],   bodyColor:'#ffcc00', bodyR:26, bodyType:'sun',   horizon:'#f0a040', groundColor:'#2d5a1b', label:'ÿßŸÑÿπÿµÿ± üå§Ô∏è'},
  Maghrib:{sky:['#1a0a30','#6b1a5a','#d4562a'],  bodyColor:'#ff6a00', bodyR:30, bodyType:'sun',   horizon:'#d4562a', groundColor:'#1a1a1a', label:'ÿßŸÑŸÖÿ∫ÿ±ÿ® üåá'},
  Isha:{   sky:['#000510','#050d1e','#0a1628'],   bodyColor:'#e8e8ff', bodyR:18, bodyType:'moon',  horizon:'#0a1628', groundColor:'#050d14', label:'ÿßŸÑÿπÿ¥ÿßÿ° üåô'}
};

let _skyAnim=null,_skyPhase=0,_curScene=null,_stars=[];

function initStars(n){
  _stars=[];
  for(let i=0;i<n;i++){_stars.push({x:Math.random(),y:Math.random()*0.65,r:Math.random()*1.5+.3,a:Math.random()});}
}

function drawSky(scene,phase){
  const canvas=G('sky-canvas');if(!canvas)return;
  const W=canvas.width,H=canvas.height;
  const ctx=canvas.getContext('2d');
  const s=scene;

  // Sky gradient
  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,s.sky[0]);
  grad.addColorStop(.5,s.sky[1]);
  grad.addColorStop(1,s.sky[2]);
  ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);

  // Stars (Fajr + Isha)
  if(s.bodyType==='moon'||s.sky[0].startsWith('#0')||s.sky[0].startsWith('#1a0')){
    _stars.forEach(st=>{
      const twinkle=Math.sin(phase*2+st.a*10)*.3+.7;
      ctx.beginPath();ctx.arc(st.x*W,st.y*H,st.r,0,Math.PI*2);
      ctx.fillStyle=`rgba(255,255,255,${twinkle*0.85})`;ctx.fill();
    });
  }

  // Body position ‚Äî Ÿäÿ™ÿ≠ÿ±ŸÉ ÿ≠ÿ≥ÿ® phase (0=ÿ£ŸÅŸÇ‚Üí1=Ÿàÿ≥ÿ∑ ÿßŸÑÿ≥ŸÖÿßÿ°)
  const bodyX=W*0.5;
  const minY=H*0.12,maxY=H*0.82;
  // ÿπŸÜÿØ Maghrib: ÿßŸÑÿ¥ŸÖÿ≥ ÿ™ÿ∫ÿ±ÿ® ‚Üí ÿ™ÿ®ÿØÿ£ ŸÖŸÜ ÿßŸÑŸÖŸÜÿ™ÿµŸÅ Ÿàÿ™ŸÜÿ≤ŸÑ ŸÑŸÑÿ£ŸÅŸÇ
  let bodyProgress=phase; // 0..1
  const bodyY=s===SKY_SCENES.Maghrib
    ? maxY-(maxY-H*0.3)*Math.sin(bodyProgress*Math.PI*0.5)  // ÿ™ÿ∫ÿ±ÿ®
    : minY+(maxY-minY)*(1-Math.sin(bodyProgress*Math.PI*0.5)); // ÿßŸÑÿ®ÿßŸÇŸä: ÿ™ÿ¥ÿ±ŸÇ Ÿàÿ™ÿπŸÑŸà

  // Glow
  const glow=ctx.createRadialGradient(bodyX,bodyY,0,bodyX,bodyY,s.bodyR*3.5);
  glow.addColorStop(0,s.bodyColor+'88');glow.addColorStop(1,'transparent');
  ctx.beginPath();ctx.arc(bodyX,bodyY,s.bodyR*3.5,0,Math.PI*2);
  ctx.fillStyle=glow;ctx.fill();

  // Body
  ctx.beginPath();ctx.arc(bodyX,bodyY,s.bodyR,0,Math.PI*2);
  ctx.fillStyle=s.bodyColor;ctx.fill();

  // Moon crescent
  if(s.bodyType==='moon'){
    ctx.beginPath();ctx.arc(bodyX+s.bodyR*.35,bodyY-s.bodyR*.1,s.bodyR*.82,0,Math.PI*2);
    ctx.fillStyle=s.sky[1];ctx.fill();
    // ŸÜÿ¨ŸÖÿ© ÿµÿ∫Ÿäÿ±ÿ©
    ctx.font=`${s.bodyR*.65}px serif`;ctx.fillStyle=s.bodyColor;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('‚ú¶',bodyX+s.bodyR*1.4,bodyY-s.bodyR*.9);
  }

  // Horizon glow
  const hGrad=ctx.createLinearGradient(0,H*0.6,0,H);
  hGrad.addColorStop(0,s.horizon+'44');hGrad.addColorStop(1,s.horizon+'00');
  ctx.fillStyle=hGrad;ctx.fillRect(0,H*0.6,W,H*0.4);

  // Ground silhouette (mosque skyline)
  drawMosque(ctx,W,H,s.groundColor);
}

function drawMosque(ctx,W,H,color){
  ctx.fillStyle=color;
  // ÿ£ÿ±ÿ∂Ÿäÿ©
  ctx.fillRect(0,H-14,W,14);
  // ŸÖÿ≥ÿßÿ¨ÿØ ŸÖÿ®ÿ≥Ÿëÿ∑ÿ©
  const M=(x,w,h,d=8)=>{
    // ÿ¨ÿ≥ŸÖ
    ctx.fillRect(x,H-14-h,w,h);
    // ŸÇÿ®ÿ©
    ctx.beginPath();ctx.arc(x+w/2,H-14-h,w*.38,Math.PI,0);ctx.fill();
    // ŸÖÿ¶ÿ∞ŸÜÿ©
    ctx.fillRect(x+w+2,H-14-d*2.4,5,d*2.4);
    ctx.beginPath();ctx.arc(x+w+4.5,H-14-d*2.4,4,Math.PI,0);ctx.fill();
  };
  M(W*.08,36,28,10);
  M(W*.35,48,38,13);
  M(W*.62,40,30,11);
  // ŸÜÿÆŸäŸÑ
  const P=(x,h)=>{ctx.fillRect(x-2,H-14-h,4,h);ctx.font=`${h*.55}px serif`;ctx.fillText('üå¥',x-10,H-14-h+6);};
  P(W*.22,22);P(W*.78,18);P(W*.88,20);
}

function startSkyAnim(prayerKey){
  if(_skyAnim)cancelAnimationFrame(_skyAnim);
  _curScene=SKY_SCENES[prayerKey]||SKY_SCENES.Dhuhr;
  const canvas=G('sky-canvas');if(!canvas)return;
  canvas.width=canvas.offsetWidth||window.innerWidth;
  canvas.height=130;
  initStars(35);
  _skyPhase=0;
  const speed=0.004;
  function loop(){
    _skyPhase=(_skyPhase+speed)%1;
    drawSky(_curScene,_skyPhase);
    _skyAnim=requestAnimationFrame(loop);
  }
  loop();
}

function stopSkyAnim(){if(_skyAnim){cancelAnimationFrame(_skyAnim);_skyAnim=null;}}

function startMini(){
  clearInterval(miniInv);
  miniInv=setInterval(()=>{
    const nx=nextPrayer();if(!nx)return;
    const diff=nx.time-new Date();if(diff<0)return;
    // update prayer scene
    const nameEl=G('pi-name'),timerEl=G('pi-timer');
    if(nameEl){
      const sc=SKY_SCENES[nx.key];
      nameEl.textContent=sc?sc.label:nx.name;
    }
    if(timerEl)timerEl.textContent=toAr(fmtDiff(diff));
    // start sky animation for current prayer
    if(_curScene!==SKY_SCENES[nx.key])startSkyAnim(nx.key);
    if(diff<300000&&diff>290000)notifPrayer(nx.name,Math.round(diff/60000));
  },1000);
  // immediate first draw
  const nx=nextPrayer();
  if(nx){
    startSkyAnim(nx.key);
    const sc=SKY_SCENES[nx.key];
    const nameEl=G('pi-name');if(nameEl)nameEl.textContent=sc?sc.label:nx.name;
  }
}
function startCountdown(){
  clearInterval(countInv);
  countInv=setInterval(()=>{
    const nx=nextPrayer();if(!nx)return;
    const diff=nx.time-new Date();if(diff<0)return;
    const ne=G('next-name'),te=G('next-timer');
    if(ne)ne.textContent=nx.name;if(te)te.textContent=toAr(fmtDiff(diff));
    document.querySelectorAll('.p-row').forEach(r=>r.classList.remove('acp'));
    const rw=G('row-'+nx.key);if(rw)rw.classList.add('acp');
  },1000);
}

/* city change */
function changeCity(){
  ck();
  const cities=[
    {n:'ÿßŸÑŸÇÿßŸáÿ±ÿ©',c:'Cairo',co:'Egypt'},{n:'ŸÖŸÉÿ© ÿßŸÑŸÖŸÉÿ±ŸÖÿ©',c:'Mecca',co:'Saudi Arabia'},
    {n:'ÿßŸÑŸÖÿØŸäŸÜÿ© ÿßŸÑŸÖŸÜŸàÿ±ÿ©',c:'Medina',co:'Saudi Arabia'},{n:'ÿßŸÑÿ±Ÿäÿßÿ∂',c:'Riyadh',co:'Saudi Arabia'},
    {n:'ÿØÿ®Ÿä',c:'Dubai',co:'UAE'},{n:'ÿßŸÑŸÉŸàŸäÿ™',c:'Kuwait City',co:'Kuwait'},
    {n:'ÿπŸÖŸëÿßŸÜ',c:'Amman',co:'Jordan'},{n:'ÿ®ÿ∫ÿØÿßÿØ',c:'Baghdad',co:'Iraq'},
    {n:'ÿßŸÑÿØŸàÿ≠ÿ©',c:'Doha',co:'Qatar'},{n:'ÿßŸÑÿÆÿ±ÿ∑ŸàŸÖ',c:'Khartoum',co:'Sudan'},
    {n:'ÿ™ŸàŸÜÿ≥',c:'Tunis',co:'Tunisia'},{n:'ÿßŸÑÿØÿßÿ± ÿßŸÑÿ®Ÿäÿ∂ÿßÿ°',c:'Casablanca',co:'Morocco'},
    {n:'ÿ•ÿ≥ÿ∑ŸÜÿ®ŸàŸÑ',c:'Istanbul',co:'Turkey'},{n:'ÿ¨ÿßŸÉÿ±ÿ™ÿß',c:'Jakarta',co:'Indonesia'},
    {n:'ŸÑŸÜÿØŸÜ',c:'London',co:'UK'},{n:'ÿ®ÿßÿ±Ÿäÿ≥',c:'Paris',co:'France'}
  ];
  let html=`<div style="padding:16px;background:var(--card);border-radius:20px 20px 0 0;max-height:70vh;overflow-y:auto">
    <h3 style="color:var(--accent);text-align:center;margin-bottom:14px;font-family:'Reem Kufi'">ÿßÿÆÿ™ÿ± ŸÖÿØŸäŸÜÿ™ŸÉ</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    ${cities.map(ct=>`<button onclick="selectCity('${ct.c}','${ct.co}','${ct.n}')" style="padding:11px;border-radius:11px;border:1.5px solid rgba(212,175,55,.2);background:var(--primary);color:var(--accent);font-family:'Amiri';font-size:.9em;cursor:pointer${currentCity===ct.c?';background:var(--accent);color:var(--primary)':''}">${ct.n}</button>`).join('')}
    </div>
    <button onclick="document.getElementById('city-modal').style.display='none'" style="width:100%;margin-top:12px;padding:11px;border-radius:11px;border:1.5px solid rgba(212,175,55,.3);background:transparent;color:var(--gray);font-family:'Amiri';font-size:.9em;cursor:pointer">ÿ•ŸÑÿ∫ÿßÿ°</button>
  </div>`;
  let m=G('city-modal');
  if(!m){m=document.createElement('div');m.id='city-modal';m.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9001;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(3px)';m.onclick=e=>{if(e.target===m)m.style.display='none';};document.body.appendChild(m);}
  m.innerHTML=html;m.style.display='flex';
}
async function selectCity(city,country,nameAr){
  const m=G('city-modal');if(m)m.style.display='none';
  currentCity=city;currentCountry=country;
  localStorage.setItem('prayerCity',city);localStorage.setItem('prayerCountry',country);
  G('city-display').textContent=nameAr;
  localStorage.removeItem('pt');localStorage.removeItem('ptd');
  prayerTimes=null;
  await loadPrayers();
  startMini();
  sh('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿØŸäŸÜÿ©: '+nameAr);
}

/* ============================================================
   NOTIFICATIONS
============================================================ */
async function reqNotif(){
  ck();
  if(typeof Notification==='undefined'){sh('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');return;}
  const p=await Notification.requestPermission();
  G('notif-banner').style.display='none';
  if(p==='granted'){
    if(!window.swReg&&'serviceWorker' in navigator){try{window.swReg=await navigator.serviceWorker.ready;}catch(e){}}
    sh('‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');schedNotifs();
  }else sh('ŸÑŸÖ Ÿäÿ™ŸÖ ŸÖŸÜÿ≠ ÿßŸÑÿ•ÿ∞ŸÜ');
  refToggles();
}
function dismissBanner(){G('notif-banner').style.display='none';localStorage.setItem('nd','1');}
function notifPrayer(name,mins){
  if(typeof Notification==='undefined'||Notification.permission!=='granted')return;
  if(notifSched)return;notifSched=true;setTimeout(()=>notifSched=false,65000);
  const opts={body:`ÿ®ÿßŸÇŸä ${toAr(mins)} ÿØŸÇÿßÿ¶ŸÇ ÿπŸÑŸâ ÿµŸÑÿßÿ© ${name}`,icon:'./icon.png',dir:'rtl',vibrate:[200,100,200],tag:'ps'};
  if(window.swReg)window.swReg.showNotification(`üïå ŸÇÿ±Ÿäÿ®ÿßŸã: ${name}`,opts);
  else new Notification(`üïå ŸÇÿ±Ÿäÿ®ÿßŸã: ${name}`,opts);
}
async function schedNotifs(){
  if(!prayerTimes||typeof Notification==='undefined'||Notification.permission!=='granted')return;
  if(!window.swReg&&'serviceWorker' in navigator){try{window.swReg=await navigator.serviceWorker.ready;}catch(e){}}

  // ‚úÖ ÿ£ÿ±ÿ≥ŸÑ ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿµŸÑÿßÿ© ŸÑŸÑŸÄ Service Worker ŸÑŸäÿ¨ÿØŸàŸÑŸá ÿ≠ÿ™Ÿâ ŸÑŸà ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ∫ŸÑŸÇ
  if(window.swReg&&navigator.serviceWorker.controller){
    navigator.serviceWorker.controller.postMessage({
      type:'SAVE_PRAYER_TIMES',
      times:prayerTimes,
      city:currentCity
    });
  }

  // ‚úÖ ÿ™ÿ≥ÿ¨ŸäŸÑ Periodic Background Sync (Chrome Android)
  if(window.swReg&&'periodicSync' in window.swReg){
    try{
      const status=await navigator.permissions.query({name:'periodic-background-sync'});
      if(status.state==='granted'){
        await window.swReg.periodicSync.register('prayer-periodic-check',{minInterval:30*60*1000}); // ŸÉŸÑ ŸÜÿµŸÅ ÿ≥ÿßÿπÿ©
        console.log('[App] Periodic sync registered');
      }
    }catch(e){console.log('[App] periodicSync not supported:',e);}
  }

  // ÿ¨ÿØŸàŸÑÿ© ÿØÿßÿÆŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÉŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© (ŸÑŸÖÿß ŸäŸÉŸàŸÜ ŸÖŸÅÿ™Ÿàÿ≠)
  const ns={Fajr:'ÿßŸÑŸÅÿ¨ÿ±',Dhuhr:'ÿßŸÑÿ∏Ÿáÿ±',Asr:'ÿßŸÑÿπÿµÿ±',Maghrib:'ÿßŸÑŸÖÿ∫ÿ±ÿ®',Isha:'ÿßŸÑÿπÿ¥ÿßÿ°'};const now=new Date();
  for(const[k,n]of Object.entries(ns)){
    if(!prayerTimes[k])continue;
    const[h,m]=prayerTimes[k].split(':');const pt=new Date();pt.setHours(+h,+m,0,0);
    const delay=pt-now-5*60000;if(delay>0&&delay<43200000)setTimeout(()=>{
      if(window.swReg)window.swReg.showNotification(`üïå ÿ≠ÿßŸÜ ŸàŸÇÿ™ ${n}`,{body:'ÿßŸÑÿµŸÑÿßÿ© ÿÆŸäÿ± ŸÖŸÜ ÿßŸÑŸÜŸàŸÖ',icon:'./icon.png',dir:'rtl',vibrate:[300,100,300,100,300],tag:'p'+k});
      else new Notification(`üïå ÿ≠ÿßŸÜ ŸàŸÇÿ™ ${n}`,{body:'ÿßŸÑÿµŸÑÿßÿ© ÿÆŸäÿ± ŸÖŸÜ ÿßŸÑŸÜŸàŸÖ',icon:'./icon.png',dir:'rtl',tag:'p'+k});
    },delay);
  }
  sh('‚úÖ ÿ™ŸÖ ÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ£ÿ∞ÿßŸÜ ‚Äî ŸäÿπŸÖŸÑ ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ© ŸàÿßŸÑÿ≥ŸÉŸàŸÜ', 3500);
}

/* ============================================================
   SEARCH
============================================================ */
function togSearchPanel(){ck();const p=G('search-panel');const op=p.classList.toggle('open');G('sr-area').style.display=op?'block':'none';if(op)setTimeout(()=>G('s-inp').focus(),300);}
function setFlt(btn,f){ck();activeFilter=f;document.querySelectorAll('.fchip').forEach(c=>c.classList.remove('on'));btn.classList.add('on');const q=G('s-inp').value.trim();if(q.length>=2)doSearch(q);}
function debSearch(v){clearTimeout(sDeb);if(v.trim().length<2){G('sr-area').innerHTML='';return;}sDeb=setTimeout(()=>doSearch(v.trim()),450);}
async function doSearch(q){
  const area=G('sr-area');area.style.display='block';area.innerHTML='<p style="padding:14px;color:var(--accent)">‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´...</p>';
  try{
    const scope=(activeFilter==='surah'&&curSurahId)?curSurahId:'all';
    const url=`https://api.alquran.cloud/v1/search/${encodeURIComponent(q)}/${scope}/ar`;
    const r=await fetch(url);const d=await r.json();
    if(!d.data||!d.data.matches||!d.data.matches.length){area.innerHTML='<p style="padding:20px;text-align:center;color:gray">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</p>';return;}
    let ms=d.data.matches;
    if(activeFilter==='exact'){const re=new RegExp('(^|\\s)'+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'(\\s|$)');ms=ms.filter(m=>re.test(m.text));}
    if(!ms.length){area.innerHTML='<p style="padding:20px;text-align:center;color:gray">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿØŸÇŸäŸÇ</p>';return;}
    let html=`<div class="sr-count">üîç Ÿàÿ¨ÿØ ${toAr(ms.length)} ŸÜÿ™Ÿäÿ¨ÿ©</div>`;
    ms.slice(0,60).forEach(m=>{html+=`<div class="sr-item" onclick="fromSearch(${m.surah.number},'${safeAttr(m.surah.name)}',${m.number})"><div class="sr-meta">${esc(m.surah.name)} ‚Ä¢ ÿ¢Ÿäÿ© ${toAr(m.numberInSurah)}</div><div class="sr-txt">${hlText(m.text,q)}</div></div>`;});
    area.innerHTML=html;
  }catch(e){
    if(quranXml)offSearch(q,area);
    else area.innerHTML='<p style="padding:20px;text-align:center;color:gray">ÿ™ÿ≠ÿ™ÿßÿ¨ ÿßÿ™ÿµÿßŸÑÿßŸã ŸÑŸÑÿ®ÿ≠ÿ´</p>';
  }
}
function hlText(txt,q){const s=esc(txt);const sq=esc(q).replace(/[.*+?^${}()|[\]\\]/g,'\\$&');return s.replace(new RegExp(sq,'g'),'<span class="hl">$&</span>');}
function offSearch(q,area){
  const ayahs=quranXml.querySelectorAll('aya');let res=[],cnt=0;
  ayahs.forEach(a=>{if(cnt>=40)return;const t=a.getAttribute('text')||'';if(t.includes(q)){const su=a.parentElement;res.push({t,i:+a.getAttribute('index'),sn:su.getAttribute('name'),si:+su.getAttribute('index')});cnt++;}});
  if(!res.length){area.innerHTML='<p style="padding:20px;text-align:center;color:gray">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</p>';return;}
  let html=`<div class="sr-count">üîç Ÿàÿ¨ÿØ ${toAr(res.length)} ŸÜÿ™Ÿäÿ¨ÿ©</div>`;
  res.forEach(r=>{html+=`<div class="sr-item" onclick="fromSearch(${r.si},'${safeAttr(r.sn)}',null)"><div class="sr-meta">${esc(r.sn)} ‚Ä¢ ÿ¢Ÿäÿ© ${toAr(r.i)}</div><div class="sr-txt">${hlText(r.t,q)}</div></div>`;});
  area.innerHTML=html;
}
async function fromSearch(sNum,sName,ayahNum){
  ck();G('search-panel').classList.remove('open');G('sr-area').style.display='none';
  pushNav(renderSearchPage);await renderAyahs(sNum,sName);
  if(ayahNum){setTimeout(()=>{const el=G('ayah-'+ayahNum);if(el)el.scrollIntoView({behavior:'smooth',block:'center'});},650);}
}
function renderSearchPage(){
  vTitle.textContent='ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÇÿ±ÿ¢ŸÜ';
  G('nic-search').classList.add('vis');G('search-panel').classList.add('open');G('sr-area').style.display='block';
  G('sr-area').innerHTML='<p style="padding:30px;text-align:center;color:var(--gray);font-size:.9em">ÿßŸÉÿ™ÿ® ŸÉŸÑŸÖÿ© ÿ£Ÿà ÿ¨ÿ≤ÿ°ÿßŸã ŸÖŸÜ ÿ¢Ÿäÿ© ŸÑŸÑÿ®ÿ≠ÿ´</p>';
  vBody.innerHTML='';setTimeout(()=>G('s-inp').focus(),350);
}

/* ============================================================
   SURAH LIST
============================================================ */
async function renderSurahList(){
  vTitle.textContent='ŸÅŸáÿ±ÿ≥ ÿßŸÑÿ≥Ÿàÿ±';
  G('nic-search').classList.add('vis');G('scroll-widget').style.display='none';
  vBody.innerHTML='<p style="text-align:center;padding:40px;color:var(--accent)">‚è≥ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥Ÿàÿ±...</p>';
  curSurahId=null;
  const tabs=`<div class="tab-bar"><button class="tbb on" onclick="ck();renderSurahList()">ÿßŸÑÿ≥Ÿàÿ±</button><button class="tbb" onclick="ck();renderJuzList()">ÿßŸÑÿ£ÿ¨ÿ≤ÿßÿ°</button><button class="tbb" onclick="ck();renderPageList()">ÿßŸÑÿµŸÅÿ≠ÿßÿ™</button></div>`;
  try{
    const r=await fetch('https://api.alquran.cloud/v1/surah');const d=await r.json();
    let html=tabs+'<div class="grid" style="margin-top:0">';
    d.data.forEach(s=>{html+=`<div class="card" onclick="ck();pushNav(renderSurahList);renderAyahs(${s.number},'${safeAttr(s.name)}')"><b>${esc(s.name)}</b><small style="color:var(--gray);font-size:.76em">${toAr(s.numberOfAyahs)} ÿ¢Ÿäÿ© ¬∑ ${esc(s.revelationType==='Meccan'?'ŸÖŸÉŸäÿ©':'ŸÖÿØŸÜŸäÿ©')}</small></div>`;});
    vBody.innerHTML=html+'</div>';
  }catch(e){
    if(quranXml){
      const ss=quranXml.querySelectorAll('sura');let html=tabs+'<div class="grid" style="margin-top:0">';
      ss.forEach(s=>{html+=`<div class="card" onclick="ck();pushNav(renderSurahList);renderAyahs(${s.getAttribute('index')},'${safeAttr(s.getAttribute('name'))}')"><b>${esc(s.getAttribute('name'))}</b></div>`;});
      vBody.innerHTML=html+'</div>';
    }else vBody.innerHTML='<p style="text-align:center;padding:40px">ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ</p>';
  }
}

/* ============================================================
   JUZ LIST
============================================================ */
function renderJuzList(){
  vTitle.textContent='ÿßŸÑÿ£ÿ¨ÿ≤ÿßÿ° ÿßŸÑÿ´ŸÑÿßÿ´ŸàŸÜ';
  const tabs=`<div class="tab-bar"><button class="tbb" onclick="ck();renderSurahList()">ÿßŸÑÿ≥Ÿàÿ±</button><button class="tbb on" onclick="ck();renderJuzList()">ÿßŸÑÿ£ÿ¨ÿ≤ÿßÿ°</button><button class="tbb" onclick="ck();renderPageList()">ÿßŸÑÿµŸÅÿ≠ÿßÿ™</button></div>`;
  let html=tabs+'<div class="grid" style="margin-top:0">';
  for(let i=1;i<=30;i++)html+=`<div class="card" onclick="ck();pushNav(renderJuzList);renderJuzAyahs(${i})"><b>ÿßŸÑÿ¨ÿ≤ÿ° ${toAr(i)}</b></div>`;
  vBody.innerHTML=html+'</div>';
}
async function renderJuzAyahs(jn){
  vTitle.textContent='ÿßŸÑÿ¨ÿ≤ÿ° '+toAr(jn);
  G('scroll-widget').style.display='flex';
  vBody.innerHTML='<p style="text-align:center;padding:40px;color:var(--accent)">‚è≥ ÿ™ÿ≠ŸÖŸäŸÑ...</p>';
  try{
    const r=await fetch(`https://api.alquran.cloud/v1/juz/${jn}/ar.alafasy`);const d=await r.json();
    let html=fctrl();
    d.data.ayahs.forEach(a=>{const bm=bookmarks.find(b=>b.num===a.number);html+=buildAyah(a.number,a.text,ayahAudioUrl(a.number),a.numberInSurah,a.surah.name,a.surah.number,bm,'');});
    vBody.innerHTML=html;
  }catch(e){vBody.innerHTML='<p style="text-align:center;padding:30px">ÿ™ÿ≠ÿ™ÿßÿ¨ ÿßÿ™ÿµÿßŸÑÿßŸã ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ¨ÿ≤ÿ°</p>';}
  vBody.scrollTo(0,0);
}

/* ============================================================
   PAGE LIST (new feature)
============================================================ */
function renderPageList(){
  vTitle.textContent='ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑŸÖÿµÿ≠ŸÅ';
  const tabs=`<div class="tab-bar"><button class="tbb" onclick="ck();renderSurahList()">ÿßŸÑÿ≥Ÿàÿ±</button><button class="tbb" onclick="ck();renderJuzList()">ÿßŸÑÿ£ÿ¨ÿ≤ÿßÿ°</button><button class="tbb on" onclick="ck();renderPageList()">ÿßŸÑÿµŸÅÿ≠ÿßÿ™</button></div>`;
  let html=tabs+'<div class="grid" style="margin-top:0">';
  for(let i=1;i<=604;i++)html+=`<div class="card" onclick="ck();pushNav(renderPageList);renderPage(${i})"><b>ÿµŸÅÿ≠ÿ© ${toAr(i)}</b></div>`;
  vBody.innerHTML=html+'</div>';
}
async function renderPage(pn){
  vTitle.textContent='ÿµŸÅÿ≠ÿ© '+toAr(pn);
  G('scroll-widget').style.display='flex';
  vBody.innerHTML='<p style="text-align:center;padding:40px;color:var(--accent)">‚è≥ ÿ™ÿ≠ŸÖŸäŸÑ...</p>';
  try{
    const r=await fetch(`https://api.alquran.cloud/v1/page/${pn}/ar.alafasy`);const d=await r.json();
    let html=fctrl();
    d.data.ayahs.forEach(a=>{const bm=bookmarks.find(b=>b.num===a.number);html+=buildAyah(a.number,a.text,ayahAudioUrl(a.number),a.numberInSurah,a.surah.name,a.surah.number,bm,'');});
    vBody.innerHTML=html;
  }catch(e){vBody.innerHTML='<p style="text-align:center;padding:30px">ÿ™ÿ≠ÿ™ÿßÿ¨ ÿßÿ™ÿµÿßŸÑÿßŸã</p>';}
  vBody.scrollTo(0,0);
}

/* ============================================================
   SURAH AYAHS ‚Äî Ÿàÿ∂ÿπ ÿßŸÑŸÖÿµÿ≠ŸÅ ÿßŸÑŸÖÿ™ÿµŸÑ
============================================================ */
function ayahAudioUrl(absoluteNum){return`https://everyayah.com/data/Alafasy_128kbps/${String(absoluteNum).padStart(6,'0')}.mp3`;}

/* --- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ¢Ÿäÿ© (ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©) --- */
let _ctxAyah=null; // {num,text,numInS,sName,sId,audioUrl}
// ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ÿ™ŸÇÿ±ÿ£ ŸÖŸÜ ÿßŸÑŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÖÿÆÿ≤ŸÜÿ© ŸÑÿ™ÿ¨ŸÜÿ® ŸÖÿ¥ŸÉŸÑÿ© ÿßŸÑÿßŸÇÿ™ÿ®ÿßÿ≥ÿßÿ™ ŸÅŸä onclick
function openAyahCtxIdx(i){
  const d=window._ayahsData&&window._ayahsData[i];
  if(!d)return;
  openAyahCtx(d.num,d.text,d.numInS,d.sName,d.sId,d.audioUrl);
}
function openAyahCtx(num,text,numInS,sName,sId,audioUrl){
  ck();
  _ctxAyah={num,text,numInS,sName,sId,audioUrl};
  G('ctx-ayah-ref').textContent=esc(sName)+' ‚Ä¢ ÿßŸÑÿ¢Ÿäÿ© '+toAr(numInS);
  // ÿπÿ±ÿ∂ ÿ¨ÿ≤ÿ° ŸÖŸÜ ŸÜÿµ ÿßŸÑÿ¢Ÿäÿ© ŸÅŸÇÿ∑ (ÿ£ŸàŸÑ Ÿ¶Ÿ† ÿ≠ÿ±ŸÅ)
  G('ctx-ayah-preview').textContent=(text.length>60?text.slice(0,60)+'...':text);
  // ŸÑŸàŸÜ ÿ≤ÿ± ÿßŸÑÿ•ÿ¥ÿßÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ©
  const bm=bookmarks.find(b=>b.num===num);
  const bmBtn=G('ayah-ctx-menu').querySelector('.ctx-btn.green,.ctx-btn.red-bm');
  if(bmBtn){bmBtn.textContent=bm?'üóëÔ∏è ÿ•ÿ≤ÿßŸÑÿ©':'üîñ ÿ•ÿ¥ÿßÿ±ÿ©';bmBtn.className=bm?'ctx-btn red':'ctx-btn green';}
  G('ctx-overlay').classList.add('show');
  G('ayah-ctx-menu').classList.add('show');
}
function closeAyahCtx(){
  G('ctx-overlay').classList.remove('show');
  G('ayah-ctx-menu').classList.remove('show');
  _ctxAyah=null;
}
function ctxBm(){
  if(!_ctxAyah)return;
  const{num,sName,numInS,sId}=_ctxAyah;
  togBm(num,sName,numInS,sId);
  // ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸàŸÜ ÿ±ŸÇŸÖ ÿßŸÑÿ¢Ÿäÿ© ŸÅŸä ÿßŸÑŸÖÿµÿ≠ŸÅ
  const numEl=G('mn-'+num);
  if(numEl){const hasBm=bookmarks.find(b=>b.num===num);numEl.classList.toggle('has-bm',!!hasBm);}
  closeAyahCtx();
}
function ctxSaveRead(){
  if(!_ctxAyah)return;
  const{num,sName,sId}=_ctxAyah;
  saveLastRead(sId,sName,num);sh('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖŸàÿ∂ÿπ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©');
  closeAyahCtx();
}
function ctxPlay(){
  if(!_ctxAyah)return;
  playSaut(_ctxAyah.audioUrl,_ctxAyah.num);
  closeAyahCtx();
}
function ctxCopy(){
  if(!_ctxAyah)return;
  cpAyah(_ctxAyah.text+' Ô¥ø'+_ctxAyah.numInS+'Ô¥æ - '+_ctxAyah.sName);
  closeAyahCtx();
}
function ctxShare(){
  if(!_ctxAyah)return;
  shareAyah(_ctxAyah.text+' Ô¥ø'+_ctxAyah.numInS+'Ô¥æ - '+_ctxAyah.sName);
  closeAyahCtx();
}
function ctxTafsir(){
  if(!_ctxAyah)return;
  const{sId,sName}=_ctxAyah;
  closeAyahCtx();
  // ŸÅÿ™ÿ≠ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ŸÅÿßÿ≥Ÿäÿ± ÿßŸÑŸÉÿßŸÖŸÑÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿπŸÑŸâ Ÿáÿ∞Ÿá ÿßŸÑÿ≥Ÿàÿ±ÿ©
  openMod('tafsir');
  setTimeout(()=>loadTafsirSurah(sId,sName),200);
}

async function renderAyahs(id,name){
  vTitle.textContent='ÿ≥Ÿàÿ±ÿ© '+name;curSurahId=id;curSurahName=name;
  G('nic-search').classList.add('vis');
  G('scroll-widget').style.display='flex';
  vBody.innerHTML='<p style="text-align:center;padding:40px;color:var(--accent)">‚è≥ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥Ÿàÿ±ÿ©...</p>';
  try{
    const[arR,tfR]=await Promise.all([
      fetch(`https://api.alquran.cloud/v1/surah/${id}/ar.alafasy`),
      fetch(`https://api.alquran.cloud/v1/surah/${id}/ar.jalalayn`)
    ]);
    const arD=await arR.json(),tfD=await tfR.json();

    // ÿ¥ÿ±Ÿäÿ∑ ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑
    let html=fctrl();

    // ÿ±ÿ£ÿ≥ ÿßŸÑÿ≥Ÿàÿ±ÿ©
    html+=`<div class="mushaf-header">
      <div class="mushaf-sname">${esc(name)}</div>
      <div class="mushaf-sinfo">${toAr(arD.data.numberOfAyahs)} ÿ¢Ÿäÿ© &nbsp;¬∑&nbsp; ${arD.data.revelationType==='Meccan'?'ŸÖŸÉŸäÿ©':'ŸÖÿØŸÜŸäÿ©'}</div>
    </div>`;

    // ÿßŸÑÿ®ÿ≥ŸÖŸÑÿ©
    if(id!==9&&id!==1){
      html+=`<div class="mushaf-bismillah">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>`;
    }

    // ÿ™ÿÆÿ≤ŸäŸÜ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¢Ÿäÿßÿ™ ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸáÿß ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©
    window._ayahsData = [];
    // ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿ™ÿµŸÑ ŸÑŸÉŸÑ ÿßŸÑÿ¢Ÿäÿßÿ™
    html+='<div class="mushaf-wrap"><div class="mushaf-body" id="mushaf-body-'+id+'">';
    arD.data.ayahs.forEach((a,i)=>{
      const bm=!!bookmarks.find(b=>b.num===a.number);
      const safeText=esc(a.text);
      // ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÖÿµŸÅŸàŸÅÿ© ÿπÿßŸÑŸÖŸäÿ© ŸÑÿ™ÿ¨ŸÜÿ® ŸÖÿ¥ŸÉŸÑÿ© ÿßŸÑÿßŸÇÿ™ÿ®ÿßÿ≥ÿßÿ™ ŸÅŸä onclick
      window._ayahsData[i]={num:a.number,text:a.text,numInS:a.numberInSurah,sName:name,sId:id,audioUrl:ayahAudioUrl(a.number)};
      html+=`${safeText}<span class="m-anum${bm?' has-bm':''}" id="mn-${a.number}" onclick="event.stopPropagation();openAyahCtxIdx(${i})">Ô¥ø${toAr(a.numberInSurah)}Ô¥æ</span> `;
    });
    html+='</div></div>';
    html+=`<p style="text-align:center;color:var(--gray);font-size:.8em;padding:16px 12px">${esc(name)} ‚Ä¢ ${toAr(arD.data.numberOfAyahs)} ÿ¢Ÿäÿ©</p>`;
    vBody.innerHTML=html;

    // ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑÿ¢ÿÆÿ± ŸÖŸàÿ∂ÿπ ŸÇÿ±ÿßÿ°ÿ© ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑÿ≥Ÿàÿ±ÿ©
    const lr=JSON.parse(localStorage.getItem('lastRead')||'null');
    if(lr&&lr.surahId===id&&lr.ayahNum){
      setTimeout(()=>{
        const el=G('mn-'+lr.ayahNum);
        if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.classList.add('selected');setTimeout(()=>el.classList.remove('selected'),2000);}
      },300);
    }
  }catch(e){
      // Ÿàÿ∂ÿπ ÿ£ŸàŸÅŸÑÿßŸäŸÜ
    if(quranXml){
      const sura=quranXml.querySelector(`sura[index="${id}"]`);
      if(!sura){vBody.innerHTML='<p style="text-align:center;padding:40px">ÿßŸÑÿ≥Ÿàÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ© ÿ£ŸàŸÅŸÑÿßŸäŸÜ</p>';return;}
      const ayahs=sura.querySelectorAll('aya');
      let html=fctrl();
      html+=`<div class="mushaf-header"><div class="mushaf-sname">${esc(name)}</div></div>`;
      if(id!==9&&id!==1)html+=`<div class="mushaf-bismillah">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>`;
      html+='<div class="mushaf-wrap"><div class="mushaf-body">';
      // ÿ™ŸáŸäÿ¶ÿ© ŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸàÿ∂ÿπ ÿßŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ
      window._ayahsData=[];
      let absNum=0;
      ayahs.forEach((a,i)=>{
        const ayahIdx=parseInt(a.getAttribute('index')||'0');
        const txt=a.getAttribute('text')||'';
        const bm=!!bookmarks.find(b=>b.num===absNum||(b.ayah===ayahIdx&&b.surahId==id));
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÖÿ∑ŸÑŸÇ (ÿ™ŸÇÿ±Ÿäÿ®Ÿä - ÿ®ÿØŸàŸÜ API)
        window._ayahsData[i]={num:ayahIdx,text:txt,numInS:ayahIdx,sName:name,sId:id,audioUrl:ayahAudioUrl(ayahIdx)};
        html+=`${esc(txt)}<span class="m-anum${bm?' has-bm':''}" id="mn-${ayahIdx}" onclick="event.stopPropagation();openAyahCtxIdx(${i})">Ô¥ø${toAr(ayahIdx)}Ô¥æ</span> `;
      });
      html+='</div></div>';
      html+=`<p style="text-align:center;color:var(--gray);font-size:.8em;padding:14px">üì¥ Ÿàÿ∂ÿπ ÿßŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ ‚Äî ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ Ÿäÿ™ÿ∑ŸÑÿ® ÿßÿ™ÿµÿßŸÑÿßŸã</p>`;
      vBody.innerHTML=html;
    }else{
      vBody.innerHTML='<p style="text-align:center;padding:40px;color:var(--gray)">‚ö†Ô∏è ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ</p>';
    }
  }
  vBody.scrollTo(0,0);
}

function buildAyah(num,text,audioUrl,numInS,sName,sId,bm,tafsir){
  const bmCls=bm?' bookmarked':'';
  const bmBtnCls=bm?' bmact':'';
  const safeAud=esc(audioUrl||'');
  const safeSn=safeAttr(sName);
  // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿßŸã ŸÖÿ≥ÿ®ŸÇÿßŸã ŸÜÿ≥ÿ™ÿÆÿØŸÖŸáÿå Ÿàÿ•ŸÑÿß ŸÜÿ∂ŸäŸÅ ÿ≤ÿ± ŸÑÿ™ÿ≠ŸÖŸäŸÑŸá ŸÑÿ≠ÿ∏ŸäÿßŸã
  const tfBlock=tafsir?`<div class="tf-box" id="tf${num}">${esc(tafsir)}</div>`:'';
  const tfBtn=tafsir
    ?`<button class="ab" onclick="event.stopPropagation();togTf(${num})">üìñ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±</button>`
    :`<button class="ab" onclick="event.stopPropagation();showAyahTafsir(${num},${numInS},${sId},'${safeSn}','${esc(text)}')">üìñ ÿ™ŸÅÿ≥Ÿäÿ±</button>`;
  return `<div class="ayah-frame${bmCls}" id="ayah-${num}" onclick="playSaut('${safeAud}',${num})">
  <div class="qf" style="font-size:${fontSize}em">${esc(text)} <span class="anum">Ô¥ø${toAr(numInS)}Ô¥æ</span></div>
  <div class="ayah-acts">
    <button class="ab${bmBtnCls}" id="bmbtn${num}" onclick="event.stopPropagation();togBm(${num},'${safeSn}',${numInS},${sId})">üîñ</button>
    <button class="ab" onclick="event.stopPropagation();cpAyah('${esc(text)} Ô¥ø${numInS}Ô¥æ - ${esc(sName)}')">ŸÜÿ≥ÿÆ</button>
    <button class="ab" onclick="event.stopPropagation();shareAyah('${esc(text)} Ô¥ø${numInS}Ô¥æ - ${esc(sName)}')">ŸÖÿ¥ÿßÿ±ŸÉÿ©</button>
    ${tfBtn}
    <button class="ab" onclick="event.stopPropagation();saveLastRead(${sId},'${safeSn}',${num});sh('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖŸàÿ∂ÿπ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©')">üìå ÿ≠ŸÅÿ∏</button>
  </div>
  ${tfBlock}
</div>`;
}

function fctrl(){return`<div id="font-ctrl"><button onclick="chFont(-.15)" title="ÿ™ÿµÿ∫Ÿäÿ±">ÿ£‚àí</button><span id="font-lbl">ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑ ¬∑ ${fontSize.toFixed(1)}</span><button onclick="chFont(.15)" title="ÿ™ŸÉÿ®Ÿäÿ±">ÿ£+</button></div>`;}
function chFont(d){
  fontSize=Math.max(1.2,Math.min(3.2,fontSize+d));
  document.querySelectorAll('.qf').forEach(e=>e.style.fontSize=fontSize+'em');
  document.querySelectorAll('.mushaf-body').forEach(e=>e.style.fontSize=fontSize+'em');
  const lbl=G('font-lbl');if(lbl)lbl.textContent='ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑ ¬∑ '+fontSize.toFixed(1);
  localStorage.setItem('fontSize',fontSize);
}

/* SHARE AYAH */
function shareAyah(text){
  if(navigator.share){navigator.share({text:text,title:'ÿ¢Ÿäÿ© ŸÖŸÜ ŸÖÿµÿ≠ŸÅ ÿßŸÑŸÜŸàÿ±'}).catch(()=>{});}
  else{cpAyah(text);}
}

/* PLAY */
function playSaut(url,num){
  if(!url)return;ck();
  document.querySelectorAll('.ayah-frame').forEach(f=>f.classList.remove('playing'));
  const f=G('ayah-'+num);if(f)f.classList.add('playing');
  aud.src=url;aud.play().catch(err=>console.warn('audio:',err));
}
aud.addEventListener('ended',()=>{
  document.querySelectorAll('.ayah-frame.playing').forEach(f=>f.classList.remove('playing'));
  if(curRecBase&&curRecSurahNum)setTimeout(()=>playNextSurah(),1500);
});

function cpAyah(t){navigator.clipboard.writeText(t).then(()=>sh('‚úÖ ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ')).catch(()=>sh('ÿ™ÿπÿ∞ÿ± ÿßŸÑŸÜÿ≥ÿÆ'));}
function togTf(n){ck();const b=G('tf'+n);if(b)b.style.display=b.style.display==='block'?'none':'block';}

/* ============================================================
   BOOKMARKS
============================================================ */
function togBm(num,sName,ayahInS,sId){
  ck();const idx=bookmarks.findIndex(b=>b.num===num);
  const btn=G('bmbtn'+num),frame=G('ayah-'+num),mnum=G('mn-'+num);
  if(idx>=0){
    bookmarks.splice(idx,1);sh('üóëÔ∏è ÿ™ŸÖÿ™ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿßÿ±ÿ©');
    if(btn)btn.classList.remove('bmact');
    if(frame)frame.classList.remove('bookmarked');
    if(mnum)mnum.classList.remove('has-bm');
  }else{
    bookmarks.push({num,surah:sName,surahId:sId,ayah:ayahInS,date:new Date().toLocaleDateString('ar')});
    sh('üîñ ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©');ckOk();if(navigator.vibrate)navigator.vibrate(60);
    if(btn)btn.classList.add('bmact');
    if(frame)frame.classList.add('bookmarked');
    if(mnum)mnum.classList.add('has-bm');
  }
  localStorage.setItem('bm',JSON.stringify(bookmarks));
  updateHomeStats();
}
function renderBookmarks(){
  vTitle.textContent='ÿßŸÑÿ•ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ±ÿ¨ÿπŸäÿ© üîñ';
  if(!bookmarks.length){vBody.innerHTML='<div style="text-align:center;padding:60px"><div style="font-size:4em">üîñ</div><p style="color:var(--gray);margin-top:16px">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿßÿ±ÿßÿ™ ŸÖÿ±ÿ¨ÿπŸäÿ©<br>ÿßÿ∂ÿ∫ÿ∑ üîñ ÿ®ÿ¨ÿßŸÜÿ® ÿ£Ÿä ÿ¢Ÿäÿ© ŸÑÿ≠ŸÅÿ∏Ÿáÿß</p></div>';return;}
  let html=`<p style="padding:13px 14px;color:var(--accent)">${toAr(bookmarks.length)} ÿ•ÿ¥ÿßÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©</p>`;
  bookmarks.slice().reverse().forEach(bm=>{
    html+=`<div class="bm-item" onclick="ck();goBm(${bm.surahId||0},'${safeAttr(bm.surah)}',${bm.num})">
      <div><div style="color:var(--accent);font-weight:bold">ÿ≥Ÿàÿ±ÿ© ${esc(bm.surah)} - ÿ¢Ÿäÿ© ${toAr(bm.ayah)}</div><div style="color:var(--gray);font-size:.8em;margin-top:3px">${esc(bm.date)}</div></div>
      <button onclick="event.stopPropagation();delBm(${bm.num})" style="background:#8b0000;color:#fff;border:none;border-radius:9px;padding:7px 12px;cursor:pointer;font-family:'Amiri';flex-shrink:0;font-size:.85em">ÿ≠ÿ∞ŸÅ</button>
    </div>`;
  });
  vBody.innerHTML=html;
}
function delBm(num){ck();bookmarks=bookmarks.filter(b=>b.num!==num);localStorage.setItem('bm',JSON.stringify(bookmarks));renderBookmarks();updateHomeStats();}
async function goBm(sId,sName,ayahNum){
  pushNav(renderBookmarks);
  if(sId){await renderAyahs(sId,sName);}
  else{try{const r=await fetch('https://api.alquran.cloud/v1/surah');const d=await r.json();const s=d.data.find(x=>x.name===sName);if(s)await renderAyahs(s.number,s.name);else{sh('ÿ™ÿπÿ∞ÿ± ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ≥Ÿàÿ±ÿ©');return;}}catch(e){sh('ÿ™ÿ≠ÿ™ÿßÿ¨ ÿßÿ™ÿµÿßŸÑÿßŸã');return;}}
  setTimeout(()=>{
    // Ÿàÿ∂ÿπ ÿßŸÑŸÖÿµÿ≠ŸÅ: ÿ±ŸÇŸÖ ÿßŸÑÿ¢Ÿäÿ© id="mn-{num}"
    const el=G('mn-'+ayahNum)||G('ayah-'+ayahNum);
    if(el){
      el.scrollIntoView({behavior:'smooth',block:'center'});
      el.classList.add('selected');
      setTimeout(()=>el.classList.remove('selected'),2500);
    }
  },700);
}

/* ============================================================
   AUTO SCROLL
============================================================ */
function updSpd(v){scrollSpd=110-v;if(isScroll){clearInterval(scrollInv);startScroll();}}
function togScroll(){
  if(isScroll){stopScroll();sh('‚èπ ÿ™ŸàŸÇŸÅ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ±');}
  else{
    isScroll=true;
    G('asbtn').classList.add('running');
    G('asbtn-icon').textContent='‚è∏';
    G('asbtn-lbl').textContent='ÿ•ŸäŸÇÿßŸÅ';
    startScroll();sh('‚ñ∂ ÿ®ÿØÿ£ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä');
  }
}
function startScroll(){scrollInv=setInterval(()=>vBody.scrollTop+=1,scrollSpd);}
function stopScroll(){
  clearInterval(scrollInv);isScroll=false;
  const btn=G('asbtn');if(btn)btn.classList.remove('running');
  const icon=G('asbtn-icon');if(icon)icon.textContent='‚ñº‚ñº';
  const lbl=G('asbtn-lbl');if(lbl)lbl.textContent='ÿ™ŸÖÿ±Ÿäÿ±';
}

/* ============================================================
   RECITERS
============================================================ */
function renderReciters(){
  vTitle.textContent='ÿßÿÆÿ™ÿ± ÿßŸÑŸÇÿßÿ±ÿ¶';G('player-bar').classList.remove('show');curRecBase=null;curRecName=null;
  const rec=[
    {n:'Ÿäÿßÿ≥ÿ± ÿßŸÑÿØŸàÿ≥ÿ±Ÿä',b:'https://server11.mp3quran.net/yasser/',i:'üåü'},
    {n:'ŸÖÿ¥ÿßÿ±Ÿä ÿßŸÑÿπŸÅÿßÿ≥Ÿä',b:'https://server8.mp3quran.net/afs/',i:'üéôÔ∏è'},
    {n:'ÿπÿ®ÿØÿßŸÑÿ®ÿßÿ≥ÿ∑ ÿπÿ®ÿØÿßŸÑÿµŸÖÿØ',b:'https://server7.mp3quran.net/basit/',i:'‚ú®'},
    {n:'ŸÖÿ≠ŸÖÿØ ÿßŸÑŸÖŸÜÿ¥ÿßŸàŸä',b:'https://server10.mp3quran.net/minsh/',i:'üéµ'},
    {n:'ÿ≥ÿπÿØ ÿßŸÑÿ∫ÿßŸÖÿØŸä',b:'https://server7.mp3quran.net/s_gmd/',i:'üïå'},
    {n:'ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ≥ÿØŸäÿ≥',b:'https://server11.mp3quran.net/sds/',i:'üåô'}
  ];
  let html='<div class="grid" style="margin-top:16px">';
  rec.forEach(r=>{html+=`<div class="card" onclick="ck();pushNav(renderReciters);loadRecSurahs('${safeAttr(r.b)}','${safeAttr(r.n)}')"><span style="font-size:2em">${r.i}</span><b style="font-size:.9em">${esc(r.n)}</b></div>`;});
  vBody.innerHTML=html+'</div>';
}
async function loadRecSurahs(base,rName){
  vTitle.textContent='ÿ™ŸÑÿßŸàÿ© '+rName;curRecBase=base;curRecName=rName;
  vBody.innerHTML='<p style="text-align:center;padding:30px;color:var(--accent)">‚è≥ ÿ™ÿ≠ŸÖŸäŸÑ...</p>';
  try{
    const r=await fetch('https://api.alquran.cloud/v1/surah');const d=await r.json();
    let html='<div class="grid" style="margin-top:0">';
    d.data.forEach(s=>{html+=`<div class="card" onclick="ck();playRec('${safeAttr(base)}',${s.number},'${safeAttr(s.name)}')"><b style="font-size:.9em">${esc(s.name)}</b></div>`;});
    vBody.innerHTML=html+'</div>';
  }catch(e){vBody.innerHTML='<p style="text-align:center;padding:40px">ÿßŸÑÿ™ŸÑÿßŸàÿßÿ™ ÿ™ÿ≠ÿ™ÿßÿ¨ ÿßÿ™ÿµÿßŸÑÿßŸã ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™</p>';}
}
function playRec(base,sNum,sName){
  ck();curRecSurahNum=sNum;
  const url=`${base}${String(sNum).padStart(3,'0')}.mp3`;
  aud.src=url;aud.play().catch(()=>sh('ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ‚Äì ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ'));
  sh('‚ñ∂ '+sName);G('pinfo').textContent=sName+' ‚Äì '+(curRecName||'');G('player-bar').classList.add('show');
}
function playPrevSurah(){if(curRecBase&&curRecSurahNum&&curRecSurahNum>1){curRecSurahNum--;playRec(curRecBase,curRecSurahNum,'ÿ≥Ÿàÿ±ÿ© '+toAr(curRecSurahNum));}}
function playNextSurah(){if(curRecBase&&curRecSurahNum&&curRecSurahNum<114){curRecSurahNum++;playRec(curRecBase,curRecSurahNum,'ÿ≥Ÿàÿ±ÿ© '+toAr(curRecSurahNum));}}
function stopAud(){ck();aud.pause();aud.currentTime=0;G('player-bar').classList.remove('show');curRecSurahNum=null;document.querySelectorAll('.ayah-frame.playing').forEach(f=>f.classList.remove('playing'));sh('‚èπ ÿ™ŸÖ ÿßŸÑÿ•ŸäŸÇÿßŸÅ');}

/* ============================================================
   TASBIH
============================================================ */
function renderTasbih(){
  vTitle.textContent='ÿßŸÑÿ≥ÿ®ÿ≠ÿ© ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿ©';
  sCount=parseInt(localStorage.getItem('tasbihCount')||'0');
  const phrases=['ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá','ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá','ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±','ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá','ÿ£ÿ≥ÿ™ÿ∫ŸÅÿ± ÿßŸÑŸÑŸá','ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá Ÿàÿ®ÿ≠ŸÖÿØŸá','ŸÑÿß ÿ≠ŸàŸÑ ŸàŸÑÿß ŸÇŸàÿ© ÿ•ŸÑÿß ÿ®ÿßŸÑŸÑŸá'];
  let cur=localStorage.getItem('tasbihPhrase')||phrases[0];
  const btns=phrases.map(p=>`<button class="tbb${p===cur?' on':''}" onclick="setPhrase('${safeAttr(p)}',this)">${esc(p)}</button>`).join('');
  const total33=Math.floor(sCount/33);
  vBody.innerHTML=`<div style="text-align:center;padding:16px 14px">
    <div class="tab-bar" style="justify-content:center;flex-wrap:wrap">${btns}</div>
    <div id="tp" style="font-size:1.15em;color:var(--accent);margin:10px 0;font-family:'Noto Naskh Arabic'">${esc(cur)}</div>
    <div id="sc" style="font-size:clamp(5em,18vw,7em);color:var(--accent);font-weight:bold;line-height:1;font-family:monospace">${toAr(sCount)}</div>
    <div id="scsub" style="color:var(--gray);margin:5px 0;font-size:.9em">${toAr(total33)} √ó Ÿ£Ÿ£</div>
    <div class="sebha-circle" onclick="incTas()">ÿ≥ÿ®Ÿëÿ≠<small>ÿßÿ∂ÿ∫ÿ∑</small></div>
    <div style="display:flex;gap:10px;margin-top:16px;justify-content:center">
      <button class="btn-back" onclick="sCount=0;localStorage.setItem('tasbihCount','0');G('sc').textContent='Ÿ†';G('scsub').textContent='Ÿ† √ó Ÿ£Ÿ£';updateHomeStats()">ÿ™ÿµŸÅŸäÿ±</button>
    </div>
  </div>`;
}
function setPhrase(p,btn){ck();localStorage.setItem('tasbihPhrase',p);G('tp').textContent=p;document.querySelectorAll('.tbb').forEach(b=>b.classList.remove('on'));btn.classList.add('on');}
function incTas(){
  sCount++;ck();if(navigator.vibrate)navigator.vibrate(20);
  G('sc').textContent=toAr(sCount);G('scsub').textContent=toAr(Math.floor(sCount/33))+' √ó Ÿ£Ÿ£';
  localStorage.setItem('tasbihCount',sCount);
  updateHomeStats();
  if(sCount%33===0){sh('üåü ÿ£ÿ≠ÿ≥ŸÜÿ™! Ÿ£Ÿ£ ÿ™ÿ≥ÿ®Ÿäÿ≠ÿ©');ckOk();if(navigator.vibrate)navigator.vibrate([80,40,80]);}
}

/* ============================================================
   PRAYER TIMES SCREEN
============================================================ */
async function renderPrayers(){
  vTitle.textContent='ŸÖŸàÿßŸÇŸäÿ™ ÿßŸÑÿµŸÑÿßÿ©';
  if(!prayerTimes)await loadPrayers();
  const pNames={Fajr:'ÿßŸÑŸÅÿ¨ÿ± üåÖ',Sunrise:'ÿßŸÑÿ¥ÿ±ŸàŸÇ ‚òÄÔ∏è',Dhuhr:'ÿßŸÑÿ∏Ÿáÿ± ‚òÄÔ∏è',Asr:'ÿßŸÑÿπÿµÿ± üå§Ô∏è',Sunset:'ÿßŸÑÿ∫ÿ±Ÿàÿ® üåá',Maghrib:'ÿßŸÑŸÖÿ∫ÿ±ÿ® üåá',Isha:'ÿßŸÑÿπÿ¥ÿßÿ° üåô',Midnight:'ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÑŸäŸÑ üåë'};
  const mainPrayers=['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  let html=`<div id="next-card"><h3>‚è≥ ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©</h3><div id="next-name">...</div><div id="next-timer">--:--:--</div></div>`;
  // main prayers
  mainPrayers.forEach(k=>{
    const t=prayerTimes&&prayerTimes[k]?toAr(prayerTimes[k]):'--:--';
    html+=`<div class="p-row" id="row-${k}"><span class="pn">${pNames[k]||k}</span><span class="pt">${t}</span></div>`;
  });
  // extra times toggle
  html+=`<div style="margin:10px 12px">
    <button class="tbb" onclick="togExtraTimes(this)" style="width:100%;justify-content:center">ÿπÿ±ÿ∂ ÿ£ŸàŸÇÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©</button>
  </div>
  <div id="extra-times" style="display:none">
    ${['Sunrise','Sunset','Midnight','Imsak'].map(k=>{
      const t=prayerTimes&&prayerTimes[k]?toAr(prayerTimes[k]):'--:--';
      const n={Sunrise:'ÿßŸÑÿ¥ÿ±ŸàŸÇ ‚òÄÔ∏è',Sunset:'ÿßŸÑÿ∫ÿ±Ÿàÿ® üåá',Midnight:'ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÑŸäŸÑ üåë',Imsak:'ÿßŸÑÿ•ŸÖÿ≥ÿßŸÉ üåô'};
      return`<div class="p-row"><span class="pn">${n[k]||k}</span><span class="pt">${t}</span></div>`;
    }).join('')}
  </div>
  <div style="padding:12px;display:flex;gap:9px">
    <button class="btn-back" style="flex:1" onclick="ck();schedNotifs()">üîî ÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™</button>
    <button class="btn-back" style="flex:1;background:transparent;border:1.5px solid var(--accent);color:var(--accent)" onclick="changeCity()">üìç ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖÿØŸäŸÜÿ©</button>
  </div>`;
  vBody.innerHTML=html;startCountdown();
}
function togExtraTimes(btn){const el=G('extra-times');if(el.style.display==='none'){el.style.display='block';btn.textContent='ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ©';}else{el.style.display='none';btn.textContent='ÿπÿ±ÿ∂ ÿ£ŸàŸÇÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©';}}

/* ============================================================
   AZKAR (improved)
============================================================ */
function renderAzkar(){
  vTitle.textContent='ÿ≠ÿµŸÜ ÿßŸÑŸÖÿ≥ŸÑŸÖ üìø';
  const categories=[
    {id:'morning',label:'ÿ£ÿ∞ŸÉÿßÿ± ÿßŸÑÿµÿ®ÿßÿ≠ üåÖ'},
    {id:'evening',label:'ÿ£ÿ∞ŸÉÿßÿ± ÿßŸÑŸÖÿ≥ÿßÿ° üåô'},
    {id:'sleep',label:'ÿ£ÿ∞ŸÉÿßÿ± ÿßŸÑŸÜŸàŸÖ üò¥'},
    {id:'prayer',label:'ÿ®ÿπÿØ ÿßŸÑÿµŸÑÿßÿ© üïå'},
    {id:'general',label:'ÿ£ÿ∞ŸÉÿßÿ± ÿπÿßŸÖÿ© ‚ú®'}
  ];
  const tabs=categories.map((c,i)=>`<button class="tbb${i===0?' on':''}" onclick="ck();showAzkarCategory('${c.id}',this)">${c.label}</button>`).join('');
  const azkarData={
    morning:[
      {t:'ÿ£ÿ∞ŸÉÿßÿ± ÿßŸÑÿµÿ®ÿßÿ≠',d:'ÿ£ÿµÿ®ÿ≠ŸÜÿß Ÿàÿ£ÿµÿ®ÿ≠ ÿßŸÑŸÖŸÑŸÉ ŸÑŸÑŸáÿå ŸàÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸáÿå ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá Ÿàÿ≠ÿØŸá ŸÑÿß ÿ¥ÿ±ŸäŸÉ ŸÑŸáÿå ŸÑŸá ÿßŸÑŸÖŸÑŸÉ ŸàŸÑŸá ÿßŸÑÿ≠ŸÖÿØ ŸàŸáŸà ÿπŸÑŸâ ŸÉŸÑ ÿ¥Ÿäÿ° ŸÇÿØŸäÿ±.',r:1},
      {t:'ÿ¢Ÿäÿ© ÿßŸÑŸÉÿ±ÿ≥Ÿä',d:'ÿßŸÑŸÑŸéŸëŸáŸè ŸÑŸéÿß ÿ•ŸêŸÑŸéŸ∞ŸáŸé ÿ•ŸêŸÑŸéŸëÿß ŸáŸèŸàŸé ÿßŸÑŸíÿ≠ŸéŸäŸèŸë ÿßŸÑŸíŸÇŸéŸäŸèŸëŸàŸÖŸè €ö ŸÑŸéÿß ÿ™Ÿéÿ£ŸíÿÆŸèÿ∞ŸèŸáŸè ÿ≥ŸêŸÜŸéÿ©Ÿå ŸàŸéŸÑŸéÿß ŸÜŸéŸàŸíŸÖŸå €ö ŸÑŸéŸëŸáŸè ŸÖŸéÿß ŸÅŸêŸä ÿßŸÑÿ≥ŸéŸëŸÖŸéÿßŸàŸéÿßÿ™Ÿê ŸàŸéŸÖŸéÿß ŸÅŸêŸä ÿßŸÑŸíÿ£Ÿéÿ±Ÿíÿ∂Ÿê.',r:1},
      {t:'ÿ≥ŸäÿØ ÿßŸÑÿßÿ≥ÿ™ÿ∫ŸÅÿßÿ±',d:'ÿßŸÑŸÑŸáŸÖ ÿ£ŸÜÿ™ ÿ±ÿ®Ÿä ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿ£ŸÜÿ™ÿå ÿÆŸÑŸÇÿ™ŸÜŸä Ÿàÿ£ŸÜÿß ÿπÿ®ÿØŸÉÿå Ÿàÿ£ŸÜÿß ÿπŸÑŸâ ÿπŸáÿØŸÉ ŸàŸàÿπÿØŸÉ ŸÖÿß ÿßÿ≥ÿ™ÿ∑ÿπÿ™ÿå ÿ£ÿπŸàÿ∞ ÿ®ŸÉ ŸÖŸÜ ÿ¥ÿ± ŸÖÿß ÿµŸÜÿπÿ™ÿå ÿ£ÿ®Ÿàÿ° ŸÑŸÉ ÿ®ŸÜÿπŸÖÿ™ŸÉ ÿπŸÑŸäŸë Ÿàÿ£ÿ®Ÿàÿ° ÿ®ÿ∞ŸÜÿ®Ÿä ŸÅÿßÿ∫ŸÅÿ± ŸÑŸäÿå ŸÅÿ•ŸÜŸá ŸÑÿß Ÿäÿ∫ŸÅÿ± ÿßŸÑÿ∞ŸÜŸàÿ® ÿ•ŸÑÿß ÿ£ŸÜÿ™.',r:1},
      {t:'ÿßŸÑŸÖÿπŸàÿ∞ÿßÿ™',d:'ŸÇŸèŸÑŸí ÿ£ŸéÿπŸèŸàÿ∞Ÿè ÿ®Ÿêÿ±Ÿéÿ®ŸêŸë ÿßŸÑŸíŸÅŸéŸÑŸéŸÇŸê ... ŸÇŸèŸÑŸí ÿ£ŸéÿπŸèŸàÿ∞Ÿè ÿ®Ÿêÿ±Ÿéÿ®ŸêŸë ÿßŸÑŸÜŸéŸëÿßÿ≥Ÿê',r:3},
      {t:'ÿßŸÑÿ™ÿ≥ÿ®Ÿäÿ≠ ÿßŸÑÿµÿ®ÿßÿ≠Ÿä',d:'ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá Ÿàÿ®ÿ≠ŸÖÿØŸá.',r:100}
    ],
    evening:[
      {t:'ÿ£ÿ∞ŸÉÿßÿ± ÿßŸÑŸÖÿ≥ÿßÿ°',d:'ÿ£ŸÖÿ≥ŸäŸÜÿß Ÿàÿ£ŸÖÿ≥Ÿâ ÿßŸÑŸÖŸÑŸÉ ŸÑŸÑŸáÿå ŸàÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸáÿå ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá Ÿàÿ≠ÿØŸá ŸÑÿß ÿ¥ÿ±ŸäŸÉ ŸÑŸáÿå ŸÑŸá ÿßŸÑŸÖŸÑŸÉ ŸàŸÑŸá ÿßŸÑÿ≠ŸÖÿØ ŸàŸáŸà ÿπŸÑŸâ ŸÉŸÑ ÿ¥Ÿäÿ° ŸÇÿØŸäÿ±.',r:1},
      {t:'ÿßŸÑÿßÿ≥ÿ™ÿπÿßÿ∞ÿ©',d:'ÿ£ÿπŸàÿ∞ ÿ®ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÑŸá ÿßŸÑÿ™ÿßŸÖÿßÿ™ ŸÖŸÜ ÿ¥ÿ± ŸÖÿß ÿÆŸÑŸÇ.',r:3},
      {t:'ÿßŸÑÿµŸÑÿßÿ© ÿπŸÑŸâ ÿßŸÑŸÜÿ®Ÿä',d:'ÿßŸÑŸÑŸáŸÖ ÿµŸÑŸêŸë Ÿàÿ≥ŸÑŸêŸëŸÖ ÿπŸÑŸâ ŸÜÿ®ŸäŸêŸëŸÜÿß ŸÖÿ≠ŸÖÿØ.',r:10},
      {t:'ÿØÿπÿßÿ° ÿßŸÑŸÖÿ≥ÿßÿ°',d:'ÿßŸÑŸÑŸáŸÖ ÿ®ŸÉ ÿ£ŸÖÿ≥ŸäŸÜÿß Ÿàÿ®ŸÉ ÿ£ÿµÿ®ÿ≠ŸÜÿß Ÿàÿ®ŸÉ ŸÜÿ≠Ÿäÿß Ÿàÿ®ŸÉ ŸÜŸÖŸàÿ™ Ÿàÿ•ŸÑŸäŸÉ ÿßŸÑŸÜÿ¥Ÿàÿ±.',r:1}
    ],
    sleep:[
      {t:'ÿØÿπÿßÿ° ÿßŸÑŸÜŸàŸÖ',d:'ÿ®ÿßÿ≥ŸÖŸÉ ÿ±ÿ®Ÿä Ÿàÿ∂ÿπÿ™ ÿ¨ŸÜÿ®Ÿä Ÿàÿ®ŸÉ ÿ£ÿ±ŸÅÿπŸáÿå ŸÅÿ•ŸÜ ÿ£ŸÖÿ≥ŸÉÿ™ ŸÜŸÅÿ≥Ÿä ŸÅÿßÿ±ÿ≠ŸÖŸáÿßÿå Ÿàÿ•ŸÜ ÿ£ÿ±ÿ≥ŸÑÿ™Ÿáÿß ŸÅÿßÿ≠ŸÅÿ∏Ÿáÿß ÿ®ŸÖÿß ÿ™ÿ≠ŸÅÿ∏ ÿ®Ÿá ÿπÿ®ÿßÿØŸÉ ÿßŸÑÿµÿßŸÑÿ≠ŸäŸÜ.',r:1},
      {t:'ÿ™ÿ≥ÿ®Ÿäÿ≠ ÿßŸÑŸÜŸàŸÖ',d:'ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá. ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá. ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±.',r:33},
      {t:'ÿßŸÑÿ•ÿÆŸÑÿßÿµ ŸàÿßŸÑŸÖÿπŸàÿ∞ÿ™ÿßŸÜ',d:'ŸÇŸèŸÑŸí ŸáŸèŸàŸé ÿßŸÑŸÑŸéŸëŸáŸè ÿ£Ÿéÿ≠ŸéÿØŸå...',r:3}
    ],
    prayer:[
      {t:'ÿ®ÿπÿØ ÿßŸÑÿ≥ŸÑÿßŸÖ',d:'ÿ£ÿ≥ÿ™ÿ∫ŸÅÿ± ÿßŸÑŸÑŸá. ÿ£ÿ≥ÿ™ÿ∫ŸÅÿ± ÿßŸÑŸÑŸá. ÿ£ÿ≥ÿ™ÿ∫ŸÅÿ± ÿßŸÑŸÑŸá. ÿßŸÑŸÑŸáŸÖ ÿ£ŸÜÿ™ ÿßŸÑÿ≥ŸÑÿßŸÖ ŸàŸÖŸÜŸÉ ÿßŸÑÿ≥ŸÑÿßŸÖÿå ÿ™ÿ®ÿßÿ±ŸÉÿ™ Ÿäÿß ÿ∞ÿß ÿßŸÑÿ¨ŸÑÿßŸÑ ŸàÿßŸÑÿ•ŸÉÿ±ÿßŸÖ.',r:1},
      {t:'ÿßŸÑÿ™ÿ≥ÿ®Ÿäÿ≠ ÿ®ÿπÿØ ÿßŸÑÿµŸÑÿßÿ©',d:'ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá. ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá. ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±.',r:33},
      {t:'ÿØÿπÿßÿ° ÿÆÿ™ŸÖ ÿßŸÑÿµŸÑÿßÿ©',d:'ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá Ÿàÿ≠ÿØŸá ŸÑÿß ÿ¥ÿ±ŸäŸÉ ŸÑŸáÿå ŸÑŸá ÿßŸÑŸÖŸÑŸÉ ŸàŸÑŸá ÿßŸÑÿ≠ŸÖÿØ ŸàŸáŸà ÿπŸÑŸâ ŸÉŸÑ ÿ¥Ÿäÿ° ŸÇÿØŸäÿ±.',r:1}
    ],
    general:[
      {t:'ÿßŸÑÿ≠ŸàŸÇŸÑÿ©',d:'ŸÑÿß ÿ≠ŸàŸÑ ŸàŸÑÿß ŸÇŸàÿ© ÿ•ŸÑÿß ÿ®ÿßŸÑŸÑŸá.',r:10},
      {t:'ÿØÿπÿßÿ° ÿßŸÑŸÉÿ±ÿ®',d:'ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá ÿßŸÑÿπÿ∏ŸäŸÖ ÿßŸÑÿ≠ŸÑŸäŸÖÿå ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá ÿ±ÿ® ÿßŸÑÿπÿ±ÿ¥ ÿßŸÑÿπÿ∏ŸäŸÖÿå ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá ÿ±ÿ® ÿßŸÑÿ≥ŸÖŸàÿßÿ™ Ÿàÿ±ÿ® ÿßŸÑÿ£ÿ±ÿ∂ Ÿàÿ±ÿ® ÿßŸÑÿπÿ±ÿ¥ ÿßŸÑŸÉÿ±ŸäŸÖ.',r:3},
      {t:'ÿßŸÑÿ™ŸáŸÑŸäŸÑ',d:'ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá.',r:100},
      {t:'ÿßŸÑÿ≠ŸÖÿØ',d:'ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá ÿπŸÑŸâ ŸÉŸÑ ÿ≠ÿßŸÑ.',r:10}
    ]
  };
  window._azkarData=azkarData;
  vBody.innerHTML=`<div class="tab-bar">${tabs}</div><div id="azkar-content"></div>`;
  showAzkarCategory('morning',vBody.querySelector('.tbb'));
}
function showAzkarCategory(id,btn){
  document.querySelectorAll('.tab-bar .tbb').forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');
  const data=window._azkarData?.[id]||[];
  let html='';
  data.forEach((a,i)=>{
    const key=id+'_'+i;
    const done=azkarCounts[key]||0;
    const pct=Math.min(100,Math.round(done/a.r*100));
    html+=`<div class="azkar-card">
      <div class="azkar-title">${esc(a.t)}</div>
      <div class="azkar-text">${esc(a.d)}</div>
      <div class="azkar-count"><span>ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${toAr(a.r)} ŸÖÿ±ÿ©</span></div>
      <div class="reading-progress"><div class="reading-fill" id="azfill-${id}-${i}" style="width:${pct}%"></div></div>
      <div class="azkar-actions">
        <button class="azkar-btn" onclick="incAzkar('${id}',${i},${a.r})">ÿπÿØŸë (${toAr(done)}/${toAr(a.r)})</button>
        <button class="azkar-btn" onclick="resetAzkar('${id}',${i})">ÿ•ÿπÿßÿØÿ©</button>
        <button class="azkar-btn" onclick="cpAyah('${esc(a.d)}')">ŸÜÿ≥ÿÆ</button>
      </div>
    </div>`;
  });
  G('azkar-content').innerHTML=html||'<p style="text-align:center;padding:40px;color:var(--gray)">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ∞ŸÉÿßÿ±</p>';
}
function incAzkar(cat,idx,max){
  ck();if(navigator.vibrate)navigator.vibrate(15);
  const key=cat+'_'+idx;
  azkarCounts[key]=(azkarCounts[key]||0)+1;
  if(azkarCounts[key]>=max){sh('üåü ÿ™ŸÖŸÖÿ™ ÿßŸÑÿ∞ŸÉÿ±!');ckOk();if(navigator.vibrate)navigator.vibrate([60,30,60]);azkarCounts[key]=max;}
  localStorage.setItem('azkarCounts',JSON.stringify(azkarCounts));
  // update UI
  const btn=document.querySelector(`[onclick="incAzkar('${cat}',${idx},${max})"]`);
  if(btn)btn.textContent=`ÿπÿØŸë (${toAr(azkarCounts[key])}/${toAr(max)})`;
  const fill=G(`azfill-${cat}-${idx}`);
  if(fill)fill.style.width=Math.min(100,Math.round(azkarCounts[key]/max*100))+'%';
}
function resetAzkar(cat,idx){
  ck();const key=cat+'_'+idx;azkarCounts[key]=0;
  localStorage.setItem('azkarCounts',JSON.stringify(azkarCounts));
  const fill=G(`azfill-${cat}-${idx}`);if(fill)fill.style.width='0%';
  sh('ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿπÿØÿßÿØ');
}

/* ============================================================
   DUAS (new feature)
============================================================ */
function renderDuas(){
  vTitle.textContent='ÿßŸÑÿ£ÿØÿπŸäÿ© ÿßŸÑŸÖÿ£ÿ´Ÿàÿ±ÿ© ü§≤';
  const duas=[
    {t:'ÿØÿπÿßÿ° ÿßŸÑÿßÿ≥ÿ™ÿÆÿßÿ±ÿ©',d:'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿ≥ÿ™ÿÆŸäÿ±ŸÉ ÿ®ÿπŸÑŸÖŸÉ Ÿàÿ£ÿ≥ÿ™ŸÇÿØÿ±ŸÉ ÿ®ŸÇÿØÿ±ÿ™ŸÉ Ÿàÿ£ÿ≥ÿ£ŸÑŸÉ ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿßŸÑÿπÿ∏ŸäŸÖÿå ŸÅÿ•ŸÜŸÉ ÿ™ŸÇÿØÿ± ŸàŸÑÿß ÿ£ŸÇÿØÿ± Ÿàÿ™ÿπŸÑŸÖ ŸàŸÑÿß ÿ£ÿπŸÑŸÖ Ÿàÿ£ŸÜÿ™ ÿπŸÑÿßŸÖ ÿßŸÑÿ∫ŸäŸàÿ®.',s:'ÿµÿ≠Ÿäÿ≠ ÿßŸÑÿ®ÿÆÿßÿ±Ÿä'},
    {t:'ÿØÿπÿßÿ° ÿßŸÑŸÇŸÜŸàÿ™',d:'ÿßŸÑŸÑŸáŸÖ ÿßŸáÿØŸÜŸä ŸÅŸäŸÖŸÜ ŸáÿØŸäÿ™ ŸàÿπÿßŸÅŸÜŸä ŸÅŸäŸÖŸÜ ÿπÿßŸÅŸäÿ™ Ÿàÿ™ŸàŸÑŸëŸÜŸä ŸÅŸäŸÖŸÜ ÿ™ŸàŸÑŸëŸäÿ™ Ÿàÿ®ÿßÿ±ŸÉ ŸÑŸä ŸÅŸäŸÖÿß ÿ£ÿπÿ∑Ÿäÿ™ ŸàŸÇŸÜŸä ÿ¥ÿ± ŸÖÿß ŸÇÿ∂Ÿäÿ™.',s:'ÿ≠ÿØŸäÿ´ ÿ¥ÿ±ŸäŸÅ'},
    {t:'ÿØÿπÿßÿ° ÿßŸÑŸáŸÖ ŸàÿßŸÑÿ≠ÿ≤ŸÜ',d:'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿπÿ®ÿØŸÉ ÿßÿ®ŸÜ ÿπÿ®ÿØŸÉ ÿßÿ®ŸÜ ÿ£ŸÖÿ™ŸÉÿå ŸÜÿßÿµŸäÿ™Ÿä ÿ®ŸäÿØŸÉÿå ŸÖÿßÿ∂Ÿç ŸÅŸäŸë ÿ≠ŸÉŸÖŸÉÿå ÿπÿØŸÑ ŸÅŸäŸë ŸÇÿ∂ÿßÿ§ŸÉÿå ÿ£ÿ≥ÿ£ŸÑŸÉ ÿ®ŸÉŸÑ ÿßÿ≥ŸÖ ŸáŸà ŸÑŸÉ ÿ≥ŸÖŸäŸëÿ™ ÿ®Ÿá ŸÜŸÅÿ≥ŸÉ ÿ£Ÿà ÿ£ŸÜÿ≤ŸÑÿ™Ÿá ŸÅŸä ŸÉÿ™ÿßÿ®ŸÉ.',s:'ÿµÿ≠Ÿäÿ≠ ÿßÿ®ŸÜ ÿ≠ÿ®ÿßŸÜ'},
    {t:'ÿØÿπÿßÿ° ÿßŸÑÿ≥ŸÅÿ±',d:'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜÿß ŸÜÿ≥ÿ£ŸÑŸÉ ŸÅŸä ÿ≥ŸÅÿ±ŸÜÿß Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ± ŸàÿßŸÑÿ™ŸÇŸàŸâ ŸàŸÖŸÜ ÿßŸÑÿπŸÖŸÑ ŸÖÿß ÿ™ÿ±ÿ∂Ÿâÿå ÿßŸÑŸÑŸáŸÖ ŸáŸàŸëŸÜ ÿπŸÑŸäŸÜÿß ÿ≥ŸÅÿ±ŸÜÿß Ÿáÿ∞ÿß Ÿàÿßÿ∑ŸàŸê ÿπŸÜÿß ÿ®ŸèÿπÿØŸá.',s:'ÿµÿ≠Ÿäÿ≠ ŸÖÿ≥ŸÑŸÖ'},
    {t:'ÿØÿπÿßÿ° ÿßŸÑÿ±ÿ≤ŸÇ',d:'ÿßŸÑŸÑŸáŸÖ ÿßŸÉŸÅŸÜŸä ÿ®ÿ≠ŸÑÿßŸÑŸÉ ÿπŸÜ ÿ≠ÿ±ÿßŸÖŸÉ Ÿàÿ£ÿ∫ŸÜŸÜŸä ÿ®ŸÅÿ∂ŸÑŸÉ ÿπŸÖŸéŸëŸÜ ÿ≥ŸàÿßŸÉ.',s:'ÿ≥ŸÜŸÜ ÿßŸÑÿ™ÿ±ŸÖÿ∞Ÿä'},
    {t:'ÿØÿπÿßÿ° ÿßŸÑŸÖÿ±Ÿäÿ∂',d:'ÿßŸÑŸÑŸáŸÖ ÿ±ÿ® ÿßŸÑŸÜÿßÿ≥ ÿ£ÿ∞Ÿáÿ® ÿßŸÑÿ®ÿ£ÿ≥ Ÿàÿßÿ¥ŸÅŸê ÿ£ŸÜÿ™ ÿßŸÑÿ¥ÿßŸÅŸä ŸÑÿß ÿ¥ŸÅÿßÿ° ÿ•ŸÑÿß ÿ¥ŸÅÿßÿ§ŸÉ ÿ¥ŸÅÿßÿ°Ÿã ŸÑÿß Ÿäÿ∫ÿßÿØÿ± ÿ≥ŸÇŸÖÿßŸã.',s:'ŸÖÿ™ŸÅŸÇ ÿπŸÑŸäŸá'},
    {t:'ÿØÿπÿßÿ° ÿßŸÑŸÅÿ±ÿ¨',d:'ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿ£ŸÜÿ™ ÿ≥ÿ®ÿ≠ÿßŸÜŸÉ ÿ•ŸÜŸä ŸÉŸÜÿ™ ŸÖŸÜ ÿßŸÑÿ∏ÿßŸÑŸÖŸäŸÜ.',s:'ÿØÿπÿßÿ° ŸäŸàŸÜÿ≥ ÿπŸÑŸäŸá ÿßŸÑÿ≥ŸÑÿßŸÖ'},
    {t:'ÿØÿπÿßÿ° ÿØÿÆŸàŸÑ ÿßŸÑŸÖŸÜÿ≤ŸÑ',d:'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿ≥ÿ£ŸÑŸÉ ÿÆŸäÿ± ÿßŸÑŸÖŸàŸÑÿ¨ ŸàÿÆŸäÿ± ÿßŸÑŸÖÿÆÿ±ÿ¨ÿå ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá ŸàŸÑÿ¨ŸÜÿß Ÿàÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá ÿÆÿ±ÿ¨ŸÜÿß ŸàÿπŸÑŸâ ÿßŸÑŸÑŸá ÿ±ÿ®ŸÜÿß ÿ™ŸàŸÉŸÑŸÜÿß.',s:'ÿ≥ŸÜŸÜ ÿ£ÿ®Ÿä ÿØÿßŸàÿØ'},
    {t:'ÿØÿπÿßÿ° ÿßŸÑÿ¥ŸÉÿ±',d:'ÿßŸÑŸÑŸáŸÖ ÿ£ÿπŸÜŸëŸä ÿπŸÑŸâ ÿ∞ŸÉÿ±ŸÉ Ÿàÿ¥ŸÉÿ±ŸÉ Ÿàÿ≠ÿ≥ŸÜ ÿπÿ®ÿßÿØÿ™ŸÉ.',s:'ÿ≥ŸÜŸÜ ÿ£ÿ®Ÿä ÿØÿßŸàÿØ'},
    {t:'ÿØÿπÿßÿ° ŸÑŸäŸÑÿ© ÿßŸÑŸÇÿØÿ±',d:'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸÉ ÿπŸÅŸà ÿ™ÿ≠ÿ® ÿßŸÑÿπŸÅŸà ŸÅÿßÿπŸÅŸè ÿπŸÜŸëŸä.',s:'ÿ≥ŸÜŸÜ ÿßŸÑÿ™ÿ±ŸÖÿ∞Ÿä'},
    {t:'ÿØÿπÿßÿ° ÿ∑ŸÑÿ® ÿßŸÑÿπŸÑŸÖ',d:'ÿ±ÿ® ÿ≤ÿØŸÜŸä ÿπŸÑŸÖÿßŸã.',s:'ÿ≥Ÿàÿ±ÿ© ÿ∑Ÿá'},
    {t:'ÿØÿπÿßÿ° ÿßŸÑÿµÿ®ÿßÿ≠ ŸàÿßŸÑŸÖÿ≥ÿßÿ°',d:'ÿßŸÑŸÑŸáŸÖ ÿπÿßŸÅŸÜŸä ŸÅŸä ÿ®ÿØŸÜŸäÿå ÿßŸÑŸÑŸáŸÖ ÿπÿßŸÅŸÜŸä ŸÅŸä ÿ≥ŸÖÿπŸäÿå ÿßŸÑŸÑŸáŸÖ ÿπÿßŸÅŸÜŸä ŸÅŸä ÿ®ÿµÿ±Ÿäÿå ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿ£ŸÜÿ™.',s:'ÿ≥ŸÜŸÜ ÿ£ÿ®Ÿä ÿØÿßŸàÿØ'}
  ];
  let html='<div class="grid" style="margin-top:14px">';
  duas.forEach((d,i)=>{
    html+=`<div class="card" onclick="ck();showDua(${i})"><span style="font-size:1.8em">ü§≤</span><b style="font-size:.85em">${esc(d.t)}</b></div>`;
  });
  vBody.innerHTML=html+'</div>';
  window._duas=duas;
}
function showDua(i){
  const d=window._duas[i];if(!d)return;
  ck();
  G('dua-title').textContent=d.t;
  G('dua-text').textContent=d.d;
  G('dua-source').textContent='ÿßŸÑŸÖÿµÿØÿ±: '+d.s;
  G('dua-modal').classList.add('show');
}
function closeDua(){G('dua-modal').classList.remove('show');}
function cpDua(){const t=G('dua-title').textContent+'\n\n'+G('dua-text').textContent;cpAyah(t);}

/* ============================================================
   NAMES
============================================================ */
function renderNames(){
  vTitle.textContent='ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÑŸá ÿßŸÑÿ≠ÿ≥ŸÜŸâ ‚ú®';
  const nd=[
    {n:'ÿßŸÑÿ±ÿ≠ŸÖŸÜ',m:'ÿßŸÑÿ∞Ÿä Ÿàÿ≥ÿπÿ™ ÿ±ÿ≠ŸÖÿ™Ÿá ŸÉŸÑ ÿ¥Ÿäÿ°'},{n:'ÿßŸÑÿ±ÿ≠ŸäŸÖ',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ±ÿ≠ŸÖ ÿπÿ®ÿßÿØŸá ÿßŸÑŸÖÿ§ŸÖŸÜŸäŸÜ'},{n:'ÿßŸÑŸÖŸÑŸÉ',m:'ŸÖÿßŸÑŸÉ ÿßŸÑŸÖŸÑŸÉ ŸÉŸÑŸá'},{n:'ÿßŸÑŸÇÿØŸàÿ≥',m:'ÿßŸÑŸÖŸÜÿ≤ŸëŸá ÿπŸÜ ŸÉŸÑ ŸÜŸÇÿµ'},{n:'ÿßŸÑÿ≥ŸÑÿßŸÖ',m:'ÿßŸÑÿ∞Ÿä ÿ≥ŸÑŸÖ ŸÖŸÜ ŸÉŸÑ ÿπŸäÿ®'},{n:'ÿßŸÑŸÖÿ§ŸÖŸÜ',m:'ÿßŸÑÿ∞Ÿä ÿ£ŸÖŸëŸÜ ÿπÿ®ÿßÿØŸá ŸÖŸÜ ÿπÿ∞ÿßÿ®Ÿá'},{n:'ÿßŸÑŸÖŸáŸäŸÖŸÜ',m:'ÿßŸÑÿ¥ÿßŸáÿØ ÿßŸÑÿ±ŸÇŸäÿ® ÿπŸÑŸâ ÿÆŸÑŸÇŸá'},{n:'ÿßŸÑÿπÿ≤Ÿäÿ≤',m:'ÿßŸÑÿ∫ÿßŸÑÿ® ÿßŸÑÿ∞Ÿä ŸÑÿß ŸäŸèÿ∫ŸÑÿ®'},{n:'ÿßŸÑÿ¨ÿ®ÿßÿ±',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ¨ÿ®ÿ± ÿßŸÑŸÉÿ≥Ÿäÿ± ŸàŸäŸÇŸáÿ± ÿßŸÑÿπÿµÿßÿ©'},{n:'ÿßŸÑŸÖÿ™ŸÉÿ®ÿ±',m:'ÿßŸÑŸÖÿ™ÿπÿßŸÑŸä ÿπŸÜ ÿµŸÅÿßÿ™ ÿßŸÑŸÜŸÇÿµ'},{n:'ÿßŸÑÿÆÿßŸÑŸÇ',m:'ÿßŸÑŸÖŸàÿ¨ÿØ ŸÑŸÑÿ£ÿ¥Ÿäÿßÿ° ŸÖŸÜ ÿßŸÑÿπÿØŸÖ'},{n:'ÿßŸÑÿ®ÿßÿ±ÿ¶',m:'ÿßŸÑÿÆÿßŸÑŸÇ ÿπŸÑŸâ ÿ∫Ÿäÿ± ŸÖÿ´ÿßŸÑ ÿ≥ÿßÿ®ŸÇ'},{n:'ÿßŸÑŸÖÿµŸàÿ±',m:'ÿßŸÑÿ∞Ÿä ŸäÿµŸàÿ± ÿßŸÑÿÆŸÑŸÇ ŸÉŸäŸÅ Ÿäÿ¥ÿßÿ°'},{n:'ÿßŸÑÿ∫ŸÅÿßÿ±',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ∫ŸÅÿ± ÿßŸÑÿ∞ŸÜŸàÿ® ŸÖÿ±ÿßÿ±ÿßŸã'},{n:'ÿßŸÑŸÇŸáÿßÿ±',m:'ÿßŸÑÿ∫ÿßŸÑÿ® ÿßŸÑÿ∞Ÿä ŸÇŸáÿ± ŸÉŸÑ ÿ¥Ÿäÿ°'},{n:'ÿßŸÑŸàŸáÿßÿ®',m:'ÿßŸÑŸÉÿ´Ÿäÿ± ÿßŸÑÿπÿ∑ÿßÿ° ÿ®ŸÑÿß ŸÖŸÇÿßÿ®ŸÑ'},{n:'ÿßŸÑÿ±ÿ≤ÿßŸÇ',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ±ÿ≤ŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑÿÆŸÑŸÇ'},{n:'ÿßŸÑŸÅÿ™ÿßÿ≠',m:'ÿßŸÑÿ∞Ÿä ŸäŸÅÿ™ÿ≠ ÿ£ÿ®Ÿàÿßÿ® ÿßŸÑÿ±ÿ≠ŸÖÿ© ŸàÿßŸÑÿÆŸäÿ±'},{n:'ÿßŸÑÿπŸÑŸäŸÖ',m:'ÿßŸÑÿ∞Ÿä ÿ£ÿ≠ÿßÿ∑ ÿπŸÑŸÖŸá ÿ®ŸÉŸÑ ÿ¥Ÿäÿ°'},{n:'ÿßŸÑŸÇÿßÿ®ÿ∂',m:'ÿßŸÑÿ∞Ÿä ŸäŸÇÿ®ÿ∂ ÿßŸÑÿ£ÿ±ÿ≤ÿßŸÇ ÿ®ÿ≠ŸÉŸÖÿ©'},{n:'ÿßŸÑÿ®ÿßÿ≥ÿ∑',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ®ÿ≥ÿ∑ ÿßŸÑÿ±ÿ≤ŸÇ ŸÑŸÖŸÜ Ÿäÿ¥ÿßÿ°'},{n:'ÿßŸÑÿÆÿßŸÅÿ∂',m:'ÿßŸÑÿ∞Ÿä ŸäÿÆŸÅÿ∂ ÿßŸÑÿ¨ÿ®ÿßÿ±ŸäŸÜ'},{n:'ÿßŸÑÿ±ÿßŸÅÿπ',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ±ŸÅÿπ ÿßŸÑŸÖÿ§ŸÖŸÜŸäŸÜ'},{n:'ÿßŸÑŸÖÿπÿ≤',m:'ÿßŸÑÿ∞Ÿä Ÿäÿπÿ≤ ŸÖŸÜ Ÿäÿ¥ÿßÿ°'},{n:'ÿßŸÑŸÖÿ∞ŸÑ',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ∞ŸÑ ŸÖŸÜ Ÿäÿ¥ÿßÿ°'},{n:'ÿßŸÑÿ≥ŸÖŸäÿπ',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ≥ŸÖÿπ ŸÉŸÑ ÿ¥Ÿäÿ°'},{n:'ÿßŸÑÿ®ÿµŸäÿ±',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ±Ÿâ ŸÉŸÑ ÿ¥Ÿäÿ°'},{n:'ÿßŸÑÿ≠ŸÉŸÖ',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ≠ŸÉŸÖ ÿ®ŸäŸÜ ÿßŸÑÿÆŸÑŸÇ ÿ®ÿπÿØŸÑ'},{n:'ÿßŸÑÿπÿØŸÑ',m:'ÿßŸÑÿ∞Ÿä ŸÑÿß Ÿäÿ∏ŸÑŸÖ ÿ£ÿ≠ÿØÿßŸã'},{n:'ÿßŸÑŸÑÿ∑ŸäŸÅ',m:'ÿßŸÑÿπŸÑŸäŸÖ ÿ®ÿØŸÇÿßÿ¶ŸÇ ÿßŸÑÿ£ŸÖŸàÿ±'},{n:'ÿßŸÑÿÆÿ®Ÿäÿ±',m:'ÿßŸÑŸÖÿ∑ŸÑÿπ ÿπŸÑŸâ ÿ≠ŸÇÿßÿ¶ŸÇ ÿßŸÑÿ£ÿ¥Ÿäÿßÿ° ÿßŸÑÿ®ÿßÿ∑ŸÜÿ©'},{n:'ÿßŸÑÿ≠ŸÑŸäŸÖ',m:'ÿßŸÑÿ∞Ÿä ŸÑÿß Ÿäÿπÿ¨ŸÑ ÿ®ÿßŸÑÿπŸÇŸàÿ®ÿ©'},{n:'ÿßŸÑÿπÿ∏ŸäŸÖ',m:'ÿßŸÑÿ¨ÿßŸÖÿπ ŸÑÿµŸÅÿßÿ™ ÿßŸÑÿπÿ∏ŸÖÿ©'},{n:'ÿßŸÑÿ∫ŸÅŸàÿ±',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ∫ŸÅÿ± ÿßŸÑÿ∞ŸÜŸàÿ® ÿ¨ŸÖŸäÿπŸáÿß'},{n:'ÿßŸÑÿ¥ŸÉŸàÿ±',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ¥ŸÉÿ± ÿßŸÑŸÇŸÑŸäŸÑ ŸÖŸÜ ÿßŸÑÿπŸÖŸÑ'},{n:'ÿßŸÑÿπŸÑŸä',m:'ÿßŸÑŸÖÿ™ÿπÿßŸÑŸä ŸÅŸàŸÇ ÿÆŸÑŸÇŸá'},{n:'ÿßŸÑŸÉÿ®Ÿäÿ±',m:'ÿßŸÑŸÉÿ®Ÿäÿ± ÿßŸÑÿ∞Ÿä ŸÉŸÑ ÿ¥Ÿäÿ° ÿØŸàŸÜŸá'},{n:'ÿßŸÑÿ≠ŸÅŸäÿ∏',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ≠ŸÅÿ∏ ÿÆŸÑŸÇŸá'},{n:'ÿßŸÑŸÖŸÇŸäÿ™',m:'ÿßŸÑÿ±ÿßÿ≤ŸÇ ÿßŸÑŸÇÿßÿ¶ŸÖ ÿπŸÑŸâ ŸÉŸÑ ŸÜŸÅÿ≥'},{n:'ÿßŸÑÿ≠ÿ≥Ÿäÿ®',m:'ÿßŸÑŸÉÿßŸÅŸä ÿßŸÑÿ∞Ÿä Ÿäÿ≠ÿßÿ≥ÿ® ÿßŸÑÿπÿ®ÿßÿØ'},{n:'ÿßŸÑÿ¨ŸÑŸäŸÑ',m:'ÿ∞Ÿà ÿßŸÑÿ¨ŸÑÿßŸÑ ŸàÿßŸÑÿπÿ∏ŸÖÿ©'},{n:'ÿßŸÑŸÉÿ±ŸäŸÖ',m:'ÿßŸÑÿ¨ŸàÿßÿØ ÿßŸÑŸÉÿ´Ÿäÿ± ÿßŸÑÿÆŸäÿ±'},{n:'ÿßŸÑÿ±ŸÇŸäÿ®',m:'ÿßŸÑÿ¥ÿßŸáÿØ ÿßŸÑÿ≠ŸÅŸäÿ∏ ÿßŸÑÿ∞Ÿä ŸÑÿß Ÿäÿ∫ŸÅŸÑ'},{n:'ÿßŸÑŸÖÿ¨Ÿäÿ®',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ¨Ÿäÿ® ÿØÿπÿßÿ° ŸÖŸÜ ÿØÿπÿßŸá'},{n:'ÿßŸÑŸàÿßÿ≥ÿπ',m:'ÿßŸÑÿ∞Ÿä Ÿàÿ≥ÿπ ÿπŸÑŸÖŸá ŸàŸÅÿ∂ŸÑŸá ŸÉŸÑ ÿ¥Ÿäÿ°'},{n:'ÿßŸÑÿ≠ŸÉŸäŸÖ',m:'ÿ∞Ÿà ÿßŸÑÿ≠ŸÉŸÖÿ© ÿßŸÑÿ™ÿßŸÖÿ© ŸÅŸä ÿ£ŸÅÿπÿßŸÑŸá'},{n:'ÿßŸÑŸàÿØŸàÿØ',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ≠ÿ® ÿπÿ®ÿßÿØŸá ÿßŸÑÿµÿßŸÑÿ≠ŸäŸÜ'},{n:'ÿßŸÑŸÖÿ¨ŸäÿØ',m:'ÿßŸÑÿ±ŸÅŸäÿπ ÿ¥ÿ£ŸÜŸá ÿßŸÑÿπÿ∏ŸäŸÖ ŸÇÿØÿ±Ÿá'},{n:'ÿßŸÑÿ®ÿßÿπÿ´',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ®ÿπÿ´ ÿßŸÑŸÖŸàÿ™Ÿâ ŸäŸàŸÖ ÿßŸÑŸÇŸäÿßŸÖÿ©'},{n:'ÿßŸÑÿ¥ŸáŸäÿØ',m:'ÿßŸÑÿ≠ÿßÿ∂ÿ± ÿßŸÑÿ∞Ÿä ŸÑÿß Ÿäÿ∫Ÿäÿ® ÿπŸÜ ÿπŸÑŸÖŸá ÿ¥Ÿäÿ°'},{n:'ÿßŸÑÿ≠ŸÇ',m:'ÿßŸÑŸÖŸàÿ¨ŸàÿØ ÿ≠ŸÇÿßŸã ÿßŸÑÿ´ÿßÿ®ÿ™ ÿ£ÿ®ÿØÿßŸã'},{n:'ÿßŸÑŸàŸÉŸäŸÑ',m:'ÿßŸÑŸÉÿßŸÅŸä ŸÑŸÖŸÜ ÿ™ŸàŸÉŸÑ ÿπŸÑŸäŸá'},{n:'ÿßŸÑŸÇŸàŸä',m:'ÿßŸÑÿ™ÿßŸÖ ÿßŸÑŸÇŸàÿ© ÿßŸÑÿ∞Ÿä ŸÑÿß ŸäŸèÿπÿ¨ÿ≤Ÿá ÿ¥Ÿäÿ°'},{n:'ÿßŸÑŸÖÿ™ŸäŸÜ',m:'ÿßŸÑÿ¥ÿØŸäÿØ ÿßŸÑŸÇŸàÿ© ŸàÿßŸÑÿ®ÿ∑ÿ¥'},{n:'ÿßŸÑŸàŸÑŸä',m:'ÿßŸÑŸÜÿßÿµÿ± ŸÑÿπÿ®ÿßÿØŸá ÿßŸÑŸÖÿ§ŸÖŸÜŸäŸÜ'},{n:'ÿßŸÑÿ≠ŸÖŸäÿØ',m:'ÿßŸÑŸÖÿ≠ŸÖŸàÿØ ÿ®ŸÉŸÑ ŸÑÿ≥ÿßŸÜ'},{n:'ÿßŸÑŸÖÿ≠ÿµŸä',m:'ÿßŸÑÿ∞Ÿä ÿ£ÿ≠ÿµŸâ ŸÉŸÑ ÿ¥Ÿäÿ° ÿπÿØÿØÿßŸã'},{n:'ÿßŸÑŸÖÿ®ÿØÿ¶',m:'ÿßŸÑÿ∞Ÿä ÿ®ÿØÿ£ ÿßŸÑÿÆŸÑŸÇ ŸÖŸÜ ÿßŸÑÿπÿØŸÖ'},{n:'ÿßŸÑŸÖÿπŸäÿØ',m:'ÿßŸÑÿ∞Ÿä ŸäÿπŸäÿØ ÿßŸÑÿÆŸÑŸÇ ÿ®ÿπÿØ ÿßŸÑŸÅŸÜÿßÿ°'},{n:'ÿßŸÑŸÖÿ≠ŸäŸä',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ≠ŸäŸä ÿßŸÑŸÖŸàÿ™Ÿâ'},{n:'ÿßŸÑŸÖŸÖŸäÿ™',m:'ÿßŸÑÿ∞Ÿä ŸäŸÖŸäÿ™ ÿßŸÑÿ£ÿ≠Ÿäÿßÿ°'},{n:'ÿßŸÑÿ≠Ÿä',m:'ÿßŸÑÿØÿßÿ¶ŸÖ ÿßŸÑÿ≠Ÿäÿßÿ© ÿßŸÑÿ∞Ÿä ŸÑÿß ŸäŸÖŸàÿ™'},{n:'ÿßŸÑŸÇŸäŸàŸÖ',m:'ÿßŸÑŸÇÿßÿ¶ŸÖ ÿ®ŸÜŸÅÿ≥Ÿá ÿßŸÑŸÖŸèŸÇŸäŸÖ ŸÑÿ∫Ÿäÿ±Ÿá'},{n:'ÿßŸÑŸàÿßÿ¨ÿØ',m:'ÿßŸÑÿ∫ŸÜŸä ÿßŸÑÿ∞Ÿä ŸÑÿß ŸäŸÅÿ™ŸÇÿ± ŸÑÿ¥Ÿäÿ°'},{n:'ÿßŸÑŸÖÿßÿ¨ÿØ',m:'ÿßŸÑÿ¥ÿ±ŸäŸÅ ÿ∞Ÿà ÿßŸÑŸÖÿ¨ÿØ ŸàÿßŸÑŸÉÿ±ŸÖ'},{n:'ÿßŸÑŸàÿßÿ≠ÿØ',m:'ÿßŸÑŸÖŸÜŸÅÿ±ÿØ ÿ®ÿ∞ÿßÿ™Ÿá ŸàÿµŸÅÿßÿ™Ÿá'},{n:'ÿßŸÑÿ£ÿ≠ÿØ',m:'ÿßŸÑŸÅÿ±ÿØ ÿßŸÑÿ∞Ÿä ŸÑÿß ÿ¥ÿ±ŸäŸÉ ŸÑŸá'},{n:'ÿßŸÑÿµŸÖÿØ',m:'ÿßŸÑÿ∞Ÿä ŸäŸèŸÇÿµÿØ ŸÅŸä ÿßŸÑÿ≠Ÿàÿßÿ¶ÿ¨ ŸÉŸÑŸáÿß'},{n:'ÿßŸÑŸÇÿßÿØÿ±',m:'ÿßŸÑÿ∞Ÿä ŸäŸÇÿØÿ± ÿπŸÑŸâ ŸÉŸÑ ÿ¥Ÿäÿ°'},{n:'ÿßŸÑŸÖŸÇÿ™ÿØÿ±',m:'ÿßŸÑÿ¥ÿØŸäÿØ ÿßŸÑŸÇÿØÿ±ÿ©'},{n:'ÿßŸÑŸÖŸÇÿØŸÖ',m:'ÿßŸÑÿ∞Ÿä ŸäŸÇÿØŸÖ ŸÖÿß ÿ¥ÿßÿ°'},{n:'ÿßŸÑŸÖÿ§ÿÆÿ±',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ§ÿÆÿ± ŸÖÿß ÿ¥ÿßÿ° ÿ®ÿ≠ŸÉŸÖÿ©'},{n:'ÿßŸÑÿ£ŸàŸÑ',m:'ÿßŸÑÿ∞Ÿä ŸÑŸäÿ≥ ŸÇÿ®ŸÑŸá ÿ¥Ÿäÿ°'},{n:'ÿßŸÑÿ¢ÿÆÿ±',m:'ÿßŸÑÿ∞Ÿä ŸÑŸäÿ≥ ÿ®ÿπÿØŸá ÿ¥Ÿäÿ°'},{n:'ÿßŸÑÿ∏ÿßŸáÿ±',m:'ÿßŸÑÿ∞Ÿä ÿ∏Ÿáÿ± ŸÅŸàŸÇ ŸÉŸÑ ÿ¥Ÿäÿ° ÿ®ŸÇÿØÿ±ÿ™Ÿá'},{n:'ÿßŸÑÿ®ÿßÿ∑ŸÜ',m:'ÿßŸÑÿπÿßŸÑŸÖ ÿ®ŸÉŸÑ ÿÆŸÅŸäÿ© Ÿàÿ≥ÿ±'},{n:'ÿßŸÑŸàÿßŸÑŸä',m:'ÿßŸÑŸÖÿßŸÑŸÉ ÿßŸÑŸÖÿ™ÿµÿ±ŸÅ ŸÅŸä ŸÉŸÑ ÿ¥Ÿäÿ°'},{n:'ÿßŸÑŸÖÿ™ÿπÿßŸÑŸä',m:'ÿßŸÑÿπÿßŸÑŸä ÿπŸÑŸâ ŸÉŸÑ ÿ¥Ÿäÿ° ÿ®ÿπÿ∏ŸÖÿ™Ÿá'},{n:'ÿßŸÑÿ®ÿ±',m:'ÿßŸÑÿπÿ∑ŸàŸÅ ÿπŸÑŸâ ÿπÿ®ÿßÿØŸá ÿßŸÑÿ±ÿ≠ŸäŸÖ ÿ®ŸáŸÖ'},{n:'ÿßŸÑÿ™Ÿàÿßÿ®',m:'ÿßŸÑÿ∞Ÿä ŸäŸÉÿ´ÿ± ŸÇÿ®ŸàŸÑ ÿ™Ÿàÿ®ÿ© ÿπÿ®ÿßÿØŸá'},{n:'ÿßŸÑŸÖŸÜÿ™ŸÇŸÖ',m:'ÿßŸÑÿ∞Ÿä ŸäŸÜÿ™ŸÇŸÖ ŸÖŸÜ ÿßŸÑÿ∏ÿßŸÑŸÖŸäŸÜ'},{n:'ÿßŸÑÿπŸÅŸà',m:'ÿßŸÑÿ∞Ÿä ŸäŸÖÿ≠Ÿà ÿßŸÑÿ∞ŸÜŸàÿ® ŸàŸäÿµŸÅÿ≠'},{n:'ÿßŸÑÿ±ÿ§ŸàŸÅ',m:'ÿßŸÑÿ±ŸÇŸäŸÇ ÿßŸÑÿπÿ∑ŸàŸÅ ÿπŸÑŸâ ÿπÿ®ÿßÿØŸá'},{n:'ŸÖÿßŸÑŸÉ ÿßŸÑŸÖŸÑŸÉ',m:'ŸÖÿßŸÑŸÉ ÿßŸÑÿØŸÜŸäÿß ŸàÿßŸÑÿ¢ÿÆÿ±ÿ©'},{n:'ÿ∞Ÿà ÿßŸÑÿ¨ŸÑÿßŸÑ',m:'ÿµÿßÿ≠ÿ® ÿßŸÑÿπÿ∏ŸÖÿ© ŸàÿßŸÑŸÉÿ±ŸÖ ÿßŸÑÿ™ÿßŸÖ'},{n:'ÿßŸÑŸÖŸÇÿ≥ÿ∑',m:'ÿßŸÑÿπÿßÿØŸÑ ŸÅŸä ÿ≠ŸÉŸÖŸá ŸàŸÇÿ∂ÿßÿ¶Ÿá'},{n:'ÿßŸÑÿ¨ÿßŸÖÿπ',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ¨ŸÖÿπ ÿßŸÑÿÆŸÑŸÇ ŸÑŸÑÿ≠ÿ≥ÿßÿ®'},{n:'ÿßŸÑÿ∫ŸÜŸä',m:'ÿßŸÑÿ∞Ÿä ŸÑÿß Ÿäÿ≠ÿ™ÿßÿ¨ ŸÑÿ£ÿ≠ÿØ'},{n:'ÿßŸÑŸÖÿ∫ŸÜŸä',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ∫ŸÜŸä ŸÖŸÜ Ÿäÿ¥ÿßÿ° ŸÖŸÜ ÿπÿ®ÿßÿØŸá'},{n:'ÿßŸÑŸÖÿßŸÜÿπ',m:'ÿßŸÑÿ∞Ÿä ŸäŸÖŸÜÿπ ŸÖÿß Ÿäÿ¥ÿßÿ° ÿ®ÿ≠ŸÉŸÖÿ™Ÿá'},{n:'ÿßŸÑÿ∂ÿßÿ±',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ∂ÿ± ŸÖŸÜ Ÿäÿ¥ÿßÿ° ÿπÿØŸÑÿßŸã'},{n:'ÿßŸÑŸÜÿßŸÅÿπ',m:'ÿßŸÑÿ∞Ÿä ŸäŸÜŸÅÿπ ŸÖŸÜ Ÿäÿ¥ÿßÿ° ŸÅÿ∂ŸÑÿßŸã'},{n:'ÿßŸÑŸÜŸàÿ±',m:'ÿßŸÑÿ∞Ÿä ŸÜŸàŸëÿ± ÿßŸÑÿ≥ŸÖÿßŸàÿßÿ™ ŸàÿßŸÑÿ£ÿ±ÿ∂'},{n:'ÿßŸÑŸáÿßÿØŸä',m:'ÿßŸÑÿ∞Ÿä ŸäŸáÿØŸä ŸÖŸÜ Ÿäÿ¥ÿßÿ° ŸÑÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ≠ŸÇ'},{n:'ÿßŸÑÿ®ÿØŸäÿπ',m:'ÿßŸÑŸÖÿ®ÿ™ŸÉÿ± ŸÑŸÑÿ£ÿ¥Ÿäÿßÿ° ÿ®ŸÑÿß ŸÖÿ´ÿßŸÑ'},{n:'ÿßŸÑÿ®ÿßŸÇŸä',m:'ÿßŸÑÿ∞Ÿä ŸÑÿß ŸäŸÅŸÜŸâ ŸàŸÑÿß Ÿäÿ≤ŸàŸÑ'},{n:'ÿßŸÑŸàÿßÿ±ÿ´',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ±ÿ´ ÿßŸÑÿ£ÿ±ÿ∂ ŸàŸÖŸÜ ÿπŸÑŸäŸáÿß'},{n:'ÿßŸÑÿ±ÿ¥ŸäÿØ',m:'ÿßŸÑÿ∞Ÿä Ÿäÿ±ÿ¥ÿØ ÿ•ŸÑŸâ ÿßŸÑÿµŸàÿßÿ®'},{n:'ÿßŸÑÿµÿ®Ÿàÿ±',m:'ÿßŸÑÿ∞Ÿä ŸÑÿß Ÿäÿπÿ¨ŸÑ ÿπŸÑŸâ ŸÖŸÜ ÿπÿµÿßŸá'}
  ];
  let html='<div class="grid" style="margin-top:14px">';
  nd.forEach((it,i)=>{
    html+=`<div class="name-card" onclick="ck();showNameDetail('${esc(it.n)}','${esc(it.m)}',${i+1})">
      <div style="color:var(--accent);font-size:.73em">${toAr(i+1)}</div>
      <b style="font-size:1em">${esc(it.n)}</b>
      <div class="name-meaning">${esc(it.m)}</div>
    </div>`;
  });
  vBody.innerHTML=html+'</div>';
}
function showNameDetail(name,meaning,num){
  sh(`${name} (${num}/99): ${meaning}`,4000);
}

/* ============================================================
   KHATMA
============================================================ */
function renderKhatma(){
  vTitle.textContent='ÿßŸÑÿÆÿ™ŸÖÿ© ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ© üåü';
  vBody.innerHTML=`<div style="text-align:center;padding:32px 20px">
    <div style="font-size:1em;color:var(--text);margin-bottom:6px;opacity:.7">ÿ•ŸÜÿ¨ÿßÿ≤ ÿßŸÑŸÖÿ≥ŸÑŸÖŸäŸÜ ÿ≠ŸàŸÑ ÿßŸÑÿπÿßŸÑŸÖ</div>
    <div id="gc" style="font-size:clamp(3.5em,14vw,5.5em);color:var(--accent);font-weight:bold;font-family:monospace">...</div>
    <p style="color:var(--gray);margin-bottom:24px;font-size:.9em">ÿ≥Ÿàÿ±ÿ© ÿ™ŸÖ ŸÇÿ±ÿßÿ°ÿ™Ÿáÿß ÿ¨ŸÖÿßÿπŸäÿßŸã</p>
    <div class="sebha-circle" style="background:var(--accent);color:var(--primary);font-size:1.1em;border-color:var(--primary)" onclick="incKhatma()">ÿ£ŸÜŸáŸäÿ™<small style="font-size:.6em">ÿ≥Ÿàÿ±ÿ©</small></div>
    <p style="color:var(--gray);font-size:.84em;margin-top:14px;padding:0 24px;line-height:1.7">ŸÉŸÑ ÿ≥Ÿàÿ±ÿ© ÿ™ŸèŸÇÿ±ÿ£ ÿ™Ÿèÿ≥ÿ¨ŸéŸëŸÑ ŸÅŸä ÿßŸÑÿÆÿ™ŸÖÿ© ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ© ŸÑŸÑŸÖÿ≥ŸÑŸÖŸäŸÜ ÿ≠ŸàŸÑ ÿßŸÑÿπÿßŸÑŸÖ</p>
  </div>`;
  if(window._fb){const{db,ref,onValue}=window._fb;onValue(ref(db,'khatma_global/total'),s=>{const gc=G('gc');if(gc)gc.textContent=toAr(s.val()||0);});}
}
function incKhatma(){
  ck();if(!window._fb){sh('ÿ™ÿ≠ÿ™ÿßÿ¨ ÿßÿ™ÿµÿßŸÑÿßŸã ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©');return;}
  const{db,ref,get,set}=window._fb;const r=ref(db,'khatma_global/total');
  get(r).then(s=>{set(r,(s.val()||0)+1);sh('üåü ÿ™ŸÇÿ®ŸëŸÑ ÿßŸÑŸÑŸá ŸÖŸÜŸÉ');ckOk();if(navigator.vibrate)navigator.vibrate([80,40,80]);}).catch(()=>sh('ÿ™ÿπÿ∞ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ'));
}

/* resize canvas */
window.addEventListener('resize',()=>{
  const c=G('sky-canvas');if(!c)return;
  c.width=c.offsetWidth||window.innerWidth;
  c.height=130;
});

/* swipe to go back */
let touchStartX=0,touchStartY=0;
viewer.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;},{passive:true});
viewer.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-touchStartX;
  const dy=Math.abs(e.changedTouches[0].clientY-touchStartY);
  if(dx>70&&dy<50&&touchStartX<40){doBack();}
},{passive:true});

/* ============================================================
   PAGE NAVIGATION SYSTEM
============================================================ */
let _currentPage='home';
function showPage(pageId){
  ck();
  // Hide all app pages
  document.querySelectorAll('.app-page').forEach(p=>p.classList.remove('active'));
  // Show home or page
  if(pageId==='home-screen'){
    G('home-screen').style.display='flex';
    _currentPage='home';
  } else {
    G('home-screen').style.display='none';
    const pg=G(pageId);
    if(pg){pg.classList.add('active');}
    _currentPage=pageId;
  }
  // update bottom nav
  document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('active'));
  const navMap={
    'home-screen':'bnav-home',
    'prayers-page':'bnav-prayers',
    'compass-page':'bnav-compass'
  };
  const navId=navMap[pageId];
  if(navId&&G(navId))G(navId).classList.add('active');
  else if(pageId==='home-screen')G('bnav-home')&&G('bnav-home').classList.add('active');
}

// Swipe back from pages
document.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX;},{passive:true});
document.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-touchStartX;
  if(dx>80&&touchStartX<30&&_currentPage!=='home'){showPage('home-screen');}
},{passive:true});

/* ============================================================
   COMPASS ‚Äî ÿ®ŸàÿµŸÑÿ© ÿ≠ŸÇŸäŸÇŸäÿ© ÿ™ÿπŸÖŸÑ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
============================================================ */
let _compassRunning=false;
let _compassRAF=null;
let _deviceHeading=0;   // heading from device sensor (degrees, 0=north)
let _qiblaAngle=0;      // qibla bearing from north (degrees)
let _compassHasLocation=false;
let _orientationHandler=null;

/* ÿ™ÿ≠ÿØŸäÿØ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿØŸäŸÜÿ© ŸÖŸÜ ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™ */
async function getCityName(lat,lng){
  const cities=[
    {n:'ŸÖŸÉÿ© ÿßŸÑŸÖŸÉÿ±ŸÖÿ©',lat:21.4225,lng:39.8262},{n:'ÿßŸÑŸÖÿØŸäŸÜÿ© ÿßŸÑŸÖŸÜŸàÿ±ÿ©',lat:24.4686,lng:39.6142},
    {n:'ÿßŸÑÿ±Ÿäÿßÿ∂',lat:24.6877,lng:46.7219},{n:'ÿ¨ÿØÿ©',lat:21.5433,lng:39.1728},
    {n:'ÿßŸÑÿØŸÖÿßŸÖ',lat:26.4207,lng:50.0888},{n:'ÿßŸÑÿ∑ÿßÿ¶ŸÅ',lat:21.2703,lng:40.4158},
    {n:'ÿ£ÿ®Ÿàÿ∏ÿ®Ÿä',lat:24.4539,lng:54.3773},{n:'ÿØÿ®Ÿä',lat:25.2048,lng:55.2708},
    {n:'ÿßŸÑÿ¥ÿßÿ±ŸÇÿ©',lat:25.3463,lng:55.4209},{n:'ÿßŸÑŸÉŸàŸäÿ™',lat:29.3759,lng:47.9774},
    {n:'ÿßŸÑÿØŸàÿ≠ÿ©',lat:25.2854,lng:51.5310},{n:'ÿ£ÿ®Ÿáÿß',lat:18.2164,lng:42.5053},
    {n:'ŸÖÿ≥ŸÇÿ∑',lat:23.5880,lng:58.3829},{n:'ÿµŸÜÿπÿßÿ°',lat:15.3694,lng:44.1910},
    {n:'ÿπÿØŸÜ',lat:12.7797,lng:45.0095},{n:'ÿπŸÖŸëÿßŸÜ',lat:31.9539,lng:35.9106},
    {n:'ÿ®Ÿäÿ±Ÿàÿ™',lat:33.8938,lng:35.5018},{n:'ÿØŸÖÿ¥ŸÇ',lat:33.5138,lng:36.2765},
    {n:'ÿ≠ŸÑÿ®',lat:36.2021,lng:37.1343},{n:'ÿ®ÿ∫ÿØÿßÿØ',lat:33.3152,lng:44.3661},
    {n:'ÿßŸÑÿ®ÿµÿ±ÿ©',lat:30.5085,lng:47.7804},{n:'ÿ£ÿ±ÿ®ŸäŸÑ',lat:36.1901,lng:44.0091},
    {n:'ÿßŸÑŸÇÿßŸáÿ±ÿ©',lat:30.0444,lng:31.2357},{n:'ÿßŸÑÿ•ÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©',lat:31.2001,lng:29.9187},
    {n:'ÿßŸÑÿ¨Ÿäÿ≤ÿ©',lat:30.0131,lng:31.2089},{n:'ÿßŸÑÿ£ŸÇÿµÿ±',lat:25.6872,lng:32.6396},
    {n:'ÿ£ÿ≥ŸàÿßŸÜ',lat:24.0889,lng:32.8998},{n:'ÿ®Ÿàÿ±ÿ≥ÿπŸäÿØ',lat:31.2653,lng:32.3019},
    {n:'ÿ∑ÿ±ÿßÿ®ŸÑÿ≥',lat:32.9020,lng:13.1795},{n:'ÿ®ŸÜÿ∫ÿßÿ≤Ÿä',lat:32.1154,lng:20.0686},
    {n:'ÿ™ŸàŸÜÿ≥',lat:36.8190,lng:10.1658},{n:'ÿµŸÅÿßŸÇÿ≥',lat:34.7424,lng:10.7616},
    {n:'ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±',lat:36.7372,lng:3.0863},{n:'ŸàŸáÿ±ÿßŸÜ',lat:35.6969,lng:-0.6331},
    {n:'ÿßŸÑÿ±ÿ®ÿßÿ∑',lat:34.0209,lng:-6.8416},{n:'ÿßŸÑÿØÿßÿ± ÿßŸÑÿ®Ÿäÿ∂ÿßÿ°',lat:33.5731,lng:-7.5898},
    {n:'ŸÖÿ±ÿßŸÉÿ¥',lat:31.6295,lng:-7.9811},{n:'ŸÅÿßÿ≥',lat:34.0331,lng:-5.0003},
    {n:'ÿßŸÑÿÆÿ±ÿ∑ŸàŸÖ',lat:15.5007,lng:32.5599},{n:'ÿ£ŸÖ ÿØÿ±ŸÖÿßŸÜ',lat:15.6448,lng:32.4749},
    {n:'ÿØÿßŸÉÿßÿ±',lat:14.7167,lng:-17.4677},{n:'ŸÜŸäÿ±Ÿàÿ®Ÿä',lat:-1.2921,lng:36.8219},
    {n:'ŸÜŸäÿ¨Ÿäÿ±Ÿäÿß - ÿ£ÿ®Ÿàÿ¨ÿß',lat:9.0579,lng:7.4951},{n:'ŸÑÿßÿ∫Ÿàÿ≥',lat:6.5244,lng:3.3792},
    {n:'ÿ•ÿ≥ÿ∑ŸÜÿ®ŸàŸÑ',lat:41.0082,lng:28.9784},{n:'ÿ£ŸÜŸÇÿ±ÿ©',lat:39.9334,lng:32.8597},
    {n:'ÿ•ÿ≤ŸÖŸäÿ±',lat:38.4189,lng:27.1287},{n:'ÿ∑Ÿáÿ±ÿßŸÜ',lat:35.6892,lng:51.3890},
    {n:'ÿ£ÿµŸÅŸáÿßŸÜ',lat:32.6546,lng:51.6679},{n:'ŸÉÿ±ÿßÿ™ÿ¥Ÿä',lat:24.8607,lng:67.0011},
    {n:'ŸÑÿßŸáŸàÿ±',lat:31.5497,lng:74.3436},{n:'ÿ•ÿ≥ŸÑÿßŸÖ ÿ£ÿ®ÿßÿØ',lat:33.7294,lng:73.0931},
    {n:'ÿ∞ÿßŸÉÿß',lat:23.8103,lng:90.4125},{n:'ÿØŸÑŸáŸä',lat:28.6139,lng:77.2090},
    {n:'ŸÖŸÖÿ®ÿßŸä',lat:19.0760,lng:72.8777},{n:'ÿ¨ÿßŸÉÿ±ÿ™ÿß',lat:-6.2088,lng:106.8456},
    {n:'ŸÉŸàÿßŸÑÿßŸÑŸÖÿ®Ÿàÿ±',lat:3.1390,lng:101.6869},{n:'ÿ®ÿßŸÜŸÉŸàŸÉ',lat:13.7563,lng:100.5018},
    {n:'ŸÑŸÜÿØŸÜ',lat:51.5074,lng:-0.1278},{n:'ÿ®ÿßÿ±Ÿäÿ≥',lat:48.8566,lng:2.3522},
    {n:'ÿ®ÿ±ŸÑŸäŸÜ',lat:52.5200,lng:13.4050},{n:'ÿ£ŸÖÿ≥ÿ™ÿ±ÿØÿßŸÖ',lat:52.3676,lng:4.9041},
    {n:'ŸÜŸäŸàŸäŸàÿ±ŸÉ',lat:40.7128,lng:-74.0060},{n:'Ÿàÿßÿ¥ŸÜÿ∑ŸÜ',lat:38.9072,lng:-77.0369},
    {n:'ŸÑŸàÿ≥ ÿ£ŸÜÿ¨ŸÑŸàÿ≥',lat:34.0522,lng:-118.2437},{n:'ÿ¥ŸäŸÉÿßÿ∫Ÿà',lat:41.8781,lng:-87.6298},
    {n:'ÿ™Ÿàÿ±ŸÜÿ™Ÿà',lat:43.6532,lng:-79.3832},{n:'ŸÖŸàŸÜÿ™ÿ±ŸäÿßŸÑ',lat:45.5017,lng:-73.5673},
    {n:'ÿ≥ŸäÿØŸÜŸä',lat:-33.8688,lng:151.2093},{n:'ŸÖŸÑÿ®Ÿàÿ±ŸÜ',lat:-37.8136,lng:144.9631},
  ];
  function distKm(la1,ln1,la2,ln2){
    const R=6371,dLa=(la2-la1)*Math.PI/180,dLn=(ln2-ln1)*Math.PI/180;
    const a=Math.sin(dLa/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLn/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }
  let best=null,bestDist=Infinity;
  for(const c of cities){const d=distKm(lat,lng,c.lat,c.lng);if(d<bestDist){bestDist=d;best=c;}}
  if(best&&bestDist<=150)return best.n;
  // ŸÖÿ≠ÿßŸàŸÑÿ© API ÿÆÿßÿ±ÿ¨Ÿä ŸÑŸÑŸÖÿØŸÜ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿπÿ±ŸàŸÅÿ©
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ar`,{signal:AbortSignal.timeout(4000)});
    const d=await r.json();
    return d.address?.city||d.address?.town||d.address?.county||d.address?.state||best?.n||'ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä';
  }catch(e){}
  return best?best.n+` (${Math.round(bestDist)}ŸÉŸÖ)`:'ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä';
}

let _compassUserCity='';

function initCompass(){
  if(_compassRunning)return;
  _compassRunning=true;
  resizeCompassCanvas();
  if(!navigator.geolocation){
    _qiblaAngle=calcQiblaAngle(30.0444,31.2357);
    _compassUserCity='ÿßŸÑŸÇÿßŸáÿ±ÿ© (ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä)';
    G('compass-city-label').textContent='üìç ÿßŸÑŸÇÿßŸáÿ±ÿ© (ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä) ‚Üê ŸÖŸÉÿ© ÿßŸÑŸÖŸÉÿ±ŸÖÿ©';
    G('compass-accuracy-badge').textContent='‚ö†Ô∏è GPS ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠';
    _compassHasLocation=true;
    attachOrientationListener();
    return;
  }
  G('compass-accuracy-badge').textContent='‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ...';
  G('compass-city-label').textContent='üìç Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ŸÖÿØŸäŸÜÿ™ŸÉ...';
  navigator.geolocation.getCurrentPosition(
    async pos=>{
      const lat=pos.coords.latitude, lng=pos.coords.longitude;
      _qiblaAngle=calcQiblaAngle(lat,lng);
      const acc=Math.round(pos.coords.accuracy||0);
      _compassUserCity=await getCityName(lat,lng);
      G('compass-city-label').textContent=`üìç ${_compassUserCity} ‚Üê ŸÖŸÉÿ© ÿßŸÑŸÖŸÉÿ±ŸÖÿ©`;
      G('compass-accuracy-badge').textContent=`‚úÖ ÿØŸÇÿ© ${acc}ŸÖ ‚Ä¢ ${Math.round(_qiblaAngle)}¬∞ ŸÖŸÜ ÿßŸÑÿ¥ŸÖÿßŸÑ`;
      G('compass-degree').textContent=Math.round(_qiblaAngle)+'¬∞';
      G('compass-direction').textContent=qiblaHint(_qiblaAngle);
      _compassHasLocation=true;
      attachOrientationListener();
    },
    async err=>{
      _qiblaAngle=calcQiblaAngle(30.0444,31.2357);
      _compassUserCity='ÿßŸÑŸÇÿßŸáÿ±ÿ©';
      G('compass-city-label').textContent='üìç ÿßŸÑŸÇÿßŸáÿ±ÿ© ‚Üê ŸÖŸÉÿ© ÿßŸÑŸÖŸÉÿ±ŸÖÿ©';
      G('compass-accuracy-badge').textContent='‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ŸÖŸÜÿ≠ ÿ•ÿ∞ŸÜ ÿßŸÑŸÖŸàŸÇÿπ ŸÑŸÑÿØŸÇÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ©';
      G('compass-degree').textContent=Math.round(_qiblaAngle)+'¬∞';
      G('compass-direction').textContent=qiblaHint(_qiblaAngle);
      _compassHasLocation=true;
      attachOrientationListener();
    },
    {enableHighAccuracy:true,timeout:12000,maximumAge:30000}
  );
  drawCompass();
}

function stopCompass(){
  _compassRunning=false;
  if(_compassRAF){cancelAnimationFrame(_compassRAF);_compassRAF=null;}
  if(_orientationHandler){
    window.removeEventListener('deviceorientationabsolute',_orientationHandler,true);
    window.removeEventListener('deviceorientation',_orientationHandler,true);
    _orientationHandler=null;
  }
}

function resizeCompassCanvas(){
  const outer=G('compass-outer');if(!outer)return;
  const sz=outer.offsetWidth||280;
  const c=G('compass-canvas');if(!c)return;
  c.width=sz;c.height=sz;
}

function calcQiblaAngle(lat,lng){
  // Kaaba coords
  const kLat=21.4225*Math.PI/180;
  const kLng=39.8262*Math.PI/180;
  const uLat=lat*Math.PI/180;
  const uLng=lng*Math.PI/180;
  const dLng=kLng-uLng;
  const y=Math.sin(dLng)*Math.cos(kLat);
  const x=Math.cos(uLat)*Math.sin(kLat)-Math.sin(uLat)*Math.cos(kLat)*Math.cos(dLng);
  return ((Math.atan2(y,x)*180/Math.PI)+360)%360;
}

function qiblaHint(deg){
  const d=['ÿ¥ŸÖÿßŸÑ','ÿ¥ŸÖÿßŸÑ ÿ¥ÿ±ŸÇ','ÿ¥ÿ±ŸÇ','ÿ¨ŸÜŸàÿ® ÿ¥ÿ±ŸÇ','ÿ¨ŸÜŸàÿ®','ÿ¨ŸÜŸàÿ® ÿ∫ÿ±ÿ®','ÿ∫ÿ±ÿ®','ÿ¥ŸÖÿßŸÑ ÿ∫ÿ±ÿ®'];
  return d[Math.round(deg/45)%8];
}

/* ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÑÿ™ŸÜÿπŸäŸÖ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ®ŸàÿµŸÑÿ© */
let _rawHeadings=[];
let _lastRawHeading=0;
let _compassHasRealSensor=false;
let _absoluteListenerAdded=false;
let _relativeListenerAdded=false;

function _smoothHeading(raw){
  _rawHeadings.push(raw);
  if(_rawHeadings.length>5)_rawHeadings.shift();
  let sinSum=0,cosSum=0;
  _rawHeadings.forEach(h=>{sinSum+=Math.sin(h*Math.PI/180);cosSum+=Math.cos(h*Math.PI/180);});
  return ((Math.atan2(sinSum/_rawHeadings.length,cosSum/_rawHeadings.length)*180/Math.PI)+360)%360;
}

function attachOrientationListener(){
  function handleOrientation(e,isAbsolute){
    let h=0;
    if(e.webkitCompassHeading!=null){
      h=e.webkitCompassHeading;
      _compassHasRealSensor=true;
    } else if(isAbsolute&&e.alpha!=null){
      h=(360-e.alpha)%360;
      _compassHasRealSensor=true;
    } else if(e.alpha!=null&&!_compassHasRealSensor){
      h=(360-e.alpha)%360;
    }
    const diff=Math.abs(h-_lastRawHeading);
    if(_rawHeadings.length>0&&diff>180&&diff<350)return;
    _lastRawHeading=h;
    _deviceHeading=_smoothHeading(h);
    if(!_compassRAF&&_compassRunning){
      _compassRAF=requestAnimationFrame(compassLoop);
    }
  }
  _orientationHandler=handleOrientation;
  if('ondeviceorientationabsolute' in window&&!_absoluteListenerAdded){
    window.addEventListener('deviceorientationabsolute',e=>handleOrientation(e,true),{passive:true});
    _absoluteListenerAdded=true;
  }
  if(!_relativeListenerAdded){
    window.addEventListener('deviceorientation',e=>handleOrientation(e,false),{passive:true});
    _relativeListenerAdded=true;
  }
  // iOS 13+ ÿ•ÿ∞ŸÜ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    const badge=G('compass-accuracy-badge');
    if(badge){
      badge.textContent='üì± ÿßÿ∂ÿ∫ÿ∑ ŸáŸÜÿß ŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ®ŸàÿµŸÑÿ©';
      badge.style.cursor='pointer';
      badge.onclick=()=>{
        DeviceOrientationEvent.requestPermission()
          .then(s=>{
            if(s==='granted'){
              badge.onclick=null;badge.style.cursor='';
              badge.textContent='‚úÖ ÿßŸÑÿ®ŸàÿµŸÑÿ© ŸÖŸÅÿπŸëŸÑÿ©';
            }
          }).catch(()=>sh('ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ•ÿ∞ŸÜ ÿßŸÑÿ®ŸàÿµŸÑÿ©'));
      };
    }
  }
  drawCompass();
  setTimeout(()=>{
    if(!_compassHasRealSensor&&_compassRunning){
      const badge=G('compass-accuracy-badge');
      if(badge&&!badge.textContent.includes('‚úÖ'))badge.textContent='‚ö†Ô∏è ŸÖÿ≥ÿ™ÿ¥ÿπÿ± ÿ∂ÿπŸäŸÅ - ÿ≠ÿ±ŸëŸÉ ÿßŸÑŸáÿßÿ™ŸÅ ÿ®ÿ¥ŸÉŸÑ ÿ±ŸÇŸÖ 8 ŸÑŸÖÿπÿßŸäÿ±ÿ™Ÿá';
    }
  },3000);
}

function compassLoop(){
  _compassRAF=null;
  if(!_compassRunning)return;
  drawCompass();
  _compassRAF=requestAnimationFrame(compassLoop);
}

function drawCompass(){
  const c=G('compass-canvas');if(!c||!c.width)return;
  const W=c.width,H=c.height;
  const cx=W/2,cy=H/2;
  const R=W/2-2; // outer radius
  const ctx=c.getContext('2d');
  ctx.clearRect(0,0,W,H);

  // === Background ===
  const bgG=ctx.createRadialGradient(cx,cy,R*.05,cx,cy,R);
  bgG.addColorStop(0,'#0f3020');bgG.addColorStop(.7,'#062115');bgG.addColorStop(1,'#020d06');
  ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);
  ctx.fillStyle=bgG;ctx.fill();

  // === Outer border ring ===
  ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);
  ctx.strokeStyle='#d4af37';ctx.lineWidth=2.5;ctx.stroke();

  // === Inner decorative ring ===
  ctx.beginPath();ctx.arc(cx,cy,R-10,0,Math.PI*2);
  ctx.strokeStyle='rgba(212,175,55,.18)';ctx.lineWidth=1;ctx.stroke();

  // === Tick marks (rotate with compass heading) ===
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(-_deviceHeading*Math.PI/180);
  for(let deg=0;deg<360;deg+=5){
    const ang=deg*Math.PI/180;
    let len,lw,color;
    if(deg%90===0){len=14;lw=2.5;color='#d4af37';}
    else if(deg%30===0){len=10;lw=1.5;color='rgba(212,175,55,.65)';}
    else if(deg%10===0){len=7;lw=1;color='rgba(212,175,55,.3)';}
    else{len=4;lw=.7;color='rgba(255,255,255,.12)';}
    const x1=Math.sin(ang)*(R-10);
    const y1=-Math.cos(ang)*(R-10);
    const x2=Math.sin(ang)*(R-10-len);
    const y2=-Math.cos(ang)*(R-10-len);
    ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);
    ctx.strokeStyle=color;ctx.lineWidth=lw;ctx.stroke();
  }
  // Cardinal labels
  [['ÿ¥',0,'#ef4444'],['ÿ¥ÿ±',90,'rgba(212,175,55,.7)'],['ÿ¨',180,'rgba(212,175,55,.55)'],['ÿ∫',270,'rgba(212,175,55,.7)']].forEach(([l,d,col])=>{
    const a=d*Math.PI/180;
    const lx=Math.sin(a)*(R-28);
    const ly=-Math.cos(a)*(R-28);
    ctx.font=`bold ${Math.round(W*.048)}px Amiri,serif`;
    ctx.fillStyle=col;ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(l,lx,ly);
  });
  ctx.restore();

  // === Qibla needle ===
  // The qibla needle points toward Mecca in absolute space
  // We rotate it by (qiblaAngle - deviceHeading)
  const needleAng=(_qiblaAngle-_deviceHeading)*Math.PI/180;
  const nr=R-22; // needle tip distance from center

  // Glow around tip
  const tipX=cx+Math.sin(needleAng)*nr;
  const tipY=cy-Math.cos(needleAng)*nr;
  const glow=ctx.createRadialGradient(tipX,tipY,0,tipX,tipY,R*.15);
  glow.addColorStop(0,'rgba(212,175,55,.5)');glow.addColorStop(1,'transparent');
  ctx.beginPath();ctx.arc(tipX,tipY,R*.15,0,Math.PI*2);ctx.fillStyle=glow;ctx.fill();

  // Needle body
  ctx.save();ctx.translate(cx,cy);ctx.rotate(needleAng);
  // Tail (opposite direction)
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(0,R*.35);
  ctx.strokeStyle='rgba(212,175,55,.3)';ctx.lineWidth=3;ctx.lineCap='round';ctx.stroke();
  // Main needle
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(0,-nr);
  ctx.strokeStyle='#d4af37';ctx.lineWidth=4;ctx.lineCap='round';ctx.stroke();
  // Arrowhead (triangle at tip)
  const aw=R*.055;
  ctx.beginPath();
  ctx.moveTo(0,-nr-aw*.5);
  ctx.lineTo(-aw,-nr+aw);
  ctx.lineTo(aw,-nr+aw);
  ctx.closePath();
  ctx.fillStyle='#d4af37';ctx.fill();
  // Kaaba icon at tip
  ctx.font=`${Math.round(W*.075)}px serif`;
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('üïã',0,-(nr-R*.09));
  ctx.restore();

  // === Center dot ===
  const cg=ctx.createRadialGradient(cx,cy,0,cx,cy,R*.06);
  cg.addColorStop(0,'#fff');cg.addColorStop(1,'#d4af37');
  ctx.beginPath();ctx.arc(cx,cy,R*.06,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
  ctx.beginPath();ctx.arc(cx,cy,R*.03,0,Math.PI*2);ctx.fillStyle='#062115';ctx.fill();

  // === Update degree display if we have location ===
  if(_compassHasLocation){
    const relativeAngle=((_qiblaAngle-_deviceHeading)+360)%360;
    G('compass-degree')&&(G('compass-degree').textContent=Math.round(_qiblaAngle)+'¬∞');
    // hint based on relative position
    const rDeg=Math.round(relativeAngle);
    let hint='';
    if(rDeg<15||rDeg>345)hint='‚úÖ ÿ£ŸÜÿ™ ÿ™Ÿàÿßÿ¨Ÿá ÿßŸÑŸÇÿ®ŸÑÿ©!';
    else if(rDeg<45||rDeg>315)hint='ŸÇÿ±Ÿäÿ® ÿ¨ÿØÿßŸã - ÿßŸÜÿπÿ∑ŸÅ ŸÇŸÑŸäŸÑÿßŸã';
    else if(rDeg<=180)hint='ÿßŸÜÿπÿ∑ŸÅ Ÿäÿ≥ÿßÿ±ÿßŸã '+(rDeg)+'¬∞';
    else hint='ÿßŸÜÿπÿ∑ŸÅ ŸäŸÖŸäŸÜÿßŸã '+(360-rDeg)+'¬∞';
    G('compass-direction')&&(G('compass-direction').textContent=hint);
  }
}

window.addEventListener('resize',()=>{if(_compassRunning){resizeCompassCanvas();drawCompass();}});

/* ============================================================
   PRAYERS PAGE ‚Äî ÿµŸÅÿ≠ÿ© ŸÖÿ≥ÿ™ŸÇŸÑÿ© ŸÑŸÖŸàÿßŸÇŸäÿ™ ÿßŸÑÿµŸÑÿßÿ©
============================================================ */
let _prayersPageTimer=null;

async function renderPrayersPage(){
  const body=G('prayers-page-body');if(!body)return;
  if(!prayerTimes)await loadPrayers();
  const city=localStorage.getItem('prayerCity')||'Cairo';
  G('prayers-city-label')&&(G('prayers-city-label').textContent='üìç '+city);

  const pNames={
    Fajr:{ar:'ÿßŸÑŸÅÿ¨ÿ± üåÖ',en:'Fajr'},
    Sunrise:{ar:'ÿßŸÑÿ¥ÿ±ŸàŸÇ ‚òÄÔ∏è',en:'Sunrise'},
    Dhuhr:{ar:'ÿßŸÑÿ∏Ÿáÿ± ‚òÄÔ∏è',en:'Dhuhr'},
    Asr:{ar:'ÿßŸÑÿπÿµÿ± üå§Ô∏è',en:'Asr'},
    Maghrib:{ar:'ÿßŸÑŸÖÿ∫ÿ±ÿ® üåá',en:'Maghrib'},
    Isha:{ar:'ÿßŸÑÿπÿ¥ÿßÿ° üåô',en:'Isha'}
  };

  let html=`
  <div id="prayers-next-card" style="background:linear-gradient(150deg,var(--primary),var(--secondary));border:1.5px solid var(--accent);border-radius:20px;margin:14px;padding:20px;text-align:center">
    <h3 style="color:var(--accent);font-family:'Reem Kufi';margin-bottom:6px;font-size:.95em">‚è≥ ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©</h3>
    <div id="pnext-name" style="font-size:clamp(1.6em,7vw,2em);color:#fff;font-family:'Reem Kufi'">...</div>
    <div id="pnext-timer" style="font-size:clamp(1.8em,8vw,2.8em);font-family:monospace;color:var(--accent);font-weight:bold;letter-spacing:2px;margin-top:4px">--:--:--</div>
  </div>
  `;
  // Prayer rows
  Object.entries(pNames).forEach(([k,v])=>{
    const t=prayerTimes&&prayerTimes[k]?toAr(prayerTimes[k]):'--:--';
    html+=`<div class="p-row" id="prow2-${k}" onclick="ck();previewAdhan('${k}')">
      <span class="pn">${v.ar}</span>
      <div style="display:flex;align-items:center;gap:10px">
        <span class="pt">${t}</span>
        <span style="font-size:1.1em;opacity:.6">üîî</span>
      </div>
    </div>`;
  });

  // Adhan voice selector
  const savedVoice=localStorage.getItem('adhanVoice')||'mecca';
  html+=`
  <div style="margin:14px;background:var(--card);border-radius:16px;padding:16px;border:1px solid rgba(212,175,55,.1)">
    <div style="color:var(--accent);font-family:'Reem Kufi';font-size:.95em;margin-bottom:10px">üîä ÿµŸàÿ™ ÿßŸÑÿ£ÿ∞ÿßŸÜ</div>
    <div style="display:flex;flex-direction:column;gap:8px">
      ${[
        {id:'mecca',label:'ŸÖŸÉÿ© ÿßŸÑŸÖŸÉÿ±ŸÖÿ© - ÿßŸÑŸÖÿ≥ÿ¨ÿØ ÿßŸÑÿ≠ÿ±ÿßŸÖ',url:'https://www.islamcan.com/audio/adhan/azan1.mp3'},
        {id:'egypt',label:'ÿßŸÑÿ£ÿ∞ÿßŸÜ ÿßŸÑŸÖÿµÿ±Ÿä ÿßŸÑŸÉŸÑÿßÿ≥ŸäŸÉŸä',url:'https://www.islamcan.com/audio/adhan/azan2.mp3'},
        {id:'medina',label:'ÿßŸÑŸÖÿØŸäŸÜÿ© ÿßŸÑŸÖŸÜŸàÿ±ÿ©',url:'https://www.islamcan.com/audio/adhan/azan3.mp3'},
      ].map(v=>`<button onclick="selectAdhanVoice('${v.id}','${v.url}',this)" class="fchip${savedVoice===v.id?' on':''}" id="av-${v.id}" style="width:100%;text-align:right;padding:10px 14px">${v.label}</button>`).join('')}
    </div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button class="btn-back" style="flex:1" onclick="ck();schedNotifs()">üîî ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™</button>
      <button class="btn-back" style="flex:1;background:transparent;border:1.5px solid var(--accent);color:var(--accent)" onclick="changeCity()">üìç ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖÿØŸäŸÜÿ©</button>
    </div>
  </div>`;
  body.innerHTML=html;
  startPrayersPageTimer();
}

function startPrayersPageTimer(){
  clearInterval(_prayersPageTimer);
  _prayersPageTimer=setInterval(()=>{
    if(_currentPage!=='prayers-page'){clearInterval(_prayersPageTimer);return;}
    const nx=nextPrayer();if(!nx)return;
    const diff=nx.time-new Date();if(diff<0)return;
    G('pnext-name')&&(G('pnext-name').textContent=nx.name);
    G('pnext-timer')&&(G('pnext-timer').textContent=toAr(fmtDiff(diff)));
    document.querySelectorAll('[id^="prow2-"]').forEach(r=>r.classList.remove('acp'));
    G('prow2-'+nx.key)&&G('prow2-'+nx.key).classList.add('acp');
    // play adhan at prayer time
    if(diff<=2000&&diff>0)playAdhan();
  },1000);
}

/* ============================================================
   ADHAN AUDIO SYSTEM
============================================================ */
let _adhanAudio=null;
let _adhanUrl=localStorage.getItem('adhanUrl')||'https://www.islamcan.com/audio/adhan/azan1.mp3';

function selectAdhanVoice(id,url,btn){
  _adhanUrl=url;
  localStorage.setItem('adhanVoice',id);
  localStorage.setItem('adhanUrl',url);
  document.querySelectorAll('[id^="av-"]').forEach(b=>{b.classList.remove('on');});
  btn.classList.add('on');
  // play preview
  playAdhan(true);
  sh('‚úÖ ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸàÿ™ ÿßŸÑÿ£ÿ∞ÿßŸÜ');
}

function previewAdhan(prayerKey){
  const names={Fajr:'ÿßŸÑŸÅÿ¨ÿ±',Dhuhr:'ÿßŸÑÿ∏Ÿáÿ±',Asr:'ÿßŸÑÿπÿµÿ±',Maghrib:'ÿßŸÑŸÖÿ∫ÿ±ÿ®',Isha:'ÿßŸÑÿπÿ¥ÿßÿ°',Sunrise:'ÿßŸÑÿ¥ÿ±ŸàŸÇ'};
  G('adhan-bar-info').textContent='üïå ÿ≠ÿßŸÜ ŸàŸÇÿ™ '+( names[prayerKey]||'ÿßŸÑÿµŸÑÿßÿ©');
  G('adhan-bar-sub').textContent='ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑŸÑÿ£ÿ∞ÿßŸÜ';
  G('adhan-bar').classList.add('show');
  G('adhan-bar').onclick=()=>{playAdhan(false,prayerKey);G('adhan-bar').onclick=null;};
}

function playAdhan(preview=false,prayerKey=''){
  const names={Fajr:'ÿßŸÑŸÅÿ¨ÿ±',Dhuhr:'ÿßŸÑÿ∏Ÿáÿ±',Asr:'ÿßŸÑÿπÿµÿ±',Maghrib:'ÿßŸÑŸÖÿ∫ÿ±ÿ®',Isha:'ÿßŸÑÿπÿ¥ÿßÿ°',Sunrise:'ÿßŸÑÿ¥ÿ±ŸàŸÇ'};
  if(!_adhanAudio)_adhanAudio=new Audio();
  _adhanAudio.src=_adhanUrl;
  _adhanAudio.volume=1;
  _adhanAudio.play().catch(e=>sh('üîî ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑŸÑÿ£ÿ∞ÿßŸÜ'));
  if(!preview){
    G('adhan-bar-info').textContent='üïå ÿ≠ÿßŸÜ ŸàŸÇÿ™ '+(names[prayerKey]||'ÿßŸÑÿµŸÑÿßÿ©');
    G('adhan-bar-sub').textContent='ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ± ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±';
    G('adhan-bar').classList.add('show');
    if(navigator.vibrate)navigator.vibrate([400,200,400,200,400]);
    if(typeof Notification!=='undefined'&&Notification.permission==='granted'){
      if(window.swReg)window.swReg.showNotification('üïå ÿ≠ÿßŸÜ ŸàŸÇÿ™ '+(names[prayerKey]||'ÿßŸÑÿµŸÑÿßÿ©'),{
        body:'ÿßŸÑÿµŸÑÿßÿ© ÿÆŸäÿ± ŸÖŸÜ ÿßŸÑŸÜŸàŸÖ',icon:'./icon.png',dir:'rtl',
        vibrate:[300,100,300],tag:'adhan-live'
      });
    }
  }
  _adhanAudio.onended=()=>{if(!preview)G('adhan-bar').classList.remove('show');};
}

function stopAdhan(){
  if(_adhanAudio){_adhanAudio.pause();_adhanAudio.currentTime=0;}
  G('adhan-bar').classList.remove('show');
}

/* Auto-play adhan at prayer times (checked every minute) */
setInterval(()=>{
  const nx=nextPrayer();if(!nx)return;
  const diff=nx.time-new Date();
  if(diff>=0&&diff<60000)playAdhan(false,nx.key);
},30000);

/* ============================================================
   OFFLINE SEARCH ‚Äî ÿ®ÿ≠ÿ´ ŸÖÿ™ŸÉÿßŸÖŸÑ ÿ£ŸàŸÅ-ŸÑÿßŸäŸÜ ÿ≥ÿ±Ÿäÿπ ŸàŸÖÿ≠ÿ≥ŸëŸÜ
============================================================ */
let _offlineIndex=null;   // [{surahId, surahName, ayahNum, text, textNorm}]
let _offlineIndexMap=null; // Map<surahId, [{...}]>
let _offSearchFilter='all';
let _offSrchDeb=null;
let _offVoiceRec=null;     // SpeechRecognition instance

/* ÿ™ÿ∑ÿ®Ÿäÿπ ÿßŸÑŸÜÿµ: ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ŸÉŸäŸÑ ŸàÿßŸÑŸáŸÖÿ≤ÿßÿ™ ŸÑŸÑŸÖŸÇÿßÿ±ŸÜÿ© ÿßŸÑÿ∞ŸÉŸäÿ© */
function normAr(txt){
  if(!txt)return'';
  return txt
    .replace(/[\u064B-\u065F\u0670]/g,'')   // ÿ™ÿ¥ŸÉŸäŸÑ
    .replace(/[ÿ£ÿ•ÿ¢ÿß]/g,'ÿß')                  // ŸáŸÖÿ≤ÿßÿ™ ‚Üí ÿ£ŸÑŸÅ
    .replace(/[Ÿâÿ¶]/g,'Ÿä')
    .replace(/ÿ©/g,'Ÿá')
    .replace(/ÿ§/g,'Ÿà')
    .replace(/\s+/g,' ')
    .trim();
}

function openOffSearch(){
  G('offline-search-overlay').classList.add('open');
  setTimeout(()=>G('off-search-inp')&&G('off-search-inp').focus(),300);
  if(!_offlineIndex)buildOfflineIndex();
}

function closeOffSearch(){G('offline-search-overlay').classList.remove('open');}

async function buildOfflineIndex(){
  G('off-search-results').innerHTML='<p style="text-align:center;padding:24px;color:var(--accent)">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ®ŸÜÿßÿ° ŸÅŸáÿ±ÿ≥ ÿßŸÑÿ®ÿ≠ÿ´...</p>';
  let xml=quranXml;
  if(!xml){
    const urls=['quran-simple.xml','quran.xml'];
    for(const url of urls){
      try{const r=await fetch(url);if(!r.ok)continue;
        xml=new DOMParser().parseFromString(await r.text(),'text/xml');
        quranXml=xml;break;
      }catch(e){}
    }
  }
  if(!xml){
    G('off-search-results').innerHTML='<p style="text-align:center;padding:24px;color:var(--gray)">‚ö†Ô∏è ŸÖŸÑŸÅ ÿßŸÑŸÇÿ±ÿ¢ŸÜ (quran-simple.xml) ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ<br>ÿ∂ÿπ ÿßŸÑŸÖŸÑŸÅ ŸÅŸä ŸÜŸÅÿ≥ ŸÖÿ¨ŸÑÿØ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ®ÿ≠ÿ´ ÿ£ŸàŸÅŸÑÿßŸäŸÜ</p>';
    return;
  }
  _offlineIndex=[];
  _offlineIndexMap=new Map();
  xml.querySelectorAll('sura').forEach(s=>{
    const sId=parseInt(s.getAttribute('index')||'0');
    const sName=s.getAttribute('name')||s.getAttribute('tname')||'ÿ≥Ÿàÿ±ÿ© '+sId;
    const arr=[];
    s.querySelectorAll('aya').forEach(a=>{
      const txt=a.getAttribute('text')||'';
      const ayahN=parseInt(a.getAttribute('index')||'0');
      const entry={surahId:sId,surahName:sName,ayahNum:ayahN,text:txt,textNorm:normAr(txt)};
      _offlineIndex.push(entry);
      arr.push(entry);
    });
    _offlineIndexMap.set(sId,arr);
  });
  const sz=_offlineIndex.length;
  G('off-search-results').innerHTML=`<p style="text-align:center;padding:16px;color:var(--green)">‚úÖ ÿ¨ÿßŸáÿ≤ ‚Ä¢ ${toAr(sz)} ÿ¢Ÿäÿ© ŸÖŸÅŸáÿ±ÿ≥ÿ©</p>`;
  const statsEl=G('off-search-stats');
  if(statsEl){
    statsEl.style.display='flex';
    const sizeEl=G('off-index-size');
    if(sizeEl)sizeEl.textContent=`üìä ${toAr(sz)} ÿ¢Ÿäÿ©`;
  }
}

function offSrchFilter(btn,f){
  _offSearchFilter=f;
  document.querySelectorAll('#offline-search-overlay .fchip').forEach(c=>c.classList.remove('on'));
  btn.classList.add('on');
  const q=G('off-search-inp')&&G('off-search-inp').value.trim();
  if(q&&q.length>=2)doOffSearch(q);
}

function offSrchDebounce(v){
  clearTimeout(_offSrchDeb);
  if(!v||v.trim().length<2){
    G('off-search-results').innerHTML='<p style="text-align:center;padding:20px;color:var(--gray)">ÿßŸÉÿ™ÿ® ŸÉŸÑŸÖÿ™ŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÑŸÑÿ®ÿ≠ÿ´</p>';
    return;
  }
  _offSrchDeb=setTimeout(()=>doOffSearch(v.trim()),280);
}

function doOffSearch(q){
  const area=G('off-search-results');
  if(!_offlineIndex){
    area.innerHTML='<p style="text-align:center;padding:20px;color:var(--accent)">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ®ŸÜÿßÿ° ÿßŸÑŸÅŸáÿ±ÿ≥...</p>';
    buildOfflineIndex().then(()=>{if(_offlineIndex)doOffSearch(q);});
    return;
  }
  const qNorm=normAr(q);
  // ÿßÿÆÿ™ÿ± ŸÖÿµÿØÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÅŸÑÿ™ÿ±
  let data=_offlineIndex;
  if(_offSearchFilter==='surah'&&curSurahId){
    data=_offlineIndexMap.get(parseInt(curSurahId))||[];
  } else if(_offSearchFilter==='juz'&&window._currentJuz){
    const juzSurahs=window._currentJuzSurahs||new Set();
    data=_offlineIndex.filter(a=>juzSurahs.has(a.surahId));
  }
  // ÿ®ÿ≠ÿ´ ÿ∞ŸÉŸä: ÿ£ÿµŸÑŸä ÿ£ŸàŸÑÿßŸã ÿ´ŸÖ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ∑ÿ®Ÿäÿπ
  const t0=performance.now();
  let results=[];
  const seen=new Set();
  // ŸÖÿ±ÿ≠ŸÑÿ© Ÿ°: ÿ®ÿ≠ÿ´ ŸÖÿ®ÿßÿ¥ÿ± (ŸÜÿµ ÿ£ÿµŸÑŸä)
  for(const a of data){
    if(results.length>=80)break;
    if(a.text&&a.text.includes(q)){
      results.push({...a,matchType:'exact'});
      seen.add(a.surahId+'_'+a.ayahNum);
    }
  }
  // ŸÖÿ±ÿ≠ŸÑÿ© Ÿ¢: ÿ®ÿ≠ÿ´ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ∑ÿ®Ÿäÿπ (ÿ•ÿ≤ÿßŸÑÿ© ÿ™ÿ¥ŸÉŸäŸÑ ŸàŸáŸÖÿ≤ÿßÿ™)
  if(results.length<30){
    for(const a of data){
      if(results.length>=80)break;
      const key=a.surahId+'_'+a.ayahNum;
      if(!seen.has(key)&&a.textNorm&&a.textNorm.includes(qNorm)){
        results.push({...a,matchType:'norm'});
        seen.add(key);
      }
    }
  }
  const t1=performance.now();
  if(!results.length){
    area.innerHTML=`<p style="text-align:center;padding:24px;color:var(--gray)">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑŸÄ: "${esc(q)}"<br><small style="color:var(--accent);font-size:.85em">ÿ¨ÿ±ÿ® ŸÉŸÑŸÖÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ© ÿ£Ÿà ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ•ŸÖŸÑÿßÿ°</small></p>`;
    return;
  }
  const re=new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
  const reNorm=new RegExp(qNorm.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
  const elapsed=Math.round(t1-t0);
  let html=`<p style="padding:8px 10px;color:var(--accent);font-size:.82em">üîç ${toAr(results.length)} ŸÜÿ™Ÿäÿ¨ÿ© &nbsp;‚Ä¢&nbsp; ${toAr(elapsed)} ŸÖŸÑŸÑŸä ÿ´ÿßŸÜŸäÿ©</p>`;
  results.forEach(r=>{
    let hi=esc(r.text);
    if(r.matchType==='exact')hi=hi.replace(re,m=>`<span class="hl">${m}</span>`);
    else{/* ÿ™ŸÑŸàŸäŸÜ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ∑ÿ®Ÿäÿπ ‚Äî ÿ™ŸÇÿ±Ÿäÿ®Ÿä */hi=hi.replace(reNorm,m=>`<span class="hl">${m}</span>`);}
    html+=`<div class="off-result-item" onclick="closeOffSearch();ck();pushNav(renderSurahList);renderAyahs(${r.surahId},'${safeAttr(r.surahName)}')">
      <div class="off-result-meta">${esc(r.surahName)} ‚Ä¢ ÿ¢Ÿäÿ© ${toAr(r.ayahNum)}</div>
      <div class="off-result-text">${hi}</div>
    </div>`;
  });
  area.innerHTML=html;
}

/* ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿµŸàÿ™Ÿä ŸÅŸä ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ£ŸàŸÅŸÑÿßŸäŸÜ */
function offVoiceSearch(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){sh('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑŸÖŸäÿ≤ÿ© ÿßŸÑÿµŸàÿ™Ÿäÿ©');return;}
  const btn=G('off-voice-btn');
  if(_offVoiceRec){_offVoiceRec.stop();_offVoiceRec=null;btn.classList.remove('listening');return;}
  const r=new SR();r.lang='ar-SA';r.continuous=false;r.interimResults=false;
  _offVoiceRec=r;btn.classList.add('listening');
  r.onresult=e=>{
    const txt=e.results[0][0].transcript;
    const inp=G('off-search-inp');if(inp){inp.value=txt;offSrchDebounce(txt);}
  };
  r.onend=()=>{_offVoiceRec=null;btn.classList.remove('listening');};
  r.onerror=()=>{_offVoiceRec=null;btn.classList.remove('listening');sh('ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿµŸàÿ™');};
  r.start();
}

function openHifzFromSearch(){
  closeOffSearch();
  openHifz();
}

/* ============================================================
   HIFZ ‚Äî ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÅŸäÿ∏ ÿ®ÿßŸÑÿµŸàÿ™ (Web Speech API)
============================================================ */
let _hifzAyahs=[];         // ŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑÿ¢Ÿäÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
let _hifzIdx=0;            // ÿßŸÑÿ¢Ÿäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
let _hifzMode='show';      // show | hide | test
let _hifzRec=null;         // SpeechRecognition
let _hifzCorrect=0;
let _hifzWrong=0;
let _hifzResults={};       // {ayahNum: 'correct'|'wrong'}

function openHifz(surahId,surahName,ayahs){
  G('hifz-overlay').classList.add('open');
  if(ayahs&&ayahs.length){
    _hifzAyahs=ayahs;
    _hifzIdx=0;
    _hifzCorrect=0;_hifzWrong=0;_hifzResults={};
    G('hifz-surah-info').textContent='ÿ≥Ÿàÿ±ÿ© '+surahName+' ‚Ä¢ '+toAr(ayahs.length)+' ÿ¢Ÿäÿ©';
    renderHifzAyahs();
  } else {
    // ÿπÿ±ÿ∂ ÿ¥ÿßÿ¥ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ≥Ÿàÿ±ÿ©
    showHifzSurahPicker();
  }
}

function closeHifz(){
  G('hifz-overlay').classList.remove('open');
  hifzStopMic();
}

function showHifzSurahPicker(){
  G('hifz-surah-info').textContent='ÿßÿÆÿ™ÿ± ÿ≥Ÿàÿ±ÿ© ŸÑŸÑÿ™ÿ≠ŸÅŸäÿ∏';
  const body=G('hifz-body');
  if(quranXml){
    let html='<div class="grid" style="margin-top:0;padding:4px">';
    quranXml.querySelectorAll('sura').forEach(s=>{
      const sId=parseInt(s.getAttribute('index'));
      const sName=s.getAttribute('name')||'ÿ≥Ÿàÿ±ÿ© '+sId;
      const cnt=s.querySelectorAll('aya').length;
      html+=`<div class="card" onclick="hifzLoadSurah(${sId},'${safeAttr(sName)}')"><b>${esc(sName)}</b><small style="color:var(--gray);font-size:.75em">${toAr(cnt)} ÿ¢Ÿäÿ©</small></div>`;
    });
    body.innerHTML=html+'</div>';
  } else {
    body.innerHTML=`<p style="text-align:center;padding:24px;color:var(--gray)">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥Ÿàÿ±...</p>`;
    fetch('https://api.alquran.cloud/v1/surah').then(r=>r.json()).then(d=>{
      let html='<div class="grid" style="margin-top:0;padding:4px">';
      d.data.forEach(s=>{html+=`<div class="card" onclick="hifzLoadSurahAPI(${s.number},'${safeAttr(s.name)}')"><b>${esc(s.name)}</b><small style="color:var(--gray);font-size:.75em">${toAr(s.numberOfAyahs)} ÿ¢Ÿäÿ©</small></div>`;});
      body.innerHTML=html+'</div>';
    }).catch(()=>{body.innerHTML='<p style="text-align:center;padding:24px;color:var(--gray)">ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿ£Ÿà ŸÖŸÑŸÅ quran-simple.xml</p>';});
  }
}

function hifzLoadSurah(sId,sName){
  if(!quranXml)return;
  const sura=quranXml.querySelector(`sura[index="${sId}"]`);
  if(!sura)return;
  const ayahs=[];
  sura.querySelectorAll('aya').forEach(a=>{
    ayahs.push({num:parseInt(a.getAttribute('index')),text:a.getAttribute('text')||''});
  });
  _hifzAyahs=ayahs;_hifzIdx=0;_hifzCorrect=0;_hifzWrong=0;_hifzResults={};
  G('hifz-surah-info').textContent='ÿ≥Ÿàÿ±ÿ© '+sName+' ‚Ä¢ '+toAr(ayahs.length)+' ÿ¢Ÿäÿ©';
  renderHifzAyahs();
}

async function hifzLoadSurahAPI(sId,sName){
  G('hifz-body').innerHTML='<p style="text-align:center;padding:24px;color:var(--accent)">‚è≥ ÿ™ÿ≠ŸÖŸäŸÑ...</p>';
  try{
    const r=await fetch(`https://api.alquran.cloud/v1/surah/${sId}`);
    const d=await r.json();
    const ayahs=d.data.ayahs.map(a=>({num:a.numberInSurah,text:a.text}));
    _hifzAyahs=ayahs;_hifzIdx=0;_hifzCorrect=0;_hifzWrong=0;_hifzResults={};
    G('hifz-surah-info').textContent='ÿ≥Ÿàÿ±ÿ© '+sName+' ‚Ä¢ '+toAr(ayahs.length)+' ÿ¢Ÿäÿ©';
    renderHifzAyahs();
  }catch(e){G('hifz-body').innerHTML='<p style="text-align:center;padding:24px;color:var(--red)">ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥Ÿàÿ±ÿ©</p>';}
}

function renderHifzAyahs(){
  if(!_hifzAyahs.length)return;
  const body=G('hifz-body');
  let html='';
  _hifzAyahs.forEach((a,i)=>{
    const res=_hifzResults[a.num];
    const isActive=i===_hifzIdx;
    const hideText=(_hifzMode==='hide')||(_hifzMode==='test'&&!res);
    const cardCls=['hifz-ayah-card',isActive?'hifz-active':'',res?'hifz-'+res:''].filter(Boolean).join(' ');
    const txtCls='hifz-ayah-text'+(hideText&&!res?' hidden':'');
    html+=`<div class="${cardCls}" id="hifz-card-${a.num}">
      <div class="hifz-ayah-num">
        <span>ÿ¢Ÿäÿ© ${toAr(a.num)}</span>
        ${res?`<span class="hifz-result-badge ${res}">${res==='correct'?'‚úÖ ÿµÿ≠Ÿäÿ≠':'‚ùå ÿÆÿ∑ÿ£'}</span>`:''}
      </div>
      <div class="${txtCls}" id="hifz-txt-${a.num}">${esc(a.text)}</div>
    </div>`;
  });
  body.innerHTML=html;
  updateHifzScores();
  // ÿßÿ≥ŸÉÿ±ŸàŸÑ ŸÑŸÑÿ¢Ÿäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
  setTimeout(()=>{
    const el=G('hifz-card-'+(_hifzAyahs[_hifzIdx]?.num));
    if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
  },150);
}

function updateHifzScores(){
  G('hifz-correct-count').textContent=toAr(_hifzCorrect);
  G('hifz-wrong-count').textContent=toAr(_hifzWrong);
  G('hifz-total-count').textContent=toAr(_hifzAyahs.length);
  const pct=_hifzAyahs.length?Math.round(((_hifzCorrect+_hifzWrong)/_hifzAyahs.length)*100):0;
  G('hifz-progress').style.width=pct+'%';
}

function hifzMode(mode,btn){
  _hifzMode=mode;
  document.querySelectorAll('.hifz-mode-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');

  // ÿ™ÿ®ÿØŸäŸÑ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸàÿ∂ÿπ
  const wordCtrl=G('hifz-word-controls');
  const stdMic=G('hifz-mic-btn');
  const stdStatus=G('hifz-status');
  const stdNav=document.querySelector('.hifz-nav-row');

  if(mode==='word'){
    if(wordCtrl)wordCtrl.style.display='flex',wordCtrl.style.flexDirection='column',wordCtrl.style.gap='8px';
    if(stdMic)stdMic.style.display='none';
    if(stdStatus)stdStatus.style.display='none';
    if(stdNav)stdNav.style.display='none';
    renderHifzWordMode();
  } else {
    if(wordCtrl)wordCtrl.style.display='none';
    if(stdMic)stdMic.style.display='flex';
    if(stdStatus)stdStatus.style.display='block';
    if(stdNav)stdNav.style.display='flex';
    renderHifzAyahs();
  }
}

/* ============================================================
   HIFZ ‚Äî Ÿàÿ∂ÿπ ŸÉŸÑŸÖÿ© ŸÉŸÑŸÖÿ© (ŸÖÿ´ŸÑ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ™ÿ±ÿ™ŸäŸÑ)
   ÿßŸÑŸÖŸÜÿ∑ŸÇ: ŸÉŸÑ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿ∏ÿßŸáÿ±ÿ© ŸÖÿßÿπÿØÿß ÿßŸÑŸÉŸÑŸÖÿ©/ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ÿ™ÿ™ÿ¥ÿßŸÑ (ŸÅÿ±ÿßÿ∫)
============================================================ */
let _hifzWords=[];        // ŸÉŸÑ ŸÉŸÑŸÖÿßÿ™ ÿßŸÑÿ≥Ÿàÿ±ÿ©: {word, ayahIdx, wordIdx, globalIdx, ayahNum}
let _hifzWordIdx=0;       // ÿ®ÿØÿßŸäÿ© ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ™ÿ≥ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑŸä
let _hifzWordSpan=1;      // ÿπÿØÿØ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ŸÅŸä ÿßŸÑŸÜÿ∑ÿßŸÇ (Ÿ°ÿå Ÿ¢ÿå Ÿ£ÿå Ÿ§)
let _hifzBlankCorrect=new Set(); // ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑÿ™Ÿä ÿ£ÿ¨ÿßÿ®Ÿáÿß ÿµÿ≠
let _hifzBlankWrong=new Set();   // ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑÿ™Ÿä ÿ£ÿ¨ÿßÿ®Ÿáÿß ÿ∫ŸÑÿ∑

function buildHifzWords(){
  _hifzWords=[];
  let gi=0;
  _hifzAyahs.forEach((a,ai)=>{
    const words=(a.text||'').split(/\s+/).filter(Boolean);
    words.forEach((w,wi)=>{
      _hifzWords.push({word:w,ayahIdx:ai,wordIdx:wi,globalIdx:gi,ayahNum:a.num});
      gi++;
    });
  });
  _hifzWordIdx=0;
  _hifzBlankCorrect=new Set();
  _hifzBlankWrong=new Set();
}

function renderHifzWordMode(){
  if(!_hifzAyahs.length)return;
  buildHifzWords();
  renderHifzMushaf();
  updateHifzWordDisplay();
}

/* ÿ±ÿ≥ŸÖ ŸÜÿµ ÿßŸÑŸÖÿµÿ≠ŸÅ: ŸÉŸÑ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿ∏ÿßŸáÿ±ÿ© ÿ•ŸÑÿß ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ÿ™ÿ™ÿ¥ÿßŸÑ */
function renderHifzMushaf(){
  const body=G('hifz-body');
  if(!body||!_hifzWords.length)return;

  // ŸÜÿ∑ÿßŸÇ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ÿ™ÿ≥ŸÖŸäÿπŸáÿß
  const rangeEnd=Math.min(_hifzWordIdx+_hifzWordSpan-1,_hifzWords.length-1);
  const targetIndices=new Set();
  for(let i=_hifzWordIdx;i<=rangeEnd;i++)targetIndices.add(i);

  let html='<div class="hifz-mushaf-wrap" id="hifz-mushaf-text">';
  let lastAyahIdx=-1;

  _hifzWords.forEach((wObj,gi)=>{
    const isTarget=targetIndices.has(gi);
    const isCorrect=_hifzBlankCorrect.has(gi);
    const isWrong=_hifzBlankWrong.has(gi);

    if(isTarget){
      // ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©: ŸÅÿ±ÿßÿ∫ ÿ®ÿ∑ŸàŸÑ ÿßŸÑŸÉŸÑŸÖÿ©
      const blanks='_'.repeat(Math.max(3,wObj.word.replace(/[\u064B-\u065F]/g,'').length));
      let cls='hifz-word hifz-word-blank';
      if(isCorrect)cls+=' word-blank-correct';
      else if(isWrong)cls+=' word-blank-wrong';
      html+=`<span class="${cls}" id="hw-${gi}" title="ŸÉŸÑŸÖÿ© ŸÖÿÆŸÅŸäÿ©">${isCorrect?esc(wObj.word):blanks}</span> `;
    } else {
      // ÿ®ÿßŸÇŸä ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿ∏ÿßŸáÿ±ÿ© ÿØÿßÿ¶ŸÖÿßŸã
      html+=`<span class="hifz-word word-visible" id="hw-${gi}">${esc(wObj.word)}</span> `;
    }

    // ÿ±ŸÇŸÖ ÿßŸÑÿ¢Ÿäÿ© ÿ®ÿπÿØ ÿ¢ÿÆÿ± ŸÉŸÑŸÖÿ©
    const isLast=gi===_hifzWords.length-1||_hifzWords[gi+1].ayahIdx!==wObj.ayahIdx;
    if(isLast){
      html+=`<span class="hifz-mushaf-anum">${toAr(wObj.ayahNum)}</span> `;
    }
  });

  html+='</div>';

  // ÿ¥ÿ±Ÿäÿ∑ ÿ™ŸÇÿØŸÖ
  const pct=_hifzWords.length?Math.round(_hifzWordIdx/_hifzWords.length*100):0;
  html=`<div style="margin-bottom:8px;font-size:.8em;color:var(--gray);text-align:center">
    ÿßŸÑŸÉŸÑŸÖÿ© ${toAr(_hifzWordIdx+1)}${_hifzWordSpan>1?'‚Äì'+toAr(rangeEnd+1):''} ŸÖŸÜ ${toAr(_hifzWords.length)} &nbsp;‚Ä¢&nbsp; ${toAr(pct)}%
  </div>`+html;

  body.innerHTML=html;

  // ÿßÿ≥ŸÉÿ±ŸàŸÑ ŸÑÿ£ŸàŸÑ ŸÉŸÑŸÖÿ© ŸÖÿÆŸÅŸäÿ©
  setTimeout(()=>{
    const el=G('hw-'+_hifzWordIdx);
    if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
  },150);
}

function updateHifzWordDisplay(){
  const disp=G('hifz-word-display');
  const sw=G('hifz-status-word');
  if(!_hifzWords.length)return;

  const rangeEnd=Math.min(_hifzWordIdx+_hifzWordSpan-1,_hifzWords.length-1);

  // ÿπÿ±ÿ∂ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÉŸÄ ŸÅÿ±ÿßÿ∫ÿßÿ™ ŸÅŸä ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ≥ŸäÿßŸÇ
  if(disp){
    // ŸÉŸÑŸÖÿ™ÿßŸÜ ŸÇÿ®ŸÑ ÿßŸÑŸÜÿ∑ÿßŸÇ ŸÉÿ≥ŸäÿßŸÇ
    const ctxStart=Math.max(0,_hifzWordIdx-2);
    const ctxWords=_hifzWords.slice(ctxStart,_hifzWordIdx).map(x=>x.word).join(' ');
    const blanksCount=rangeEnd-_hifzWordIdx+1;
    const blanksDisplay=Array(blanksCount).fill('ÿü').join('  ');
    disp.innerHTML=
      `<span style="opacity:.5;font-size:.75em;direction:rtl">${esc(ctxWords)}</span> ` +
      `<strong style="color:var(--accent);font-size:1.1em;letter-spacing:4px">${blanksDisplay}</strong>`;
  }

  if(sw){
    const a=_hifzAyahs[_hifzWords[_hifzWordIdx]?.ayahIdx];
    const rangeEndWord=_hifzWords[rangeEnd];
    const sameAyah=rangeEndWord?.ayahIdx===_hifzWords[_hifzWordIdx]?.ayahIdx;
    sw.textContent=sameAyah
      ? `ÿ¢Ÿäÿ© ${toAr(a?a.num:'')} ‚Ä¢ ŸÉŸÑŸÖÿ© ${toAr(_hifzWords[_hifzWordIdx].wordIdx+1)}${_hifzWordSpan>1?'‚Äì'+toAr(rangeEndWord.wordIdx+1):''}`
      : `ÿ¢Ÿäÿßÿ™ ${toAr(a?a.num:'')}‚Äì${toAr(_hifzAyahs[rangeEndWord?.ayahIdx]?.num||'')}`;
  }
}

/* ÿ™ÿ∫ŸäŸäÿ± ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ™ÿ≥ŸÖŸäÿπ */
function hifzSetSpan(n,btn){
  _hifzWordSpan=n;
  document.querySelectorAll('.hifz-span-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  _hifzBlankCorrect=new Set();
  _hifzBlankWrong=new Set();
  renderHifzMushaf();
  updateHifzWordDisplay();
}

function hifzWordNext(){
  hifzStopMic();
  _hifzBlankCorrect=new Set();
  _hifzBlankWrong=new Set();
  const step=_hifzWordSpan;
  if(_hifzWordIdx+step<_hifzWords.length){
    _hifzWordIdx+=step;
    renderHifzMushaf();
    updateHifzWordDisplay();
  } else {
    sh('üåü ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑÿ≥Ÿàÿ±ÿ©! ÿ£ÿ≠ÿ≥ŸÜÿ™.');
  }
}

function hifzWordPrev(){
  hifzStopMic();
  _hifzBlankCorrect=new Set();
  _hifzBlankWrong=new Set();
  const step=_hifzWordSpan;
  if(_hifzWordIdx-step>=0){
    _hifzWordIdx=Math.max(0,_hifzWordIdx-step);
    renderHifzMushaf();
    updateHifzWordDisplay();
  }
}

function hifzWordReveal(){
  // ÿßŸÉÿ¥ŸÅ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿÆŸÅŸäÿ© ŸàÿßŸÜÿ™ŸÇŸÑ ŸÑŸÑŸÜÿ∑ÿßŸÇ ÿßŸÑÿ™ÿßŸÑŸä
  const rangeEnd=Math.min(_hifzWordIdx+_hifzWordSpan-1,_hifzWords.length-1);
  for(let i=_hifzWordIdx;i<=rangeEnd;i++){
    _hifzBlankCorrect.add(i);
    const el=G('hw-'+i);
    if(el){el.className='hifz-word hifz-word-blank word-blank-correct';el.textContent=_hifzWords[i].word;}
  }
  setTimeout(()=>hifzWordNext(),700);
}

function hifzWordNextAyah(){
  hifzStopMic();
  const cur=_hifzWords[_hifzWordIdx];if(!cur)return;
  const nextAyahIdx=cur.ayahIdx+1;
  const nextWordIdx=_hifzWords.findIndex(w=>w.ayahIdx===nextAyahIdx);
  _hifzBlankCorrect=new Set();_hifzBlankWrong=new Set();
  if(nextWordIdx>=0){
    _hifzWordIdx=nextWordIdx;
    renderHifzMushaf();updateHifzWordDisplay();
  } else {
    sh('üåü ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑÿ≥Ÿàÿ±ÿ©! ÿ£ÿ≠ÿ≥ŸÜÿ™.');
  }
}

function hifzWordPrevAyah(){
  hifzStopMic();
  const cur=_hifzWords[_hifzWordIdx];if(!cur)return;
  const prevAyahIdx=Math.max(0,cur.ayahIdx-1);
  const prevWordIdx=_hifzWords.findIndex(w=>w.ayahIdx===prevAyahIdx);
  _hifzBlankCorrect=new Set();_hifzBlankWrong=new Set();
  if(prevWordIdx>=0){
    _hifzWordIdx=prevWordIdx;
    renderHifzMushaf();updateHifzWordDisplay();
  }
}

function hifzNext(){
  hifzStopMic();
  if(_hifzIdx<_hifzAyahs.length-1){_hifzIdx++;renderHifzAyahs();}
  else sh('üåü ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑÿ≥Ÿàÿ±ÿ©! ÿ£ÿ≠ÿ≥ŸÜÿ™.');
}
function hifzPrev(){
  hifzStopMic();
  if(_hifzIdx>0){_hifzIdx--;renderHifzAyahs();}
}
function hifzReveal(){
  const a=_hifzAyahs[_hifzIdx];if(!a)return;
  const el=G('hifz-txt-'+a.num);
  if(el){el.classList.remove('hidden');el.classList.add('revealed');}
}

/* ===== Web Speech API ŸÑŸÑÿ™ÿ≥ŸÖŸäÿπ ===== */
function hifzToggleMic(){
  if(_hifzRec){hifzStopMic();return;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){
    sh('‚ö†Ô∏è ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿµŸàÿ™ ‚Äî ÿ¨ÿ±ÿ® Chrome ÿ£Ÿà Edge');
    G('hifz-status').textContent='‚ö†Ô∏è Ÿäÿ™ÿ∑ŸÑÿ® Chrome ÿ£Ÿà Edge';
    return;
  }
  const a=_hifzAyahs[_hifzIdx];
  if(!a&&_hifzMode!=='word')return;
  if(_hifzMode==='word'&&!_hifzWords.length)return;
  const r=new SR();
  r.lang='ar-SA';
  r.continuous=false;
  r.interimResults=true;
  r.maxAlternatives=3;
  _hifzRec=r;
  const micBtn=G('hifz-mic-btn');
  const wordMicBtn=G('hifz-word-mic-btn');
  if(micBtn){micBtn.classList.add('recording');G('hifz-mic-icon').textContent='üî¥';G('hifz-mic-label').textContent='ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ... ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ•ŸäŸÇÿßŸÅ';}
  if(wordMicBtn){wordMicBtn.textContent='üî¥';wordMicBtn.style.background='rgba(231,76,60,.15)';wordMicBtn.style.borderColor='#e74c3c';}
  G('hifz-status').textContent='üéôÔ∏è ÿßÿ≥ÿ™ŸÖÿπ Ÿàÿ≥ŸÖŸëÿπ...';
  r.onresult=e=>{
    let interim='',final='';
    for(let i=0;i<e.results.length;i++){
      if(e.results[i].isFinal)final+=e.results[i][0].transcript;
      else interim+=e.results[i][0].transcript;
    }
    if(_hifzMode==='word'){
      // ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑŸÉŸÑŸÖÿ©: ŸÇÿßÿ±ŸÜ ÿ®ÿßŸÑŸÉŸÑŸÖÿ©/ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿÆŸÅŸäÿ©
      const statusEl=G('hifz-status-word');
      const displayEl=G('hifz-word-display');
      if(statusEl)statusEl.textContent=(interim||final)||'üéôÔ∏è ÿ¨ÿßÿ±Ÿç ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ...';
      if(final){
        const rangeEnd=Math.min(_hifzWordIdx+_hifzWordSpan-1,_hifzWords.length-1);
        const targetWords=_hifzWords.slice(_hifzWordIdx,rangeEnd+1).map(w=>w.word);
        const targetText=targetWords.join(' ');
        const spokenNorm=normAr(final.trim());
        const targetNorm=normAr(targetText);

        // ÿ≠ÿ≥ÿßÿ® ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ÿ∑ÿßÿ®ŸÇ
        const spokenArr=spokenNorm.split(/\s+/).filter(Boolean);
        const targetArr=targetNorm.split(/\s+/).filter(Boolean);
        let matches=0;
        spokenArr.forEach(sw=>{if(targetArr.some(tw=>tw.includes(sw)||sw.includes(tw)))matches++;});
        const score=targetArr.length?matches/targetArr.length:0;
        const isMatch=score>=0.6;

        if(isMatch){
          // ÿµÿ≠: ÿßŸÉÿ¥ŸÅ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ŸàÿßŸÜÿ™ŸÇŸÑ
          for(let i=_hifzWordIdx;i<=rangeEnd;i++){
            _hifzBlankCorrect.add(i);
            const el=G('hw-'+i);
            if(el){el.className='hifz-word hifz-word-blank word-blank-correct';el.textContent=_hifzWords[i].word;}
          }
          if(statusEl)statusEl.textContent=`‚úÖ ÿ£ÿ≠ÿ≥ŸÜÿ™! (${Math.round(score*100)}%)`;
          ckOk();if(navigator.vibrate)navigator.vibrate([60,40,60]);
          setTimeout(()=>hifzWordNext(),900);
        } else {
          // ÿ∫ŸÑÿ∑: ŸÑŸàŸëŸÜ ÿßŸÑŸÅÿ±ÿßÿ∫ÿßÿ™ ÿ®ÿßŸÑÿ£ÿ≠ŸÖÿ±
          for(let i=_hifzWordIdx;i<=rangeEnd;i++){
            _hifzBlankWrong.add(i);
            const el=G('hw-'+i);
            if(el){el.className='hifz-word hifz-word-blank word-blank-wrong';}
          }
          if(statusEl)statusEl.textContent=`‚ùå ÿ≠ÿßŸàŸÑ ŸÖÿ¨ÿØÿØÿßŸã ‚Äî ŸÇŸäŸÑ: "${final.trim()}"`;
          if(navigator.vibrate)navigator.vibrate(120);
          // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ©
          setTimeout(()=>{
            for(let i=_hifzWordIdx;i<=rangeEnd;i++){
              const el=G('hw-'+i);if(el)el.className='hifz-word hifz-word-blank';
            }
            _hifzBlankWrong.clear();
          },1200);
        }
      }
    } else {
      G('hifz-status').textContent=(interim||final)||'üéôÔ∏è ÿ¨ÿßÿ±Ÿç ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ...';
      if(final){hifzEvaluate(a,final);}
    }
  };
  r.onend=()=>{
    _hifzRec=null;
    const micBtn=G('hifz-mic-btn');
    const wordMicBtn=G('hifz-word-mic-btn');
    if(micBtn){micBtn.classList.remove('recording');G('hifz-mic-icon').textContent='üéôÔ∏è';G('hifz-mic-label').textContent='ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿ≥ŸÖŸäÿπ';}
    if(wordMicBtn){wordMicBtn.textContent='üéôÔ∏è';wordMicBtn.style.background='';wordMicBtn.style.borderColor='';}
  };
  r.onerror=ev=>{
    _hifzRec=null;
    const micBtn=G('hifz-mic-btn');
    const wordMicBtn=G('hifz-word-mic-btn');
    if(micBtn){micBtn.classList.remove('recording');G('hifz-mic-icon').textContent='üéôÔ∏è';G('hifz-mic-label').textContent='ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿ≥ŸÖŸäÿπ';}
    if(wordMicBtn){wordMicBtn.textContent='üéôÔ∏è';wordMicBtn.style.background='';wordMicBtn.style.borderColor='';}
    G('hifz-status').textContent='‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ™ÿπÿ±ŸÅ: '+ev.error;
  };
  r.start();
}

function hifzStopMic(){
  if(_hifzRec){try{_hifzRec.stop();}catch(e){}_hifzRec=null;}
  const micBtn=G('hifz-mic-btn');
  const wordMicBtn=G('hifz-word-mic-btn');
  if(micBtn){micBtn.classList.remove('recording');G('hifz-mic-icon').textContent='üéôÔ∏è';G('hifz-mic-label').textContent='ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿ≥ŸÖŸäÿπ';}
  if(wordMicBtn){wordMicBtn.textContent='üéôÔ∏è';wordMicBtn.style.background='';wordMicBtn.style.borderColor='';}
}

function hifzEvaluate(ayah,spoken){
  /* ŸÖŸÇÿßÿ±ŸÜÿ© ÿ∞ŸÉŸäÿ©: ŸÜÿ∑ÿ®Ÿëÿπ ÿßŸÑŸÜÿµ ÿßŸÑŸÖŸèŸÇÿßŸÑ ŸàŸÜÿµ ÿßŸÑÿ¢Ÿäÿ© ŸàŸÜÿ≠ÿ≥ÿ® ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ÿ∑ÿßÿ®ŸÇ */
  const spokenNorm=normAr(spoken);
  const ayahNorm=normAr(ayah.text);
  // ÿßÿ≠ÿ≥ÿ® ŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©
  const wordsSpoken=spokenNorm.split(' ').filter(Boolean);
  const wordsAyah=ayahNorm.split(' ').filter(Boolean);
  let matches=0;
  wordsSpoken.forEach(w=>{if(wordsAyah.some(aw=>aw.includes(w)||w.includes(aw)))matches++;});
  const score=wordsAyah.length?matches/wordsAyah.length:0;
  const isCorrect=score>=0.65; // 65% ÿ™ÿ∑ÿßÿ®ŸÇ ŸäŸèÿπÿØŸë ÿµÿ≠Ÿäÿ≠ÿßŸã

  const prev=_hifzResults[ayah.num];
  if(!prev){
    if(isCorrect)_hifzCorrect++;else _hifzWrong++;
  } else {
    if(prev==='correct'&&!isCorrect){_hifzCorrect--;_hifzWrong++;}
    else if(prev==='wrong'&&isCorrect){_hifzWrong--;_hifzCorrect++;}
  }
  _hifzResults[ayah.num]=isCorrect?'correct':'wrong';

  // ÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ¢Ÿäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©
  const card=G('hifz-card-'+ayah.num);
  if(card){
    card.classList.remove('hifz-correct','hifz-wrong');
    card.classList.add(isCorrect?'hifz-correct':'hifz-wrong');
    // ÿ£ÿ∏Ÿáÿ± ÿßŸÑŸÜÿµ ÿ®ÿπÿØ ÿßŸÑÿ™ŸÇŸäŸäŸÖ
    const txtEl=G('hifz-txt-'+ayah.num);
    if(txtEl){txtEl.classList.remove('hidden');txtEl.classList.add('revealed');}
    // ÿ£ÿ∏Ÿáÿ± ÿ¥ÿßÿ±ÿ© ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
    const numEl=card.querySelector('.hifz-ayah-num');
    if(numEl){
      const badge=numEl.querySelector('.hifz-result-badge');
      if(badge){badge.className='hifz-result-badge '+(isCorrect?'correct':'wrong');badge.textContent=isCorrect?'‚úÖ ÿµÿ≠Ÿäÿ≠':'‚ùå ÿÆÿ∑ÿ£';}
      else numEl.insertAdjacentHTML('beforeend',`<span class="hifz-result-badge ${isCorrect?'correct':'wrong'}">${isCorrect?'‚úÖ ÿµÿ≠Ÿäÿ≠':'‚ùå ÿÆÿ∑ÿ£'}</span>`);
    }
  }

  updateHifzScores();
  const pct=Math.round(score*100);
  G('hifz-status').textContent=isCorrect?`‚úÖ ŸÖŸÖÿ™ÿßÿ≤! ÿ™ÿ∑ÿßÿ®ŸÇ ${toAr(pct)}%`:`‚ùå ÿ™ÿ∑ÿßÿ®ŸÇ ${toAr(pct)}% ‚Äî ÿ≠ÿßŸàŸÑ ŸÖÿ¨ÿØÿØÿßŸã`;
  if(isCorrect){ckOk();if(navigator.vibrate)navigator.vibrate([60,40,60]);}
  else{if(navigator.vibrate)navigator.vibrate(120);}

  // ÿßŸÜÿ™ŸÇŸÑ ŸÑŸÑÿ¢Ÿäÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ÿ∞ÿß ÿßŸÑŸàÿ∂ÿπ ÿßÿÆÿ™ÿ®ÿßÿ± ŸàŸÉÿßŸÜ ÿµÿ≠Ÿäÿ≠ÿßŸã
  if(isCorrect&&_hifzMode==='test'){
    setTimeout(()=>hifzNext(),1200);
  }
}

/* ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ≠ŸÅŸäÿ∏ ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¢Ÿäÿ© */
function ctxHifz(){
  if(!_ctxAyah)return;
  closeAyahCtx();
  // ÿ¨ŸÖÿπ ŸÉŸÑ ÿ¢Ÿäÿßÿ™ ÿßŸÑÿ≥Ÿàÿ±ÿ© ŸÖŸÜ _ayahsData
  const ayahs=(window._ayahsData||[]).map(d=>({num:d.numInS,text:d.text}));
  const sName=_ctxAyah.sName;
  const targetIdx=ayahs.findIndex(a=>a.num===_ctxAyah.numInS);
  openHifz(_ctxAyah.sId,sName,ayahs);
  if(targetIdx>=0){_hifzIdx=targetIdx;renderHifzAyahs();}
}

/* ============================================================
   WORD-LEVEL BOOKMARKS (stored, not used in mushaf view)
============================================================ */
let wordBms=[];
try{wordBms=JSON.parse(localStorage.getItem('wordBms')||'[]');}catch(e){wordBms=[];}
function saveWordBms(){try{localStorage.setItem('wordBms',JSON.stringify(wordBms));}catch(e){}}
function togWordBm(key,surahId,ayahNum,wordIdx,word,surahName){
  ck();const idx=wordBms.findIndex(b=>b.key===key);const dot=G('wdot-'+key);
  if(idx>=0){wordBms.splice(idx,1);if(dot)dot.classList.remove('marked');sh('üóëÔ∏è ÿ™ŸÖÿ™ ÿ•ÿ≤ÿßŸÑÿ© ÿ•ÿ¥ÿßÿ±ÿ© ÿßŸÑŸÉŸÑŸÖÿ©');}
  else{wordBms.push({key,surahId,ayahNum,wordIdx,word,surahName,date:new Date().toLocaleDateString('ar')});if(dot)dot.classList.add('marked');if(navigator.vibrate)navigator.vibrate(40);sh('üî¥ ÿ•ÿ¥ÿßÿ±ÿ©: '+word);}
  saveWordBms();
}
/* buildAyah ‚Äî ŸÑŸÑÿ®ÿ≠ÿ´ ŸàŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ¨ÿ≤ÿ° (ŸÖŸèÿπÿ±ŸéŸëŸÅ ÿ£ÿπŸÑÿßŸá) */

/* ============================================================
   TAFSIR PAGE ‚Äî ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ŸÅÿßÿ≥Ÿäÿ± ÿßŸÑŸÉÿßŸÖŸÑÿ©
============================================================ */

// ŸÖÿµÿßÿØÿ± ÿßŸÑÿ™ŸÅÿßÿ≥Ÿäÿ± ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
const TAFSIR_EDITIONS = [
  {id:'ar.jalalayn',   name:'ÿ™ŸÅÿ≥Ÿäÿ± ÿßŸÑÿ¨ŸÑÿßŸÑŸäŸÜ',       author:'ÿ¨ŸÑÿßŸÑ ÿßŸÑÿØŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑŸä ŸàÿßŸÑÿ≥ŸäŸàÿ∑Ÿä',  color:'#8B4513'},
  {id:'ar.muyassar',  name:'ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ÿßŸÑŸÖŸäÿ≥ÿ±',         author:'ŸÜÿÆÿ®ÿ© ŸÖŸÜ ÿßŸÑÿπŸÑŸÖÿßÿ°',              color:'#1a6b35'},
  {id:'ar.waseet',    name:'ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ÿßŸÑŸàÿ≥Ÿäÿ∑',         author:'Ÿàÿ≤ÿßÿ±ÿ© ÿßŸÑÿ£ŸàŸÇÿßŸÅ ÿßŸÑŸÖÿµÿ±Ÿäÿ©',       color:'#6b3a8b'},
  {id:'ar.katheer',   name:'ÿ™ŸÅÿ≥Ÿäÿ± ÿßÿ®ŸÜ ŸÉÿ´Ÿäÿ±',         author:'ÿßŸÑÿ≠ÿßŸÅÿ∏ ÿßÿ®ŸÜ ŸÉÿ´Ÿäÿ±',              color:'#8b6914'},
  {id:'ar.tabari',    name:'ÿ™ŸÅÿ≥Ÿäÿ± ÿßŸÑÿ∑ÿ®ÿ±Ÿä',           author:'ŸÖÿ≠ŸÖÿØ ÿ®ŸÜ ÿ¨ÿ±Ÿäÿ± ÿßŸÑÿ∑ÿ®ÿ±Ÿä',         color:'#2d4a8b'},
  {id:'ar.baghawi',   name:'ÿ™ŸÅÿ≥Ÿäÿ± ÿßŸÑÿ®ÿ∫ŸàŸä',           author:'ÿßŸÑÿ≠ÿ≥ŸäŸÜ ÿ®ŸÜ ŸÖÿ≥ÿπŸàÿØ ÿßŸÑÿ®ÿ∫ŸàŸä',      color:'#6b2d2d'},
];

let _tafsirSurahId=1,_tafsirSurahName='ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©',_tafsirEdition='ar.jalalayn',_tafsirData=null,_tafsirArData=null;

async function renderTafsirPage(){
  vTitle.textContent='üìö ÿßŸÑÿ™ŸÅÿßÿ≥Ÿäÿ± ÿßŸÑŸÉÿßŸÖŸÑÿ©';
  G('scroll-widget').style.display='none';
  G('nic-search').classList.remove('vis');
  // ÿπÿ±ÿ∂ ŸÅŸáÿ±ÿ≥ ÿßŸÑÿ≥Ÿàÿ± ÿ£ŸàŸÑÿßŸã
  let html=`<div style="padding:14px 14px 6px">
    <div style="color:var(--accent);font-family:'Reem Kufi';font-size:1.1em;margin-bottom:10px">ÿßÿÆÿ™ÿ± ÿ≥Ÿàÿ±ÿ© ŸÑŸÑÿ™ŸÅÿ≥Ÿäÿ±</div>
    <div class="tab-bar" id="tafsir-edition-tabs" style="flex-wrap:wrap;gap:5px">
      ${TAFSIR_EDITIONS.map((e,i)=>`<button class="tbb${i===0?' on':''}" style="${i===0?'background:var(--accent);color:var(--primary)':''}" onclick="selectTafsirEdition('${e.id}',this)">${e.name}</button>`).join('')}
    </div>
    <div id="selected-tafsir-info" style="font-size:.78em;color:var(--gray);margin-top:6px;padding:4px 8px;background:rgba(212,175,55,.06);border-radius:8px">
      üìñ ${TAFSIR_EDITIONS[0].name} ‚Äî ${TAFSIR_EDITIONS[0].author}
    </div>
  </div>
  <div style="padding:0 14px 6px;font-size:.82em;color:var(--gray)">ÿßÿÆÿ™ÿ± ÿ≥Ÿàÿ±ÿ©:</div>`;
  
  // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥Ÿàÿ±
  vBody.innerHTML=html+'<div style="text-align:center;padding:20px;color:var(--accent)">‚è≥ ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥Ÿàÿ±...</div>';
  
  try{
    const r=await fetch('https://api.alquran.cloud/v1/surah');
    const d=await r.json();
    let sHtml=html+'<div class="grid" style="margin:0 14px">';
    d.data.forEach(s=>{
      sHtml+=`<div class="card" onclick="ck();pushNav(renderTafsirPage);loadTafsirSurah(${s.number},'${safeAttr(s.name)}')">
        <div>
          <b style="font-size:.92em">${esc(s.name)}</b>
          <div style="color:var(--gray);font-size:.72em;margin-top:2px">${toAr(s.numberOfAyahs)} ÿ¢Ÿäÿ© ¬∑ ${s.revelationType==='Meccan'?'ŸÖŸÉŸäÿ©':'ŸÖÿØŸÜŸäÿ©'}</div>
        </div>
      </div>`;
    });
    vBody.innerHTML=sHtml+'</div>';
  }catch(e){
    // Ÿàÿ∂ÿπ ÿ£ŸàŸÅŸÑÿßŸäŸÜ - ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÄ XML
    if(quranXml){
      const ss=quranXml.querySelectorAll('sura');
      let sHtml=html+'<div class="grid" style="margin:0 14px">';
      ss.forEach(s=>{
        sHtml+=`<div class="card" onclick="ck();pushNav(renderTafsirPage);loadTafsirSurah(${s.getAttribute('index')},'${safeAttr(s.getAttribute('name'))}')">
          <b style="font-size:.92em">${esc(s.getAttribute('name'))}</b>
        </div>`;
      });
      vBody.innerHTML=sHtml+'</div>';
    }else{
      vBody.innerHTML=html+'<p style="text-align:center;padding:30px;color:var(--gray)">‚ö†Ô∏è ÿ™ÿ≠ÿ™ÿßÿ¨ ÿßÿ™ÿµÿßŸÑÿßŸã ŸÑÿπÿ±ÿ∂ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥Ÿàÿ±</p>';
    }
  }
}

function selectTafsirEdition(edId,btn){
  _tafsirEdition=edId;
  document.querySelectorAll('#tafsir-edition-tabs .tbb').forEach(b=>{
    b.classList.remove('on');b.style.background='';b.style.color='';
  });
  btn.classList.add('on');btn.style.background='var(--accent)';btn.style.color='var(--primary)';
  const ed=TAFSIR_EDITIONS.find(e=>e.id===edId);
  const infoEl=G('selected-tafsir-info');
  if(infoEl&&ed)infoEl.textContent=`üìñ ${ed.name} ‚Äî ${ed.author}`;
  if(_tafsirSurahId&&_tafsirArData){
    // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ÿ®ÿßŸÑŸÖÿµÿØÿ± ÿßŸÑÿ¨ÿØŸäÿØ
    loadTafsirSurah(_tafsirSurahId,_tafsirSurahName);
  }
}

async function loadTafsirSurah(id,name){
  _tafsirSurahId=id;_tafsirSurahName=name;
  vTitle.textContent='ÿ™ŸÅÿ≥Ÿäÿ± ÿ≥Ÿàÿ±ÿ© '+name;
  G('scroll-widget').style.display='none';
  vBody.innerHTML='<p style="text-align:center;padding:40px;color:var(--accent)">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±...</p>';
  
  const ed=TAFSIR_EDITIONS.find(e=>e.id===_tafsirEdition)||TAFSIR_EDITIONS[0];
  
  try{
    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ŸàŸÜÿµ ÿßŸÑÿ¢Ÿäÿßÿ™ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸàŸÇÿ™
    const [tfRes, arRes] = await Promise.all([
      fetch(`https://api.alquran.cloud/v1/surah/${id}/${_tafsirEdition}`),
      fetch(`https://api.alquran.cloud/v1/surah/${id}/ar.alafasy`)
    ]);
    const tfD=await tfRes.json(), arD=await arRes.json();
    _tafsirData=tfD.data.ayahs;
    _tafsirArData=arD.data.ayahs;
    
    // ÿ±ÿ£ÿ≥ ÿßŸÑÿ≥Ÿàÿ±ÿ©
    let html=`
      <div style="background:linear-gradient(135deg,#041a0e,#0b2b1d);padding:16px 16px 12px;border-bottom:2px solid var(--accent)">
        <div style="font-family:'Reem Kufi';font-size:1.3em;color:var(--accent);text-align:center">${esc(name)}</div>
        <div style="color:rgba(255,255,255,.5);font-size:.78em;text-align:center;margin-top:4px">${toAr(arD.data.numberOfAyahs)} ÿ¢Ÿäÿ© ¬∑ ${arD.data.revelationType==='Meccan'?'ŸÖŸÉŸäÿ©':'ŸÖÿØŸÜŸäÿ©'}</div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          ${TAFSIR_EDITIONS.map(e=>`<button class="tbb${e.id===_tafsirEdition?' on':''}" style="font-size:.73em;padding:4px 10px;${e.id===_tafsirEdition?'background:var(--accent);color:var(--primary)':''}" onclick="ck();_tafsirEdition='${e.id}';loadTafsirSurah(${id},'${safeAttr(name)}')">${e.name}</button>`).join('')}
        </div>
      </div>`;
    
    // ÿßŸÑÿ®ÿ≥ŸÖŸÑÿ©
    if(id!==9&&id!==1){
      html+=`<div class="mushaf-bismillah">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>`;
    }
    
    // ÿßŸÑÿ¢Ÿäÿßÿ™ ŸÖÿπ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±
    arD.data.ayahs.forEach((a,i)=>{
      const tf=tfD.data.ayahs[i];
      const tfText=tf?tf.text:'';
      html+=`
        <div class="tafsir-ayah-block" id="tblock-${a.number}">
          <div class="tafsir-ayah-num">
            <span style="color:var(--accent);font-size:.75em">ÿßŸÑÿ¢Ÿäÿ© ${toAr(a.numberInSurah)}</span>
            <div style="display:flex;gap:6px">
              <button class="ab" style="padding:3px 10px;font-size:.72em" onclick="cpAyah('${esc(a.text)} Ô¥ø${a.numberInSurah}Ô¥æ - ${esc(name)}')">ŸÜÿ≥ÿÆ</button>
              <button class="ab" onclick="event.stopPropagation();playSaut('${ayahAudioUrl(a.number)}',${a.number})" style="padding:3px 10px;font-size:.72em">‚ñ∂ ÿßÿ≥ÿ™ŸÖÿπ</button>
            </div>
          </div>
          <div class="tafsir-ayah-text" dir="rtl">${esc(a.text)} <span style="color:var(--accent);font-weight:bold">Ô¥ø${toAr(a.numberInSurah)}Ô¥æ</span></div>
          <div class="tafsir-content">
            <div class="tafsir-source-label">üìñ ${ed.name}</div>
            <div class="tafsir-text" dir="rtl">${esc(tfText)||'<span style="color:var(--gray);font-size:.85em">ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ± ŸÑŸáÿ∞Ÿá ÿßŸÑÿ¢Ÿäÿ©</span>'}</div>
          </div>
        </div>`;
    });
    
    html+=`<p style="text-align:center;color:var(--gray);font-size:.78em;padding:20px">${esc(name)} ‚Ä¢ ÿ™ŸÅÿ≥Ÿäÿ±: ${ed.name}</p>`;
    vBody.innerHTML=html;
    vBody.scrollTo(0,0);
  }catch(e){
    vBody.innerHTML=`<div style="text-align:center;padding:40px">
      <div style="font-size:3em;margin-bottom:12px">üì°</div>
      <p style="color:var(--gray)">ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±<br>ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™</p>
      <button class="btn-back" style="margin-top:16px" onclick="loadTafsirSurah(${id},'${safeAttr(name)}')">ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
    </div>`;
  }
}

/* ÿ≤ÿ± ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ŸÅŸä ÿßŸÑÿ¢Ÿäÿ© ‚Äî Ÿäÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ÿßŸÑŸÖÿ∂ŸÖŸëŸÜ ÿ£Ÿà ŸäŸÅÿ™ÿ≠ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ŸÅÿßÿ≥Ÿäÿ± */
async function showAyahTafsir(num,numInS,sId,sName,text){
  ck();
  const boxId='tf-inline-'+num;
  const existing=G(boxId);
  if(existing){existing.style.display=existing.style.display==='none'?'block':'none';return;}
  
  // ÿ•ŸÜÿ¥ÿßÿ° ÿµŸÜÿØŸàŸÇ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ÿ™ÿ≠ÿ™ ÿßŸÑÿ¢Ÿäÿ©
  const frame=G('ayah-'+num)||G('mn-'+num)?.closest('.ayah-frame');
  if(!frame)return;
  
  const box=document.createElement('div');
  box.id=boxId;
  box.className='tf-box';
  box.style.display='block';
  box.innerHTML='<span style="color:var(--accent)">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±...</span>';
  frame.appendChild(box);
  
  try{
    const r=await fetch(`https://api.alquran.cloud/v1/ayah/${num}/ar.jalalayn`);
    const d=await r.json();
    const tfText=d.data?.text||'';
    box.innerHTML=`
      <div style="color:var(--accent);font-size:.75em;margin-bottom:6px;font-weight:bold">üìñ ÿ™ŸÅÿ≥Ÿäÿ± ÿßŸÑÿ¨ŸÑÿßŸÑŸäŸÜ:</div>
      <div style="line-height:2">${esc(tfText)}</div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
        <button class="ab" style="font-size:.72em" onclick="ck();_tafsirSurahId=${sId};_tafsirSurahName='${safeAttr(sName)}';openMod('tafsir');setTimeout(()=>loadTafsirSurah(${sId},'${safeAttr(sName)}'),100)">ÿπÿ±ÿ∂ ŸÉŸÑ ÿßŸÑÿ™ŸÅÿßÿ≥Ÿäÿ±</button>
      </div>`;
  }catch(e){
    box.innerHTML=`<span style="color:var(--gray)">‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ‚Äî ÿ™ÿ≠ÿ™ÿßÿ¨ ÿßÿ™ÿµÿßŸÑÿßŸã</span>
      <div style="margin-top:8px">
        <button class="ab" style="font-size:.72em" onclick="cpAyah('${esc(text)} Ô¥ø${numInS}Ô¥æ')">ŸÜÿ≥ÿÆ ÿßŸÑÿ¢Ÿäÿ©</button>
      </div>`;
  }
}

</script>
</body>
</html>
