<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ù…ØµØ­Ù Ø§Ù„Ù†ÙˆØ±">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<title>Ù…ØµØ­Ù Ø§Ù„Ù†ÙˆØ± Ù¢Ù Ù¢Ù¦</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#062115">
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&family=Reem+Kufi:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ===================== VARIABLES ===================== */
:root{
  --primary:#062115;--secondary:#0b2b1d;--accent:#d4af37;
  --bg:#fdfcf6;--text:#062115;--card:#ffffff;
  --gray:#888;--red:#c0392b;--green:#2d9e6b;
  --ease:all .38s cubic-bezier(.175,.885,.32,1.275);
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bot:env(safe-area-inset-bottom,0px);
}
.dark-mode{
  --primary:#010e07;--secondary:#031a0e;
  --bg:#010e07;--text:#e8e8e8;--card:#051a0f;--gray:#aaa;
}

/* ===================== RESET ===================== */
*{-webkit-tap-highlight-color:transparent;user-select:none;box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased;}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:'Amiri',serif;transition:background .4s,color .4s;background-image:url('https://www.transparenttextures.com/patterns/islamic-art.png')}

/* ===================== SPLASH ===================== */
#splash{position:fixed;inset:0;background:var(--primary);z-index:10000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .8s}
.splash-logo{font-family:'Reem Kufi';font-size:clamp(2.5em,10vw,4.5em);color:var(--accent);text-shadow:0 0 30px rgba(212,175,55,.4);animation:splashPulse 2s ease-in-out infinite}
.splash-ayah{color:rgba(255,255,255,.5);font-size:clamp(.82em,3.5vw,.95em);text-align:center;padding:0 24px;max-width:320px;line-height:1.8}
.splash-bar{width:160px;height:3px;background:rgba(212,175,55,.2);border-radius:3px;overflow:hidden;margin-top:10px}
.splash-fill{height:100%;background:var(--accent);border-radius:3px;animation:fillBar 2.2s linear forwards}
@keyframes splashPulse{0%,100%{opacity:.75;transform:scale(1)}50%{opacity:1;transform:scale(1.06)}}
@keyframes fillBar{from{width:0}to{width:100%}}

/* ===================== TOAST ===================== */
#toast{position:fixed;top:max(20px, calc(var(--safe-top) + 12px));left:50%;transform:translateX(-50%) translateY(-200%);background:rgba(6,33,21,.96);color:var(--accent);padding:11px 28px;border-radius:50px;border:1.5px solid var(--accent);z-index:9999;transition:transform .35s cubic-bezier(.175,.885,.32,1.275);font-size:.92em;font-weight:bold;box-shadow:0 8px 24px rgba(0,0,0,.5);text-align:center;pointer-events:none;max-width:88vw;backdrop-filter:blur(10px)}
#toast.show{transform:translateX(-50%) translateY(0)}

/* ===================== HOME ===================== */
#home-screen{display:flex;flex-direction:column;height:100vh;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}

/* ===================== HEADER ===================== */
header{background:linear-gradient(160deg,#041a0e 0%,#0b2b1d 100%);padding:calc(var(--safe-top) + 52px) 20px 20px;text-align:center;position:relative;flex-shrink:0;overflow:hidden}
header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
header h1{font-family:'Reem Kufi';font-size:clamp(2.2em,9vw,3.4em);color:var(--accent);line-height:1;letter-spacing:1px;text-shadow:0 0 20px rgba(212,175,55,.3)}
header p{color:rgba(255,255,255,.45);margin-top:4px;font-size:clamp(.8em,3.2vw,.9em)}
#menu-btn{position:absolute;top:calc(var(--safe-top) + 12px);left:14px;width:44px;height:44px;border-radius:50%;background:rgba(212,175,55,.1);border:1.5px solid rgba(212,175,55,.4);color:var(--accent);font-size:1.35em;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:background .2s}
#menu-btn:active{background:rgba(212,175,55,.25)}
#search-home-btn{position:absolute;top:calc(var(--safe-top) + 12px);right:14px;width:44px;height:44px;border-radius:50%;background:rgba(212,175,55,.1);border:1.5px solid rgba(212,175,55,.4);color:var(--accent);font-size:1.2em;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:background .2s}
#search-home-btn:active{background:rgba(212,175,55,.25)}

/* ===================== PRAYER SCENE CARD ===================== */
#prayer-scene{background:linear-gradient(180deg,#041520 0%,#0d2b1e 60%,#0b2b1d 100%);margin:0;padding:0;flex-shrink:0;position:relative;overflow:hidden;cursor:pointer}
#prayer-scene:active{opacity:.9}

/* Sky canvas */
#sky-canvas{width:100%;height:130px;display:block}

/* Prayer info row */
#prayer-info-row{display:flex;justify-content:space-between;align-items:center;padding:8px 18px 12px;background:rgba(0,0,0,.2);border-bottom:1.5px solid rgba(212,175,55,.25)}
#pi-left{display:flex;flex-direction:column;gap:2px}
#pi-label{font-size:.75em;color:rgba(255,255,255,.45);letter-spacing:.5px}
#pi-name{font-size:1.1em;color:var(--accent);font-weight:bold;font-family:'Reem Kufi'}
#pi-timer{font-family:monospace;font-size:1.5em;color:#fff;letter-spacing:2px;font-weight:bold;direction:ltr}

/* ===================== DATE / HIJRI ===================== */
#hijri-bar{background:rgba(0,0,0,.15);padding:6px 16px;display:flex;justify-content:space-between;align-items:center;font-size:clamp(.75em,3vw,.85em);color:rgba(255,255,255,.6);flex-shrink:0;border-bottom:1px solid rgba(212,175,55,.1)}
#hijri-bar .hj{color:var(--accent)}

/* ===================== NOTIF BANNER ===================== */
#notif-banner{background:linear-gradient(135deg,#1a3a2a,#0f2218);border:1px solid rgba(212,175,55,.3);border-radius:14px;margin:10px 12px 0;padding:12px 14px;display:none;flex-direction:column;gap:9px;flex-shrink:0}
#notif-banner p{color:rgba(212,175,55,.9);text-align:center;font-size:.88em;line-height:1.5}
.nb-btns{display:flex;gap:9px}
.nb-allow{flex:1;padding:10px;border-radius:11px;border:none;font-weight:bold;cursor:pointer;font-family:'Amiri';font-size:.92em;background:var(--accent);color:var(--primary)}
.nb-later{flex:1;padding:10px;border-radius:11px;border:1.5px solid rgba(212,175,55,.5);font-weight:bold;cursor:pointer;font-family:'Amiri';font-size:.92em;background:transparent;color:var(--accent)}

/* ===================== LAST READ BANNER ===================== */
#last-read-bar{margin:10px 12px 0;background:var(--card);border:1.5px solid rgba(212,175,55,.2);border-radius:13px;padding:11px 14px;display:none;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;flex-shrink:0}
#last-read-bar:active{opacity:.75}
#last-read-bar .lr-label{font-size:.75em;color:var(--gray)}
#last-read-bar .lr-value{color:var(--accent);font-weight:bold;font-size:.92em;margin-top:2px}
#last-read-bar .lr-arrow{color:var(--accent);font-size:1.1em;flex-shrink:0}

/* ===================== GRID ===================== */
.home-grid-wrap{padding:12px 12px 0;flex-shrink:0}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:11px}
.card{background:var(--card);border:1px solid rgba(212,175,55,.15);border-radius:18px;padding:20px 10px 16px;text-align:center;transition:transform .15s,background .15s;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.06);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
.card:active{transform:scale(.87);background:rgba(212,175,55,.05)}
.card-icon{font-size:clamp(1.7em,6vw,2em)}
.card b{font-size:clamp(.83em,3.5vw,.93em);line-height:1.3;color:var(--text)}

/* ===================== QURAN STATS ===================== */
#stats-bar{display:flex;gap:9px;padding:10px 12px 14px;flex-shrink:0}
.stat-chip{flex:1;background:var(--card);border:1px solid rgba(212,175,55,.12);border-radius:11px;padding:9px 6px;text-align:center}
.stat-chip .sc-num{color:var(--accent);font-size:1.25em;font-weight:bold;display:block;line-height:1.2}
.stat-chip .sc-lbl{color:var(--gray);font-size:.72em;display:block;margin-top:2px}

/* ===================== SIDE MENU ===================== */
#side-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:7999;display:none;opacity:0;transition:opacity .3s;backdrop-filter:blur(2px)}
#side-overlay.show{display:block;opacity:1}
#side-menu{position:fixed;top:0;right:-300px;width:280px;height:100%;background:var(--card);z-index:8000;transition:right .38s cubic-bezier(.25,.8,.25,1);box-shadow:-8px 0 32px rgba(0,0,0,.3);display:flex;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch}
#side-menu.open{right:0}
.side-header{background:linear-gradient(150deg,var(--primary),var(--secondary));padding:calc(var(--safe-top) + 44px) 16px 22px;text-align:center;border-bottom:2px solid var(--accent)}
.side-header h2{font-family:'Reem Kufi';color:var(--accent);font-size:1.35em}
.side-header p{color:rgba(255,255,255,.45);font-size:.78em;margin-top:4px}
.side-section{padding:10px 16px 4px;font-size:.72em;color:var(--accent);opacity:.6;letter-spacing:1.5px;border-top:1px solid rgba(212,175,55,.08);margin-top:4px;text-transform:uppercase}
.side-item{display:flex;align-items:center;gap:13px;padding:14px 16px;border-bottom:1px solid rgba(212,175,55,.06);cursor:pointer;transition:background .2s;font-size:.97em}
.side-item:active{background:rgba(212,175,55,.08)}
.side-icon{font-size:1.25em;width:26px;text-align:center;flex-shrink:0}
.side-toggle{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;border-bottom:1px solid rgba(212,175,55,.06);font-size:.97em;gap:10px}
.side-toggle span{flex:1}
.tog{width:44px;height:24px;background:rgba(136,136,136,.4);border-radius:12px;position:relative;cursor:pointer;transition:background .3s;flex-shrink:0}
.tog.on{background:var(--accent)}
.tog::after{content:'';position:absolute;width:20px;height:20px;background:white;border-radius:50%;top:2px;right:2px;transition:transform .3s;box-shadow:0 1px 4px rgba(0,0,0,.3)}
.tog.on::after{transform:translateX(-20px)}

/* ===================== VIEWER ===================== */
#viewer{position:fixed;inset:0;background:var(--bg);z-index:5000;display:none;opacity:0;transform:translateY(12px);transition:opacity .35s ease,transform .35s ease;flex-direction:column}
#viewer.active{display:flex;opacity:1;transform:translateY(0)}
.nav-bar{background:var(--primary);padding:calc(var(--safe-top) + 10px) 12px 10px;display:flex;align-items:center;gap:8px;border-bottom:2px solid var(--accent);z-index:100;flex-shrink:0}
.btn-back{background:var(--accent);color:var(--primary);border:none;padding:8px 16px;border-radius:10px;font-weight:bold;cursor:pointer;font-family:'Amiri';font-size:clamp(.82em,3.5vw,.9em);white-space:nowrap;flex-shrink:0;min-height:38px}
#v-title{flex:1;text-align:center;color:var(--accent);font-family:'Reem Kufi';font-size:clamp(.95em,4vw,1.1em);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.nic{background:transparent;border:1.5px solid rgba(212,175,55,.35);border-radius:8px;color:var(--accent);font-size:1.1em;width:36px;height:36px;display:none;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.nic.vis{display:flex}

/* ===================== SEARCH ===================== */
#search-panel{background:var(--secondary);max-height:0;overflow:hidden;transition:max-height .38s ease,padding .32s;border-bottom:2px solid transparent;flex-shrink:0}
#search-panel.open{max-height:220px;padding:12px 13px;border-bottom-color:var(--accent)}
.s-inp{width:100%;padding:11px 16px;border-radius:24px;border:1.5px solid var(--accent);background:var(--primary);color:var(--accent);font-family:'Noto Naskh Arabic';font-size:clamp(.95em,4vw,1.05em);outline:none;-webkit-appearance:none}
.s-inp::placeholder{color:rgba(212,175,55,.4)}
#filter-row{display:flex;gap:7px;margin-top:9px;flex-wrap:wrap}
.fchip{padding:5px 12px;border-radius:18px;border:1.5px solid var(--accent);background:transparent;color:var(--accent);font-family:'Amiri';font-size:clamp(.8em,3.2vw,.88em);cursor:pointer;transition:background .2s;white-space:nowrap}
.fchip.on{background:var(--accent);color:var(--primary);font-weight:bold}
#sr-area{overflow-y:auto;-webkit-overflow-scrolling:touch;flex-shrink:0;max-height:40vh}
.sr-item{background:var(--card);border-radius:13px;padding:13px;margin:0 13px 9px;border-right:4px solid var(--accent);cursor:pointer}
.sr-item:active{opacity:.8}
.sr-meta{color:var(--accent);font-size:.8em;margin-bottom:7px;font-weight:bold}
.sr-txt{font-family:'Noto Naskh Arabic';font-size:clamp(1.05em,4.5vw,1.18em);line-height:1.85}
.hl{background:rgba(212,175,55,.3);border-radius:3px;padding:0 2px}
.sr-count{padding:8px 14px;color:var(--accent);font-size:.85em}

/* ===================== V-BODY ===================== */
#v-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;padding-bottom:calc(var(--safe-bot) + 70px)}

/* ===================== AYAH ===================== */
.ayah-frame{animation:fadeUp .28s ease forwards;background:var(--card);margin:10px 12px;padding:18px;border-radius:16px;border-right:5px solid var(--accent);box-shadow:0 3px 10px rgba(0,0,0,.05);position:relative}
.ayah-frame.playing{background:rgba(45,158,107,.07);border-right-color:var(--green)}
.ayah-frame.bookmarked{border-right-color:var(--red)}
.ayah-frame.highlighted{background:rgba(212,175,55,.1)}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.qf{font-family:'Noto Naskh Arabic',serif;line-height:2.1;text-align:justify}
.anum{color:var(--accent);font-weight:bold;display:inline-block}
.ayah-acts{display:flex;gap:6px;margin-top:9px;flex-wrap:wrap;align-items:center}
.ab{font-size:clamp(.72em,3vw,.8em);padding:5px 11px;border-radius:9px;border:1.5px solid var(--accent);background:transparent;color:var(--accent);cursor:pointer;font-family:'Amiri';white-space:nowrap;min-height:32px;display:flex;align-items:center}
.ab:active{background:rgba(212,175,55,.18)}
.ab.bmact{background:var(--red);border-color:var(--red);color:#fff}
.tf-box{background:rgba(45,106,79,.07);border-radius:10px;padding:12px;margin-top:10px;color:#2d6a4f;font-size:.9em;display:none;line-height:1.9;font-family:'Noto Naskh Arabic'}
.dark-mode .tf-box{background:rgba(126,200,164,.06);color:#7ec8a4}
.bismillah-line{text-align:center;color:var(--accent);font-weight:bold;font-size:clamp(1.1em,4.5vw,1.3em);padding:14px 0 8px;font-family:'Noto Naskh Arabic';letter-spacing:.5px}

/* ===================== FONT CTRL ===================== */
#font-ctrl{display:flex;align-items:center;gap:8px;margin:10px 12px;background:var(--card);border-radius:11px;padding:8px 14px;border:1px solid rgba(212,175,55,.12)}
#font-ctrl span{flex:1;text-align:center;font-size:.85em;color:var(--text);opacity:.65}
#font-ctrl button{width:34px;height:34px;border-radius:50%;border:1.5px solid var(--accent);background:var(--primary);color:var(--accent);font-size:1em;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* ===================== AUTO SCROLL ===================== */
#asbtn{position:fixed;bottom:calc(var(--safe-bot) + 84px);left:16px;width:52px;height:52px;background:var(--primary);color:var(--accent);border:1.5px solid var(--accent);border-radius:50%;display:none;align-items:center;justify-content:center;z-index:9000;cursor:pointer;font-size:.72em;text-align:center;font-weight:bold;line-height:1.2;box-shadow:0 4px 14px rgba(0,0,0,.4)}
#spctl{position:fixed;bottom:calc(var(--safe-bot) + 146px);left:20px;width:44px;height:120px;display:none;z-index:9000;flex-direction:column;align-items:center;background:var(--primary);border-radius:16px;border:1px solid var(--accent);padding:9px}
#spctl input{writing-mode:vertical-lr;direction:rtl;width:10px;height:100%;accent-color:var(--accent)}

/* ===================== SEBHA ===================== */
.sebha-circle{width:clamp(160px,55vw,210px);height:clamp(160px,55vw,210px);border-radius:50%;margin:22px auto;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:clamp(1.8em,7vw,2.6em);cursor:pointer;transition:all .08s;background:radial-gradient(circle at 30% 30%,#0b2b1d,#062115);color:#fff;border:7px solid var(--accent);box-shadow:0 12px 0 #04140e,0 16px 24px rgba(0,0,0,.4);position:relative;top:0;gap:4px}
.sebha-circle:active{top:9px;box-shadow:0 3px 0 #04140e}
.sebha-circle small{font-size:.35em;opacity:.7;font-family:'Amiri'}

/* ===================== TABS ===================== */
.tab-bar{display:flex;gap:7px;padding:10px 12px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;flex-shrink:0}
.tab-bar::-webkit-scrollbar{display:none}
.tbb{flex-shrink:0;padding:7px 16px;border-radius:18px;border:1.5px solid var(--accent);background:transparent;color:var(--accent);font-family:'Amiri';font-size:clamp(.83em,3.5vw,.93em);cursor:pointer;white-space:nowrap;min-height:36px}
.tbb.on{background:var(--accent);color:var(--primary);font-weight:bold}

/* ===================== PRAYER ===================== */
#next-card{background:linear-gradient(150deg,var(--primary),var(--secondary));border:1.5px solid var(--accent);border-radius:20px;margin:13px;padding:20px;text-align:center}
#next-card h3{color:var(--accent);font-family:'Reem Kufi';margin-bottom:5px;font-size:clamp(.95em,4vw,1.05em)}
#next-name{font-size:clamp(1.7em,7vw,2.2em);color:#fff;font-family:'Reem Kufi'}
#next-timer{font-size:clamp(2em,8vw,3em);font-family:monospace;color:var(--accent);font-weight:bold;letter-spacing:2px;margin-top:4px}
.p-row{display:flex;justify-content:space-between;align-items:center;padding:13px 16px;border-radius:13px;margin:0 12px 9px;background:var(--card);border:1.5px solid rgba(212,175,55,.1)}
.p-row.acp{border-color:var(--accent);background:rgba(212,175,55,.07)}
.pn{font-size:clamp(1em,4vw,1.1em);font-weight:bold}
.pt{color:var(--accent);font-size:clamp(1em,4vw,1.15em);font-family:monospace}

/* ===================== BOOKMARKS ===================== */
.bm-item{background:var(--card);border-radius:13px;margin:8px 12px;padding:13px;border-right:4px solid var(--red);cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:10px}
.bm-item:active{opacity:.8}

/* ===================== NAMES ===================== */
.name-card{background:var(--card);border:1.5px solid rgba(212,175,55,.13);border-radius:14px;padding:clamp(13px,4vw,17px) 10px;text-align:center;cursor:pointer;transition:var(--ease);display:flex;flex-direction:column;align-items:center;gap:5px}
.name-card:active{transform:scale(.88);background:rgba(212,175,55,.07)}
.name-meaning{font-size:.76em;color:var(--gray);line-height:1.4;margin-top:4px}

/* ===================== PLAYER BAR ===================== */
#player-bar{background:var(--primary);border-top:1.5px solid var(--accent);padding:10px 14px calc(var(--safe-bot) + 10px);display:none;align-items:center;gap:9px;z-index:200;flex-shrink:0}
#player-bar.show{display:flex}
#pinfo{flex:1;font-size:.85em;color:var(--accent);overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.p-ctrl{display:flex;gap:7px}
#pprev,#pnext{background:rgba(212,175,55,.15);color:var(--accent);border:1px solid rgba(212,175,55,.3);border-radius:8px;padding:7px 11px;cursor:pointer;font-family:'Amiri';font-size:.85em}
#pstop{background:#8b0000;color:#fff;border:none;border-radius:9px;padding:8px 13px;cursor:pointer;font-family:'Amiri';font-size:.88em}

/* ===================== DUA MODAL ===================== */
#dua-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9000;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(3px)}
#dua-modal.show{display:flex}
#dua-sheet{background:var(--card);border-radius:22px 22px 0 0;padding:20px 18px calc(var(--safe-bot) + 20px);max-height:70vh;overflow-y:auto;width:100%;animation:slideUp .32s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
#dua-sheet h3{color:var(--accent);font-family:'Reem Kufi';margin-bottom:12px;font-size:1.1em}
#dua-sheet p{font-family:'Noto Naskh Arabic';font-size:1.15em;line-height:2;color:var(--text)}
#dua-sheet .dua-source{color:var(--gray);font-size:.8em;margin-top:8px}
.dua-close{position:absolute;top:10px;left:50%;transform:translateX(-50%);width:40px;height:4px;background:rgba(136,136,136,.4);border-radius:2px;cursor:pointer}

/* ===================== AZKAR CARD ===================== */
.azkar-card{background:var(--card);border-right:5px solid var(--accent);border-radius:16px;margin:10px 12px;padding:16px 14px;position:relative;overflow:hidden}
.azkar-title{color:var(--accent);font-family:'Reem Kufi';font-size:1em;margin-bottom:10px}
.azkar-text{font-family:'Noto Naskh Arabic';font-size:clamp(1.05em,4.5vw,1.2em);line-height:2.1;color:var(--text)}
.azkar-count{display:inline-flex;align-items:center;gap:6px;background:rgba(212,175,55,.1);border:1px solid rgba(212,175,55,.2);border-radius:20px;padding:4px 12px;font-size:.8em;color:var(--accent);margin-top:10px}
.azkar-actions{display:flex;gap:7px;margin-top:11px}
.azkar-btn{flex:1;padding:8px;border-radius:10px;border:1.5px solid var(--accent);background:transparent;color:var(--accent);font-family:'Amiri';font-size:.85em;cursor:pointer}
.azkar-btn.active{background:var(--accent);color:var(--primary);font-weight:bold}
.azkar-counter-display{position:absolute;top:14px;left:14px;font-size:.78em;color:var(--gray);font-family:monospace}

/* ===================== WORD SEARCH (tajweed) ===================== */
.word-btn{display:inline;cursor:pointer;border-radius:4px;padding:0 2px;transition:background .15s}
.word-btn:active{background:rgba(212,175,55,.3)}

/* ===================== PROGRESS ===================== */
.reading-progress{background:rgba(212,175,55,.15);border-radius:6px;height:6px;margin:8px 12px;overflow:hidden}
.reading-fill{height:100%;background:var(--accent);border-radius:6px;transition:width .5s ease}

/* ===================== SCROLL TO TOP ===================== */
#scroll-top-btn{position:fixed;bottom:calc(var(--safe-bot) + 22px);right:16px;width:44px;height:44px;background:var(--accent);color:var(--primary);border:none;border-radius:50%;font-size:1.1em;display:none;align-items:center;justify-content:center;z-index:9000;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.3)}
#scroll-top-btn.show{display:flex}

/* ===================== RESPONSIVE ===================== */
@media(max-width:360px){
  header h1{font-size:1.9em}
  .card{padding:14px 7px}
  .qf{font-size:1.4em!important}
  .home-grid-wrap{padding:9px 9px 0}
  .grid{gap:9px}
  #stats-bar{padding:8px 9px 12px}
}
@media(min-width:480px){
  .grid{grid-template-columns:repeat(4,1fr)}
  #side-menu{width:310px;right:-320px}
}
@media(max-width:479px){
  .grid{grid-template-columns:repeat(2,1fr)}
}
@media(prefers-color-scheme:dark){
  body:not(.light-forced){--primary:#010e07;--secondary:#031a0e;--bg:#010e07;--text:#e8e8e8;--card:#051a0f;--gray:#aaa}
}
</style>
</head>
<body>

<div id="splash">
  <div class="splash-logo">Ù…ØµØ­Ù Ø§Ù„Ù†ÙˆØ±</div>
  <div class="splash-ayah">ï´¿ Ø¥ÙÙ†ÙÙ‘ Ù‡ÙÙ€Ù°Ø°ÙØ§ Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†Ù ÙŠÙÙ‡Ù’Ø¯ÙÙŠ Ù„ÙÙ„ÙÙ‘ØªÙÙŠ Ù‡ÙÙŠÙ Ø£ÙÙ‚Ù’ÙˆÙÙ…Ù ï´¾</div>
  <div class="splash-bar"><div class="splash-fill"></div></div>
</div>

<div id="toast"></div>
<div id="side-overlay" onclick="closeSide()"></div>

<!-- DUA MODAL -->
<div id="dua-modal" onclick="if(event.target===this)closeDua()">
  <div id="dua-sheet">
    <div class="dua-close" onclick="closeDua()"></div>
    <h3 id="dua-title"></h3>
    <p id="dua-text"></p>
    <div class="dua-source" id="dua-source"></div>
    <div style="margin-top:14px;display:flex;gap:8px">
      <button class="ab" style="flex:1;justify-content:center" onclick="cpDua()">Ù†Ø³Ø® Ø§Ù„Ø¯Ø¹Ø§Ø¡</button>
      <button class="ab" onclick="closeDua()" style="flex:1;justify-content:center">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- SIDE MENU -->
<div id="side-menu">
  <div class="side-header">
    <h2>Ù…ØµØ­Ù Ø§Ù„Ù†ÙˆØ± âœ¨</h2>
    <p>Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù¢Ù Ù¢Ù¦</p>
  </div>
  <div class="side-section">Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØ§Ù„Ù‚Ø±Ø§Ø¡Ø©</div>
  <div class="side-item" onclick="closeSide();openMod('quran')"><span class="side-icon">ğŸ“–</span>Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</div>
  <div class="side-item" onclick="closeSide();openMod('search')"><span class="side-icon">ğŸ”</span>Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†</div>
  <div class="side-item" onclick="closeSide();openMod('bookmarks')"><span class="side-icon">ğŸ”–</span>Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©</div>
  <div class="side-item" onclick="closeSide();openMod('khatma')"><span class="side-icon">ğŸŒŸ</span>Ø§Ù„Ø®ØªÙ…Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</div>
  <div class="side-section">Ø§Ù„Ø°ÙƒØ± ÙˆØ§Ù„Ø¹Ø¨Ø§Ø¯Ø©</div>
  <div class="side-item" onclick="closeSide();openMod('azkar')"><span class="side-icon">ğŸ“¿</span>Ø§Ù„Ø£Ø°ÙƒØ§Ø±</div>
  <div class="side-item" onclick="closeSide();openMod('tasbih')"><span class="side-icon">ğŸ”¢</span>Ø§Ù„Ø³Ø¨Ø­Ø©</div>
  <div class="side-item" onclick="closeSide();openMod('duas')"><span class="side-icon">ğŸ¤²</span>Ø§Ù„Ø£Ø¯Ø¹ÙŠØ© Ø§Ù„Ù…Ø£Ø«ÙˆØ±Ø©</div>
  <div class="side-item" onclick="closeSide();openMod('names')"><span class="side-icon">âœ¨</span>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ù‡ Ø§Ù„Ø­Ø³Ù†Ù‰</div>
  <div class="side-section">Ø§Ù„ØµÙ„Ø§Ø©</div>
  <div class="side-item" onclick="closeSide();openMod('prayers')"><span class="side-icon">ğŸ•Œ</span>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</div>
  <div class="side-item" onclick="closeSide();openMod('reciters')"><span class="side-icon">ğŸ™ï¸</span>Ø§Ù„ØªÙ„Ø§ÙˆØ§Øª</div>
  <div class="side-section">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
  <div class="side-toggle"><span>ğŸŒ— Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span><div id="tg-dark" class="tog" onclick="toggleDark()"></div></div>
  <div class="side-toggle"><span>ğŸ”” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©</span><div id="tg-notif" class="tog" onclick="toggleNotifSetting()"></div></div>
  <div class="side-toggle"><span>ğŸ”Š Ø£ØµÙˆØ§Øª Ø§Ù„Ù„Ù…Ø³</span><div id="tg-click" class="tog" onclick="toggleClickSnd()"></div></div>
  <div class="side-section">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ù„ØµÙ„Ø§Ø©</div>
  <div class="side-item" onclick="changeCity()" style="justify-content:space-between">
    <span><span class="side-icon">ğŸ“</span><span id="city-display">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</span></span>
    <span style="color:var(--accent);font-size:.8em">ØªØºÙŠÙŠØ±</span>
  </div>
</div>

<!-- AUTO SCROLL -->
<div id="spctl"><input type="range" min="10" max="100" value="50" oninput="updSpd(this.value)"></div>
<div id="asbtn" onclick="togScroll()">Ù†Ø²ÙˆÙ„<br>ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>
<button id="scroll-top-btn" onclick="scrollToTop()">â†‘</button>

<!-- HOME -->
<div id="home-screen">

  <!-- HEADER -->
  <header>
    <div id="menu-btn" onclick="openSide()">â˜°</div>
    <div id="search-home-btn" onclick="ck();openMod('search')">ğŸ”</div>
    <h1>Ù…ØµØ­Ù Ø§Ù„Ù†ÙˆØ±</h1>
    <p>ØªØ·Ø¨ÙŠÙ‚Ùƒ Ø§Ù„Ø¥ÙŠÙ…Ø§Ù†ÙŠ Ø§Ù„Ù…ÙØ¶Ù„</p>
  </header>

  <!-- HIJRI BAR -->
  <div id="hijri-bar">
    <span class="hj" id="hijri-date">â³</span>
    <span id="gregorian-date"></span>
  </div>

  <!-- PRAYER SCENE CARD -->
  <div id="prayer-scene" onclick="ck();openMod('prayers')">
    <canvas id="sky-canvas"></canvas>
    <div id="prayer-info-row">
      <div id="pi-left">
        <span id="pi-label">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</span>
        <span id="pi-name">ØªØ­Ù…ÙŠÙ„...</span>
      </div>
      <span id="pi-timer">--:--:--</span>
    </div>
  </div>

  <!-- NOTIF BANNER -->
  <div id="notif-banner">
    <p>ğŸ”” ÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„ØªÙ„Ù‚Ù‘ÙŠ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
    <div class="nb-btns">
      <button class="nb-allow" onclick="reqNotif()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
      <button class="nb-later" onclick="dismissBanner()">Ù„Ø§Ø­Ù‚Ø§Ù‹</button>
    </div>
  </div>

  <!-- LAST READ -->
  <div id="last-read-bar" onclick="goLastRead()">
    <div>
      <div class="lr-label">ØªØ§Ø¨Ø¹ Ù…Ù† Ø­ÙŠØ« ØªÙˆÙ‚ÙØª</div>
      <div class="lr-value" id="lr-text">...</div>
    </div>
    <span class="lr-arrow">â†</span>
  </div>

  <!-- GRID -->
  <div class="home-grid-wrap">
    <div class="grid">
      <div class="card" onclick="ck();openMod('quran')"><span class="card-icon">ğŸ“–</span><b>Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</b></div>
      <div class="card" onclick="ck();openMod('azkar')"><span class="card-icon">ğŸ“¿</span><b>Ø§Ù„Ø£Ø°ÙƒØ§Ø±</b></div>
      <div class="card" onclick="ck();openMod('prayers')"><span class="card-icon">ğŸ•Œ</span><b>Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª</b></div>
      <div class="card" onclick="ck();openMod('tasbih')"><span class="card-icon">ğŸ”¢</span><b>Ø§Ù„Ø³Ø¨Ø­Ø©</b></div>
      <div class="card" onclick="ck();openMod('reciters')"><span class="card-icon">ğŸ™ï¸</span><b>Ø§Ù„ØªÙ„Ø§ÙˆØ§Øª</b></div>
      <div class="card" onclick="ck();openMod('names')"><span class="card-icon">âœ¨</span><b>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ù‡</b></div>
      <div class="card" onclick="ck();openMod('duas')"><span class="card-icon">ğŸ¤²</span><b>Ø§Ù„Ø£Ø¯Ø¹ÙŠØ©</b></div>
      <div class="card" onclick="ck();openMod('khatma')"><span class="card-icon">ğŸŒ</span><b>Ø§Ù„Ø®ØªÙ…Ø©</b></div>
    </div>
  </div>

  <!-- STATS -->
  <div id="stats-bar">
    <div class="stat-chip"><span class="sc-num" id="stat-bm">Ù </span><span class="sc-lbl">Ø¥Ø´Ø§Ø±Ø© Ù…Ø­ÙÙˆØ¸Ø©</span></div>
    <div class="stat-chip"><span class="sc-num" id="stat-tas">Ù </span><span class="sc-lbl">ØªØ³Ø¨ÙŠØ­Ø©</span></div>
    <div class="stat-chip"><span class="sc-num" id="stat-days">Ù </span><span class="sc-lbl">ÙŠÙˆÙ… Ù…Ø¹Ù†Ø§</span></div>
  </div>

</div>

<!-- VIEWER -->
<div id="viewer">
  <div class="nav-bar">
    <button class="btn-back" onclick="doBack()">â† Ø±Ø¬ÙˆØ¹</button>
    <div id="v-title"></div>
    <button class="nic" id="nic-search" onclick="togSearchPanel()" title="Ø¨Ø­Ø«">ğŸ”</button>
    <button class="nic vis" onclick="openSide()" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
  </div>
  <div id="search-panel">
    <input class="s-inp" id="s-inp" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¢ÙŠØ© Ø£Ùˆ ÙƒÙ„Ù…Ø©..." autocomplete="off" oninput="debSearch(this.value)">
    <div id="filter-row">
      <button class="fchip on" onclick="setFlt(this,'all')">ÙƒÙ„ Ø§Ù„Ù‚Ø±Ø¢Ù†</button>
      <button class="fchip" onclick="setFlt(this,'surah')">Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
      <button class="fchip" onclick="setFlt(this,'exact')">ØªØ·Ø§Ø¨Ù‚ ØªØ§Ù…</button>
    </div>
  </div>
  <div id="sr-area"></div>
  <div id="v-body"></div>
  <div id="player-bar">
    <div id="pinfo">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„...</div>
    <div class="p-ctrl">
      <button id="pprev" onclick="playPrevSurah()">â—€</button>
      <button id="pnext" onclick="playNextSurah()">â–¶</button>
      <button id="pstop" onclick="stopAud()">â¹</button>
    </div>
  </div>
</div>

<audio id="aud" crossorigin="anonymous" preload="none"></audio>

<!-- Firebase -->
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import{getDatabase,ref,set,onValue,get}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
const cfg={apiKey:"AIzaSyBKc0Vu8e1WxyUTmd1dEpGgrKDNOQV9PsY",authDomain:"quranapp-9c312.firebaseapp.com",projectId:"quranapp-9c312",databaseURL:"https://quranapp-9c312-default-rtdb.firebaseio.com/",storageBucket:"quranapp-9c312.firebasestorage.app",messagingSenderId:"708147485092",appId:"1:708147485092:web:ce228b7a245a89f08b0931"};
try{const app=initializeApp(cfg);const db=getDatabase(app);window._fb={db,ref,set,onValue,get};}catch(e){console.warn('Firebase init failed',e);}
</script>

<script>
/* ============================================================
   GLOBALS
============================================================ */
let quranXml=null,prayerTimes=null,countInv=null,miniInv=null;
let isScroll=false,scrollInv=null,scrollSpd=50;
let fontSize=1.8;
let bookmarks=[];
try{bookmarks=JSON.parse(localStorage.getItem('bm')||'[]');}catch(e){bookmarks=[];}
let clickOn=localStorage.getItem('clickSnd')!=='false';
let sDeb=null,activeFilter='all',curSurahId=null,curSurahName=null,curRecBase=null,curRecName=null,curRecSurahNum=null;
let notifSched=false;
let currentCity=localStorage.getItem('prayerCity')||'Cairo';
let currentCountry=localStorage.getItem('prayerCountry')||'Egypt';
const navStack=[];
let azkarCounts={};
try{azkarCounts=JSON.parse(localStorage.getItem('azkarCounts')||'{}');}catch(e){}

const G=id=>document.getElementById(id);
const aud=G('aud'),viewer=G('viewer'),vBody=G('v-body'),vTitle=G('v-title'),toast=G('toast');
let sCount=parseInt(localStorage.getItem('tasbihCount')||'0');

/* ============================================================
   AUDIO CTX
============================================================ */
let _actx=null;
function gctx(){
  if(!_actx)_actx=new(window.AudioContext||window.webkitAudioContext)();
  if(_actx.state==='suspended')_actx.resume();
  return _actx;
}
function ck(){
  if(!clickOn)return;
  try{const c=gctx(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=820;o.type='sine';g.gain.setValueAtTime(.11,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+.09);o.start(c.currentTime);o.stop(c.currentTime+.09);}catch(e){}
}
function ckOk(){
  if(!clickOn)return;
  try{const c=gctx();[523,659,784].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=f;g.gain.setValueAtTime(.07,c.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+i*.1+.15);o.start(c.currentTime+i*.1);o.stop(c.currentTime+i*.1+.15);});}catch(e){}
}
document.addEventListener('click',function unlockAudio(){aud.play().then(()=>{aud.pause();aud.currentTime=0;}).catch(()=>{});document.removeEventListener('click',unlockAudio);},{once:true});

/* ============================================================
   HELPERS
============================================================ */
function toAr(n){return String(n).replace(/\d/g,d=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);}
function sh(msg,dur=2700){toast.textContent=msg;toast.classList.add('show');clearTimeout(toast._t);toast._t=setTimeout(()=>toast.classList.remove('show'),dur);}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function safeAttr(s){return String(s).replace(/'/g,'&#39;').replace(/"/g,'&quot;');}
function fmtDiff(ms){const h=Math.floor(ms/3600000),m=Math.floor((ms%3600000)/60000),s=Math.floor((ms%60000)/1000);return`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}

/* ============================================================
   SIDE MENU
============================================================ */
function openSide(){ck();G('side-menu').classList.add('open');G('side-overlay').classList.add('show');}
function closeSide(){G('side-menu').classList.remove('open');G('side-overlay').classList.remove('show');}
function refToggles(){
  G('tg-dark').classList.toggle('on',document.body.classList.contains('dark-mode'));
  G('tg-notif').classList.toggle('on',typeof Notification!=='undefined'&&Notification.permission==='granted');
  G('tg-click').classList.toggle('on',clickOn);
}
function toggleDark(){ck();document.body.classList.toggle('dark-mode');localStorage.setItem('darkMode',document.body.classList.contains('dark-mode'));refToggles();}
function toggleNotifSetting(){ck();if(typeof Notification==='undefined'){sh('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');return;}if(Notification.permission!=='granted')reqNotif();else sh('Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù‘Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„');}
function toggleClickSnd(){clickOn=!clickOn;localStorage.setItem('clickSnd',clickOn);refToggles();sh(clickOn?'ğŸ”Š Ø§Ù„Ø£ØµÙˆØ§Øª Ù…ÙØ¹Ù‘Ù„Ø©':'ğŸ”‡ Ø§Ù„Ø£ØµÙˆØ§Øª Ù…ÙƒØªÙˆÙ…Ø©');}

/* ============================================================
   VIEWER NAVIGATION
============================================================ */
function openViewer(){
  stopSkyAnim();
  viewer.style.display='flex';
  setTimeout(()=>viewer.classList.add('active'),10);
  G('search-panel').classList.remove('open');
  G('sr-area').style.display='none';
  G('nic-search').classList.remove('vis');
  G('player-bar').classList.remove('show');
  G('asbtn').style.display='none';
  G('spctl').style.display='none';
  G('scroll-top-btn').classList.remove('show');
}
function openMod(type){ck();navStack.length=0;openViewer();route(type);}
function route(t){
  if(t==='quran')renderSurahList();
  else if(t==='azkar')renderAzkar();
  else if(t==='prayers')renderPrayers();
  else if(t==='tasbih')renderTasbih();
  else if(t==='reciters')renderReciters();
  else if(t==='names')renderNames();
  else if(t==='khatma')renderKhatma();
  else if(t==='bookmarks')renderBookmarks();
  else if(t==='search')renderSearchPage();
  else if(t==='duas')renderDuas();
}
function doBack(){
  ck();clearInterval(countInv);stopScroll();
  G('search-panel').classList.remove('open');
  G('sr-area').style.display='none';
  G('asbtn').style.display='none';
  G('spctl').style.display='none';
  G('scroll-top-btn').classList.remove('show');
  if(navStack.length>0){const fn=navStack.pop();fn();}
  else{
    viewer.classList.remove('active');
    setTimeout(()=>{viewer.style.display='none';const nx=nextPrayer();if(nx)startSkyAnim(nx.key);},380);
  }
  aud.pause();
}
function pushNav(fn){navStack.push(fn);}

/* ============================================================
   SCROLL TO TOP (in viewer)
============================================================ */
function scrollToTop(){vBody.scrollTo({top:0,behavior:'smooth'});}
vBody&&vBody.addEventListener('scroll',()=>{
  G('scroll-top-btn').classList.toggle('show',vBody.scrollTop>300);
});

/* ============================================================
   HIJRI DATE
============================================================ */
function renderHijriDate(){
  try{
    const now=new Date();
    const hijri=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'numeric',month:'long',year:'numeric'}).format(now);
    const greg=new Intl.DateTimeFormat('ar',{day:'numeric',month:'long',year:'numeric'}).format(now);
    G('hijri-date').textContent=hijri;
    G('gregorian-date').textContent=greg;
  }catch(e){
    G('hijri-date').textContent='';G('gregorian-date').textContent='';
  }
}

/* ============================================================
   STATS HOME
============================================================ */
function updateHomeStats(){
  G('stat-bm').textContent=toAr(bookmarks.length);
  G('stat-tas').textContent=toAr(parseInt(localStorage.getItem('tasbihCount')||'0'));
  const first=parseInt(localStorage.getItem('firstVisit')||'0');
  const days=first?Math.max(1,Math.floor((Date.now()-first)/86400000)):1;
  G('stat-days').textContent=toAr(days);
}

/* ============================================================
   LAST READ
============================================================ */
function saveLastRead(surahId,surahName,ayahNum){
  const data={surahId,surahName,ayahNum,date:Date.now()};
  localStorage.setItem('lastRead',JSON.stringify(data));
  updateLastReadBar();
}
function updateLastReadBar(){
  try{
    const d=JSON.parse(localStorage.getItem('lastRead')||'null');
    if(!d||!d.surahName||!d.ayahNum){G('last-read-bar').style.display='none';return;}
    G('last-read-bar').style.display='flex';
    G('lr-text').textContent=`Ø³ÙˆØ±Ø© ${d.surahName} - Ø¢ÙŠØ© ${toAr(d.ayahNum)}`;
  }catch(e){G('last-read-bar').style.display='none';}
}
async function goLastRead(){
  try{
    const d=JSON.parse(localStorage.getItem('lastRead')||'null');
    if(!d)return;
    ck();
    openViewer();
    navStack.length=0;
    await renderAyahs(d.surahId,d.surahName);
    setTimeout(()=>{const el=G('ayah-'+d.ayahNum);if(el)el.scrollIntoView({behavior:'smooth',block:'center'});},600);
  }catch(e){}
}

/* ============================================================
   ONLOAD
============================================================ */
window.addEventListener('load',async()=>{
  // First visit
  if(!localStorage.getItem('firstVisit'))localStorage.setItem('firstVisit',Date.now().toString());
  setTimeout(()=>{G('splash').style.opacity='0';setTimeout(()=>G('splash').style.display='none',750);},2200);
  if(localStorage.getItem('darkMode')==='true')document.body.classList.add('dark-mode');
  refToggles();
  renderHijriDate();
  updateHomeStats();
  updateLastReadBar();
  G('city-display').textContent=currentCity;

  // Load quran xml
  try{const r=await fetch('quran-simple.xml');const t=await r.text();quranXml=new DOMParser().parseFromString(t,'text/xml');}catch(e){}

  await loadPrayers();
  startMini();

  if(typeof Notification!=='undefined'&&Notification.permission==='default'&&!localStorage.getItem('nd')){
    G('notif-banner').style.display='flex';
  }
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js')
      .then(async r=>{
        window.swReg=r;
        if(r.installing)await new Promise(res=>{r.installing.addEventListener('statechange',function(){if(this.state==='activated')res();});});
        if(typeof Notification!=='undefined'&&Notification.permission==='granted')schedNotifs();
      }).catch(e=>console.warn('SW:',e));
  }

  // Handle hash shortcuts
  const hash=location.hash.replace('#','');
  if(hash&&['quran','prayers','azkar','tasbih','reciters','names','duas','khatma'].includes(hash)){openMod(hash);}
});

/* ============================================================
   PRAYER TIMES
============================================================ */
async function loadPrayers(){
  const c=localStorage.getItem('pt'),cd=localStorage.getItem('ptd'),today=new Date().toDateString();
  if(c&&cd===today){prayerTimes=JSON.parse(c);return;}
  try{
    const r=await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(currentCity)}&country=${encodeURIComponent(currentCountry)}&method=5`);
    const d=await r.json();
    if(d.data){prayerTimes=d.data.timings;localStorage.setItem('pt',JSON.stringify(prayerTimes));localStorage.setItem('ptd',today);}
  }catch(e){if(c)prayerTimes=JSON.parse(c);}
}
function nextPrayer(){
  if(!prayerTimes)return null;
  const ks=['Fajr','Dhuhr','Asr','Maghrib','Isha'],ns={Fajr:'Ø§Ù„ÙØ¬Ø±',Dhuhr:'Ø§Ù„Ø¸Ù‡Ø±',Asr:'Ø§Ù„Ø¹ØµØ±',Maghrib:'Ø§Ù„Ù…ØºØ±Ø¨',Isha:'Ø§Ù„Ø¹Ø´Ø§Ø¡'};
  const now=new Date();
  for(const k of ks){
    if(!prayerTimes[k])continue;
    const[h,m]=prayerTimes[k].split(':');const t=new Date();t.setHours(+h,+m,0,0);
    if(t>now)return{name:ns[k],time:t,key:k};
  }
  const[h,m]=(prayerTimes.Fajr||'05:00').split(':');
  const t=new Date();t.setDate(t.getDate()+1);t.setHours(+h,+m,0,0);
  return{name:'Ø§Ù„ÙØ¬Ø±',time:t,key:'Fajr'};
}
/* ============================================================
   SKY CANVAS â€” Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØ­Ø±Ùƒ
============================================================ */
const SKY_SCENES={
  Fajr:{   sky:['#0a0e2a','#1a1040','#2d1b5a'],  bodyColor:'#ffd700', bodyR:20, bodyType:'moon',  horizon:'#1a2040', groundColor:'#0d1520', label:'Ø§Ù„ÙØ¬Ø± ğŸŒ™'},
  Dhuhr:{  sky:['#1a6fb5','#2196f3','#87ceeb'],   bodyColor:'#fff7aa', bodyR:28, bodyType:'sun',   horizon:'#4db8ff', groundColor:'#0f5c2e', label:'Ø§Ù„Ø¸Ù‡Ø± â˜€ï¸'},
  Asr:{    sky:['#e8750a','#f0a500','#ffd580'],   bodyColor:'#ffcc00', bodyR:26, bodyType:'sun',   horizon:'#f0a040', groundColor:'#2d5a1b', label:'Ø§Ù„Ø¹ØµØ± ğŸŒ¤ï¸'},
  Maghrib:{sky:['#1a0a30','#6b1a5a','#d4562a'],  bodyColor:'#ff6a00', bodyR:30, bodyType:'sun',   horizon:'#d4562a', groundColor:'#1a1a1a', label:'Ø§Ù„Ù…ØºØ±Ø¨ ğŸŒ‡'},
  Isha:{   sky:['#000510','#050d1e','#0a1628'],   bodyColor:'#e8e8ff', bodyR:18, bodyType:'moon',  horizon:'#0a1628', groundColor:'#050d14', label:'Ø§Ù„Ø¹Ø´Ø§Ø¡ ğŸŒ™'}
};

let _skyAnim=null,_skyPhase=0,_curScene=null,_stars=[];

function initStars(n){
  _stars=[];
  for(let i=0;i<n;i++){_stars.push({x:Math.random(),y:Math.random()*0.65,r:Math.random()*1.5+.3,a:Math.random()});}
}

function drawSky(scene,phase){
  const canvas=G('sky-canvas');if(!canvas)return;
  const W=canvas.width,H=canvas.height;
  const ctx=canvas.getContext('2d');
  const s=scene;

  // Sky gradient
  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,s.sky[0]);
  grad.addColorStop(.5,s.sky[1]);
  grad.addColorStop(1,s.sky[2]);
  ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);

  // Stars (Fajr + Isha)
  if(s.bodyType==='moon'||s.sky[0].startsWith('#0')||s.sky[0].startsWith('#1a0')){
    _stars.forEach(st=>{
      const twinkle=Math.sin(phase*2+st.a*10)*.3+.7;
      ctx.beginPath();ctx.arc(st.x*W,st.y*H,st.r,0,Math.PI*2);
      ctx.fillStyle=`rgba(255,255,255,${twinkle*0.85})`;ctx.fill();
    });
  }

  // Body position â€” ÙŠØªØ­Ø±Ùƒ Ø­Ø³Ø¨ phase (0=Ø£ÙÙ‚â†’1=ÙˆØ³Ø· Ø§Ù„Ø³Ù…Ø§Ø¡)
  const bodyX=W*0.5;
  const minY=H*0.12,maxY=H*0.82;
  // Ø¹Ù†Ø¯ Maghrib: Ø§Ù„Ø´Ù…Ø³ ØªØºØ±Ø¨ â†’ ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ù…Ù†ØªØµÙ ÙˆØªÙ†Ø²Ù„ Ù„Ù„Ø£ÙÙ‚
  let bodyProgress=phase; // 0..1
  const bodyY=s===SKY_SCENES.Maghrib
    ? maxY-(maxY-H*0.3)*Math.sin(bodyProgress*Math.PI*0.5)  // ØªØºØ±Ø¨
    : minY+(maxY-minY)*(1-Math.sin(bodyProgress*Math.PI*0.5)); // Ø§Ù„Ø¨Ø§Ù‚ÙŠ: ØªØ´Ø±Ù‚ ÙˆØªØ¹Ù„Ùˆ

  // Glow
  const glow=ctx.createRadialGradient(bodyX,bodyY,0,bodyX,bodyY,s.bodyR*3.5);
  glow.addColorStop(0,s.bodyColor+'88');glow.addColorStop(1,'transparent');
  ctx.beginPath();ctx.arc(bodyX,bodyY,s.bodyR*3.5,0,Math.PI*2);
  ctx.fillStyle=glow;ctx.fill();

  // Body
  ctx.beginPath();ctx.arc(bodyX,bodyY,s.bodyR,0,Math.PI*2);
  ctx.fillStyle=s.bodyColor;ctx.fill();

  // Moon crescent
  if(s.bodyType==='moon'){
    ctx.beginPath();ctx.arc(bodyX+s.bodyR*.35,bodyY-s.bodyR*.1,s.bodyR*.82,0,Math.PI*2);
    ctx.fillStyle=s.sky[1];ctx.fill();
    // Ù†Ø¬Ù…Ø© ØµØºÙŠØ±Ø©
    ctx.font=`${s.bodyR*.65}px serif`;ctx.fillStyle=s.bodyColor;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('âœ¦',bodyX+s.bodyR*1.4,bodyY-s.bodyR*.9);
  }

  // Horizon glow
  const hGrad=ctx.createLinearGradient(0,H*0.6,0,H);
  hGrad.addColorStop(0,s.horizon+'44');hGrad.addColorStop(1,s.horizon+'00');
  ctx.fillStyle=hGrad;ctx.fillRect(0,H*0.6,W,H*0.4);

  // Ground silhouette (mosque skyline)
  drawMosque(ctx,W,H,s.groundColor);
}

function drawMosque(ctx,W,H,color){
  ctx.fillStyle=color;
  // Ø£Ø±Ø¶ÙŠØ©
  ctx.fillRect(0,H-14,W,14);
  // Ù…Ø³Ø§Ø¬Ø¯ Ù…Ø¨Ø³Ù‘Ø·Ø©
  const M=(x,w,h,d=8)=>{
    // Ø¬Ø³Ù…
    ctx.fillRect(x,H-14-h,w,h);
    // Ù‚Ø¨Ø©
    ctx.beginPath();ctx.arc(x+w/2,H-14-h,w*.38,Math.PI,0);ctx.fill();
    // Ù…Ø¦Ø°Ù†Ø©
    ctx.fillRect(x+w+2,H-14-d*2.4,5,d*2.4);
    ctx.beginPath();ctx.arc(x+w+4.5,H-14-d*2.4,4,Math.PI,0);ctx.fill();
  };
  M(W*.08,36,28,10);
  M(W*.35,48,38,13);
  M(W*.62,40,30,11);
  // Ù†Ø®ÙŠÙ„
  const P=(x,h)=>{ctx.fillRect(x-2,H-14-h,4,h);ctx.font=`${h*.55}px serif`;ctx.fillText('ğŸŒ´',x-10,H-14-h+6);};
  P(W*.22,22);P(W*.78,18);P(W*.88,20);
}

function startSkyAnim(prayerKey){
  if(_skyAnim)cancelAnimationFrame(_skyAnim);
  _curScene=SKY_SCENES[prayerKey]||SKY_SCENES.Dhuhr;
  const canvas=G('sky-canvas');if(!canvas)return;
  canvas.width=canvas.offsetWidth||window.innerWidth;
  canvas.height=130;
  initStars(35);
  _skyPhase=0;
  const speed=0.004;
  function loop(){
    _skyPhase=(_skyPhase+speed)%1;
    drawSky(_curScene,_skyPhase);
    _skyAnim=requestAnimationFrame(loop);
  }
  loop();
}

function stopSkyAnim(){if(_skyAnim){cancelAnimationFrame(_skyAnim);_skyAnim=null;}}

function startMini(){
  clearInterval(miniInv);
  miniInv=setInterval(()=>{
    const nx=nextPrayer();if(!nx)return;
    const diff=nx.time-new Date();if(diff<0)return;
    // update prayer scene
    const nameEl=G('pi-name'),timerEl=G('pi-timer');
    if(nameEl){
      const sc=SKY_SCENES[nx.key];
      nameEl.textContent=sc?sc.label:nx.name;
    }
    if(timerEl)timerEl.textContent=toAr(fmtDiff(diff));
    // start sky animation for current prayer
    if(_curScene!==SKY_SCENES[nx.key])startSkyAnim(nx.key);
    if(diff<300000&&diff>290000)notifPrayer(nx.name,Math.round(diff/60000));
  },1000);
  // immediate first draw
  const nx=nextPrayer();
  if(nx){
    startSkyAnim(nx.key);
    const sc=SKY_SCENES[nx.key];
    const nameEl=G('pi-name');if(nameEl)nameEl.textContent=sc?sc.label:nx.name;
  }
}
function startCountdown(){
  clearInterval(countInv);
  countInv=setInterval(()=>{
    const nx=nextPrayer();if(!nx)return;
    const diff=nx.time-new Date();if(diff<0)return;
    const ne=G('next-name'),te=G('next-timer');
    if(ne)ne.textContent=nx.name;if(te)te.textContent=toAr(fmtDiff(diff));
    document.querySelectorAll('.p-row').forEach(r=>r.classList.remove('acp'));
    const rw=G('row-'+nx.key);if(rw)rw.classList.add('acp');
  },1000);
}

/* city change */
function changeCity(){
  ck();
  const cities=[
    {n:'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©',c:'Cairo',co:'Egypt'},{n:'Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©',c:'Mecca',co:'Saudi Arabia'},
    {n:'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©',c:'Medina',co:'Saudi Arabia'},{n:'Ø§Ù„Ø±ÙŠØ§Ø¶',c:'Riyadh',co:'Saudi Arabia'},
    {n:'Ø¯Ø¨ÙŠ',c:'Dubai',co:'UAE'},{n:'Ø§Ù„ÙƒÙˆÙŠØª',c:'Kuwait City',co:'Kuwait'},
    {n:'Ø¹Ù…Ù‘Ø§Ù†',c:'Amman',co:'Jordan'},{n:'Ø¨ØºØ¯Ø§Ø¯',c:'Baghdad',co:'Iraq'},
    {n:'Ø§Ù„Ø¯ÙˆØ­Ø©',c:'Doha',co:'Qatar'},{n:'Ø§Ù„Ø®Ø±Ø·ÙˆÙ…',c:'Khartoum',co:'Sudan'},
    {n:'ØªÙˆÙ†Ø³',c:'Tunis',co:'Tunisia'},{n:'Ø§Ù„Ø¯Ø§Ø± Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡',c:'Casablanca',co:'Morocco'},
    {n:'Ø¥Ø³Ø·Ù†Ø¨ÙˆÙ„',c:'Istanbul',co:'Turkey'},{n:'Ø¬Ø§ÙƒØ±ØªØ§',c:'Jakarta',co:'Indonesia'},
    {n:'Ù„Ù†Ø¯Ù†',c:'London',co:'UK'},{n:'Ø¨Ø§Ø±ÙŠØ³',c:'Paris',co:'France'}
  ];
  let html=`<div style="padding:16px;background:var(--card);border-radius:20px 20px 0 0;max-height:70vh;overflow-y:auto">
    <h3 style="color:var(--accent);text-align:center;margin-bottom:14px;font-family:'Reem Kufi'">Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†ØªÙƒ</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    ${cities.map(ct=>`<button onclick="selectCity('${ct.c}','${ct.co}','${ct.n}')" style="padding:11px;border-radius:11px;border:1.5px solid rgba(212,175,55,.2);background:var(--primary);color:var(--accent);font-family:'Amiri';font-size:.9em;cursor:pointer${currentCity===ct.c?';background:var(--accent);color:var(--primary)':''}">${ct.n}</button>`).join('')}
    </div>
    <button onclick="document.getElementById('city-modal').style.display='none'" style="width:100%;margin-top:12px;padding:11px;border-radius:11px;border:1.5px solid rgba(212,175,55,.3);background:transparent;color:var(--gray);font-family:'Amiri';font-size:.9em;cursor:pointer">Ø¥Ù„ØºØ§Ø¡</button>
  </div>`;
  let m=G('city-modal');
  if(!m){m=document.createElement('div');m.id='city-modal';m.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9001;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(3px)';m.onclick=e=>{if(e.target===m)m.style.display='none';};document.body.appendChild(m);}
  m.innerHTML=html;m.style.display='flex';
}
async function selectCity(city,country,nameAr){
  const m=G('city-modal');if(m)m.style.display='none';
  currentCity=city;currentCountry=country;
  localStorage.setItem('prayerCity',city);localStorage.setItem('prayerCountry',country);
  G('city-display').textContent=nameAr;
  localStorage.removeItem('pt');localStorage.removeItem('ptd');
  prayerTimes=null;
  await loadPrayers();
  startMini();
  sh('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: '+nameAr);
}

/* ============================================================
   NOTIFICATIONS
============================================================ */
async function reqNotif(){
  ck();
  if(typeof Notification==='undefined'){sh('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');return;}
  const p=await Notification.requestPermission();
  G('notif-banner').style.display='none';
  if(p==='granted'){
    if(!window.swReg&&'serviceWorker' in navigator){try{window.swReg=await navigator.serviceWorker.ready;}catch(e){}}
    sh('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');schedNotifs();
  }else sh('Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†');
  refToggles();
}
function dismissBanner(){G('notif-banner').style.display='none';localStorage.setItem('nd','1');}
function notifPrayer(name,mins){
  if(typeof Notification==='undefined'||Notification.permission!=='granted')return;
  if(notifSched)return;notifSched=true;setTimeout(()=>notifSched=false,65000);
  const opts={body:`Ø¨Ø§Ù‚ÙŠ ${toAr(mins)} Ø¯Ù‚Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø© ${name}`,icon:'./icon.png',dir:'rtl',vibrate:[200,100,200],tag:'ps'};
  if(window.swReg)window.swReg.showNotification(`ğŸ•Œ Ù‚Ø±ÙŠØ¨Ø§Ù‹: ${name}`,opts);
  else new Notification(`ğŸ•Œ Ù‚Ø±ÙŠØ¨Ø§Ù‹: ${name}`,opts);
}
async function schedNotifs(){
  if(!prayerTimes||typeof Notification==='undefined'||Notification.permission!=='granted')return;
  if(!window.swReg&&'serviceWorker' in navigator){try{window.swReg=await navigator.serviceWorker.ready;}catch(e){}}
  const ns={Fajr:'Ø§Ù„ÙØ¬Ø±',Dhuhr:'Ø§Ù„Ø¸Ù‡Ø±',Asr:'Ø§Ù„Ø¹ØµØ±',Maghrib:'Ø§Ù„Ù…ØºØ±Ø¨',Isha:'Ø§Ù„Ø¹Ø´Ø§Ø¡'};const now=new Date();
  for(const[k,n]of Object.entries(ns)){
    if(!prayerTimes[k])continue;
    const[h,m]=prayerTimes[k].split(':');const pt=new Date();pt.setHours(+h,+m,0,0);
    const delay=pt-now-5*60000;if(delay>0)setTimeout(()=>{
      if(window.swReg)window.swReg.showNotification(`ğŸ•Œ Ø­Ø§Ù† ÙˆÙ‚Øª ${n}`,{body:'Ø§Ù„ØµÙ„Ø§Ø© Ø®ÙŠØ± Ù…Ù† Ø§Ù„Ù†ÙˆÙ…',icon:'./icon.png',dir:'rtl',vibrate:[300,100,300,100,300],tag:'p'+k});
      else new Notification(`ğŸ•Œ Ø­Ø§Ù† ÙˆÙ‚Øª ${n}`,{body:'Ø§Ù„ØµÙ„Ø§Ø© Ø®ÙŠØ± Ù…Ù† Ø§Ù„Ù†ÙˆÙ…',icon:'./icon.png',dir:'rtl',tag:'p'+k});
    },delay);
  }
  sh('âœ… ØªÙ… Ø¬Ø¯ÙˆÙ„Ø© ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©');
}

/* ============================================================
   SEARCH
============================================================ */
function togSearchPanel(){ck();const p=G('search-panel');const op=p.classList.toggle('open');G('sr-area').style.display=op?'block':'none';if(op)setTimeout(()=>G('s-inp').focus(),300);}
function setFlt(btn,f){ck();activeFilter=f;document.querySelectorAll('.fchip').forEach(c=>c.classList.remove('on'));btn.classList.add('on');const q=G('s-inp').value.trim();if(q.length>=2)doSearch(q);}
function debSearch(v){clearTimeout(sDeb);if(v.trim().length<2){G('sr-area').innerHTML='';return;}sDeb=setTimeout(()=>doSearch(v.trim()),450);}
async function doSearch(q){
  const area=G('sr-area');area.style.display='block';area.innerHTML='<p style="padding:14px;color:var(--accent)">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';
  try{
    const scope=(activeFilter==='surah'&&curSurahId)?curSurahId:'all';
    const url=`https://api.alquran.cloud/v1/search/${encodeURIComponent(q)}/${scope}/ar`;
    const r=await fetch(url);const d=await r.json();
    if(!d.data||!d.data.matches||!d.data.matches.length){area.innerHTML='<p style="padding:20px;text-align:center;color:gray">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';return;}
    let ms=d.data.matches;
    if(activeFilter==='exact'){const re=new RegExp('(^|\\s)'+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'(\\s|$)');ms=ms.filter(m=>re.test(m.text));}
    if(!ms.length){area.innerHTML='<p style="padding:20px;text-align:center;color:gray">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù‚ÙŠÙ‚</p>';return;}
    let html=`<div class="sr-count">ğŸ” ÙˆØ¬Ø¯ ${toAr(ms.length)} Ù†ØªÙŠØ¬Ø©</div>`;
    ms.slice(0,60).forEach(m=>{html+=`<div class="sr-item" onclick="fromSearch(${m.surah.number},'${safeAttr(m.surah.name)}',${m.number})"><div class="sr-meta">${esc(m.surah.name)} â€¢ Ø¢ÙŠØ© ${toAr(m.numberInSurah)}</div><div class="sr-txt">${hlText(m.text,q)}</div></div>`;});
    area.innerHTML=html;
  }catch(e){
    if(quranXml)offSearch(q,area);
    else area.innerHTML='<p style="padding:20px;text-align:center;color:gray">ØªØ­ØªØ§Ø¬ Ø§ØªØµØ§Ù„Ø§Ù‹ Ù„Ù„Ø¨Ø­Ø«</p>';
  }
}
function hlText(txt,q){const s=esc(txt);const sq=esc(q).replace(/[.*+?^${}()|[\]\\]/g,'\\$&');return s.replace(new RegExp(sq,'g'),'<span class="hl">$&</span>');}
function offSearch(q,area){
  const ayahs=quranXml.querySelectorAll('aya');let res=[],cnt=0;
  ayahs.forEach(a=>{if(cnt>=40)return;const t=a.getAttribute('text')||'';if(t.includes(q)){const su=a.parentElement;res.push({t,i:+a.getAttribute('index'),sn:su.getAttribute('name'),si:+su.getAttribute('index')});cnt++;}});
  if(!res.length){area.innerHTML='<p style="padding:20px;text-align:center;color:gray">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';return;}
  let html=`<div class="sr-count">ğŸ” ÙˆØ¬Ø¯ ${toAr(res.length)} Ù†ØªÙŠØ¬Ø©</div>`;
  res.forEach(r=>{html+=`<div class="sr-item" onclick="fromSearch(${r.si},'${safeAttr(r.sn)}',null)"><div class="sr-meta">${esc(r.sn)} â€¢ Ø¢ÙŠØ© ${toAr(r.i)}</div><div class="sr-txt">${hlText(r.t,q)}</div></div>`;});
  area.innerHTML=html;
}
async function fromSearch(sNum,sName,ayahNum){
  ck();G('search-panel').classList.remove('open');G('sr-area').style.display='none';
  pushNav(renderSearchPage);await renderAyahs(sNum,sName);
  if(ayahNum){setTimeout(()=>{const el=G('ayah-'+ayahNum);if(el)el.scrollIntoView({behavior:'smooth',block:'center'});},650);}
}
function renderSearchPage(){
  vTitle.textContent='Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†';
  G('nic-search').classList.add('vis');G('search-panel').classList.add('open');G('sr-area').style.display='block';
  G('sr-area').innerHTML='<p style="padding:30px;text-align:center;color:var(--gray);font-size:.9em">Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø¢ÙŠØ© Ù„Ù„Ø¨Ø­Ø«</p>';
  vBody.innerHTML='';setTimeout(()=>G('s-inp').focus(),350);
}

/* ============================================================
   SURAH LIST
============================================================ */
async function renderSurahList(){
  vTitle.textContent='ÙÙ‡Ø±Ø³ Ø§Ù„Ø³ÙˆØ±';
  G('nic-search').classList.add('vis');G('asbtn').style.display='none';G('spctl').style.display='none';
  vBody.innerHTML='<p style="text-align:center;padding:40px;color:var(--accent)">â³ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±...</p>';
  curSurahId=null;
  const tabs=`<div class="tab-bar"><button class="tbb on" onclick="ck();renderSurahList()">Ø§Ù„Ø³ÙˆØ±</button><button class="tbb" onclick="ck();renderJuzList()">Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡</button><button class="tbb" onclick="ck();renderPageList()">Ø§Ù„ØµÙØ­Ø§Øª</button></div>`;
  try{
    const r=await fetch('https://api.alquran.cloud/v1/surah');const d=await r.json();
    let html=tabs+'<div class="grid" style="margin-top:0">';
    d.data.forEach(s=>{html+=`<div class="card" onclick="ck();pushNav(renderSurahList);renderAyahs(${s.number},'${safeAttr(s.name)}')"><b>${esc(s.name)}</b><small style="color:var(--gray);font-size:.76em">${toAr(s.numberOfAyahs)} Ø¢ÙŠØ© Â· ${esc(s.revelationType==='Meccan'?'Ù…ÙƒÙŠØ©':'Ù…Ø¯Ù†ÙŠØ©')}</small></div>`;});
    vBody.innerHTML=html+'</div>';
  }catch(e){
    if(quranXml){
      const ss=quranXml.querySelectorAll('sura');let html=tabs+'<div class="grid" style="margin-top:0">';
      ss.forEach(s=>{html+=`<div class="card" onclick="ck();pushNav(renderSurahList);renderAyahs(${s.getAttribute('index')},'${safeAttr(s.getAttribute('name'))}')"><b>${esc(s.getAttribute('name'))}</b></div>`;});
      vBody.innerHTML=html+'</div>';
    }else vBody.innerHTML='<p style="text-align:center;padding:40px">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„</p>';
  }
}

/* ============================================================
   JUZ LIST
============================================================ */
function renderJuzList(){
  vTitle.textContent='Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†';
  const tabs=`<div class="tab-bar"><button class="tbb" onclick="ck();renderSurahList()">Ø§Ù„Ø³ÙˆØ±</button><button class="tbb on" onclick="ck();renderJuzList()">Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡</button><button class="tbb" onclick="ck();renderPageList()">Ø§Ù„ØµÙØ­Ø§Øª</button></div>`;
  let html=tabs+'<div class="grid" style="margin-top:0">';
  for(let i=1;i<=30;i++)html+=`<div class="card" onclick="ck();pushNav(renderJuzList);renderJuzAyahs(${i})"><b>Ø§Ù„Ø¬Ø²Ø¡ ${toAr(i)}</b></div>`;
  vBody.innerHTML=html+'</div>';
}
async function renderJuzAyahs(jn){
  vTitle.textContent='Ø§Ù„Ø¬Ø²Ø¡ '+toAr(jn);
  G('asbtn').style.display='flex';G('spctl').style.display='flex';
  vBody.innerHTML='<p style="text-align:center;padding:40px;color:var(--accent)">â³ ØªØ­Ù…ÙŠÙ„...</p>';
  try{
    const r=await fetch(`https://api.alquran.cloud/v1/juz/${jn}/ar.alafasy`);const d=await r.json();
    let html=fctrl();
    d.data.ayahs.forEach(a=>{const bm=bookmarks.find(b=>b.num===a.number);html+=buildAyah(a.number,a.text,ayahAudioUrl(a.number),a.numberInSurah,a.surah.name,a.surah.number,bm,'');});
    vBody.innerHTML=html;
  }catch(e){vBody.innerHTML='<p style="text-align:center;padding:30px">ØªØ­ØªØ§Ø¬ Ø§ØªØµØ§Ù„Ø§Ù‹ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø²Ø¡</p>';}
  vBody.scrollTo(0,0);
}

/* ============================================================
   PAGE LIST (new feature)
============================================================ */
function renderPageList(){
  vTitle.textContent='ØµÙØ­Ø§Øª Ø§Ù„Ù…ØµØ­Ù';
  const tabs=`<div class="tab-bar"><button class="tbb" onclick="ck();renderSurahList()">Ø§Ù„Ø³ÙˆØ±</button><button class="tbb" onclick="ck();renderJuzList()">Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡</button><button class="tbb on" onclick="ck();renderPageList()">Ø§Ù„ØµÙØ­Ø§Øª</button></div>`;
  let html=tabs+'<div class="grid" style="margin-top:0">';
  for(let i=1;i<=604;i++)html+=`<div class="card" onclick="ck();pushNav(renderPageList);renderPage(${i})"><b>ØµÙØ­Ø© ${toAr(i)}</b></div>`;
  vBody.innerHTML=html+'</div>';
}
async function renderPage(pn){
  vTitle.textContent='ØµÙØ­Ø© '+toAr(pn);
  G('asbtn').style.display='flex';G('spctl').style.display='flex';
  vBody.innerHTML='<p style="text-align:center;padding:40px;color:var(--accent)">â³ ØªØ­Ù…ÙŠÙ„...</p>';
  try{
    const r=await fetch(`https://api.alquran.cloud/v1/page/${pn}/ar.alafasy`);const d=await r.json();
    let html=fctrl();
    d.data.ayahs.forEach(a=>{const bm=bookmarks.find(b=>b.num===a.number);html+=buildAyah(a.number,a.text,ayahAudioUrl(a.number),a.numberInSurah,a.surah.name,a.surah.number,bm,'');});
    vBody.innerHTML=html;
  }catch(e){vBody.innerHTML='<p style="text-align:center;padding:30px">ØªØ­ØªØ§Ø¬ Ø§ØªØµØ§Ù„Ø§Ù‹</p>';}
  vBody.scrollTo(0,0);
}

/* ============================================================
   SURAH AYAHS
============================================================ */
function ayahAudioUrl(absoluteNum){return`https://everyayah.com/data/Alafasy_128kbps/${String(absoluteNum).padStart(6,'0')}.mp3`;}

async function renderAyahs(id,name){
  vTitle.textContent='Ø³ÙˆØ±Ø© '+name;curSurahId=id;curSurahName=name;
  G('nic-search').classList.add('vis');
  G('asbtn').style.display='flex';G('spctl').style.display='flex';
  vBody.innerHTML='<p style="text-align:center;padding:40px;color:var(--accent)">â³ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø©...</p>';
  try{
    const[ar,tf]=await Promise.all([
      fetch(`https://api.alquran.cloud/v1/surah/${id}/ar.alafasy`),
      fetch(`https://api.alquran.cloud/v1/surah/${id}/ar.jalalayn`)
    ]);
    const arD=await ar.json(),tfD=await tf.json();
    let html=fctrl();
    // Ø¨Ø³Ù…Ù„Ø© (Ù…Ø§ Ø¹Ø¯Ø§ Ø³ÙˆØ±Ø© Ø§Ù„ØªÙˆØ¨Ø© ÙˆØ§Ù„ÙØ§ØªØ­Ø©)
    if(id!==9&&id!==1){html+=`<div class="bismillah-line">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>`;}
    arD.data.ayahs.forEach((a,i)=>{
      const bm=bookmarks.find(b=>b.num===a.number);
      const tf2=tfD.data?.ayahs?.[i]?.text||'';
      html+=buildAyah(a.number,a.text,ayahAudioUrl(a.number),a.numberInSurah,name,id,bm,tf2);
    });
    // reading progress
    const total=arD.data.numberOfAyahs||arD.data.ayahs.length;
    html+=`<div style="padding:16px 12px;text-align:center;color:var(--gray);font-size:.82em">${esc(name)} â€¢ ${toAr(total)} Ø¢ÙŠØ©</div>`;
    vBody.innerHTML=html;
  }catch(e){
    if(quranXml){
      const sura=quranXml.querySelector(`sura[index="${id}"]`);
      if(!sura){vBody.innerHTML='<p style="text-align:center;padding:40px">Ø§Ù„Ø³ÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£ÙˆÙÙ„Ø§ÙŠÙ†</p>';return;}
      const ayahs=sura.querySelectorAll('aya');let html=fctrl(),body='';
      if(id!==9&&id!==1)body+=`<div class="bismillah-line">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>`;
      ayahs.forEach(a=>{body+=`${esc(a.getAttribute('text'))} <span class="anum">ï´¿${toAr(a.getAttribute('index'))}ï´¾</span> `;});
      html+=`<div class="ayah-frame"><div class="qf" style="font-size:${fontSize}em;text-align:justify;line-height:2.2">${body}</div><p style="text-align:center;color:var(--gray);font-size:.8em;margin-top:14px">(ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† â€“ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªØ§Ø­)</p></div>`;
      vBody.innerHTML=html;
    }
  }
  vBody.scrollTo(0,0);
}

function buildAyah(num,text,audioUrl,numInS,sName,sId,bm,tafsir){
  const bmCls=bm?' bookmarked':'';
  const bmBtnCls=bm?' bmact':'';
  const safeAud=esc(audioUrl||'');
  const safeSn=safeAttr(sName);
  const tfBlock=tafsir?`<div class="tf-box" id="tf${num}">${esc(tafsir)}</div>`:'';
  const tfBtn=tafsir?`<button class="ab" onclick="event.stopPropagation();togTf(${num})">Ø§Ù„ØªÙØ³ÙŠØ±</button>`:'';
  return `<div class="ayah-frame${bmCls}" id="ayah-${num}" onclick="playSaut('${safeAud}',${num})">
  <div class="qf" style="font-size:${fontSize}em">${esc(text)} <span class="anum">ï´¿${toAr(numInS)}ï´¾</span></div>
  <div class="ayah-acts">
    <button class="ab${bmBtnCls}" id="bmbtn${num}" onclick="event.stopPropagation();togBm(${num},'${safeSn}',${numInS},${sId})">ğŸ”–</button>
    <button class="ab" onclick="event.stopPropagation();cpAyah('${esc(text)} ï´¿${numInS}ï´¾ - ${esc(sName)}')">Ù†Ø³Ø®</button>
    <button class="ab" onclick="event.stopPropagation();shareAyah('${esc(text)} ï´¿${numInS}ï´¾ - ${esc(sName)}')">Ù…Ø´Ø§Ø±ÙƒØ©</button>
    ${tfBtn}
    <button class="ab" onclick="event.stopPropagation();saveLastRead(${sId},'${safeSn}',${num});sh('âœ… ØªÙ… Ø­ÙØ¸ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©')">ğŸ“Œ Ø­ÙØ¸</button>
  </div>
  ${tfBlock}
</div>`;
}

function fctrl(){return`<div id="font-ctrl"><button onclick="chFont(-.2)">Ø£âˆ’</button><span>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</span><button onclick="chFont(.2)">Ø£+</button></div>`;}
function chFont(d){fontSize=Math.max(1,Math.min(3.2,fontSize+d));document.querySelectorAll('.qf').forEach(e=>e.style.fontSize=fontSize+'em');}

/* SHARE AYAH */
function shareAyah(text){
  if(navigator.share){navigator.share({text:text,title:'Ø¢ÙŠØ© Ù…Ù† Ù…ØµØ­Ù Ø§Ù„Ù†ÙˆØ±'}).catch(()=>{});}
  else{cpAyah(text);}
}

/* PLAY */
function playSaut(url,num){
  if(!url)return;ck();
  document.querySelectorAll('.ayah-frame').forEach(f=>f.classList.remove('playing'));
  const f=G('ayah-'+num);if(f)f.classList.add('playing');
  aud.src=url;aud.play().catch(err=>console.warn('audio:',err));
}
aud.addEventListener('ended',()=>document.querySelectorAll('.ayah-frame.playing').forEach(f=>f.classList.remove('playing')));

function cpAyah(t){navigator.clipboard.writeText(t).then(()=>sh('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®')).catch(()=>sh('ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®'));}
function togTf(n){ck();const b=G('tf'+n);if(b)b.style.display=b.style.display==='block'?'none':'block';}

/* ============================================================
   BOOKMARKS
============================================================ */
function togBm(num,sName,ayahInS,sId){
  ck();const idx=bookmarks.findIndex(b=>b.num===num);
  const btn=G('bmbtn'+num),frame=G('ayah-'+num);
  if(idx>=0){
    bookmarks.splice(idx,1);sh('ğŸ—‘ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©');
    if(btn)btn.classList.remove('bmact');if(frame)frame.classList.remove('bookmarked');
  }else{
    bookmarks.push({num,surah:sName,surahId:sId,ayah:ayahInS,date:new Date().toLocaleDateString('ar')});
    sh('ğŸ”– ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');ckOk();if(navigator.vibrate)navigator.vibrate(60);
    if(btn)btn.classList.add('bmact');if(frame)frame.classList.add('bookmarked');
  }
  localStorage.setItem('bm',JSON.stringify(bookmarks));
  updateHomeStats();
}
function renderBookmarks(){
  vTitle.textContent='Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© ğŸ”–';
  if(!bookmarks.length){vBody.innerHTML='<div style="text-align:center;padding:60px"><div style="font-size:4em">ğŸ”–</div><p style="color:var(--gray);margin-top:16px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø§Øª Ù…Ø±Ø¬Ø¹ÙŠØ©<br>Ø§Ø¶ØºØ· ğŸ”– Ø¨Ø¬Ø§Ù†Ø¨ Ø£ÙŠ Ø¢ÙŠØ© Ù„Ø­ÙØ¸Ù‡Ø§</p></div>';return;}
  let html=`<p style="padding:13px 14px;color:var(--accent)">${toAr(bookmarks.length)} Ø¥Ø´Ø§Ø±Ø© Ù…Ø­ÙÙˆØ¸Ø©</p>`;
  bookmarks.slice().reverse().forEach(bm=>{
    html+=`<div class="bm-item" onclick="ck();goBm(${bm.surahId||0},'${safeAttr(bm.surah)}',${bm.num})">
      <div><div style="color:var(--accent);font-weight:bold">Ø³ÙˆØ±Ø© ${esc(bm.surah)} - Ø¢ÙŠØ© ${toAr(bm.ayah)}</div><div style="color:var(--gray);font-size:.8em;margin-top:3px">${esc(bm.date)}</div></div>
      <button onclick="event.stopPropagation();delBm(${bm.num})" style="background:#8b0000;color:#fff;border:none;border-radius:9px;padding:7px 12px;cursor:pointer;font-family:'Amiri';flex-shrink:0;font-size:.85em">Ø­Ø°Ù</button>
    </div>`;
  });
  vBody.innerHTML=html;
}
function delBm(num){ck();bookmarks=bookmarks.filter(b=>b.num!==num);localStorage.setItem('bm',JSON.stringify(bookmarks));renderBookmarks();updateHomeStats();}
async function goBm(sId,sName,ayahNum){
  pushNav(renderBookmarks);
  if(sId){await renderAyahs(sId,sName);}
  else{try{const r=await fetch('https://api.alquran.cloud/v1/surah');const d=await r.json();const s=d.data.find(x=>x.name===sName);if(s)await renderAyahs(s.number,s.name);else{sh('ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙˆØ±Ø©');return;}}catch(e){sh('ØªØ­ØªØ§Ø¬ Ø§ØªØµØ§Ù„Ø§Ù‹');return;}}
  setTimeout(()=>{const el=G('ayah-'+ayahNum);if(el)el.scrollIntoView({behavior:'smooth',block:'center'});},700);
}

/* ============================================================
   AUTO SCROLL
============================================================ */
function updSpd(v){scrollSpd=110-v;if(isScroll){clearInterval(scrollInv);startScroll();}}
function togScroll(){if(isScroll){stopScroll();sh('â¹ ØªÙˆÙ‚Ù Ø§Ù„ØªÙ…Ø±ÙŠØ±');}else{isScroll=true;G('asbtn').innerHTML='Ø¥ÙŠÙ‚Ø§Ù';G('asbtn').style.background='var(--accent)';G('asbtn').style.color='var(--primary)';startScroll();sh('â–¶ Ø¨Ø¯Ø£ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');}}
function startScroll(){scrollInv=setInterval(()=>vBody.scrollTop+=1,scrollSpd);}
function stopScroll(){clearInterval(scrollInv);isScroll=false;G('asbtn').innerHTML='Ù†Ø²ÙˆÙ„<br>ØªÙ„Ù‚Ø§Ø¦ÙŠ';G('asbtn').style.background='var(--primary)';G('asbtn').style.color='var(--accent)';}

/* ============================================================
   RECITERS
============================================================ */
function renderReciters(){
  vTitle.textContent='Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø±Ø¦';G('player-bar').classList.remove('show');curRecBase=null;curRecName=null;
  const rec=[
    {n:'ÙŠØ§Ø³Ø± Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ',b:'https://server11.mp3quran.net/yasser/',i:'ğŸŒŸ'},
    {n:'Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ',b:'https://server8.mp3quran.net/afs/',i:'ğŸ™ï¸'},
    {n:'Ø¹Ø¨Ø¯Ø§Ù„Ø¨Ø§Ø³Ø· Ø¹Ø¨Ø¯Ø§Ù„ØµÙ…Ø¯',b:'https://server7.mp3quran.net/basit/',i:'âœ¨'},
    {n:'Ù…Ø­Ù…Ø¯ Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ',b:'https://server10.mp3quran.net/minsh/',i:'ğŸµ'},
    {n:'Ø³Ø¹Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ',b:'https://server7.mp3quran.net/s_gmd/',i:'ğŸ•Œ'},
    {n:'Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³',b:'https://server11.mp3quran.net/sds/',i:'ğŸŒ™'}
  ];
  let html='<div class="grid" style="margin-top:16px">';
  rec.forEach(r=>{html+=`<div class="card" onclick="ck();pushNav(renderReciters);loadRecSurahs('${safeAttr(r.b)}','${safeAttr(r.n)}')"><span style="font-size:2em">${r.i}</span><b style="font-size:.9em">${esc(r.n)}</b></div>`;});
  vBody.innerHTML=html+'</div>';
}
async function loadRecSurahs(base,rName){
  vTitle.textContent='ØªÙ„Ø§ÙˆØ© '+rName;curRecBase=base;curRecName=rName;
  vBody.innerHTML='<p style="text-align:center;padding:30px;color:var(--accent)">â³ ØªØ­Ù…ÙŠÙ„...</p>';
  try{
    const r=await fetch('https://api.alquran.cloud/v1/surah');const d=await r.json();
    let html='<div class="grid" style="margin-top:0">';
    d.data.forEach(s=>{html+=`<div class="card" onclick="ck();playRec('${safeAttr(base)}',${s.number},'${safeAttr(s.name)}')"><b style="font-size:.9em">${esc(s.name)}</b></div>`;});
    vBody.innerHTML=html+'</div>';
  }catch(e){vBody.innerHTML='<p style="text-align:center;padding:40px">Ø§Ù„ØªÙ„Ø§ÙˆØ§Øª ØªØ­ØªØ§Ø¬ Ø§ØªØµØ§Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</p>';}
}
function playRec(base,sNum,sName){
  ck();curRecSurahNum=sNum;
  const url=`${base}${String(sNum).padStart(3,'0')}.mp3`;
  aud.src=url;aud.play().catch(()=>sh('ØªØ¹Ø°Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ â€“ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„'));
  sh('â–¶ '+sName);G('pinfo').textContent=sName+' â€“ '+(curRecName||'');G('player-bar').classList.add('show');
}
function playPrevSurah(){if(curRecBase&&curRecSurahNum&&curRecSurahNum>1){curRecSurahNum--;playRec(curRecBase,curRecSurahNum,'Ø³ÙˆØ±Ø© '+toAr(curRecSurahNum));}}
function playNextSurah(){if(curRecBase&&curRecSurahNum&&curRecSurahNum<114){curRecSurahNum++;playRec(curRecBase,curRecSurahNum,'Ø³ÙˆØ±Ø© '+toAr(curRecSurahNum));}}
aud.addEventListener('ended',()=>{if(curRecBase&&curRecSurahNum)setTimeout(()=>playNextSurah(),1500);});
function stopAud(){ck();aud.pause();aud.currentTime=0;G('player-bar').classList.remove('show');curRecSurahNum=null;document.querySelectorAll('.ayah-frame.playing').forEach(f=>f.classList.remove('playing'));sh('â¹ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù');}

/* ============================================================
   TASBIH
============================================================ */
function renderTasbih(){
  vTitle.textContent='Ø§Ù„Ø³Ø¨Ø­Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©';
  sCount=parseInt(localStorage.getItem('tasbihCount')||'0');
  const phrases=['Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡','Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡','Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±','Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡','Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡','Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡','Ù„Ø§ Ø­ÙˆÙ„ ÙˆÙ„Ø§ Ù‚ÙˆØ© Ø¥Ù„Ø§ Ø¨Ø§Ù„Ù„Ù‡'];
  let cur=localStorage.getItem('tasbihPhrase')||phrases[0];
  const btns=phrases.map(p=>`<button class="tbb${p===cur?' on':''}" onclick="setPhrase('${safeAttr(p)}',this)">${esc(p)}</button>`).join('');
  const total33=Math.floor(sCount/33);
  vBody.innerHTML=`<div style="text-align:center;padding:16px 14px">
    <div class="tab-bar" style="justify-content:center;flex-wrap:wrap">${btns}</div>
    <div id="tp" style="font-size:1.15em;color:var(--accent);margin:10px 0;font-family:'Noto Naskh Arabic'">${esc(cur)}</div>
    <div id="sc" style="font-size:clamp(5em,18vw,7em);color:var(--accent);font-weight:bold;line-height:1;font-family:monospace">${toAr(sCount)}</div>
    <div id="scsub" style="color:var(--gray);margin:5px 0;font-size:.9em">${toAr(total33)} Ã— Ù£Ù£</div>
    <div class="sebha-circle" onclick="incTas()">Ø³Ø¨Ù‘Ø­<small>Ø§Ø¶ØºØ·</small></div>
    <div style="display:flex;gap:10px;margin-top:16px;justify-content:center">
      <button class="btn-back" onclick="sCount=0;localStorage.setItem('tasbihCount','0');G('sc').textContent='Ù ';G('scsub').textContent='Ù  Ã— Ù£Ù£';updateHomeStats()">ØªØµÙÙŠØ±</button>
    </div>
  </div>`;
}
function setPhrase(p,btn){ck();localStorage.setItem('tasbihPhrase',p);G('tp').textContent=p;document.querySelectorAll('.tbb').forEach(b=>b.classList.remove('on'));btn.classList.add('on');}
function incTas(){
  sCount++;ck();if(navigator.vibrate)navigator.vibrate(20);
  G('sc').textContent=toAr(sCount);G('scsub').textContent=toAr(Math.floor(sCount/33))+' Ã— Ù£Ù£';
  localStorage.setItem('tasbihCount',sCount);
  updateHomeStats();
  if(sCount%33===0){sh('ğŸŒŸ Ø£Ø­Ø³Ù†Øª! Ù£Ù£ ØªØ³Ø¨ÙŠØ­Ø©');ckOk();if(navigator.vibrate)navigator.vibrate([80,40,80]);}
}

/* ============================================================
   PRAYER TIMES SCREEN
============================================================ */
async function renderPrayers(){
  vTitle.textContent='Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©';
  if(!prayerTimes)await loadPrayers();
  const pNames={Fajr:'Ø§Ù„ÙØ¬Ø± ğŸŒ…',Sunrise:'Ø§Ù„Ø´Ø±ÙˆÙ‚ â˜€ï¸',Dhuhr:'Ø§Ù„Ø¸Ù‡Ø± â˜€ï¸',Asr:'Ø§Ù„Ø¹ØµØ± ğŸŒ¤ï¸',Sunset:'Ø§Ù„ØºØ±ÙˆØ¨ ğŸŒ‡',Maghrib:'Ø§Ù„Ù…ØºØ±Ø¨ ğŸŒ‡',Isha:'Ø§Ù„Ø¹Ø´Ø§Ø¡ ğŸŒ™',Midnight:'Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ ğŸŒ‘'};
  const mainPrayers=['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  let html=`<div id="next-card"><h3>â³ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</h3><div id="next-name">...</div><div id="next-timer">--:--:--</div></div>`;
  // main prayers
  mainPrayers.forEach(k=>{
    const t=prayerTimes&&prayerTimes[k]?toAr(prayerTimes[k]):'--:--';
    html+=`<div class="p-row" id="row-${k}"><span class="pn">${pNames[k]||k}</span><span class="pt">${t}</span></div>`;
  });
  // extra times toggle
  html+=`<div style="margin:10px 12px">
    <button class="tbb" onclick="togExtraTimes(this)" style="width:100%;justify-content:center">Ø¹Ø±Ø¶ Ø£ÙˆÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</button>
  </div>
  <div id="extra-times" style="display:none">
    ${['Sunrise','Sunset','Midnight','Imsak'].map(k=>{
      const t=prayerTimes&&prayerTimes[k]?toAr(prayerTimes[k]):'--:--';
      const n={Sunrise:'Ø§Ù„Ø´Ø±ÙˆÙ‚ â˜€ï¸',Sunset:'Ø§Ù„ØºØ±ÙˆØ¨ ğŸŒ‡',Midnight:'Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ ğŸŒ‘',Imsak:'Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ ğŸŒ™'};
      return`<div class="p-row"><span class="pn">${n[k]||k}</span><span class="pt">${t}</span></div>`;
    }).join('')}
  </div>
  <div style="padding:12px;display:flex;gap:9px">
    <button class="btn-back" style="flex:1" onclick="ck();schedNotifs()">ğŸ”” Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
    <button class="btn-back" style="flex:1;background:transparent;border:1.5px solid var(--accent);color:var(--accent)" onclick="changeCity()">ğŸ“ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</button>
  </div>`;
  vBody.innerHTML=html;startCountdown();
}
function togExtraTimes(btn){const el=G('extra-times');if(el.style.display==='none'){el.style.display='block';btn.textContent='Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©';}else{el.style.display='none';btn.textContent='Ø¹Ø±Ø¶ Ø£ÙˆÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©';}}

/* ============================================================
   AZKAR (improved)
============================================================ */
function renderAzkar(){
  vTitle.textContent='Ø­ØµÙ† Ø§Ù„Ù…Ø³Ù„Ù… ğŸ“¿';
  const categories=[
    {id:'morning',label:'Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ ğŸŒ…'},
    {id:'evening',label:'Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡ ğŸŒ™'},
    {id:'sleep',label:'Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù†ÙˆÙ… ğŸ˜´'},
    {id:'prayer',label:'Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„Ø§Ø© ğŸ•Œ'},
    {id:'general',label:'Ø£Ø°ÙƒØ§Ø± Ø¹Ø§Ù…Ø© âœ¨'}
  ];
  const tabs=categories.map((c,i)=>`<button class="tbb${i===0?' on':''}" onclick="ck();showAzkarCategory('${c.id}',this)">${c.label}</button>`).join('');
  const azkarData={
    morning:[
      {t:'Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­',d:'Ø£ØµØ¨Ø­Ù†Ø§ ÙˆØ£ØµØ¨Ø­ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡ØŒ ÙˆØ§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ØŒ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡ØŒ Ù„Ù‡ Ø§Ù„Ù…Ù„Ùƒ ÙˆÙ„Ù‡ Ø§Ù„Ø­Ù…Ø¯ ÙˆÙ‡Ùˆ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù‚Ø¯ÙŠØ±.',r:1},
      {t:'Ø¢ÙŠØ© Ø§Ù„ÙƒØ±Ø³ÙŠ',d:'Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ù„ÙØ§ Ø¥ÙÙ„ÙÙ°Ù‡Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ù‡ÙÙˆÙ Ø§Ù„Ù’Ø­ÙÙŠÙÙ‘ Ø§Ù„Ù’Ù‚ÙÙŠÙÙ‘ÙˆÙ…Ù Ûš Ù„ÙØ§ ØªÙØ£Ù’Ø®ÙØ°ÙÙ‡Ù Ø³ÙÙ†ÙØ©ÙŒ ÙˆÙÙ„ÙØ§ Ù†ÙÙˆÙ’Ù…ÙŒ Ûš Ù„ÙÙ‘Ù‡Ù Ù…ÙØ§ ÙÙÙŠ Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§ÙˆÙØ§ØªÙ ÙˆÙÙ…ÙØ§ ÙÙÙŠ Ø§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù.',r:1},
      {t:'Ø³ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØºÙØ§Ø±',d:'Ø§Ù„Ù„Ù‡Ù… Ø£Ù†Øª Ø±Ø¨ÙŠ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø£Ù†ØªØŒ Ø®Ù„Ù‚ØªÙ†ÙŠ ÙˆØ£Ù†Ø§ Ø¹Ø¨Ø¯ÙƒØŒ ÙˆØ£Ù†Ø§ Ø¹Ù„Ù‰ Ø¹Ù‡Ø¯Ùƒ ÙˆÙˆØ¹Ø¯Ùƒ Ù…Ø§ Ø§Ø³ØªØ·Ø¹ØªØŒ Ø£Ø¹ÙˆØ° Ø¨Ùƒ Ù…Ù† Ø´Ø± Ù…Ø§ ØµÙ†Ø¹ØªØŒ Ø£Ø¨ÙˆØ¡ Ù„Ùƒ Ø¨Ù†Ø¹Ù…ØªÙƒ Ø¹Ù„ÙŠÙ‘ ÙˆØ£Ø¨ÙˆØ¡ Ø¨Ø°Ù†Ø¨ÙŠ ÙØ§ØºÙØ± Ù„ÙŠØŒ ÙØ¥Ù†Ù‡ Ù„Ø§ ÙŠØºÙØ± Ø§Ù„Ø°Ù†ÙˆØ¨ Ø¥Ù„Ø§ Ø£Ù†Øª.',r:1},
      {t:'Ø§Ù„Ù…Ø¹ÙˆØ°Ø§Øª',d:'Ù‚ÙÙ„Ù’ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙØ±ÙØ¨ÙÙ‘ Ø§Ù„Ù’ÙÙÙ„ÙÙ‚Ù ... Ù‚ÙÙ„Ù’ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙØ±ÙØ¨ÙÙ‘ Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù',r:3},
      {t:'Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„ØµØ¨Ø§Ø­ÙŠ',d:'Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡.',r:100}
    ],
    evening:[
      {t:'Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡',d:'Ø£Ù…Ø³ÙŠÙ†Ø§ ÙˆØ£Ù…Ø³Ù‰ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡ØŒ ÙˆØ§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ØŒ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡ØŒ Ù„Ù‡ Ø§Ù„Ù…Ù„Ùƒ ÙˆÙ„Ù‡ Ø§Ù„Ø­Ù…Ø¯ ÙˆÙ‡Ùˆ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù‚Ø¯ÙŠØ±.',r:1},
      {t:'Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø°Ø©',d:'Ø£Ø¹ÙˆØ° Ø¨ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù„Ù‡ Ø§Ù„ØªØ§Ù…Ø§Øª Ù…Ù† Ø´Ø± Ù…Ø§ Ø®Ù„Ù‚.',r:3},
      {t:'Ø§Ù„ØµÙ„Ø§Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ÙŠ',d:'Ø§Ù„Ù„Ù‡Ù… ØµÙ„ÙÙ‘ ÙˆØ³Ù„ÙÙ‘Ù… Ø¹Ù„Ù‰ Ù†Ø¨ÙŠÙÙ‘Ù†Ø§ Ù…Ø­Ù…Ø¯.',r:10},
      {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¡',d:'Ø§Ù„Ù„Ù‡Ù… Ø¨Ùƒ Ø£Ù…Ø³ÙŠÙ†Ø§ ÙˆØ¨Ùƒ Ø£ØµØ¨Ø­Ù†Ø§ ÙˆØ¨Ùƒ Ù†Ø­ÙŠØ§ ÙˆØ¨Ùƒ Ù†Ù…ÙˆØª ÙˆØ¥Ù„ÙŠÙƒ Ø§Ù„Ù†Ø´ÙˆØ±.',r:1}
    ],
    sleep:[
      {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…',d:'Ø¨Ø§Ø³Ù…Ùƒ Ø±Ø¨ÙŠ ÙˆØ¶Ø¹Øª Ø¬Ù†Ø¨ÙŠ ÙˆØ¨Ùƒ Ø£Ø±ÙØ¹Ù‡ØŒ ÙØ¥Ù† Ø£Ù…Ø³ÙƒØª Ù†ÙØ³ÙŠ ÙØ§Ø±Ø­Ù…Ù‡Ø§ØŒ ÙˆØ¥Ù† Ø£Ø±Ø³Ù„ØªÙ‡Ø§ ÙØ§Ø­ÙØ¸Ù‡Ø§ Ø¨Ù…Ø§ ØªØ­ÙØ¸ Ø¨Ù‡ Ø¹Ø¨Ø§Ø¯Ùƒ Ø§Ù„ØµØ§Ù„Ø­ÙŠÙ†.',r:1},
      {t:'ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ù†ÙˆÙ…',d:'Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡. Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡. Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±.',r:33},
      {t:'Ø§Ù„Ø¥Ø®Ù„Ø§Øµ ÙˆØ§Ù„Ù…Ø¹ÙˆØ°ØªØ§Ù†',d:'Ù‚ÙÙ„Ù’ Ù‡ÙÙˆÙ Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø£ÙØ­ÙØ¯ÙŒ...',r:3}
    ],
    prayer:[
      {t:'Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ù„Ø§Ù…',d:'Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡. Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡. Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡. Ø§Ù„Ù„Ù‡Ù… Ø£Ù†Øª Ø§Ù„Ø³Ù„Ø§Ù… ÙˆÙ…Ù†Ùƒ Ø§Ù„Ø³Ù„Ø§Ù…ØŒ ØªØ¨Ø§Ø±ÙƒØª ÙŠØ§ Ø°Ø§ Ø§Ù„Ø¬Ù„Ø§Ù„ ÙˆØ§Ù„Ø¥ÙƒØ±Ø§Ù….',r:1},
      {t:'Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„Ø§Ø©',d:'Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡. Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡. Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±.',r:33},
      {t:'Ø¯Ø¹Ø§Ø¡ Ø®ØªÙ… Ø§Ù„ØµÙ„Ø§Ø©',d:'Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡ØŒ Ù„Ù‡ Ø§Ù„Ù…Ù„Ùƒ ÙˆÙ„Ù‡ Ø§Ù„Ø­Ù…Ø¯ ÙˆÙ‡Ùˆ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ù‚Ø¯ÙŠØ±.',r:1}
    ],
    general:[
      {t:'Ø§Ù„Ø­ÙˆÙ‚Ù„Ø©',d:'Ù„Ø§ Ø­ÙˆÙ„ ÙˆÙ„Ø§ Ù‚ÙˆØ© Ø¥Ù„Ø§ Ø¨Ø§Ù„Ù„Ù‡.',r:10},
      {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„ÙƒØ±Ø¨',d:'Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø¸ÙŠÙ… Ø§Ù„Ø­Ù„ÙŠÙ…ØŒ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ Ø±Ø¨ Ø§Ù„Ø¹Ø±Ø´ Ø§Ù„Ø¹Ø¸ÙŠÙ…ØŒ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ Ø±Ø¨ Ø§Ù„Ø³Ù…ÙˆØ§Øª ÙˆØ±Ø¨ Ø§Ù„Ø£Ø±Ø¶ ÙˆØ±Ø¨ Ø§Ù„Ø¹Ø±Ø´ Ø§Ù„ÙƒØ±ÙŠÙ….',r:3},
      {t:'Ø§Ù„ØªÙ‡Ù„ÙŠÙ„',d:'Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡.',r:100},
      {t:'Ø§Ù„Ø­Ù…Ø¯',d:'Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø¹Ù„Ù‰ ÙƒÙ„ Ø­Ø§Ù„.',r:10}
    ]
  };
  window._azkarData=azkarData;
  vBody.innerHTML=`<div class="tab-bar">${tabs}</div><div id="azkar-content"></div>`;
  showAzkarCategory('morning',vBody.querySelector('.tbb'));
}
function showAzkarCategory(id,btn){
  document.querySelectorAll('.tab-bar .tbb').forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');
  const data=window._azkarData?.[id]||[];
  let html='';
  data.forEach((a,i)=>{
    const key=id+'_'+i;
    const done=azkarCounts[key]||0;
    const pct=Math.min(100,Math.round(done/a.r*100));
    html+=`<div class="azkar-card">
      <div class="azkar-title">${esc(a.t)}</div>
      <div class="azkar-text">${esc(a.d)}</div>
      <div class="azkar-count"><span>Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${toAr(a.r)} Ù…Ø±Ø©</span></div>
      <div class="reading-progress"><div class="reading-fill" id="azfill-${id}-${i}" style="width:${pct}%"></div></div>
      <div class="azkar-actions">
        <button class="azkar-btn" onclick="incAzkar('${id}',${i},${a.r})">Ø¹Ø¯Ù‘ (${toAr(done)}/${toAr(a.r)})</button>
        <button class="azkar-btn" onclick="resetAzkar('${id}',${i})">Ø¥Ø¹Ø§Ø¯Ø©</button>
        <button class="azkar-btn" onclick="cpAyah('${esc(a.d)}')">Ù†Ø³Ø®</button>
      </div>
    </div>`;
  });
  G('azkar-content').innerHTML=html||'<p style="text-align:center;padding:40px;color:var(--gray)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø°ÙƒØ§Ø±</p>';
}
function incAzkar(cat,idx,max){
  ck();if(navigator.vibrate)navigator.vibrate(15);
  const key=cat+'_'+idx;
  azkarCounts[key]=(azkarCounts[key]||0)+1;
  if(azkarCounts[key]>=max){sh('ğŸŒŸ ØªÙ…Ù…Øª Ø§Ù„Ø°ÙƒØ±!');ckOk();if(navigator.vibrate)navigator.vibrate([60,30,60]);azkarCounts[key]=max;}
  localStorage.setItem('azkarCounts',JSON.stringify(azkarCounts));
  // update UI
  const btn=document.querySelector(`[onclick="incAzkar('${cat}',${idx},${max})"]`);
  if(btn)btn.textContent=`Ø¹Ø¯Ù‘ (${toAr(azkarCounts[key])}/${toAr(max)})`;
  const fill=G(`azfill-${cat}-${idx}`);
  if(fill)fill.style.width=Math.min(100,Math.round(azkarCounts[key]/max*100))+'%';
}
function resetAzkar(cat,idx){
  ck();const key=cat+'_'+idx;azkarCounts[key]=0;
  localStorage.setItem('azkarCounts',JSON.stringify(azkarCounts));
  const fill=G(`azfill-${cat}-${idx}`);if(fill)fill.style.width='0%';
  sh('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯');
}

/* ============================================================
   DUAS (new feature)
============================================================ */
function renderDuas(){
  vTitle.textContent='Ø§Ù„Ø£Ø¯Ø¹ÙŠØ© Ø§Ù„Ù…Ø£Ø«ÙˆØ±Ø© ğŸ¤²';
  const duas=[
    {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø§Ø±Ø©',d:'Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³ØªØ®ÙŠØ±Ùƒ Ø¨Ø¹Ù„Ù…Ùƒ ÙˆØ£Ø³ØªÙ‚Ø¯Ø±Ùƒ Ø¨Ù‚Ø¯Ø±ØªÙƒ ÙˆØ£Ø³Ø£Ù„Ùƒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù„Ø¹Ø¸ÙŠÙ…ØŒ ÙØ¥Ù†Ùƒ ØªÙ‚Ø¯Ø± ÙˆÙ„Ø§ Ø£Ù‚Ø¯Ø± ÙˆØªØ¹Ù„Ù… ÙˆÙ„Ø§ Ø£Ø¹Ù„Ù… ÙˆØ£Ù†Øª Ø¹Ù„Ø§Ù… Ø§Ù„ØºÙŠÙˆØ¨.',s:'ØµØ­ÙŠØ­ Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ'},
    {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ù‚Ù†ÙˆØª',d:'Ø§Ù„Ù„Ù‡Ù… Ø§Ù‡Ø¯Ù†ÙŠ ÙÙŠÙ…Ù† Ù‡Ø¯ÙŠØª ÙˆØ¹Ø§ÙÙ†ÙŠ ÙÙŠÙ…Ù† Ø¹Ø§ÙÙŠØª ÙˆØªÙˆÙ„Ù‘Ù†ÙŠ ÙÙŠÙ…Ù† ØªÙˆÙ„Ù‘ÙŠØª ÙˆØ¨Ø§Ø±Ùƒ Ù„ÙŠ ÙÙŠÙ…Ø§ Ø£Ø¹Ø·ÙŠØª ÙˆÙ‚Ù†ÙŠ Ø´Ø± Ù…Ø§ Ù‚Ø¶ÙŠØª.',s:'Ø­Ø¯ÙŠØ« Ø´Ø±ÙŠÙ'},
    {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ù‡Ù… ÙˆØ§Ù„Ø­Ø²Ù†',d:'Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø¹Ø¨Ø¯Ùƒ Ø§Ø¨Ù† Ø¹Ø¨Ø¯Ùƒ Ø§Ø¨Ù† Ø£Ù…ØªÙƒØŒ Ù†Ø§ØµÙŠØªÙŠ Ø¨ÙŠØ¯ÙƒØŒ Ù…Ø§Ø¶Ù ÙÙŠÙ‘ Ø­ÙƒÙ…ÙƒØŒ Ø¹Ø¯Ù„ ÙÙŠÙ‘ Ù‚Ø¶Ø§Ø¤ÙƒØŒ Ø£Ø³Ø£Ù„Ùƒ Ø¨ÙƒÙ„ Ø§Ø³Ù… Ù‡Ùˆ Ù„Ùƒ Ø³Ù…ÙŠÙ‘Øª Ø¨Ù‡ Ù†ÙØ³Ùƒ Ø£Ùˆ Ø£Ù†Ø²Ù„ØªÙ‡ ÙÙŠ ÙƒØªØ§Ø¨Ùƒ.',s:'ØµØ­ÙŠØ­ Ø§Ø¨Ù† Ø­Ø¨Ø§Ù†'},
    {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø³ÙØ±',d:'Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†Ø§ Ù†Ø³Ø£Ù„Ùƒ ÙÙŠ Ø³ÙØ±Ù†Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø± ÙˆØ§Ù„ØªÙ‚ÙˆÙ‰ ÙˆÙ…Ù† Ø§Ù„Ø¹Ù…Ù„ Ù…Ø§ ØªØ±Ø¶Ù‰ØŒ Ø§Ù„Ù„Ù‡Ù… Ù‡ÙˆÙ‘Ù† Ø¹Ù„ÙŠÙ†Ø§ Ø³ÙØ±Ù†Ø§ Ù‡Ø°Ø§ ÙˆØ§Ø·ÙˆÙ Ø¹Ù†Ø§ Ø¨ÙØ¹Ø¯Ù‡.',s:'ØµØ­ÙŠØ­ Ù…Ø³Ù„Ù…'},
    {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø±Ø²Ù‚',d:'Ø§Ù„Ù„Ù‡Ù… Ø§ÙƒÙÙ†ÙŠ Ø¨Ø­Ù„Ø§Ù„Ùƒ Ø¹Ù† Ø­Ø±Ø§Ù…Ùƒ ÙˆØ£ØºÙ†Ù†ÙŠ Ø¨ÙØ¶Ù„Ùƒ Ø¹Ù…ÙÙ‘Ù† Ø³ÙˆØ§Ùƒ.',s:'Ø³Ù†Ù† Ø§Ù„ØªØ±Ù…Ø°ÙŠ'},
    {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø±ÙŠØ¶',d:'Ø§Ù„Ù„Ù‡Ù… Ø±Ø¨ Ø§Ù„Ù†Ø§Ø³ Ø£Ø°Ù‡Ø¨ Ø§Ù„Ø¨Ø£Ø³ ÙˆØ§Ø´ÙÙ Ø£Ù†Øª Ø§Ù„Ø´Ø§ÙÙŠ Ù„Ø§ Ø´ÙØ§Ø¡ Ø¥Ù„Ø§ Ø´ÙØ§Ø¤Ùƒ Ø´ÙØ§Ø¡Ù‹ Ù„Ø§ ÙŠØºØ§Ø¯Ø± Ø³Ù‚Ù…Ø§Ù‹.',s:'Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡'},
    {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„ÙØ±Ø¬',d:'Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø£Ù†Øª Ø³Ø¨Ø­Ø§Ù†Ùƒ Ø¥Ù†ÙŠ ÙƒÙ†Øª Ù…Ù† Ø§Ù„Ø¸Ø§Ù„Ù…ÙŠÙ†.',s:'Ø¯Ø¹Ø§Ø¡ ÙŠÙˆÙ†Ø³ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…'},
    {t:'Ø¯Ø¹Ø§Ø¡ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø²Ù„',d:'Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø®ÙŠØ± Ø§Ù„Ù…ÙˆÙ„Ø¬ ÙˆØ®ÙŠØ± Ø§Ù„Ù…Ø®Ø±Ø¬ØŒ Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ ÙˆÙ„Ø¬Ù†Ø§ ÙˆØ¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø®Ø±Ø¬Ù†Ø§ ÙˆØ¹Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ø±Ø¨Ù†Ø§ ØªÙˆÙƒÙ„Ù†Ø§.',s:'Ø³Ù†Ù† Ø£Ø¨ÙŠ Ø¯Ø§ÙˆØ¯'},
    {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø´ÙƒØ±',d:'Ø§Ù„Ù„Ù‡Ù… Ø£Ø¹Ù†Ù‘ÙŠ Ø¹Ù„Ù‰ Ø°ÙƒØ±Ùƒ ÙˆØ´ÙƒØ±Ùƒ ÙˆØ­Ø³Ù† Ø¹Ø¨Ø§Ø¯ØªÙƒ.',s:'Ø³Ù†Ù† Ø£Ø¨ÙŠ Ø¯Ø§ÙˆØ¯'},
    {t:'Ø¯Ø¹Ø§Ø¡ Ù„ÙŠÙ„Ø© Ø§Ù„Ù‚Ø¯Ø±',d:'Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†Ùƒ Ø¹ÙÙˆ ØªØ­Ø¨ Ø§Ù„Ø¹ÙÙˆ ÙØ§Ø¹ÙÙ Ø¹Ù†Ù‘ÙŠ.',s:'Ø³Ù†Ù† Ø§Ù„ØªØ±Ù…Ø°ÙŠ'},
    {t:'Ø¯Ø¹Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù„Ù…',d:'Ø±Ø¨ Ø²Ø¯Ù†ÙŠ Ø¹Ù„Ù…Ø§Ù‹.',s:'Ø³ÙˆØ±Ø© Ø·Ù‡'},
    {t:'Ø¯Ø¹Ø§Ø¡ Ø§Ù„ØµØ¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø³Ø§Ø¡',d:'Ø§Ù„Ù„Ù‡Ù… Ø¹Ø§ÙÙ†ÙŠ ÙÙŠ Ø¨Ø¯Ù†ÙŠØŒ Ø§Ù„Ù„Ù‡Ù… Ø¹Ø§ÙÙ†ÙŠ ÙÙŠ Ø³Ù…Ø¹ÙŠØŒ Ø§Ù„Ù„Ù‡Ù… Ø¹Ø§ÙÙ†ÙŠ ÙÙŠ Ø¨ØµØ±ÙŠØŒ Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø£Ù†Øª.',s:'Ø³Ù†Ù† Ø£Ø¨ÙŠ Ø¯Ø§ÙˆØ¯'}
  ];
  let html='<div class="grid" style="margin-top:14px">';
  duas.forEach((d,i)=>{
    html+=`<div class="card" onclick="ck();showDua(${i})"><span style="font-size:1.8em">ğŸ¤²</span><b style="font-size:.85em">${esc(d.t)}</b></div>`;
  });
  vBody.innerHTML=html+'</div>';
  window._duas=duas;
}
function showDua(i){
  const d=window._duas[i];if(!d)return;
  ck();
  G('dua-title').textContent=d.t;
  G('dua-text').textContent=d.d;
  G('dua-source').textContent='Ø§Ù„Ù…ØµØ¯Ø±: '+d.s;
  G('dua-modal').classList.add('show');
}
function closeDua(){G('dua-modal').classList.remove('show');}
function cpDua(){const t=G('dua-title').textContent+'\n\n'+G('dua-text').textContent;cpAyah(t);}

/* ============================================================
   NAMES
============================================================ */
function renderNames(){
  vTitle.textContent='Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ù‡ Ø§Ù„Ø­Ø³Ù†Ù‰ âœ¨';
  const nd=[
    {n:'Ø§Ù„Ø±Ø­Ù…Ù†',m:'Ø§Ù„Ø°ÙŠ ÙˆØ³Ø¹Øª Ø±Ø­Ù…ØªÙ‡ ÙƒÙ„ Ø´ÙŠØ¡'},{n:'Ø§Ù„Ø±Ø­ÙŠÙ…',m:'Ø§Ù„Ø°ÙŠ ÙŠØ±Ø­Ù… Ø¹Ø¨Ø§Ø¯Ù‡ Ø§Ù„Ù…Ø¤Ù…Ù†ÙŠÙ†'},{n:'Ø§Ù„Ù…Ù„Ùƒ',m:'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ù„Ùƒ ÙƒÙ„Ù‡'},{n:'Ø§Ù„Ù‚Ø¯ÙˆØ³',m:'Ø§Ù„Ù…Ù†Ø²Ù‘Ù‡ Ø¹Ù† ÙƒÙ„ Ù†Ù‚Øµ'},{n:'Ø§Ù„Ø³Ù„Ø§Ù…',m:'Ø§Ù„Ø°ÙŠ Ø³Ù„Ù… Ù…Ù† ÙƒÙ„ Ø¹ÙŠØ¨'},{n:'Ø§Ù„Ù…Ø¤Ù…Ù†',m:'Ø§Ù„Ø°ÙŠ Ø£Ù…Ù‘Ù† Ø¹Ø¨Ø§Ø¯Ù‡ Ù…Ù† Ø¹Ø°Ø§Ø¨Ù‡'},{n:'Ø§Ù„Ù…Ù‡ÙŠÙ…Ù†',m:'Ø§Ù„Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø±Ù‚ÙŠØ¨ Ø¹Ù„Ù‰ Ø®Ù„Ù‚Ù‡'},{n:'Ø§Ù„Ø¹Ø²ÙŠØ²',m:'Ø§Ù„ØºØ§Ù„Ø¨ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠÙØºÙ„Ø¨'},{n:'Ø§Ù„Ø¬Ø¨Ø§Ø±',m:'Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¨Ø± Ø§Ù„ÙƒØ³ÙŠØ± ÙˆÙŠÙ‚Ù‡Ø± Ø§Ù„Ø¹ØµØ§Ø©'},{n:'Ø§Ù„Ù…ØªÙƒØ¨Ø±',m:'Ø§Ù„Ù…ØªØ¹Ø§Ù„ÙŠ Ø¹Ù† ØµÙØ§Øª Ø§Ù„Ù†Ù‚Øµ'},{n:'Ø§Ù„Ø®Ø§Ù„Ù‚',m:'Ø§Ù„Ù…ÙˆØ¬Ø¯ Ù„Ù„Ø£Ø´ÙŠØ§Ø¡ Ù…Ù† Ø§Ù„Ø¹Ø¯Ù…'},{n:'Ø§Ù„Ø¨Ø§Ø±Ø¦',m:'Ø§Ù„Ø®Ø§Ù„Ù‚ Ø¹Ù„Ù‰ ØºÙŠØ± Ù…Ø«Ø§Ù„ Ø³Ø§Ø¨Ù‚'},{n:'Ø§Ù„Ù…ØµÙˆØ±',m:'Ø§Ù„Ø°ÙŠ ÙŠØµÙˆØ± Ø§Ù„Ø®Ù„Ù‚ ÙƒÙŠÙ ÙŠØ´Ø§Ø¡'},{n:'Ø§Ù„ØºÙØ§Ø±',m:'Ø§Ù„Ø°ÙŠ ÙŠØºÙØ± Ø§Ù„Ø°Ù†ÙˆØ¨ Ù…Ø±Ø§Ø±Ø§Ù‹'},{n:'Ø§Ù„Ù‚Ù‡Ø§Ø±',m:'Ø§Ù„ØºØ§Ù„Ø¨ Ø§Ù„Ø°ÙŠ Ù‚Ù‡Ø± ÙƒÙ„ Ø´ÙŠØ¡'},{n:'Ø§Ù„ÙˆÙ‡Ø§Ø¨',m:'Ø§Ù„ÙƒØ«ÙŠØ± Ø§Ù„Ø¹Ø·Ø§Ø¡ Ø¨Ù„Ø§ Ù…Ù‚Ø§Ø¨Ù„'},{n:'Ø§Ù„Ø±Ø²Ø§Ù‚',m:'Ø§Ù„Ø°ÙŠ ÙŠØ±Ø²Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ù„Ù‚'},{n:'Ø§Ù„ÙØªØ§Ø­',m:'Ø§Ù„Ø°ÙŠ ÙŠÙØªØ­ Ø£Ø¨ÙˆØ§Ø¨ Ø§Ù„Ø±Ø­Ù…Ø© ÙˆØ§Ù„Ø®ÙŠØ±'},{n:'Ø§Ù„Ø¹Ù„ÙŠÙ…',m:'Ø§Ù„Ø°ÙŠ Ø£Ø­Ø§Ø· Ø¹Ù„Ù…Ù‡ Ø¨ÙƒÙ„ Ø´ÙŠØ¡'},{n:'Ø§Ù„Ù‚Ø§Ø¨Ø¶',m:'Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø¨Ø¶ Ø§Ù„Ø£Ø±Ø²Ø§Ù‚ Ø¨Ø­ÙƒÙ…Ø©'},{n:'Ø§Ù„Ø¨Ø§Ø³Ø·',m:'Ø§Ù„Ø°ÙŠ ÙŠØ¨Ø³Ø· Ø§Ù„Ø±Ø²Ù‚ Ù„Ù…Ù† ÙŠØ´Ø§Ø¡'},{n:'Ø§Ù„Ø®Ø§ÙØ¶',m:'Ø§Ù„Ø°ÙŠ ÙŠØ®ÙØ¶ Ø§Ù„Ø¬Ø¨Ø§Ø±ÙŠÙ†'},{n:'Ø§Ù„Ø±Ø§ÙØ¹',m:'Ø§Ù„Ø°ÙŠ ÙŠØ±ÙØ¹ Ø§Ù„Ù…Ø¤Ù…Ù†ÙŠÙ†'},{n:'Ø§Ù„Ù…Ø¹Ø²',m:'Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø² Ù…Ù† ÙŠØ´Ø§Ø¡'},{n:'Ø§Ù„Ù…Ø°Ù„',m:'Ø§Ù„Ø°ÙŠ ÙŠØ°Ù„ Ù…Ù† ÙŠØ´Ø§Ø¡'},{n:'Ø§Ù„Ø³Ù…ÙŠØ¹',m:'Ø§Ù„Ø°ÙŠ ÙŠØ³Ù…Ø¹ ÙƒÙ„ Ø´ÙŠØ¡'},{n:'Ø§Ù„Ø¨ØµÙŠØ±',m:'Ø§Ù„Ø°ÙŠ ÙŠØ±Ù‰ ÙƒÙ„ Ø´ÙŠØ¡'},{n:'Ø§Ù„Ø­ÙƒÙ…',m:'Ø§Ù„Ø°ÙŠ ÙŠØ­ÙƒÙ… Ø¨ÙŠÙ† Ø§Ù„Ø®Ù„Ù‚ Ø¨Ø¹Ø¯Ù„'},{n:'Ø§Ù„Ø¹Ø¯Ù„',m:'Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØ¸Ù„Ù… Ø£Ø­Ø¯Ø§Ù‹'},{n:'Ø§Ù„Ù„Ø·ÙŠÙ',m:'Ø§Ù„Ø¹Ù„ÙŠÙ… Ø¨Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ø£Ù…ÙˆØ±'},{n:'Ø§Ù„Ø®Ø¨ÙŠØ±',m:'Ø§Ù„Ù…Ø·Ù„Ø¹ Ø¹Ù„Ù‰ Ø­Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ Ø§Ù„Ø¨Ø§Ø·Ù†Ø©'},{n:'Ø§Ù„Ø­Ù„ÙŠÙ…',m:'Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØ¹Ø¬Ù„ Ø¨Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©'},{n:'Ø§Ù„Ø¹Ø¸ÙŠÙ…',m:'Ø§Ù„Ø¬Ø§Ù…Ø¹ Ù„ØµÙØ§Øª Ø§Ù„Ø¹Ø¸Ù…Ø©'},{n:'Ø§Ù„ØºÙÙˆØ±',m:'Ø§Ù„Ø°ÙŠ ÙŠØºÙØ± Ø§Ù„Ø°Ù†ÙˆØ¨ Ø¬Ù…ÙŠØ¹Ù‡Ø§'},{n:'Ø§Ù„Ø´ÙƒÙˆØ±',m:'Ø§Ù„Ø°ÙŠ ÙŠØ´ÙƒØ± Ø§Ù„Ù‚Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„'},{n:'Ø§Ù„Ø¹Ù„ÙŠ',m:'Ø§Ù„Ù…ØªØ¹Ø§Ù„ÙŠ ÙÙˆÙ‚ Ø®Ù„Ù‚Ù‡'},{n:'Ø§Ù„ÙƒØ¨ÙŠØ±',m:'Ø§Ù„ÙƒØ¨ÙŠØ± Ø§Ù„Ø°ÙŠ ÙƒÙ„ Ø´ÙŠØ¡ Ø¯ÙˆÙ†Ù‡'},{n:'Ø§Ù„Ø­ÙÙŠØ¸',m:'Ø§Ù„Ø°ÙŠ ÙŠØ­ÙØ¸ Ø®Ù„Ù‚Ù‡'},{n:'Ø§Ù„Ù…Ù‚ÙŠØª',m:'Ø§Ù„Ø±Ø§Ø²Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ ÙƒÙ„ Ù†ÙØ³'},{n:'Ø§Ù„Ø­Ø³ÙŠØ¨',m:'Ø§Ù„ÙƒØ§ÙÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ­Ø§Ø³Ø¨ Ø§Ù„Ø¹Ø¨Ø§Ø¯'},{n:'Ø§Ù„Ø¬Ù„ÙŠÙ„',m:'Ø°Ùˆ Ø§Ù„Ø¬Ù„Ø§Ù„ ÙˆØ§Ù„Ø¹Ø¸Ù…Ø©'},{n:'Ø§Ù„ÙƒØ±ÙŠÙ…',m:'Ø§Ù„Ø¬ÙˆØ§Ø¯ Ø§Ù„ÙƒØ«ÙŠØ± Ø§Ù„Ø®ÙŠØ±'},{n:'Ø§Ù„Ø±Ù‚ÙŠØ¨',m:'Ø§Ù„Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø­ÙÙŠØ¸ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØºÙÙ„'},{n:'Ø§Ù„Ù…Ø¬ÙŠØ¨',m:'Ø§Ù„Ø°ÙŠ ÙŠØ¬ÙŠØ¨ Ø¯Ø¹Ø§Ø¡ Ù…Ù† Ø¯Ø¹Ø§Ù‡'},{n:'Ø§Ù„ÙˆØ§Ø³Ø¹',m:'Ø§Ù„Ø°ÙŠ ÙˆØ³Ø¹ Ø¹Ù„Ù…Ù‡ ÙˆÙØ¶Ù„Ù‡ ÙƒÙ„ Ø´ÙŠØ¡'},{n:'Ø§Ù„Ø­ÙƒÙŠÙ…',m:'Ø°Ùˆ Ø§Ù„Ø­ÙƒÙ…Ø© Ø§Ù„ØªØ§Ù…Ø© ÙÙŠ Ø£ÙØ¹Ø§Ù„Ù‡'},{n:'Ø§Ù„ÙˆØ¯ÙˆØ¯',m:'Ø§Ù„Ø°ÙŠ ÙŠØ­Ø¨ Ø¹Ø¨Ø§Ø¯Ù‡ Ø§Ù„ØµØ§Ù„Ø­ÙŠÙ†'},{n:'Ø§Ù„Ù…Ø¬ÙŠØ¯',m:'Ø§Ù„Ø±ÙÙŠØ¹ Ø´Ø£Ù†Ù‡ Ø§Ù„Ø¹Ø¸ÙŠÙ… Ù‚Ø¯Ø±Ù‡'},{n:'Ø§Ù„Ø¨Ø§Ø¹Ø«',m:'Ø§Ù„Ø°ÙŠ ÙŠØ¨Ø¹Ø« Ø§Ù„Ù…ÙˆØªÙ‰ ÙŠÙˆÙ… Ø§Ù„Ù‚ÙŠØ§Ù…Ø©'},{n:'Ø§Ù„Ø´Ù‡ÙŠØ¯',m:'Ø§Ù„Ø­Ø§Ø¶Ø± Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØºÙŠØ¨ Ø¹Ù† Ø¹Ù„Ù…Ù‡ Ø´ÙŠØ¡'},{n:'Ø§Ù„Ø­Ù‚',m:'Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø­Ù‚Ø§Ù‹ Ø§Ù„Ø«Ø§Ø¨Øª Ø£Ø¨Ø¯Ø§Ù‹'},{n:'Ø§Ù„ÙˆÙƒÙŠÙ„',m:'Ø§Ù„ÙƒØ§ÙÙŠ Ù„Ù…Ù† ØªÙˆÙƒÙ„ Ø¹Ù„ÙŠÙ‡'},{n:'Ø§Ù„Ù‚ÙˆÙŠ',m:'Ø§Ù„ØªØ§Ù… Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠÙØ¹Ø¬Ø²Ù‡ Ø´ÙŠØ¡'},{n:'Ø§Ù„Ù…ØªÙŠÙ†',m:'Ø§Ù„Ø´Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„Ø¨Ø·Ø´'},{n:'Ø§Ù„ÙˆÙ„ÙŠ',m:'Ø§Ù„Ù†Ø§ØµØ± Ù„Ø¹Ø¨Ø§Ø¯Ù‡ Ø§Ù„Ù…Ø¤Ù…Ù†ÙŠÙ†'},{n:'Ø§Ù„Ø­Ù…ÙŠØ¯',m:'Ø§Ù„Ù…Ø­Ù…ÙˆØ¯ Ø¨ÙƒÙ„ Ù„Ø³Ø§Ù†'},{n:'Ø§Ù„Ù…Ø­ØµÙŠ',m:'Ø§Ù„Ø°ÙŠ Ø£Ø­ØµÙ‰ ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ø¯Ø¯Ø§Ù‹'},{n:'Ø§Ù„Ù…Ø¨Ø¯Ø¦',m:'Ø§Ù„Ø°ÙŠ Ø¨Ø¯Ø£ Ø§Ù„Ø®Ù„Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¯Ù…'},{n:'Ø§Ù„Ù…Ø¹ÙŠØ¯',m:'Ø§Ù„Ø°ÙŠ ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø®Ù„Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ†Ø§Ø¡'},{n:'Ø§Ù„Ù…Ø­ÙŠÙŠ',m:'Ø§Ù„Ø°ÙŠ ÙŠØ­ÙŠÙŠ Ø§Ù„Ù…ÙˆØªÙ‰'},{n:'Ø§Ù„Ù…Ù…ÙŠØª',m:'Ø§Ù„Ø°ÙŠ ÙŠÙ…ÙŠØª Ø§Ù„Ø£Ø­ÙŠØ§Ø¡'},{n:'Ø§Ù„Ø­ÙŠ',m:'Ø§Ù„Ø¯Ø§Ø¦Ù… Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠÙ…ÙˆØª'},{n:'Ø§Ù„Ù‚ÙŠÙˆÙ…',m:'Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ù†ÙØ³Ù‡ Ø§Ù„Ù…ÙÙ‚ÙŠÙ… Ù„ØºÙŠØ±Ù‡'},{n:'Ø§Ù„ÙˆØ§Ø¬Ø¯',m:'Ø§Ù„ØºÙ†ÙŠ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠÙØªÙ‚Ø± Ù„Ø´ÙŠØ¡'},{n:'Ø§Ù„Ù…Ø§Ø¬Ø¯',m:'Ø§Ù„Ø´Ø±ÙŠÙ Ø°Ùˆ Ø§Ù„Ù…Ø¬Ø¯ ÙˆØ§Ù„ÙƒØ±Ù…'},{n:'Ø§Ù„ÙˆØ§Ø­Ø¯',m:'Ø§Ù„Ù…Ù†ÙØ±Ø¯ Ø¨Ø°Ø§ØªÙ‡ ÙˆØµÙØ§ØªÙ‡'},{n:'Ø§Ù„Ø£Ø­Ø¯',m:'Ø§Ù„ÙØ±Ø¯ Ø§Ù„Ø°ÙŠ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡'},{n:'Ø§Ù„ØµÙ…Ø¯',m:'Ø§Ù„Ø°ÙŠ ÙŠÙÙ‚ØµØ¯ ÙÙŠ Ø§Ù„Ø­ÙˆØ§Ø¦Ø¬ ÙƒÙ„Ù‡Ø§'},{n:'Ø§Ù„Ù‚Ø§Ø¯Ø±',m:'Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø¯Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡'},{n:'Ø§Ù„Ù…Ù‚ØªØ¯Ø±',m:'Ø§Ù„Ø´Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø¯Ø±Ø©'},{n:'Ø§Ù„Ù…Ù‚Ø¯Ù…',m:'Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø¯Ù… Ù…Ø§ Ø´Ø§Ø¡'},{n:'Ø§Ù„Ù…Ø¤Ø®Ø±',m:'Ø§Ù„Ø°ÙŠ ÙŠØ¤Ø®Ø± Ù…Ø§ Ø´Ø§Ø¡ Ø¨Ø­ÙƒÙ…Ø©'},{n:'Ø§Ù„Ø£ÙˆÙ„',m:'Ø§Ù„Ø°ÙŠ Ù„ÙŠØ³ Ù‚Ø¨Ù„Ù‡ Ø´ÙŠØ¡'},{n:'Ø§Ù„Ø¢Ø®Ø±',m:'Ø§Ù„Ø°ÙŠ Ù„ÙŠØ³ Ø¨Ø¹Ø¯Ù‡ Ø´ÙŠØ¡'},{n:'Ø§Ù„Ø¸Ø§Ù‡Ø±',m:'Ø§Ù„Ø°ÙŠ Ø¸Ù‡Ø± ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡ Ø¨Ù‚Ø¯Ø±ØªÙ‡'},{n:'Ø§Ù„Ø¨Ø§Ø·Ù†',m:'Ø§Ù„Ø¹Ø§Ù„Ù… Ø¨ÙƒÙ„ Ø®ÙÙŠØ© ÙˆØ³Ø±'},{n:'Ø§Ù„ÙˆØ§Ù„ÙŠ',m:'Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…ØªØµØ±Ù ÙÙŠ ÙƒÙ„ Ø´ÙŠØ¡'},{n:'Ø§Ù„Ù…ØªØ¹Ø§Ù„ÙŠ',m:'Ø§Ù„Ø¹Ø§Ù„ÙŠ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡ Ø¨Ø¹Ø¸Ù…ØªÙ‡'},{n:'Ø§Ù„Ø¨Ø±',m:'Ø§Ù„Ø¹Ø·ÙˆÙ Ø¹Ù„Ù‰ Ø¹Ø¨Ø§Ø¯Ù‡ Ø§Ù„Ø±Ø­ÙŠÙ… Ø¨Ù‡Ù…'},{n:'Ø§Ù„ØªÙˆØ§Ø¨',m:'Ø§Ù„Ø°ÙŠ ÙŠÙƒØ«Ø± Ù‚Ø¨ÙˆÙ„ ØªÙˆØ¨Ø© Ø¹Ø¨Ø§Ø¯Ù‡'},{n:'Ø§Ù„Ù…Ù†ØªÙ‚Ù…',m:'Ø§Ù„Ø°ÙŠ ÙŠÙ†ØªÙ‚Ù… Ù…Ù† Ø§Ù„Ø¸Ø§Ù„Ù…ÙŠÙ†'},{n:'Ø§Ù„Ø¹ÙÙˆ',m:'Ø§Ù„Ø°ÙŠ ÙŠÙ…Ø­Ùˆ Ø§Ù„Ø°Ù†ÙˆØ¨ ÙˆÙŠØµÙØ­'},{n:'Ø§Ù„Ø±Ø¤ÙˆÙ',m:'Ø§Ù„Ø±Ù‚ÙŠÙ‚ Ø§Ù„Ø¹Ø·ÙˆÙ Ø¹Ù„Ù‰ Ø¹Ø¨Ø§Ø¯Ù‡'},{n:'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ù„Ùƒ',m:'Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¯Ù†ÙŠØ§ ÙˆØ§Ù„Ø¢Ø®Ø±Ø©'},{n:'Ø°Ùˆ Ø§Ù„Ø¬Ù„Ø§Ù„',m:'ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ø¸Ù…Ø© ÙˆØ§Ù„ÙƒØ±Ù… Ø§Ù„ØªØ§Ù…'},{n:'Ø§Ù„Ù…Ù‚Ø³Ø·',m:'Ø§Ù„Ø¹Ø§Ø¯Ù„ ÙÙŠ Ø­ÙƒÙ…Ù‡ ÙˆÙ‚Ø¶Ø§Ø¦Ù‡'},{n:'Ø§Ù„Ø¬Ø§Ù…Ø¹',m:'Ø§Ù„Ø°ÙŠ ÙŠØ¬Ù…Ø¹ Ø§Ù„Ø®Ù„Ù‚ Ù„Ù„Ø­Ø³Ø§Ø¨'},{n:'Ø§Ù„ØºÙ†ÙŠ',m:'Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ù„Ø£Ø­Ø¯'},{n:'Ø§Ù„Ù…ØºÙ†ÙŠ',m:'Ø§Ù„Ø°ÙŠ ÙŠØºÙ†ÙŠ Ù…Ù† ÙŠØ´Ø§Ø¡ Ù…Ù† Ø¹Ø¨Ø§Ø¯Ù‡'},{n:'Ø§Ù„Ù…Ø§Ù†Ø¹',m:'Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù†Ø¹ Ù…Ø§ ÙŠØ´Ø§Ø¡ Ø¨Ø­ÙƒÙ…ØªÙ‡'},{n:'Ø§Ù„Ø¶Ø§Ø±',m:'Ø§Ù„Ø°ÙŠ ÙŠØ¶Ø± Ù…Ù† ÙŠØ´Ø§Ø¡ Ø¹Ø¯Ù„Ø§Ù‹'},{n:'Ø§Ù„Ù†Ø§ÙØ¹',m:'Ø§Ù„Ø°ÙŠ ÙŠÙ†ÙØ¹ Ù…Ù† ÙŠØ´Ø§Ø¡ ÙØ¶Ù„Ø§Ù‹'},{n:'Ø§Ù„Ù†ÙˆØ±',m:'Ø§Ù„Ø°ÙŠ Ù†ÙˆÙ‘Ø± Ø§Ù„Ø³Ù…Ø§ÙˆØ§Øª ÙˆØ§Ù„Ø£Ø±Ø¶'},{n:'Ø§Ù„Ù‡Ø§Ø¯ÙŠ',m:'Ø§Ù„Ø°ÙŠ ÙŠÙ‡Ø¯ÙŠ Ù…Ù† ÙŠØ´Ø§Ø¡ Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø­Ù‚'},{n:'Ø§Ù„Ø¨Ø¯ÙŠØ¹',m:'Ø§Ù„Ù…Ø¨ØªÙƒØ± Ù„Ù„Ø£Ø´ÙŠØ§Ø¡ Ø¨Ù„Ø§ Ù…Ø«Ø§Ù„'},{n:'Ø§Ù„Ø¨Ø§Ù‚ÙŠ',m:'Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠÙÙ†Ù‰ ÙˆÙ„Ø§ ÙŠØ²ÙˆÙ„'},{n:'Ø§Ù„ÙˆØ§Ø±Ø«',m:'Ø§Ù„Ø°ÙŠ ÙŠØ±Ø« Ø§Ù„Ø£Ø±Ø¶ ÙˆÙ…Ù† Ø¹Ù„ÙŠÙ‡Ø§'},{n:'Ø§Ù„Ø±Ø´ÙŠØ¯',m:'Ø§Ù„Ø°ÙŠ ÙŠØ±Ø´Ø¯ Ø¥Ù„Ù‰ Ø§Ù„ØµÙˆØ§Ø¨'},{n:'Ø§Ù„ØµØ¨ÙˆØ±',m:'Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØ¹Ø¬Ù„ Ø¹Ù„Ù‰ Ù…Ù† Ø¹ØµØ§Ù‡'}
  ];
  let html='<div class="grid" style="margin-top:14px">';
  nd.forEach((it,i)=>{
    html+=`<div class="name-card" onclick="ck();showNameDetail('${esc(it.n)}','${esc(it.m)}',${i+1})">
      <div style="color:var(--accent);font-size:.73em">${toAr(i+1)}</div>
      <b style="font-size:1em">${esc(it.n)}</b>
      <div class="name-meaning">${esc(it.m)}</div>
    </div>`;
  });
  vBody.innerHTML=html+'</div>';
}
function showNameDetail(name,meaning,num){
  sh(`${name} (${num}/99): ${meaning}`,4000);
}

/* ============================================================
   KHATMA
============================================================ */
function renderKhatma(){
  vTitle.textContent='Ø§Ù„Ø®ØªÙ…Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© ğŸŒŸ';
  vBody.innerHTML=`<div style="text-align:center;padding:32px 20px">
    <div style="font-size:1em;color:var(--text);margin-bottom:6px;opacity:.7">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø³Ù„Ù…ÙŠÙ† Ø­ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù„Ù…</div>
    <div id="gc" style="font-size:clamp(3.5em,14vw,5.5em);color:var(--accent);font-weight:bold;font-family:monospace">...</div>
    <p style="color:var(--gray);margin-bottom:24px;font-size:.9em">Ø³ÙˆØ±Ø© ØªÙ… Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§ Ø¬Ù…Ø§Ø¹ÙŠØ§Ù‹</p>
    <div class="sebha-circle" style="background:var(--accent);color:var(--primary);font-size:1.1em;border-color:var(--primary)" onclick="incKhatma()">Ø£Ù†Ù‡ÙŠØª<small style="font-size:.6em">Ø³ÙˆØ±Ø©</small></div>
    <p style="color:var(--gray);font-size:.84em;margin-top:14px;padding:0 24px;line-height:1.7">ÙƒÙ„ Ø³ÙˆØ±Ø© ØªÙÙ‚Ø±Ø£ ØªÙØ³Ø¬ÙÙ‘Ù„ ÙÙŠ Ø§Ù„Ø®ØªÙ…Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ù„Ù„Ù…Ø³Ù„Ù…ÙŠÙ† Ø­ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù„Ù…</p>
  </div>`;
  if(window._fb){const{db,ref,onValue}=window._fb;onValue(ref(db,'khatma_global/total'),s=>{const gc=G('gc');if(gc)gc.textContent=toAr(s.val()||0);});}
}
function incKhatma(){
  ck();if(!window._fb){sh('ØªØ­ØªØ§Ø¬ Ø§ØªØµØ§Ù„Ø§Ù‹ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©');return;}
  const{db,ref,get,set}=window._fb;const r=ref(db,'khatma_global/total');
  get(r).then(s=>{set(r,(s.val()||0)+1);sh('ğŸŒŸ ØªÙ‚Ø¨Ù‘Ù„ Ø§Ù„Ù„Ù‡ Ù…Ù†Ùƒ');ckOk();if(navigator.vibrate)navigator.vibrate([80,40,80]);}).catch(()=>sh('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„'));
}

/* resize canvas */
window.addEventListener('resize',()=>{
  const c=G('sky-canvas');if(!c)return;
  c.width=c.offsetWidth||window.innerWidth;
  c.height=130;
});

/* swipe to go back */
let touchStartX=0,touchStartY=0;
viewer.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;},{passive:true});
viewer.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-touchStartX;
  const dy=Math.abs(e.changedTouches[0].clientY-touchStartY);
  if(dx>70&&dy<50&&touchStartX<40){doBack();}
},{passive:true});
</script>
</body>
</html>
